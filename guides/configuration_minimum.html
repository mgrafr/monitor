

<!DOCTYPE html>
<html class="writer-html5" lang="fr">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Configuration minimum : la page d’accueil &mdash; Monitor</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=536c50fe" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=d44bf9f9" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e59be10d"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/translations.js?v=d99ca74e"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="2. Une 1ere PAGE : LE PLAN INTERIEUR" href="plan_interieur.html" />
    <link rel="prev" title="0. Infos pour bien débuter" href="bien_debuter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            monitor-domotique
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SOMMAIRE</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bien_debuter.html">0. Infos pour bien débuter</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Configuration minimum : la page d’accueil</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration-admin-config-php">1.1     – Configuration :/admin.config.php</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adresse-ip-domaine-favicon-de-monitor">1.1.1 -Adresse IP , domaine, favicon de monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-pour-limage-de-fond-suivant-la-resolution-decran-et-le-logo">1.1.1.a Pour l’image de fond suivant la résolution d’écran et le logo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-pour-les-titres-slogans-et-lexique">1.1.1.b Pour les titres, slogans et lexique</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#intervalles-de-maj">1.1.2 intervalles de maj</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maj-en-temps-reel">1.1.3 maj en temps réel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#solution-semi-temps-reel">1.1.3.1 Solution semi temps réel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#solution-temps-reel-sse">1.1.3.2 Solution temps réel SSE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#autres-donnees">1.1.4 Autres données</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#les-fichiers-php-les-styles-le-javascript">1.2     - Les fichiers PHP, les styles, le javascript</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#a-la-racine-du-site">1.2.1 - à la racine du site :</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#status-variables-devices-zone-et-device-plan">1.2.1.1 status_variables , devices_zone et device_plan</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#les-styles-css">1.2.2 les styles css</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#styles-css-communs-a-toutes-les-pages">1.2.2.1 styles CSS communs à toutes les pages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#le-javascript">1.2.3 – Le javascript</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#les-fichiers-principaux-dans-include">1.3 Les fichiers principaux dans /include</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#entete-html-php">1.3.1 entete_html.php</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-de-la-base-de-donnees-test-db-php">1.3.2 Test de la base de données, test_db.php</a></li>
<li class="toctree-l3"><a class="reference internal" href="#le-menu-header-php">1.3.3 le menu, header.php</a></li>
<li class="toctree-l3"><a class="reference internal" href="#la-page-daccueil-avec-les-notifications-accueil-php">1.3.4   la page d’accueil avec les notifications , accueil.php</a></li>
<li class="toctree-l3"><a class="reference internal" href="#les-scripts-javascript">1.3.5 les scripts JavaScript</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rafraichissements-des-donnees">1.3.5.1 rafraîchissements des données</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#a-rafrichissement-de-la-page-avec-une-variable">1.3.5.1.a rafrichissement de la page avec une variable</a></li>
<li class="toctree-l5"><a class="reference internal" href="#b-rafraichissement-avec-sse">1.3.5.1.b rafraichissement avec SSE</a></li>
<li class="toctree-l5"><a class="reference internal" href="#c-le-serveur-sse">1.3.5.1.c Le serveur SSE</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#quelques-infos-supplementaires">1.3.5.2 Quelques infos supplémentaires</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#le-lexique-et-la-temperature-exterieure">1.4 Le lexique et la température extérieure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#le-lexique">1.4.1 Le lexique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#la-temperature-exterieure-valable-pour-dautres-dispositifs">1.4.2 La température extérieure (valable pour d’autres dispositifs)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#liens-avec-domoticz-home-assistant-ou-io-broker">1.5 liens avec Domoticz, Home Assistant ou io.broker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#liens-avec-domoticz">1.5.1 Liens avec Domoticz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#les-variables-lua-de-configuration-dans-un-fichier-externe">1.5.1.1 les variables lua de configuration dans un fichier externe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#les-scripts-de-notifications-gerees-par-domoticz">1.5.1.2 les scripts de notifications gérées par Domoticz</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#script-lua">script lua</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#liens-avec-home-assistant">1.5.2 Liens avec Home Assistant</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exemple-dun-on-off-sur-un-interrupteur-virtuel">1.5.2.1  Exemple d’un ON OFF sur un interrupteur virtuel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#liaison-mqtt-entre-home-assistant-et-domoticz">1.5.3 Liaison MQTT entre Home Assistant et Domoticz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ajout-dans-domoticz">1.5.3.1  Ajout dans Domoticz</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ajout-dans-home-assistant">1.5.3.2  Ajout dans Home Assistant</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#liens-avec-io-broker">1.5.4 Liens avec io.broker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#utlisation-de-rest-api">1.5.4.1  Utlisation de rest-api</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utlisation-de-vis-2-0">1.5.4.2 Utlisation de Vis 2.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lien-avec-la-base-de-donnees-sql">1.6 Lien avec la base de données SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#exemple-avec-la-date-de-ramassage-des-poubelles">1.6.1- exemple avec la date de ramassage des poubelles</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ajuster-le-menu-au-nombre-de-pages">1.7 Ajuster le menu au nombre de pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#complement-pour-les-notifications-sur-l-ecran-d-accueil">1.8 Complément pour les notifications sur l’écran d’accueil</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#les-notifications-incluses-dans-le-programme">1.8.1 les notifications incluses dans le programme</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mode-d-emploi-pour-ajouter-une-notification">1.8.2 Mode d’emploi pour ajouter une notification</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ecriture-d-un-script-dzvent-ou-yaml">1.8.2.1 Ecriture d’un script Dzvent ou yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#domoticz">1.8.2.1.1 Domoticz</a></li>
<li class="toctree-l5"><a class="reference internal" href="#la-variable-lastseen">1.8.2.1.2 La variable lastseen</a></li>
<li class="toctree-l5"><a class="reference internal" href="#home-assistant">1.8.2.1.3 Home Assistant</a></li>
<li class="toctree-l5"><a class="reference internal" href="#io-broker">1.8.2.1.4 Io.Broker</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#la-page-d-accueil-de-monitor-include-accueil-php">1.8.2.2  La page d’accueil de monitor : include/accueil.php</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#les-emplacements-disponibles-et-les-styles-css">1.8.3 les emplacements disponibles et les styles css</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enregistrement-de-la-variable-dans-la-base-sql">1.8.4 Enregistrement de la variable dans la base SQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#affichage-dans-monitor">1.8.5 Affichage dans monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#function-status-variables-xx-dans-fonctions-php">1.8.5.1 function status_variables($xx) dans fonctions.php</a></li>
<li class="toctree-l4"><a class="reference internal" href="#script-jquery-dans-footer-php">1.8.5.2 script Jquery dans footer.php</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reception-du-mail-de-notification">1.8.6 Réception du mail de notification</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#acces-distant-https">1.9 Accès distant HTTPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#monitor-conf">1.9.1 monitor.conf</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plan_interieur.html">2. Une 1ere PAGE : LE PLAN INTERIEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="meteo.html">3. Météo</a></li>
<li class="toctree-l1"><a class="reference internal" href="plan_exterieur.html">4. La page du plan extérieur</a></li>
<li class="toctree-l1"><a class="reference internal" href="alarme.html">5. L’ALARME</a></li>
<li class="toctree-l1"><a class="reference internal" href="graphiques.html">6. GRAHIQUES &amp; BASE DE DONNEES</a></li>
<li class="toctree-l1"><a class="reference internal" href="mur_cameras.html">7. MUR de CAMERAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="mur_de_commandes.html">8. MUR de COMMANDES</a></li>
<li class="toctree-l1"><a class="reference internal" href="zigbee.html">9. Dispositifs Zigbee</a></li>
<li class="toctree-l1"><a class="reference internal" href="zwave.html">10. Dispositifs Zwave</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">11. MONITORING Nagios</a></li>
<li class="toctree-l1"><a class="reference internal" href="app_diverses.html">12. - FICHIERS LOG Domoticz, Nagios, SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="app_externes.html">13. APPLICATIONS externes en lien avec Domoticz, HA ou monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">14.  ADMINISTRATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="exemples.html">15. EXEMPLES</a></li>
<li class="toctree-l1"><a class="reference internal" href="ajout_page_alertes.html">16. Ajouter des pages ou des alertes</a></li>
<li class="toctree-l1"><a class="reference internal" href="diy.html">17. DIY</a></li>
<li class="toctree-l1"><a class="reference internal" href="divers.html">18. Divers</a></li>
<li class="toctree-l1"><a class="reference internal" href="update.html">19. UPDATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="resolution_problemes.html">20. Résolution de problèmes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mon_installation.html">21. – Mon installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimisations.html">22. OPTIMISATION en cours</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">monitor-domotique</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">1. Configuration minimum : la page d’accueil</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/guides/configuration_minimum.rst.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="configuration-minimum-la-page-daccueil">
<h1>1. Configuration minimum : la page d’accueil<a class="headerlink" href="#configuration-minimum-la-page-daccueil" title="Lien permanent vers cette rubrique"></a></h1>
<p>Permet d’afficher</p>
<ul class="simple">
<li><p>La température extérieure,</p></li>
<li><p>Le jour (changement à 0H pour une tablette connectée en permanence),</p></li>
<li><p>La sortie des poubelles,</p></li>
<li><p>La gestion de la fosse septique,</p></li>
<li><p>La surveillance de la pression de la chaudière</p></li>
<li><p>Les anniversaires</p></li>
<li><p>Rappel pour la prise de médicaments</p></li>
<li><p>La prévision de pluie à 1 heure de Météo France</p></li>
<li><p>L’arrivée du courrier</p></li>
<li><p>La mise en service de l’alarme de nuit</p></li>
<li><p>Le remplacement des piles pour les capteurs concernés</p></li>
<li><p>Les dispositifs off line</p></li>
<li><p>etc ….</p></li>
</ul>
<p><a class="reference internal" href="../_images/image117.webp"><img alt="image117" src="../_images/image117.webp" style="width: 531px;" /></a></p>
<section id="configuration-admin-config-php">
<h2>1.1     – Configuration :/admin.config.php<a class="headerlink" href="#configuration-admin-config-php" title="Lien permanent vers cette rubrique"></a></h2>
<blockquote>
<div><p><span class="red">Il faut fournir un minimum de renseignements</span> :</p>
</div></blockquote>
<section id="adresse-ip-domaine-favicon-de-monitor">
<h3>1.1.1 -Adresse IP , domaine, favicon de monitor<a class="headerlink" href="#adresse-ip-domaine-favicon-de-monitor" title="Lien permanent vers cette rubrique"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">general</span> <span class="n">monitor</span>
<span class="o">--&gt;</span><span class="n">define</span><span class="p">(</span><span class="s1">&#39;URLMONITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">domaine</span> <span class="p">(</span><span class="n">pour</span> <span class="n">accès</span> <span class="n">distant</span><span class="p">)</span> <span class="n">et</span> <span class="n">port</span> <span class="n">si</span> <span class="n">différent</span> <span class="n">de</span> <span class="mi">443</span>
<span class="o">--&gt;</span><span class="n">define</span><span class="p">(</span><span class="s1">&#39;IPMONITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.1.9&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">ip</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;PASSMONITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;*******&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">mot</span> <span class="n">passe</span> <span class="n">serveur</span> <span class="n">et</span> <span class="n">SSH2</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;USERMONITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;michel&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">user</span> <span class="n">serveur</span> <span class="n">et</span> <span class="n">SSH2</span> <span class="p">;</span><span class="n">le</span> <span class="n">répertoire</span> <span class="n">perso</span> <span class="n">sera</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">nom</span> <span class="n">de</span> <span class="n">USERMONITOR</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;MONCONFIG&#39;</span><span class="p">,</span> <span class="s1">&#39;admin/config.php&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">fichier</span> <span class="n">config</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;DZCONFIG&#39;</span><span class="p">,</span> <span class="s1">&#39;admin/dz/temp.lua&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">fichier</span> <span class="n">temp</span>
<span class="o">--&gt;</span><span class="n">define</span><span class="p">(</span><span class="s1">&#39;FAVICON&#39;</span><span class="p">,</span> <span class="s1">&#39;/favicon.ico&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">fichier</span> <span class="n">favicon</span>  <span class="p">,</span> <span class="n">icone</span> <span class="n">du</span> <span class="n">domaine</span> <span class="n">dans</span> <span class="n">barre</span> <span class="n">url</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;DISPOSITIFS&#39;</span><span class="p">,</span> <span class="s1">&#39;dispositifs&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl>
<dt><span class="red">define(“DISPOSITIFS”, “dispositifs”);</span></dt><dd><p>Pour faciliter la réinitialisation des dispositifs dans Domoticz ou un transfert (ex, zwavejs2mqtt , zigbee2mqtt sous docker) ;</p>
<p>en créant une copie de la table dispositifs (« dispositifs » par défaut), il est
possible de préparer le transfert ; ici la table dispositifs a été renommée Dispositifs</p>
<p><a class="reference internal" href="../_images/image120.webp"><img alt="image120" src="../_images/image120.webp" style="width: 357px;" /></a></p>
<p><a class="reference internal" href="../_images/image121.webp"><img alt="image121" src="../_images/image121.webp" style="width: 239px;" /></a></p>
</dd>
</dl>
</div>
<section id="a-pour-limage-de-fond-suivant-la-resolution-decran-et-le-logo">
<h4>1.1.1.a Pour l’image de fond suivant la résolution d’écran et le logo<a class="headerlink" href="#a-pour-limage-de-fond-suivant-la-resolution-decran-et-le-logo" title="Lien permanent vers cette rubrique"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Monitor</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;IMAGEACCUEIL&#39;</span><span class="p">,</span> <span class="s1">&#39;images/maison.webp&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">image</span> <span class="n">page</span> <span class="n">accueil</span> <span class="n">pour</span> <span class="n">écrans</span> <span class="o">&gt;</span><span class="mi">534</span> <span class="n">px</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;IMAGEACCUEILSMALL&#39;</span><span class="p">,</span> <span class="s1">&#39;images/maison_small.webp&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">image</span> <span class="n">page</span> <span class="n">accueil</span> <span class="n">pour</span> <span class="n">écrans</span> <span class="o">&lt;</span><span class="mi">535</span> <span class="n">px</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;IMGLOGO&#39;</span><span class="p">,</span> <span class="s1">&#39;images/logo.png&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">image</span> <span class="n">logo</span>
</pre></div>
</div>
</section>
<section id="b-pour-les-titres-slogans-et-lexique">
<h4>1.1.1.b Pour les titres, slogans et lexique<a class="headerlink" href="#b-pour-les-titres-slogans-et-lexique" title="Lien permanent vers cette rubrique"></a></h4>
<p>Pour le lexique :</p>
<ul class="simple">
<li><p>true = lexique par défaut</p></li>
<li><p>false = lexique à modifier /include/lexique_no.php</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">define</span><span class="p">(</span><span class="s1">&#39;NOMSITE&#39;</span><span class="p">,</span> <span class="s1">&#39;Domoticz&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">nom</span> <span class="n">principal</span> <span class="n">du</span> <span class="n">site</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;NOMSLOGAN&#39;</span><span class="p">,</span> <span class="n">xxxxxxxxxxx</span><span class="p">);</span><span class="o">//</span><span class="n">nom</span> <span class="n">secondaire</span> <span class="n">ou</span> <span class="n">slogan</span>
<span class="o">//</span> <span class="n">affichage</span> <span class="n">lexique</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;LEXIQUE&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="intervalles-de-maj">
<h3>1.1.2 intervalles de maj<a class="headerlink" href="#intervalles-de-maj" title="Lien permanent vers cette rubrique"></a></h3>
<p>L’intervalle de mise à jour pour les services (poubelles, anniversaires,…) et les dispositifs, il peut être changé:
- il est de ½ heure (1800000 milli secondes) pour les variables (services)
- il est se 3Os pour les dispositifs avec un minimum de 5 secondes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">interval</span> <span class="n">de</span> <span class="n">maj</span> <span class="n">des</span> <span class="n">fonctions</span> <span class="n">JS</span> <span class="n">maj_services</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">maj_devices</span><span class="p">()</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TEMPSMAJSERVICES&#39;</span><span class="p">,</span> <span class="mi">1800000</span><span class="p">);</span><span class="o">//</span><span class="n">interval</span> <span class="n">maj</span> <span class="n">services</span> <span class="n">en</span> <span class="n">milli</span> <span class="n">secondes</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TEMPSMAJSERVICESAL&#39;</span><span class="p">,</span> <span class="mi">180000</span><span class="p">);</span><span class="o">//</span><span class="n">interval</span> <span class="n">maj</span> <span class="n">services</span> <span class="n">ALARME</span> <span class="n">ABSENCE</span><span class="p">(</span><span class="n">si</span> <span class="n">installée</span><span class="p">)</span> <span class="n">en</span> <span class="n">milli</span> <span class="n">secondes</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TEMPO_DEVICES&#39;</span><span class="p">,</span> <span class="mi">180000</span><span class="p">);</span><span class="o">//</span> <span class="n">en</span> <span class="n">milli</span> <span class="n">secondes</span><span class="p">,</span> <span class="n">rafraichissement</span> <span class="n">programmé</span><span class="p">(</span><span class="n">dispositifs</span> <span class="n">non</span> <span class="n">prioritaires</span><span class="p">)</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TEMPO_DEVICES_D&#39;</span><span class="p">,</span> <span class="mi">30000</span><span class="p">);</span><span class="o">//</span> <span class="n">en</span> <span class="n">milli</span> <span class="n">secondes</span> <span class="p">(</span><span class="o">&gt;=</span><span class="mi">5</span><span class="n">s</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">30</span><span class="n">s</span><span class="p">)</span> <span class="n">maj</span> <span class="n">déclenchée</span> <span class="n">par</span> <span class="n">Dz</span> <span class="n">ou</span> <span class="n">Ha</span> <span class="n">voir</span> <span class="n">doc</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Si define(“SSE”, true) = TEMP REEL :  :red:”TEMPO_DEVICES_DZ est annulé”.</p>
<p>un serveur SSE doit etre installé ainsi qu’un script(léger)  dans DZ ou(et) HA</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>TEMPO_DEVICES</em> pour tous les dispositifs</p>
<p><em>TEMPO_DEVICES_D ou serveur SSE*</em> pour les dispositifs qui doivent afficher leurs données en temps réel (voir le § suivant)</p>
</div>
</section>
<section id="maj-en-temps-reel">
<h3>1.1.3 maj en temps réel<a class="headerlink" href="#maj-en-temps-reel" title="Lien permanent vers cette rubrique"></a></h3>
<p>2 solutions :</p>
<ul class="simple">
<li><p>semi temps réel , monitor interroge une variable mis à jour par Dz ou Ha lors d’un changement de valeur d’un dispositif; si la variable est à 1 monitor fait une mise à jour avec l’API des dispositifs et remet à 0 la variable.C’est la solution historique de monitor mais la solution SSE-php, incluse dans monitor est à privilégier.cette solution sera obsolète dans les prochaines versions</p></li>
<li><p>temps réel, en recevant de Domoticz ou Home Assistant, par un message depuis un SSE(Server-sent Events) , les données du dispositifs qui ont changées de valeur</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>TEMPO_DEVICES_D</strong> : avec la valeur dans config.php, rafraichissement des dispositifs toutes les 30 secondes pouvant être ramenée à 5 secondes ( si par exemple un PIR, un contact de porte,  qui sont déclarés prioritaires dans DZ passent à ON)</p>
<ul class="simple">
<li><p>Avantage : simplicité de mise en oeuvre , création d’une variable dans DZ ou HA et ajout d’une (ou plusieurs) ligne(s)  de script (DzVent ou yaml).</p></li>
<li><dl class="simple">
<dt>Inconvénients<span class="classifier">Retard dans la mise à jour de 5 secondes minimum , si 2 écrans (2 navigateurs sont connectés) la mise à jour est effective sur un seul des écrans ; le second écran sera mis à jour lors de la mise à jour cyclique.</span></dt><dd><p>avec les groupes, les scènes ou automatisations ce retard du rafraichissement peut être désagréable.</p>
</dd>
</dl>
</li>
</ul>
<p><a class="reference internal" href="../_images/image126.webp"><img alt="image126" src="../_images/image126.webp" style="width: 604px;" /></a></p>
<p><strong>Seveur SSE</strong> pour l’installation d’un serveur node.js voir ce § :ref:”21.12 Serveur SSE Node JS”</p>
<ul class="simple">
<li><p>Avantages : Vrai temps réel, économise de la bande passante; un serveur SSE PHP est déjà installé dans monitor , la création d’un script pour envoyer les données depuis DZ ou HA est simple;</p></li>
<li><p>Inconvénients : Installation d’un serveur JS pour la version SSE NodeJS ;</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>En https,pour des connexions distantes, il suffit de demander des certificats Let’encrypt; le serveur SSE-PHP installé dans monitor n’a pas besoin de certificat contrairement à un serveur SSE Node.JS</p>
</div>
</div>
<section id="solution-semi-temps-reel">
<h4>1.1.3.1 Solution semi temps réel<a class="headerlink" href="#solution-semi-temps-reel" title="Lien permanent vers cette rubrique"></a></h4>
<p><span class="red">Cette solution est obsolète et sera supprimée dans les futures version</span>.</p>
<p>La fonction JS :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?php
if (MQTT==false) echo &#39;
tempo_devices=&#39;.TEMPO_DEVICES_D.&#39;;
var idsp=1;if (tempo_devices&gt;30000)  tempo_devices=30000;
var_sp(idsp);
function var_sp(idsp){
  $.getJSON( &quot;ajax.php?app=data_var&amp;variable=29&quot;, function(data) {
  //console.log(data.var_dz);
  if (data.var_dz==&quot;1&quot;){maj_variable(29,&quot;variable_sp&quot;,0,2);maj_devices(plan);maj_services(0);}
      if (data.message!=&quot;0&quot;){maj_variable(&quot;msg&quot;,data.message,0,0);maj_services(0);  }
 });
setTimeout(var_sp, tempo_devices, idsp);
}&#39;;?&gt;
</pre></div>
</div>
<p>La fonction PHP qui récupère la valeur de la variable Domoticz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// valeur d&#39;une variable
function val_variable($variable){
$result=array();
$L=URLDOMOTIC.&quot;json.htm?type=command&amp;param=getuservariable&amp;idx=&quot;.$variable;
$json_string = file_get_curl($L);
$result = json_decode($json_string, true);
$lect_var = $result[&#39;result&#39;][0];
$value = $lect_var[&#39;Value&#39;];
return       $value;
}
</pre></div>
</div>
<p>pour Home Assistant l” API monitor peut être  utilisée.</p>
</section>
<section id="solution-temps-reel-sse">
<h4>1.1.3.2 Solution temps réel SSE<a class="headerlink" href="#solution-temps-reel-sse" title="Lien permanent vers cette rubrique"></a></h4>
<p>Le serveur SSE-NodeJS voir § <a class="reference internal" href="mon_installation.html#serveur-sse-node-js"><span class="std std-ref">21.12 Serveur SSE Node JS</span></a></p>
<p>Le serveur SSE-PHP voir ce § <a class="reference internal" href="divers.html#serveur-sse-installe-dans-monitor"><span class="std std-ref">18.10 Serveur SSE installé dans Monitor</span></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>cette solution évite pour l’accès distant la demande d’un certificat pour https</p>
</div>
<p>Pour SSE-node, l’IP, le port, sont à déclarer dans /admin/config.php.</p>
<p>Pour SSE-php , indiquer le rafraichissement en secondes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE&#39;</span><span class="p">,</span> <span class="n">false</span><span class="p">);</span><span class="o">//</span>  <span class="n">node</span> <span class="n">ou</span> <span class="n">php</span> <span class="n">si</span> <span class="n">serveur</span> <span class="n">SSE</span> <span class="n">utilisé</span> <span class="n">par</span> <span class="n">monitor</span>
<span class="o">//</span><span class="n">pour</span> <span class="n">SSE</span> <span class="n">php</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_SLEEP&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span><span class="o">//</span><span class="n">raffraichissement</span> <span class="n">en</span> <span class="n">secondes</span>
<span class="o">//</span> <span class="n">pour</span> <span class="n">SSE</span> <span class="n">node</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_USER&#39;</span><span class="p">,</span> <span class="s2">&quot;michel&quot;</span><span class="p">);</span><span class="o">//</span><span class="n">user</span> <span class="n">et</span> <span class="n">mot</span> <span class="n">passe</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_PASS&#39;</span><span class="p">,</span> <span class="s2">&quot;&lt;mot passe&gt;&quot;</span><span class="p">);</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;socket.&lt;DOMAINE&gt;.ovh&#39;</span><span class="p">);</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_IP&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.1.26&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">adresse</span> <span class="n">IP</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SSE_PORT&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span><span class="o">//</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Port mqtt: 3000</p>
</div>
<p>les scripts JS dans footer.php:</p>
<p>voir ce paragraphe concernant le serveur <a class="reference internal" href="divers.html#serveur-sse-installe-dans-monitor"><span class="std std-ref">18.10 Serveur SSE installé dans Monitor</span></a></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="p">(</span><span class="n">SSE</span><span class="o">==</span><span class="s1">&#39;php&#39;</span><span class="p">)</span> <span class="p">{</span><span class="n">echo</span> <span class="s2">&quot;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
   <span class="n">window</span><span class="o">.</span><span class="n">onload</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">établir</span> <span class="n">un</span> <span class="n">flux</span> <span class="n">et</span> <span class="n">enregistrer</span> <span class="n">les</span> <span class="n">réponses</span> <span class="n">sur</span> <span class="n">la</span> <span class="n">console</span>
<span class="n">var</span> <span class="n">source</span> <span class="o">=</span> <span class="n">new</span> <span class="n">EventSource</span><span class="p">(</span><span class="s1">&#39;include/serveur_sse.php&#39;</span><span class="p">);</span>
<span class="n">source</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="p">;</span>
<span class="n">donnees</span><span class="o">=</span><span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span><span class="n">var</span> <span class="n">id_x</span><span class="o">=</span><span class="n">donnees</span><span class="o">.</span><span class="n">id</span><span class="p">;</span><span class="n">var</span> <span class="n">state</span><span class="o">=</span><span class="n">donnees</span><span class="o">.</span><span class="n">state</span><span class="p">;</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">id_x</span><span class="p">,</span><span class="n">state</span><span class="p">);</span>
<span class="n">maj_mqtt</span><span class="p">(</span><span class="n">id_x</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">},</span> <span class="n">false</span><span class="p">);</span>
<span class="n">source</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">innerText</span><span class="o">=</span><span class="s1">&#39;connecté&#39;</span><span class="p">;</span>
<span class="p">},</span> <span class="n">false</span><span class="p">);</span>
<span class="n">source</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">readyState</span> <span class="o">==</span> <span class="n">EventSource</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">)</span> <span class="p">{</span>
<span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">innerText</span><span class="o">=</span><span class="s1">&#39;connexion fermée&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">},</span> <span class="n">false</span><span class="p">);</span>
<span class="p">};</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span><span class="s2">&quot;;}?&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition-client-sse-nodejs admonition">
<p class="admonition-title"><strong>Client SSE NodeJS:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">SSE</span><span class="o">==</span><span class="s1">&#39;node&#39;</span><span class="p">)</span> <span class="p">{</span><span class="n">echo</span> <span class="s2">&quot;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
<span class="n">const</span> <span class="n">eventSource</span> <span class="o">=</span> <span class="n">new</span> <span class="n">EventSource</span><span class="p">(</span><span class="s1">&#39;http://&quot;.SSE_IP.&quot;:&quot;.SSE_PORT.&quot;/events&#39;</span><span class="p">);</span>
<span class="n">eventSource</span><span class="o">.</span><span class="n">onopen</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">innerText</span><span class="o">=</span><span class="s1">&#39;connecté&#39;</span><span class="p">;};</span>
<span class="n">eventSource</span><span class="o">.</span><span class="n">onmessage</span> <span class="o">=</span> <span class="n">function</span> <span class="p">(</span><span class="n">currentEvent</span><span class="p">)</span> <span class="p">{</span>
<span class="n">const</span> <span class="n">listElement</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>
<span class="n">const</span> <span class="n">newElement</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">);</span>
<span class="n">const</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">currentEvent</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
  <span class="n">newElement</span><span class="o">.</span><span class="n">innerText</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">;</span>

<span class="n">listElement</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">newElement</span><span class="p">);</span>
<span class="p">};</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span><span class="s2">&quot;;}</span>
</pre></div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">maj_mqtt</span><span class="p">(</span><span class="n">id_x</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">){</span>
<span class="n">switch</span> <span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">case</span> <span class="mi">0</span><span class="p">:</span>
<span class="k">for</span> <span class="p">(</span><span class="n">attribute</span> <span class="ow">in</span> <span class="n">maj_dev</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">maj_dev</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span><span class="o">==</span><span class="n">id_x</span><span class="p">)</span> <span class="n">var</span> <span class="n">id_m</span><span class="o">=</span><span class="n">attribute</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">var</span> <span class="n">command</span><span class="o">=</span><span class="n">state</span><span class="p">;</span>
<span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">Data</span><span class="o">=</span><span class="n">command</span><span class="p">;</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="n">var</span> <span class="n">sid1</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">ID1</span><span class="p">;;</span>
<span class="n">var</span> <span class="n">sid2</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">ID2</span><span class="p">;</span>
<span class="n">var</span> <span class="n">scoul_on</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">coul_ON</span><span class="p">;</span>
<span class="n">var</span> <span class="n">scoul_off</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">coul_OFF</span><span class="p">;</span>
<span class="n">var</span> <span class="n">c_l_on</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">coullamp_ON</span>
<span class="n">var</span> <span class="n">c_l_off</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">coullamp_OFF</span>
<span class="n">var</span> <span class="n">scoul</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="n">var</span> <span class="n">scoull</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">==</span><span class="s2">&quot;On&quot;</span> <span class="o">||</span> <span class="n">command</span><span class="o">==</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>  <span class="p">{</span><span class="n">scoul</span><span class="o">=</span><span class="n">scoul_on</span><span class="p">;</span><span class="n">scoull</span><span class="o">=</span><span class="n">c_l_on</span><span class="p">;}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Set Level&quot;</span><span class="p">)</span>  <span class="p">{</span><span class="n">scoull</span><span class="o">=</span><span class="n">scoull</span><span class="o">=</span><span class="n">c_l_on</span><span class="p">;}</span>
<span class="k">else</span> <span class="k">if</span>  <span class="p">(</span><span class="n">command</span><span class="o">==</span><span class="s2">&quot;Off&quot;</span>  <span class="o">||</span> <span class="n">command</span><span class="o">==</span><span class="s2">&quot;off&quot;</span> <span class="p">)</span> <span class="p">{</span><span class="n">scoul</span><span class="o">=</span><span class="n">scoul_off</span><span class="p">;</span><span class="n">scoull</span><span class="o">=</span><span class="n">c_l_off</span><span class="p">;}</span>
<span class="k">else</span> <span class="k">return</span><span class="p">;</span>
<span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="n">sid1</span><span class="p">)</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">scoul</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sid2</span><span class="p">)</span> <span class="p">{</span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="n">sid2</span><span class="p">)</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">scoul</span><span class="p">;}</span>
<span class="n">var</span> <span class="n">c_lamp</span><span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="n">id_m</span><span class="p">]</span><span class="o">.</span><span class="n">class_lamp</span>      <span class="p">;</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;c_lamp=&quot;</span><span class="o">+</span><span class="n">c_lamp</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Set Level&quot;</span><span class="p">)</span> <span class="p">{</span><span class="n">var</span> <span class="n">h</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="n">sid1</span><span class="p">)</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">);</span>
     <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="n">sid1</span><span class="p">)</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="n">parseInt</span><span class="p">((</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)));</span>
     <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;h=&quot;</span><span class="o">+</span><span class="n">h</span><span class="o">+</span><span class="n">parseInt</span><span class="p">((</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)));}</span>
<span class="k">break</span><span class="p">;</span>
<span class="n">case</span> <span class="mi">1</span><span class="p">:</span><span class="n">scoull</span><span class="o">=</span><span class="n">state</span><span class="p">;</span><span class="n">c_lamp</span><span class="o">=</span><span class="n">id_x</span><span class="p">;</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;c_lamp=&quot;</span><span class="o">+</span><span class="n">c_lamp</span><span class="p">);</span>
<span class="k">break</span><span class="p">;</span>
<span class="n">default</span><span class="p">:</span>
<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">c_lamp</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">scoull</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">var</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementsByClassName</span><span class="p">(</span><span class="n">c_lamp</span><span class="p">);</span>
     <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elements</span><span class="o">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">var</span> <span class="n">element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
 <span class="n">element</span><span class="o">.</span><span class="n">style</span><span class="o">=</span><span class="n">scoull</span><span class="p">;}</span>
     <span class="p">}</span>
<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>explications</strong>:</p>
<p>2 parties dans ce script, la 1ère partie concerne la réception des évènements avec SSE (php ou node.js), la 2eme partie, la mise à jour des dispositifs</p>
<p><a class="reference internal" href="../_images/image906.webp"><img alt="image906" src="../_images/image906.webp" style="width: 700px;" /></a></p>
</section>
</section>
<section id="autres-donnees">
<h3>1.1.4 Autres données<a class="headerlink" href="#autres-donnees" title="Lien permanent vers cette rubrique"></a></h3>
<p>Choisir Idx de Domoticz ou idm de monitor ?</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour une première installation avec Domoticz, choisir idx ; pour une réinstallation de Domoticz, il sera alors préférable de choisir idm pour éviter de renommer tous les dispositifs dans les images svg</p>
<p>Pour une installation avec HA , idm , il n’existe pas d” Idx, choisir idm et laisser vide “NUMPLAN”.</p>
</div>
<p><em>La création d’un plan qui regroupe les dispositifs sur Domoticz est nécessaire : noter le N° du plan (NUMPLAN)</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// choix ID pour l&#39;affichage des infos des dispositifs
// idx : idx de Domoticz    (dans ce cas ,
//     en cas de problème il faudra renommer tous les dispositifs
//     dans monitor au lieu de la DB)
define(&#39;CHOIXID&#39;,&#39;idm&#39;);// DZ:idm ou idx ; HA : idm uniquement
define(&#39;NUMPLAN&#39;,&#39;2&#39;);//DZ uniquement: n° du plan regroupant tous les capteurs
</pre></div>
</div>
<p>Paramètres de la base de données :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">parametres</span> <span class="n">serveur</span> <span class="n">DBMaria</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;SERVEUR&#39;</span><span class="p">,</span><span class="s1">&#39;localhost&#39;</span><span class="p">);</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;MOTDEPASSE&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;MOT PASSE&gt;&#39;</span><span class="p">);</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;UTILISATEUR&#39;</span><span class="p">,</span><span class="s1">&#39;michel&#39;</span><span class="p">);</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;DBASE&#39;</span><span class="p">,</span><span class="s1">&#39;monitor&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Paramètres pour Domoticz ou HA :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">seveurs</span> <span class="n">domotiques</span> <span class="n">Domoticz</span> <span class="n">ou</span> <span class="n">HA</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;IPDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.1.76&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">ip</span>
<span class="o">//</span><span class="n">pour</span> <span class="n">ssh2</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;USERDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;michel&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">user</span> <span class="n">du</span> <span class="n">serveur</span><span class="p">,</span><span class="n">répertoire</span> <span class="p">:</span><span class="n">home</span><span class="o">/</span><span class="n">user</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;PWDDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">mot</span> <span class="n">passe</span> <span class="n">serveur</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;URLDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;http://192.168.1.76:8086/&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">url</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;DOMDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;https://*************&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">domaine</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TOKENDOMOTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">TOKEN</span> <span class="n">ou</span> <span class="n">BEARER</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;IPDOMOTIC1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">ip</span> <span class="mi">2</span><span class="n">emme</span> <span class="n">serveur</span> <span class="n">Domotique</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;USERDOMOTIC1&#39;</span><span class="p">,</span> <span class="s1">&#39;michel&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">user</span> <span class="n">du</span> <span class="n">serveur</span><span class="p">,</span><span class="n">répertoire</span> <span class="p">:</span><span class="n">home</span><span class="o">/</span><span class="n">user</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;PWDDOMOTIC1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">mot</span> <span class="n">passe</span> <span class="n">serveur</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;URLDOMOTIC1&#39;</span><span class="p">,</span> <span class="s1">&#39;http://192.168.1.5:8123/&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">url</span> <span class="n">ex</span><span class="p">:</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.5</span><span class="p">:</span><span class="mi">8123</span><span class="o">/</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;DOMDOMOTIC1&#39;</span><span class="p">,</span> <span class="s1">&#39;https://***********&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">domaine</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;TOKEN_DOMOTIC1&#39;</span><span class="p">,</span><span class="s2">&quot;eyJhb*****************************************************************2k&quot;</span><span class="p">);</span>
<span class="o">//*************************</span><span class="n">modules</span> <span class="n">complémentaires</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;VARTAB&#39;</span><span class="p">,</span> <span class="n">URLDOMOTIC</span><span class="o">.</span><span class="s1">&#39;modules_lua/string_tableaux.lua&#39;</span><span class="p">);</span><span class="o">//</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;BASE64&#39;</span><span class="p">,</span> <span class="s1">&#39;admin/connect.py&#39;</span><span class="p">);</span><span class="o">//</span><span class="n">login</span> <span class="n">et</span> <span class="n">password</span> <span class="n">en</span> <span class="n">Base64</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;CONF_MODECT&#39;</span><span class="p">,</span> <span class="s1">&#39;admin/string_modect.json&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>les variables ci-dessus , VARTAB, BASE64, CONF_MODECT ne sont à déclarer ici que si elles sont utilisées dans un fichier</p>
</div>
<p>Le programme démarre avec 3 pages :</p>
<ul class="simple">
<li><p>Accueil</p></li>
<li><p>Plan intérieur</p></li>
<li><p>Page d’administration, pour afficher cette page, le mot de passe est obligatoire : par défaut <span class="red">« admin »</span>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>pour afficher d’autres pages existantes dans le programme, modifier la configuration.</em></p>
<ul class="simple">
<li><p>à partir de la page administration</p></li>
<li><p>avec un éditeur (le fichier à modifier: :green:”admin/config.php”</p></li>
</ul>
</div>
<p>Les autres pages concernent l’alarme, un mur de caméras, …</p>
</section>
</section>
<section id="les-fichiers-php-les-styles-le-javascript">
<h2>1.2     - Les fichiers PHP, les styles, le javascript<a class="headerlink" href="#les-fichiers-php-les-styles-le-javascript" title="Lien permanent vers cette rubrique"></a></h2>
<section id="a-la-racine-du-site">
<h3>1.2.1 - à la racine du site :<a class="headerlink" href="#a-la-racine-du-site" title="Lien permanent vers cette rubrique"></a></h3>
<blockquote>
<div><p>voir ce paragraphe : <a class="reference internal" href="bien_debuter.html#le-serveur-http-de-nginx"><span class="std std-ref">0.4 Le serveur http de NGINX</span></a></p>
</div></blockquote>
<p><strong>Complément d’informations concernant « fonctions.php »:</strong></p>
<p>voir le fichier à jour sur Github : <a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/fonctions.php">https://raw.githubusercontent.com/mgrafr/monitor/main/fonctions.php</a></p>
<p>Principales fonctions contenues dans ce fichier :</p>
<div class="admonition-function-file-http-curl admonition">
<p class="admonition-title"><strong>function file_http_curl</strong></p>
<p><a class="reference internal" href="../_images/image134.webp"><img alt="image134" src="../_images/image134.webp" style="width: 544px;" /></a></p>
</div>
<section id="status-variables-devices-zone-et-device-plan">
<h4>1.2.1.1 status_variables , devices_zone et device_plan<a class="headerlink" href="#status-variables-devices-zone-et-device-plan" title="Lien permanent vers cette rubrique"></a></h4>
<div class="admonition-function-status-variables admonition">
<p class="admonition-title"><strong>function status_variables</strong></p>
<p>Pour récupérer les valeurs des variables de Domoticz et HA</p>
<p><a class="reference internal" href="../_images/image1181.webp"><img alt="image1181" src="../_images/image1181.webp" style="width: 650px;" /></a></p>
<p><a class="reference internal" href="../_images/image135.webp"><img alt="image135" src="../_images/image135.webp" style="width: 605px;" /></a></p>
<p><a class="reference internal" href="../_images/image136.webp"><img alt="image136" src="../_images/image136.webp" style="width: 635px;" /></a></p>
</div>
<div class="admonition-fonctions-maj-variable-et-sql-variable admonition">
<p class="admonition-title"><strong>fonctions maj_variable et sql_variable</strong></p>
<p><a class="reference internal" href="../_images/image138.webp"><img alt="image138" src="../_images/image138.webp" style="width: 650px;" /></a></p>
<p><a class="reference internal" href="../_images/image1184.webp"><img alt="image1184" src="../_images/image1184.webp" style="width: 700px;" /></a></p>
</div>
<div class="admonition-function-devices-zone admonition">
<p class="admonition-title"><strong>function devices_zone</strong></p>
<p>API HA pour récupérer les valeurs des dispositifs</p>
<p><a class="reference internal" href="../_images/image137.webp"><img alt="image137" src="../_images/image137.webp" style="width: 650px;" /></a></p>
</div>
<div class="admonition-function-devices-plan-et-function-sql-plan admonition">
<p class="admonition-title"><strong>function devices_plan et function sql_plan()</strong></p>
<p>API Domoticz pour les devices : les dispositifs doivent être placés dans un plan; celui-ci peut se résumer à un rectangle ou un carré</p>
<p><a class="reference internal" href="../_images/image1414.webp"><img alt="image1414" src="../_images/image1414.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image139.webp"><img alt="image139" src="../_images/image139.webp" style="width: 605px;" /></a></p>
<p><a class="reference internal" href="../_images/image1413.webp"><img alt="image1413" src="../_images/image1413.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image1328.webp"><img alt="image1328" src="../_images/image1328.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image140.webp"><img alt="image140" src="../_images/image140.webp" style="width: 650px;" /></a></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>plan Domoticz</strong></p>
<p>Le mode plan consiste à définir des salles et y placer différents périphériques; l’avantage de ce mode c’est que l’api peut envoyer des données concernant tous les dispositifs dun plan.</p>
<p>Plusieurs plans peuvent être crées mais l’un d’eux doit regrouper tous les dispositifs utilisés par monitor.</p>
<p><a class="reference internal" href="../_images/image943.webp"><img alt="image943" src="../_images/image943.webp" style="width: 600px;" /></a></p>
</div>
<p><strong>Maj de la date</strong></p>
<p>si la tablette reste allumée en permanence,la date ne sera pas mise à jour en absence de rafraichissement</p>
<p>On crée un maj_date=0 avec lequel la maj sera forcée (voir la fonction maj_devices(plan) dans footer.php)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$data[0] = [&#39;jour&#39; =&gt; date(&#39;d&#39;),
            &#39;maj_date&#39; =&gt; &#39;0&#39;];
</pre></div>
</div>
<p><strong>Maj état des piles des dispositifs</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$abat=&quot;0&quot;;
if ($al_bat==0) $abat=&quot;batterie_forte&quot;;
if ($al_bat==1) $abat=&quot;batterie_moyenne&quot;;
if ($al_bat==2) $abat=&quot;batterie_faible&quot;;
$val_albat=val_variable(PILES[0]);
if ($abat != $val_albat) maj_variable(PILES[0],PILES[1],$abat,2);
</pre></div>
</div>
</div>
</section>
</section>
<section id="les-styles-css">
<h3>1.2.2 les styles css<a class="headerlink" href="#les-styles-css" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image141.webp"><img alt="image141" src="../_images/image141.webp" style="width: 205px;" /></a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/css/mes_css.css">https://raw.githubusercontent.com/mgrafr/monitor/main/css/mes_css.css</a>
<a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/css/jquery-ui.css">https://raw.githubusercontent.com/mgrafr/monitor/main/css/jquery-ui.css</a></p>
<p>Fichier mes_css.css , extrait :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span><span class="n">interieur</span><span class="o">*/</span>
<span class="c1">#linky{position: relative;top: -250px;left: 600px;width: 60px;}</span>
<span class="c1">#th_ext_cuis{position: relative;top: -747px; left: 170px; width: 50px;}</span>
<span class="c1">#temp_ext_cuisine{font-size: 8px; color: black;}</span>
<span class="c1">#voltage{position: absolute;top: -30px;right: -20px;width: 200px;}</span>
<span class="o">.</span><span class="n">meteo_concept_am</span>  <span class="p">{</span><span class="n">display</span><span class="p">:</span> <span class="n">inline</span><span class="p">;</span><span class="n">width</span><span class="p">:</span> <span class="mi">150</span><span class="n">px</span><span class="p">;</span><span class="n">margin</span><span class="o">-</span><span class="n">left</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="n">px</span><span class="p">;}</span>
<span class="c1">#meteo_concept_am{position: relative;top: 20px;margin-left: -20px;}</span>
<span class="c1">#meteo_concept{position: relative;top: 10px;}</span>
<span class="o">.</span><span class="n">image_met</span><span class="p">{</span><span class="n">width</span><span class="p">:</span><span class="mi">80</span><span class="n">px</span><span class="p">;</span><span class="n">margin</span><span class="o">-</span><span class="n">left</span><span class="p">:</span> <span class="o">-</span><span class="mi">15</span><span class="n">px</span><span class="p">;}</span>
<span class="o">.</span><span class="n">icone_vent</span><span class="p">{</span><span class="n">width</span><span class="p">:</span> <span class="mi">40</span><span class="n">px</span><span class="p">;</span><span class="n">margin</span><span class="o">-</span><span class="n">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span><span class="n">margin</span><span class="o">-</span><span class="n">top</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="n">px</span><span class="p">;}</span>
<span class="o">.</span><span class="n">vvent</span><span class="p">{</span><span class="n">font</span><span class="o">-</span><span class="n">family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">;</span><span class="n">font</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">15</span><span class="n">px</span><span class="p">;</span><span class="n">margin</span><span class="o">-</span><span class="n">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">/*</span> <span class="n">MediaQueries</span>
<span class="o">/*</span> <span class="n">Large</span> <span class="n">devices</span> <span class="p">(</span><span class="n">Large</span> <span class="n">desktops</span> <span class="mi">768</span><span class="n">px</span> <span class="ow">and</span> <span class="n">up</span><span class="p">)</span> <span class="o">*/</span>
<span class="nd">@media</span> <span class="p">(</span><span class="nb">min</span><span class="o">-</span><span class="n">width</span><span class="p">:</span><span class="mi">768</span><span class="n">px</span><span class="p">)</span> <span class="p">{</span><span class="n">img</span><span class="c1">#cam1,img#cam2,img#cam3,img#cam4,img#cam5,img#cam6,img#cam7,img#cam8,img#cam9{width: 450px;}</span>
        <span class="o">.</span><span class="n">modal</span><span class="o">-</span><span class="n">lg</span> <span class="p">{</span><span class="n">width</span><span class="p">:</span> <span class="mi">740</span><span class="n">px</span><span class="p">;}</span><span class="o">.</span><span class="n">cam</span> <span class="p">{</span><span class="n">margin</span><span class="o">-</span><span class="n">left</span><span class="p">:</span> <span class="mi">100</span><span class="n">px</span><span class="p">;}</span><span class="o">.</span><span class="n">fond_date</span> <span class="p">{</span><span class="n">right</span><span class="p">:</span> <span class="o">-</span><span class="mi">270</span><span class="n">px</span><span class="p">;}</span><span class="n">body</span> <span class="p">{</span><span class="nb">max</span><span class="o">-</span><span class="n">width</span><span class="p">:</span> <span class="mi">768</span><span class="n">px</span><span class="p">;</span><span class="n">margin</span><span class="p">:</span> <span class="mi">0</span> <span class="n">auto</span><span class="p">;</span><span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span> <span class="c1">#79afbf;}</span>
 <span class="o">.</span><span class="n">menu</span><span class="o">-</span><span class="n">link</span> <span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="mi">50</span><span class="o">%</span><span class="p">;</span><span class="n">top</span><span class="p">:</span> <span class="mi">50</span><span class="n">px</span><span class="p">;}</span><span class="c1">#bar_pression{top: -750px;left: 450px;}.txt_ext{left:100px;}.modal {left: -100px;}</span>
        <span class="o">.</span><span class="n">modal_param</span> <span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="mi">200</span><span class="n">px</span><span class="p">;</span>   <span class="p">}</span><span class="o">.</span><span class="n">modal</span><span class="o">-</span><span class="n">dialog</span> <span class="p">{</span><span class="n">width</span><span class="p">:</span><span class="mi">740</span><span class="n">px</span><span class="p">;}</span> <span class="p">}</span>
</pre></div>
</div>
<section id="styles-css-communs-a-toutes-les-pages">
<h4>1.2.2.1 styles CSS communs à toutes les pages<a class="headerlink" href="#styles-css-communs-a-toutes-les-pages" title="Lien permanent vers cette rubrique"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#interieur, #exterieur, #meteo, #alarmes,#commandes,#murcam ,#murinter,#app_diverses,#graphiques,#admin, #zigbee, #zwave, #dvr, #nagios,#spa,#recettes{</span>
  <span class="n">width</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span><span class="p">;</span><span class="n">height</span><span class="p">:</span> <span class="mi">1120</span><span class="n">px</span><span class="p">;</span><span class="n">padding</span><span class="p">:</span> <span class="mi">80</span><span class="n">px</span> <span class="mi">0</span><span class="p">;</span><span class="nb">min</span><span class="o">-</span><span class="n">height</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span><span class="p">;</span><span class="n">position</span><span class="p">:</span> <span class="n">relative</span><span class="p">;</span><span class="n">color</span><span class="p">:</span> <span class="c1">#000;top: 350px;z-index:-20;overflow: auto;}</span>
<span class="c1">#interieur, #exterieur,#alarmes,#commandes,#murcam ,#murinter,#app_diverses,#admin, #zigbee, #zwave, #dvr, #nagios,#spa,#recettes{</span>
  <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span> <span class="n">aquamarine</span><span class="p">;}</span>
</pre></div>
</div>
</section>
</section>
<section id="le-javascript">
<h3>1.2.3 – Le javascript<a class="headerlink" href="#le-javascript" title="Lien permanent vers cette rubrique"></a></h3>
<blockquote>
<div><p>1.2.3 a - Les fichiers footer.php , voir ce script <a class="reference internal" href="#les-scripts-javascript"><span class="std std-ref">1.3.5 les scripts JavaScript</span></a></p>
<p>1.2.3 b - le fichier mes_js.js : scripts principaux ,</p>
<p>fichier complet : <a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/js/mes_js.js">https://raw.githubusercontent.com/mgrafr/monitor/main/js/mes_js.js</a></p>
</div></blockquote>
<div class="admonition-virtual-keypad admonition">
<p class="admonition-title"><strong>virtual keypad</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> /*Minimal Virtual Keypad
 $(document).ready(function () {
const input_value = $(&quot;#password&quot;);
var pwd,nameid;
//disable input from typing
$(&quot;#password&quot;).keypress(function () {
 return false;
});
.......
</pre></div>
</div>
</div>
<div class="admonition-fenetre-modale-modallink admonition">
<p class="admonition-title"><strong>fenêtre modale modallink</strong></p>
<p><a class="reference internal" href="../_images/image145.webp"><img alt="image145" src="../_images/image145.webp" style="width: 479px;" /></a></p>
</div>
</section>
</section>
<section id="les-fichiers-principaux-dans-include">
<h2>1.3 Les fichiers principaux dans /include<a class="headerlink" href="#les-fichiers-principaux-dans-include" title="Lien permanent vers cette rubrique"></a></h2>
<section id="entete-html-php">
<h3>1.3.1 entete_html.php<a class="headerlink" href="#entete-html-php" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/include/entete_html.php">https://raw.githubusercontent.com/mgrafr/monitor/main/include/entete_html.php</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
     &lt;head&gt;
             &lt;meta charset=&quot;utf-8&quot;&gt;
             &lt;title&gt;monitor-domoticz | by michel Gravier&lt;/title&gt;
             &lt;meta name=&quot;description&quot; content=&quot;Domotique&quot;&gt;
             &lt;!-- Mobile Meta --&gt;
             &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
             &lt;!-- Favicon  racine du site --&gt;
             &lt;link rel=&quot;shortcut icon&quot; href=&quot;&lt;?php if (substr($_SERVER[&#39;HTTP_HOST&#39;], 0, 7)==&quot;192.168&quot;) echo &#39;/monitor&#39;.FAVICON;else echo FAVICON; ?&gt;&quot;&gt;
             &lt;!-- mes css  dossier css --&gt;
             &lt;link href=&quot;bootstrap/css/bootstrap.css?2&quot; rel=&quot;stylesheet&quot;&gt;
             &lt;link href=&quot;bootstrap/bootstrap-switch-button.css&quot; rel=&quot;stylesheet&quot;&gt;
             &lt;link href=&quot;css/mes_css.css?8&quot; rel=&quot;stylesheet&quot;&gt;

             &lt;!-- icones  racine du site --&gt;
             &lt;link rel=&quot;apple-touch-icon&quot; href=&quot;iphone-icon.png&quot;/&gt;
             &lt;link rel=&quot;icon&quot; sizes=&quot;196x196&quot; href=&quot;logo_t.png&quot;&gt;
             &lt;link rel=&quot;icon&quot; sizes=&quot;192x192&quot; href=&quot;logo192.png&quot;&gt;
     &lt;/head&gt;
&lt;?php
</pre></div>
</div>
<p><em>Le HTML du navigateur</em> :</p>
<p><a class="reference internal" href="../_images/image147.webp"><img alt="image147" src="../_images/image147.webp" style="width: 540px;" /></a></p>
</section>
<section id="test-de-la-base-de-donnees-test-db-php">
<h3>1.3.2 Test de la base de données, test_db.php<a class="headerlink" href="#test-de-la-base-de-donnees-test-db-php" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/include/test_db.php">https://raw.githubusercontent.com/mgrafr/monitor/main/include/test_db.php</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> &lt;?php
 echo &#39;&lt;textarea id=&quot;adm1&quot; style=&quot;height:&#39;.$height.&#39;px;&quot; name=&quot;command&quot; &gt;&#39;;
 echo &quot;test....BD: &quot;;
 // Create connection
 $con = new mysqli(SERVEUR, UTILISATEUR, MOTDEPASSE);
 // Check connection
 if ($con-&gt;connect_error) {   die(&quot;Pas de connexion au serveur: &quot; . $con-&gt;connect_error);$_SESSION[&quot;exeption_db&quot;]=&quot;pas de connexion à la BD&quot;;}
 else echo &quot; connection au serveur OK , ..&quot;;
 $conn = new mysqli(SERVEUR, UTILISATEUR, MOTDEPASSE, DBASE);
 if ($conn-&gt;connect_error) { die(&quot;Verifier le nom de la BD: &quot; . $conn-&gt;connect_error);$_SESSION[&quot;exeption_db&quot;]=&quot;pas de connexion à la BD&quot;;}
 echo &quot; connection à la BD OK , ..&quot;;$_SESSION[&quot;exeption_db&quot;]=&quot;&quot;;
 echo &quot;connexion terminée , ..&quot;;
?&gt;
</pre></div>
</div>
</section>
<section id="le-menu-header-php">
<h3>1.3.3 le menu, header.php<a class="headerlink" href="#le-menu-header-php" title="Lien permanent vers cette rubrique"></a></h3>
<p>les pages configurées avec config.php sont ajoutées automatiquement au menu</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/include/header.php">https://raw.githubusercontent.com/mgrafr/monitor/main/include/header.php</a></p>
<p>Extrait:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;ul class=&quot;nav navbar-nav navbar-right&quot; style=&quot;color: #adafb1;&quot;&gt;
     &lt;li class=&quot;zz active&quot;&gt;&lt;a href=&quot;#header&quot;&gt;Accueil&lt;/a&gt;&lt;/li&gt;
     &lt;?php if (ON_MET==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#meteo&quot;&gt;Météo&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#interieur&quot;&gt;Intérieur&lt;/a&gt;&lt;/li&gt;
     &lt;?php if (ON_EXT==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#exterieur&quot;&gt;Extérieur&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;?php if (ON_ALARM==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#alarmes&quot;&gt;Alarmes&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;?php if (ON_GRAPH==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#graphiques&quot;&gt;Graphiques&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;?php if (ON_ONOFF==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#murinter&quot;&gt;Mur On/Off&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;?php if (ON_ZIGBEE==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#zigbee&quot;&gt;Zigbee2mqtt&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     &lt;?php if (ON_ZWAVE==true) echo &#39;&lt;li class=&quot;zz&quot;&gt;&lt;a href=&quot;#zwave&quot;&gt;Zwavejs2mqtt&lt;/a&gt;&lt;/li&gt;&#39;;?&gt;
     ...
</pre></div>
</div>
<p>Pour modifier la largeur, Du menu :</p>
<p><a class="reference internal" href="../_images/image150.webp"><img alt="image150" src="../_images/image150.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image151.webp"><img alt="image151" src="../_images/image151.webp" style="width: 500px;" /></a></p>
</section>
<section id="la-page-daccueil-avec-les-notifications-accueil-php">
<h3>1.3.4   la page d’accueil avec les notifications , accueil.php<a class="headerlink" href="#la-page-daccueil-avec-les-notifications-accueil-php" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/include/accueil.php">https://raw.githubusercontent.com/mgrafr/monitor/main/include/accueil.php</a></p>
<p>Le HTML:</p>
<p><a class="reference internal" href="../_images/image152.webp"><img alt="image152" src="../_images/image152.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image153.webp"><img alt="image153" src="../_images/image153.webp" style="width: 498px;" /></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!--accueil start --&gt;
     &lt;!-- image de la page d&#39;accueuil déclarée dans admin/config.php --&gt;
     &lt;div id=&quot;accueil&quot; class=&quot;text-white banner&quot;&gt;
       &lt;div class=&quot;banner-image&quot;&gt;&lt;/div&gt;
         &lt;div class=&quot;banner-caption&quot;&gt;
             &lt;div class=&quot;container&quot;&gt;
                &lt;div class=&quot;row&quot;&gt;
                     &lt;div class=&quot;txtcenter col-md-12&quot; &gt;
                     &lt;h2 class=&quot;text-centre&quot;&gt;Température&lt;span style=&quot;color:cyan&quot;&gt; Extérieure&lt;/span&gt;&lt;/h2&gt;
                     &lt;p class=&quot;taille18 text-centre&quot;&gt;En ce moment , il fait :&lt;span id=&quot;temp_ext&quot; &gt;&lt;/span&gt;&lt;/p&gt;
                     &lt;p class=&quot;text-centre&quot;&gt;T° ressentie :&lt;span id=&quot;temp_ressentie&quot; style=&quot;color:#ffc107;&quot;&gt;&lt;/span&gt;&lt;/p&gt;
                     &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
</pre></div>
</div>
</section>
<section id="les-scripts-javascript">
<h3>1.3.5 les scripts JavaScript<a class="headerlink" href="#les-scripts-javascript" title="Lien permanent vers cette rubrique"></a></h3>
<p>dans la page footer.php : <a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/include/footer.php">https://raw.githubusercontent.com/mgrafr/monitor/main/include/footer.php</a></p>
<p>Extrait:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?php
require(&quot;fonctions.php&quot;);
?&gt;
&lt;!-- footer start --&gt;
     &lt;footer id=&quot;footer&quot;&gt;
     &lt;div class=&quot;footer section&quot;&gt;
     &lt;div class=&quot;container&quot;&gt;
     &lt;/div&gt;&lt;/div&gt;&lt;/footer&gt;
&lt;!-- footer end --&gt;
&lt;!-- JavaScript files placées à la fin du document--&gt;
&lt;script src=&quot;js/jquery-3.6.3.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;bootstrap/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/jquery-ui.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/jquery.backstretch.min.js&quot;&gt;&lt;/script&gt;
</pre></div>
</div>
<section id="rafraichissements-des-donnees">
<h4>1.3.5.1 rafraîchissements des données<a class="headerlink" href="#rafraichissements-des-donnees" title="Lien permanent vers cette rubrique"></a></h4>
<p>voir dans ce même chapitre le § <a class="reference internal" href="#maj-en-temps-reel"><span class="std std-ref">1.1.3 maj en temps réel</span></a></p>
<section id="a-rafrichissement-de-la-page-avec-une-variable">
<h5>1.3.5.1.a rafrichissement de la page avec une variable<a class="headerlink" href="#a-rafrichissement-de-la-page-avec-une-variable" title="Lien permanent vers cette rubrique"></a></h5>
<p>La fonction pour le rafraichissement des données : à partir d’un changement d’état d’un dispositif, une variable est mise à « 1 » ;</p>
<p>monitor qui scrute en permanence cette valeur importe les données de tous les dispositifs si cette variable est à 1.</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>Exemple pour Domoticz</p>
<p><a class="reference internal" href="../_images/image155.webp"><img alt="image155" src="../_images/image155.webp" style="width: 700px;" /></a></p>
<p>Dans les scripts lua :</p>
<p><a class="reference internal" href="../_images/image156.webp"><img alt="image156" src="../_images/image156.webp" style="width: 378px;" /></a></p>
<p>la variable:</p>
<p><a class="reference internal" href="../_images/image158.webp"><img alt="image158" src="../_images/image158.webp" style="width: 686px;" /></a></p>
</section>
<section id="b-rafraichissement-avec-sse">
<h5>1.3.5.1.b rafraichissement avec SSE<a class="headerlink" href="#b-rafraichissement-avec-sse" title="Lien permanent vers cette rubrique"></a></h5>
<div class="admonition-dans-domoticz admonition">
<p class="admonition-title"><strong>Dans Domoticz</strong></p>
<ul class="simple">
<li><p>Soit on utilise une fonction qui appelle un script python si le serveur est sous Node.js</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_topic</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="n">txt1</span><span class="p">)</span>
<span class="n">local</span> <span class="n">sse</span> <span class="o">=</span> <span class="s1">&#39;python3 userdata/scripts/python/sse.py &#39;</span><span class="o">..</span><span class="n">txt</span><span class="o">..</span><span class="s1">&#39; &#39;</span><span class="o">..</span><span class="n">txt1</span><span class="o">..</span><span class="s1">&#39; &gt;&gt;  /opt/domoticz/userdata/sse.log 2&gt;&amp;1&#39;</span> <span class="p">;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sse</span><span class="p">);</span>
<span class="n">os</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sse</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<ul class="simple">
<li><p>soit on utilise l” API monitor si le serveur est sous PHP , voir ce § <a class="reference internal" href="bien_debuter.html#api-de-monitor"><span class="std std-ref">0.12 API de monitor</span></a></p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">Voir aussi</p>
<p>Voir le § <a class="reference internal" href="mon_installation.html#depuis-domoticz"><span class="std std-ref">21.12.2.1 Depuis Domoticz</span></a></p>
</div>
</div>
<div class="admonition-dans-home-assistant admonition">
<p class="admonition-title"><strong>Dans Home Assistant</strong></p>
<ul>
<li><p>Soit on utilise SSE avec un script python comme avec Domoticz mais python_script ne peut pas être utilisé car un seul import python est autorisé.Dans ce cas il faut utilisé pyscrypt et HACS; <span class="darkblue">dans les cas simples la 2eme solution ci-dessous est à privilégier mais pour se familiariser avec Pyscript c’est un cas interressant</span>. voir ce § <span class="xref std std-ref">21.10.2 Python avec pyscript</span></p></li>
<li><p>Soit on crée une automation :</p>
<blockquote>
<div><p>. appelant le service <span class="darkblue">shell_command</span> pour un serveur Node.js</p>
<p>. appelant le service <span class="green">rest_command</span> pour un serveur PHP</p>
</div></blockquote>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shell_command</span><span class="p">:</span>
    <span class="n">curl_sse</span><span class="p">:</span>  <span class="s2">&quot;curl -X POST  -H &#39;Content-Type: application/json&#39;  -d &#39;{{ data }}&#39; -s {{ url }}&quot;</span>
<span class="n">rest_command</span><span class="p">:</span>
  <span class="n">monitor_2</span><span class="p">:</span>
    <span class="n">url</span><span class="p">:</span> <span class="s2">&quot;http://192.168.1.9/monitor/api/json.php?app=maj&amp;id={{id}}&amp;contenu={{state}}&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">Voir aussi</p>
<p>Voir le § <a class="reference internal" href="mon_installation.html#depuis-home-assistant"><span class="std std-ref">21.12.2.2 Depuis Home Assistant</span></a></p>
</div>
</div>
<p>Avec Monitor, vérification de réception des messages:</p>
<p><a class="reference internal" href="../_images/image1211.webp"><img alt="image1211" src="../_images/image1211.webp" style="width: 482px;" /></a></p>
<p>Domoticz et Home Assistant sont tous deux connectés au serveur mosquitto, ils reçoivent les topics SSE.</p>
</section>
<section id="c-le-serveur-sse">
<h5>1.3.5.1.c Le serveur SSE<a class="headerlink" href="#c-le-serveur-sse" title="Lien permanent vers cette rubrique"></a></h5>
<p>Comme indiqué précédemment , 2 possibilites :</p>
<ul class="simple">
<li><p>Sous node.js , il peut être installé sur le serveur principal ou dans une VM ou dans un conteneur, <a class="reference internal" href="mon_installation.html#installation-dans-un-conteneur-lxc-proxmox"><span class="std std-ref">21.12.1 Installation: dans un conteneur LXC Proxmox</span></a></p></li>
<li><p>Sous PHP , il peut être installé sur le serveur web de monitor, voir ce § <span class="xref std std-ref">18.10 Installer un serveur SSE PHP</span></p></li>
</ul>
<p>J’ai installé un serveur Node dans un conteneur LXC Proxmox.</p>
</section>
</section>
<section id="quelques-infos-supplementaires">
<h4>1.3.5.2 Quelques infos supplémentaires<a class="headerlink" href="#quelques-infos-supplementaires" title="Lien permanent vers cette rubrique"></a></h4>
<p>substring(0, 32) : affichage tronqué ID ZWAVE très long</p>
<p><a class="reference internal" href="../_images/image159.webp"><img alt="image159" src="../_images/image159.webp" style="width: 536px;" /></a></p>
<p>substring(0, 11)== »Set Level</p>
<p><a class="reference internal" href="../_images/image160.webp"><img alt="image160" src="../_images/image160.webp" style="width: 650px;" /></a></p>
<ul class="simple">
<li><p>La fonction <strong>maj_services</strong> récupère les valeurs de toutes les variables.</p></li>
<li><p>La fonction <strong>maj_variable</strong> modifie la valeur d’une variable.</p></li>
<li><p>La fonction <strong>maj_devices(plan)</strong> récupère les données des dispositifs</p></li>
<li><p>La fonction <strong>json_idx_idm(command)</strong> crée une table d’équivalence idm-&gt;idx ou ID</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function json_idx_idm(command){
 $.ajax({
 type: &quot;GET&quot;,
 dataType: &quot;json&quot;,
 url: &quot;ajax.php&quot;,
 data: &quot;app=idxidm&amp;command=&quot;+command,
 success: function(html){}
 });  };
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image1185.webp"><img alt="image1185" src="../_images/image1185.webp" style="width: 214px;" /></a></p>
<blockquote>
<div><p>Un exemple avec set ou get Attribute</p>
</div></blockquote>
<p><a class="reference internal" href="../_images/image161.webp"><img alt="image161" src="../_images/image161.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image1536.webp"><img alt="image1536" src="../_images/image1536.webp" style="width: 700px;" /></a></p>
<blockquote>
<div><p>Voir le paragraphe concernant les volets <span class="xref std std-ref">8.2.4 Exemple volet roulant</span></p>
</div></blockquote>
<ul class="simple">
<li><p>La fonction <strong>switchOnOff_setpoint()</strong> exécute des commandes</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>La ligne en PHP « &lt;?php if ($_SESSION[« exeption_db »]!= »pas de connexion à la BD ») {sql_plan(0);}?&gt; » crée pour chaque dispositif on/off le script correspondant à partir de la BD</p>
</div>
<p><a class="reference internal" href="../_images/image162.webp"><img alt="image162" src="../_images/image162.webp" style="width: 621px;" /></a></p>
<p>Le HTML :</p>
<p><a class="reference internal" href="../_images/image163.webp"><img alt="image163" src="../_images/image163.webp" style="width: 650px;" /></a></p>
<ul>
<li><p>la fonction <strong>maj_sevices()</strong></p>
<p>Copie d’écran le jour de l’entretien de la fosse septique</p>
</li>
</ul>
<p><a class="reference internal" href="../_images/image164.webp"><img alt="image164" src="../_images/image164.webp" style="width: 650px;" /></a></p>
<p><a class="reference internal" href="../_images/image165.webp"><img alt="image165" src="../_images/image165.webp" style="width: 602px;" /></a></p>
<ul>
<li><p>la fonction <strong>Maj_devices(plan)</strong>: pour l’installation minimale, ne concerne que la maj de la température extérieure et de la date ;</p>
<p>lorsqu’une tablette reste connectée en permanence, donc sans rafraichissement , la date affichée doit être rafraichie.</p>
<p>Une solution pour la maj de la date : un script qui tourne en permanence sur la tablette.</p>
<p>je n’ai pas retenu cette solution car un script dans Domoticz gère très bien la gestion du temps.  <a class="reference internal" href="#a-la-racine-du-site"><span class="std std-ref">1.2.1 - à la racine du site :</span></a> <em>maj date</em></p>
</li>
</ul>
<div class="admonition-solution-js-sur-la-tablette admonition">
<p class="admonition-title"><strong>solution JS sur la tablette</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fonction</span> <span class="n">date_heure</span><span class="p">(</span><span class="nb">id</span><span class="p">){</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Date</span><span class="p">;</span>
<span class="n">annee</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getFullYear</span><span class="p">();</span>
<span class="n">moi</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getMonth</span><span class="p">();</span>
<span class="n">mois</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Array</span><span class="p">(</span><span class="s1">&#39;Janvier&#39;</span><span class="p">,</span> <span class="s1">&#39;F&amp;eacute;vrier&#39;</span><span class="p">,</span> <span class="s1">&#39;Mars&#39;</span><span class="p">,</span> <span class="s1">&#39;Avril&#39;</span><span class="p">,</span> <span class="s1">&#39;Mai&#39;</span><span class="p">,</span> <span class="s1">&#39;Juin&#39;</span><span class="p">,</span> <span class="s1">&#39;Juillet&#39;</span><span class="p">,</span> <span class="s1">&#39;Ao&amp;ucirc;t&#39;</span><span class="p">,</span> <span class="s1">&#39;Septembre&#39;</span><span class="p">,</span> <span class="s1">&#39;Octobre&#39;</span><span class="p">,</span> <span class="s1">&#39;Novembre&#39;</span><span class="p">,</span> <span class="s1">&#39;D&amp;eacute;cembre&#39;</span><span class="p">);</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getDate</span><span class="p">();</span>
<span class="n">jour</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getDay</span><span class="p">();</span>
<span class="n">jours</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Array</span><span class="p">(</span><span class="s1">&#39;Dimanche&#39;</span><span class="p">,</span> <span class="s1">&#39;Lundi&#39;</span><span class="p">,</span> <span class="s1">&#39;Mardi&#39;</span><span class="p">,</span> <span class="s1">&#39;Mercredi&#39;</span><span class="p">,</span> <span class="s1">&#39;Jeudi&#39;</span><span class="p">,</span> <span class="s1">&#39;Vendredi&#39;</span><span class="p">,</span> <span class="s1">&#39;Samedi&#39;</span><span class="p">);</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getHours</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">h</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">){</span><span class="n">h</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="n">h</span><span class="p">;}</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getMinutes</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">){</span><span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">;}</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">getSeconds</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">){</span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="n">s</span><span class="p">;}</span>
<span class="n">resultat</span> <span class="o">=</span> <span class="s1">&#39;Nous sommes le &#39;</span><span class="o">+</span><span class="n">jours</span><span class="p">[</span><span class="n">jour</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">mois</span><span class="p">[</span><span class="n">moi</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">annee</span><span class="o">+</span><span class="s1">&#39; il est &#39;</span><span class="o">+</span><span class="n">h</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">;</span>
<span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="n">resultat</span><span class="p">;</span>
<span class="n">setTimeout</span><span class="p">(</span><span class="s1">&#39;date_heure(&quot;&#39;</span><span class="o">+</span><span class="nb">id</span><span class="o">+</span><span class="s1">&#39;&quot;);&#39;</span><span class="p">,</span><span class="s1">&#39;1000&#39;</span><span class="p">);</span>
<span class="k">return</span> <span class="n">true</span><span class="p">;}</span>
</pre></div>
</div>
</div>
<p><a class="reference internal" href="../_images/image1486.webp"><img alt="image1486" src="../_images/image1486.webp" style="width: 700px;" /></a></p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Pour la fonction custom_js appelé dans la fonction devices_plan voir le paragraphe consacré aux pages perso.</p>
<p>voir un exemple d’utilisation dans la page perso consacré au robot Worx <a class="reference internal" href="mon_installation.html#le-javascript-concerne"><span class="std std-ref">21.14.4 Le Javascript concerné</span></a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour que les icones sur la page d’accueil soient affichées, il faut enregistrer les variables dans la base de Données Maria DB,</p>
<ul class="simple">
<li><p>soit avec monitor–&gt;**Administration–&gt;Enregistrer Variable (DZ ou HA) dans SQL**</p></li>
<li><p>soit avec PHPMyAdmin</p></li>
</ul>
</div>
<ul class="simple">
<li><p>La table <strong>dispositifs</strong></p></li>
</ul>
<p><a class="reference internal" href="../_images/image167.webp"><img alt="image167" src="../_images/image167.webp" style="width: 662px;" /></a></p>
<ul class="simple">
<li><p>La table d’équivalence texte -&gt;images : <strong>text_image</strong></p></li>
</ul>
<p><a class="reference internal" href="../_images/image168.webp"><img alt="image168" src="../_images/image168.webp" style="width: 352px;" /></a></p>
<p><a class="reference internal" href="../_images/image169.webp"><img alt="image169" src="../_images/image169.webp" style="width: 338px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour les Anniversaires, il faut entrer chaque prénom ou nom dans la base de données, ces noms correspondent à ceux du script LUA décrit ci-après :</p>
<p><a class="reference internal" href="../_images/image170.webp"><img alt="image170" src="../_images/image170.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image171.webp"><img alt="image171" src="../_images/image171.webp" style="width: 529px;" /></a></p>
<p>L’image peut être personnalisée pour chaque nom</p>
</div>
<p><em>Sur la page d’accueil, il est possible d’ajouter d’autres icones, il suffit d’ajouter un ID dans accueil.php et de renseigner la base de données</em></p>
<p><a class="reference internal" href="../_images/image172.webp"><img alt="image172" src="../_images/image172.webp" style="width: 700px;" /></a></p>
</section>
</section>
</section>
<section id="le-lexique-et-la-temperature-exterieure">
<h2>1.4 Le lexique et la température extérieure<a class="headerlink" href="#le-lexique-et-la-temperature-exterieure" title="Lien permanent vers cette rubrique"></a></h2>
<section id="le-lexique">
<h3>1.4.1 Le lexique<a class="headerlink" href="#le-lexique" title="Lien permanent vers cette rubrique"></a></h3>
<p>L’image est inline dans header.php</p>
<p>La fenêtre modale dans include/lexique .php ou include/lexique_no.php (le fichier est choisi par la configuration) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">affichage</span> <span class="n">lexique</span>
<span class="n">define</span><span class="p">(</span><span class="s1">&#39;LEXIQUE&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image174.webp"><img alt="image174" src="../_images/image174.webp" style="width: 602px;" /></a></p>
<ul class="simple">
<li><p>Lexique.php</p></li>
</ul>
<p><a class="reference internal" href="../_images/image175.webp"><img alt="image175" src="../_images/image175.webp" style="width: 465px;" /></a></p>
<ul class="simple">
<li><p>Lexique_no.php</p></li>
</ul>
<p><a class="reference internal" href="../_images/image176.webp"><img alt="image176" src="../_images/image176.webp" style="width: 650px;" /></a></p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Pour ne pas utiliser de lexique et donc de supprimer l’icône :<a class="reference internal" href="../_images/image177.webp"><img alt="image177" src="../_images/image177.webp" style="width: 60px;" /></a></p>
<ul class="simple">
<li><p>Supprimer le script ou le ou mettre en commentaire : <span class="red">&lt;!–</span>  &lt;div class= »modal » id= »lexique »&gt;</p></li>
</ul>
</div>
</section>
<section id="la-temperature-exterieure-valable-pour-dautres-dispositifs">
<h3>1.4.2 La température extérieure (valable pour d’autres dispositifs)<a class="headerlink" href="#la-temperature-exterieure-valable-pour-dautres-dispositifs" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image179.webp"><img alt="image179" src="../_images/image179.webp" style="width: 438px;" /></a></p>
<p>Le fichier Json reçu par monitor après une demande de la fonction devices(plan):</p>
<p><a class="reference internal" href="../_images/image180.webp"><img alt="image180" src="../_images/image180.webp" style="width: 286px;" /></a></p>
</section>
</section>
<section id="liens-avec-domoticz-home-assistant-ou-io-broker">
<h2>1.5 liens avec Domoticz, Home Assistant ou io.broker<a class="headerlink" href="#liens-avec-domoticz-home-assistant-ou-io-broker" title="Lien permanent vers cette rubrique"></a></h2>
<section id="liens-avec-domoticz">
<h3>1.5.1 Liens avec Domoticz<a class="headerlink" href="#liens-avec-domoticz" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image183.webp"><img alt="image183" src="../_images/image183.webp" style="width: 307px;" /></a></p>
<p>Le script <strong>maj_services.lua</strong> concerne :</p>
<ul class="simple">
<li><p>les poubelles</p></li>
<li><p>la fosse septique</p></li>
<li><p>les anniversaires</p></li>
<li><p>la gestion des piles des dispositifs</p></li>
<li><p>….et plus encore</p></li>
</ul>
<p>Affichage des évènements :
-       sur monitor,</p>
<ul class="simple">
<li><p>sur la TV</p></li>
<li><p>notifications SMS</p></li>
<li><p>envoi e_mail</p></li>
</ul>
<p>lien Github: <a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/share/scripts_dz/lua/maj_services.lua">https://raw.githubusercontent.com/mgrafr/monitor/main/share/scripts_dz/lua/maj_services.lua</a></p>
<p>le script met à jour, suivant l’horaire et la date, des variables Domoticz ; quand javascript
demande une mise à jour, il appelle, par l’intermédiaire d’un fichier ajax.php, une fonction
PHP (status_variables), qui récupère toutes les infos (API Domoticz) et renvoi un fichier Json</p>
<p><em>Variables Domoticz</em> :</p>
<blockquote>
<div><ul class="simple">
<li><p><span class="darkblue">variables not_tv_* : pour le script notifications_tv.lua</span></p></li>
</ul>
</div></blockquote>
<p><a class="reference internal" href="../_images/image181.webp"><img alt="image181" src="../_images/image181.webp" style="width: 650px;" /></a></p>
<p>fichier Json* :</p>
<p><a class="reference internal" href="../_images/image182.webp"><img alt="image182" src="../_images/image182.webp" style="width: 285px;" /></a></p>
<div class="admonition-remarque admonition">
<p class="admonition-title"><strong>REMARQUE</strong></p>
<p><span class="darkblue">D’une année à l’autre, certains jours de ramassage des poubelles peuvent être modifiés</span> :</p>
<p>Pour en tenir compte dans Domoticz, il est possible de mettre les variables (string et tableau dans un fichier, voir ci-après:</p>
</div>
<section id="les-variables-lua-de-configuration-dans-un-fichier-externe">
<h4>1.5.1.1 les variables lua de configuration dans un fichier externe<a class="headerlink" href="#les-variables-lua-de-configuration-dans-un-fichier-externe" title="Lien permanent vers cette rubrique"></a></h4>
<p>Les jours de ramassage des poubelles peuvent changer, le nombre d’anniversaires augmenter, toutes les variables correspondantes à ces valeurs peuvent être insérées dans un fichier appelé dans le script lua ; pour les anniversaires on utilise un tableau multidimensionnel, plus facile à compléter que 2 tableaux, si les données sont importantes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ce fichier peut alors être modifié dans monitor sans intervenir dans Domoticz, voir le paragraphe concernant l’administration  <a class="reference internal" href="administration.html#administration"><span class="std std-ref">14.  ADMINISTRATION</span></a></p>
<p>Dans ce cas il faut que le fichier soit accessible en http, il faut donc créer un répertoire « modules_lua »   dans « <span class="darkblue">/home/USER/domoticz/www</span> »</p>
<p>Exemple le fichier <span class="darkblue">/home/USER/domoticz/www/modules_lua/string_tableaux.lua</span>, affiché dans monitor</p>
<p><a class="reference internal" href="../_images/image186.webp"><img alt="image186" src="../_images/image186.webp" style="width: 506px;" /></a></p>
</div>
<p>Pour une maj depuis monitor, on utilise une variable de Domoticz, ainsi c’est Domoticz qui télécharge le fichier modifié.</p>
<p><a class="reference internal" href="../_images/image187.webp"><img alt="image187" src="../_images/image187.webp" style="width: 573px;" /></a></p>
<p>Il est ausi possible d’utiliser SSH2 pour modifier à distance le fichier; ce n’est pas l’option retenue ici.</p>
<p>voir le paragraphe <a class="reference internal" href="administration.html#explications-concernant-limportation-distantes-dun-tableau-lua"><span class="std std-ref">14.7 Explications concernant l’importation distantes d’un tableau LUA</span></a></p>
<div class="admonition-facon-de-proceder admonition">
<p class="admonition-title"><strong>Façon de procéder</strong></p>
<p>On place le fichier (ici : string_tableaux.lua)  dans ce répertoire</p>
<p><a class="reference internal" href="../_images/image188.webp"><img alt="image188" src="../_images/image188.webp" style="width: 402px;" /></a></p>
<p>Dans le script LUA, pour les jours de poubelles, les anniversaires, on appelle ce fichier, en ayant indiqué le chemin :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span> <span class="n">chargement</span> <span class="n">fichier</span> <span class="n">contenant</span> <span class="n">les</span> <span class="n">variables</span> <span class="n">de</span> <span class="n">configuration</span>
  <span class="n">package</span><span class="o">.</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;;/home/USER/domoticz/www/modules_lua/?.lua&quot;</span>
  <span class="n">require</span> <span class="s1">&#39;string_tableaux&#39;</span>

  <span class="o">--</span> <span class="n">exclusion</span> <span class="n">ou</span> <span class="n">ajout</span> <span class="n">dates</span> <span class="n">poubelles</span> <span class="p">,</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">e_poubelles</span><span class="p">)</span> <span class="n">do</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jour_mois</span><span class="o">==</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span> <span class="n">then</span> <span class="n">jour_poubelle_grise</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="n">elseif</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;j&quot;</span><span class="p">)</span> <span class="n">then</span> <span class="n">jour_poubelle_jaune</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="n">end</span>
        <span class="n">end</span>
     <span class="n">end</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">a_poubelles</span><span class="p">)</span> <span class="n">do</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">jour_mois</span><span class="o">==</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span> <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span> <span class="n">then</span> <span class="n">jour_poubelle_grise</span> <span class="o">=</span> <span class="n">day</span><span class="p">;</span>
            <span class="n">elseif</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;j&quot;</span><span class="p">)</span> <span class="n">then</span> <span class="n">jour_poubelle_jaune</span> <span class="o">=</span> <span class="n">day</span><span class="p">;</span>
            <span class="n">end</span>
      <span class="n">end</span>
<span class="n">end</span>

<span class="o">--</span> <span class="n">anniversaires</span> <span class="p">,</span>
<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="s2">&quot;01:30&quot;</span><span class="p">)</span>  <span class="n">then</span>
  <span class="n">local</span> <span class="n">jour_mois</span> <span class="o">=</span> <span class="n">jour</span><span class="o">..</span><span class="s2">&quot;-&quot;</span><span class="o">..</span><span class="n">mois</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">anniversaires</span><span class="p">)</span> <span class="n">do</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">jour_mois</span><span class="o">==</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span>  <span class="n">commandArray</span><span class="p">[</span><span class="s1">&#39;Variable:anniversaires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
     <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
     <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</section>
<section id="les-scripts-de-notifications-gerees-par-domoticz">
<h4>1.5.1.2 les scripts de notifications gérées par Domoticz<a class="headerlink" href="#les-scripts-de-notifications-gerees-par-domoticz" title="Lien permanent vers cette rubrique"></a></h4>
<p>Alarmes SMS ou Mail ,</p>
<ul class="simple">
<li><p>le script LUA pour les variables : ‘<span class="darkblue">notifications_variables</span>’</p></li>
</ul>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_variables.lua">https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_variables.lua</a></p>
<p>Extrait:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span>
     <span class="n">on</span> <span class="o">=</span> <span class="p">{</span>
             <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;alarme_bat&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;boite_lettres&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;upload&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;zm_cam&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;pression-chaudiere&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;variable_sp&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;pilule_tension&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;BASH&#39;</span>
             <span class="p">}</span>
     <span class="p">},</span>
     <span class="n">execute</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">domoticz</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>le script LUA pour les dispositifs : ‘<span class="darkblue">notifications_devices</span>’</p></li>
</ul>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_devices.lua">https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_devices.lua</a></p>
<p><a class="reference internal" href="../_images/image194.webp"><img alt="image194" src="../_images/image194.webp" style="width: 650px;" /></a></p>
<section id="script-lua">
<h5>script lua<a class="headerlink" href="#script-lua" title="Lien permanent vers cette rubrique"></a></h5>
<ul class="simple">
<li><p>le script LUA pour les notifications concernant le temps: ‘<span class="darkblue">notification-timer.lua</span>,</p></li>
</ul>
<p><a class="reference internal" href="../_images/image195.webp"><img alt="image195" src="../_images/image195.webp" style="width: 650px;" /></a></p>
</section>
</section>
</section>
<section id="liens-avec-home-assistant">
<h3>1.5.2 Liens avec Home Assistant<a class="headerlink" href="#liens-avec-home-assistant" title="Lien permanent vers cette rubrique"></a></h3>
<p>Les services gérés peuvent être les même que pour Domoticz ; au lieu de Lua les scripts sont écrit en Yaml.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour faire un essai de Rest API, sans installer de client HTTP, il suffit à partir de monitor d’envoyer la variable app=ha</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://IP DE MONITOR/monitor/ajax.php?app=ha
</pre></div>
</div>
</div>
<p><a class="reference internal" href="../_images/image142.webp"><img alt="image142" src="../_images/image142.webp" style="width: 700px;" /></a></p>
<section id="exemple-dun-on-off-sur-un-interrupteur-virtuel">
<h4>1.5.2.1  Exemple d’un ON OFF sur un interrupteur virtuel<a class="headerlink" href="#exemple-dun-on-off-sur-un-interrupteur-virtuel" title="Lien permanent vers cette rubrique"></a></h4>
<p><a class="reference internal" href="../_images/image196.webp"><img alt="image196" src="../_images/image196.webp" style="width: 440px;" /></a></p>
<p><a class="reference internal" href="../_images/image197.webp"><img alt="image197" src="../_images/image197.webp" style="width: 596px;" /></a></p>
<p><a class="reference internal" href="../_images/image198.webp"><img alt="image198" src="../_images/image198.webp" style="width: 529px;" /></a></p>
<p>Réponse de l’API sur l’état :</p>
<p><a class="reference internal" href="../_images/image199.webp"><img alt="image199" src="../_images/image199.webp" style="width: 529px;" /></a></p>
<p><a class="reference internal" href="../_images/image200.webp"><img alt="image200" src="../_images/image200.webp" style="width: 547px;" /></a></p>
<p><a class="reference internal" href="../_images/image201.webp"><img alt="image201" src="../_images/image201.webp" style="width: 700px;" /></a></p>
<p>La fonction PHP</p>
<p><a class="reference internal" href="../_images/image202.webp"><img alt="image202" src="../_images/image202.webp" style="width: 700px;" /></a></p>
<p>Comme pour Domoticz une commande dans monitor appelle l’api qui exécute la commande.</p>
<p>Dans footer.php : départ de la commande avec le script créé automatiquement depuis la base de données:</p>
<p><a class="reference internal" href="../_images/image203.webp"><img alt="image203" src="../_images/image203.webp" style="width: 655px;" /></a></p>
<ul class="simple">
<li><p>la fonction <span class="darkblue">turnonoff()</span></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function turnonoff(idm,idx,command,pass=&quot;0&quot;){console.log(idm);
     if (pp[idm].Data == &quot;On&quot; || pp[idm].Data == &quot;on&quot;) {command=&quot;off&quot;;}
     else {command=&quot;on&quot;;}
     $.ajax({ //commande ON/OFF
     type: &quot;GET&quot;,
     dataType: &quot;json&quot;,
     url: &quot;ajax.php&quot;,
     data: &quot;app=turn&amp;device=&quot;+idx+&quot;&amp;command=&quot;+command+&quot;&amp;name=&quot;+pass,
     success: function(response){qq=response;
        if (qq.resultat != &quot;OK&quot; ){alert(&quot;erreur&quot;);}
        else {
        $.ajax({ // commande STATE
        type: &quot;GET&quot;,
        dataType: &quot;json&quot;,
        url: &quot;ajax.php&quot;,
        data: &quot;app=turn&amp;device=&quot;+idx+&quot;&amp;command=etat&amp;name=&quot;+pass,
        success: function(response){qq=response;
             }});}
        }   });
     var level=&quot;&quot;;command=qq.state;
     maj_mqtt(idx,command,0,level)
    //maj_switch(idx,command,level,idm);remplacé par maj_mqtt
     }
</pre></div>
</div>
<p>commande concernée dans ajax.php:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if ($app==&quot;turn&quot;) {$retour=devices_id($device,$command);echo $retour; }
</pre></div>
</div>
<p>La fonction PHP « <span class="darkblue">device_id</span> » ci-dessus retourne pour les capteurs binaires :</p>
<p><a class="reference internal" href="../_images/image206.webp"><img alt="image206" src="../_images/image206.webp" style="width: 327px;" /></a></p>
<p>En plus clair :</p>
<p><a class="reference internal" href="../_images/image207.webp"><img alt="image207" src="../_images/image207.webp" style="width: 454px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour les interrupteurs réels : l’API retourne un tableau vide , d’où un appel de l’API/states pour avoir une confirmation du changement d’état.</p>
<p>Pour faire des essais à partir d’un navigateur :</p>
</div>
<p><a class="reference internal" href="../_images/image208.webp"><img alt="image208" src="../_images/image208.webp" style="width: 700px;" /></a></p>
</section>
</section>
<section id="liaison-mqtt-entre-home-assistant-et-domoticz">
<h3>1.5.3 Liaison MQTT entre Home Assistant et Domoticz<a class="headerlink" href="#liaison-mqtt-entre-home-assistant-et-domoticz" title="Lien permanent vers cette rubrique"></a></h3>
<section id="ajout-dans-domoticz">
<h4>1.5.3.1  Ajout dans Domoticz<a class="headerlink" href="#ajout-dans-domoticz" title="Lien permanent vers cette rubrique"></a></h4>
<ul class="simple">
<li><p><strong>Créer une pièce fictive</strong> nommée <span class="darkblue">mqttDevices</span> où seront placés les dispositifs concernés.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>les dispositifs peuvent appartenir également à une autre pièce</p>
</div>
<p><a class="reference internal" href="../_images/image1092.webp"><img alt="image1092" src="../_images/image1092.webp" style="width: 500px;" /></a></p>
<p>Ici les 2 dispositifs concernant les interrupteurs pour l’alarme d’absence et l’alarme de nuit.</p>
<p><a class="reference internal" href="../_images/image1094.webp"><img alt="image1094" src="../_images/image1094.webp" style="width: 500px;" /></a></p>
<ul class="simple">
<li><p><strong>Sous Configuration/Matériel</strong>, ajoutez un périphérique de ce type : <span class="darkblue">MQTT Client Gateway with LAN interface</span></p></li>
</ul>
<p><a class="reference internal" href="../_images/image1093.webp"><img alt="image1093" src="../_images/image1093.webp" style="width: 600px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>pour la pièce choisie ci-dessus le topic sera <span class="darkblue">domoticz/out/interieur/mqttDevices</span> et <span class="darkblue">domoticz/out</span></p>
</div>
</section>
<section id="ajout-dans-home-assistant">
<h4>1.5.3.2  Ajout dans Home Assistant<a class="headerlink" href="#ajout-dans-home-assistant" title="Lien permanent vers cette rubrique"></a></h4>
<ul class="simple">
<li><p><strong>Créer un répertoire mqtt</strong> et l’inclure dans <span class="darkblue">/config/configuration.yaml</span></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mqtt: !include_dir_merge_named mqtt/
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image1095.webp"><img alt="image1095" src="../_images/image1095.webp" style="width: 319px;" /></a></p>
<p>enregistrer le fichier modifié</p>
<ul class="simple">
<li><p><a href="#id3"><span class="problematic" id="id4">**</span></a>créer un fichier qui concernera les interrupteurs: <span class="darkblue">switches.yaml</span></p></li>
</ul>
<p><a class="reference internal" href="../_images/image1096.webp"><img alt="image1096" src="../_images/image1096.webp" style="width: 291px;" /></a></p>
<ul class="simple">
<li><p><strong>ajouter le code pour chaque interrupteur:</strong></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;alarme_absence&quot;</span>
    <span class="n">object_id</span><span class="p">:</span> <span class="s2">&quot;41&quot;</span>
    <span class="n">unique_id</span><span class="p">:</span> <span class="n">alarme_absence</span>
    <span class="n">state_topic</span><span class="p">:</span> <span class="s2">&quot;domoticz/out/interieur/mqttDevices&quot;</span>
    <span class="n">command_topic</span><span class="p">:</span> <span class="s2">&quot;domoticz/in&quot;</span>
    <span class="n">value_template</span><span class="p">:</span> <span class="s2">&quot;{{ value_json.nvalue }}&quot;</span>
    <span class="n">state_on</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
    <span class="n">state_off</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
    <span class="n">payload_on</span><span class="p">:</span>  <span class="s1">&#39;{&quot;command&quot;: &quot;switchlight&quot;, &quot;idx&quot;: 41 , &quot;switchcmd&quot;: &quot;On&quot; }&#39;</span>
    <span class="n">payload_off</span><span class="p">:</span> <span class="s1">&#39;{&quot;command&quot;: &quot;switchlight&quot;, &quot;idx&quot;: 41, &quot;switchcmd&quot;: &quot;Off&quot; }&#39;</span>
    <span class="n">optimistic</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">qos</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">retain</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>Pour l’alarme de nuit (idx=42), le script sera le même avec comme object_id et idx <span class="red">42</span> au lieu de <span class="darkblue">41</span></p>
<p>Enregistrer le fichier modifier, vérifier la configuration et <strong>redémarrer Home Assistant</strong></p>
<p><a class="reference internal" href="../_images/image1097.webp"><img alt="image1097" src="../_images/image1097.webp" style="width: 443px;" /></a></p>
</section>
</section>
<section id="liens-avec-io-broker">
<h3>1.5.4 Liens avec io.broker<a class="headerlink" href="#liens-avec-io-broker" title="Lien permanent vers cette rubrique"></a></h3>
<p>Au lieu d’utiliser Lua(Dz) ou Yaml(Ha), on utilise plutôt Javascript</p>
<p>Avec io.broker , 2 solutions:</p>
<ul class="simple">
<li><p>soit on utilise l’API comme pour Domoticz ou Home Assistant</p></li>
<li><p>soit on crée de belles pages avec Vis 2.0 et la mise à jour par web socket est automatique, c’est cette solution qui est à privilégier</p></li>
</ul>
<section id="utlisation-de-rest-api">
<h4>1.5.4.1  Utlisation de rest-api<a class="headerlink" href="#utlisation-de-rest-api" title="Lien permanent vers cette rubrique"></a></h4>
<p><a class="reference external" href="https://github.com/ioBroker/ioBroker.rest-api">https://github.com/ioBroker/ioBroker.rest-api</a></p>
<p>les dispositifs crées automatiquement à partir de la BD</p>
<p><a class="reference internal" href="../_images/image1521.webp"><img alt="image1521" src="../_images/image1521.webp" style="width: 700px;" /></a></p>
<p>La fonction PHP:</p>
<p><a class="reference internal" href="../_images/image1522.webp"><img alt="image1522" src="../_images/image1522.webp" style="width: 700px;" /></a></p>
<p>Voir un exemple concret :  <a class="reference internal" href="mon_installation.html#robot-tondeuse-landroid-worx"><span class="std std-ref">21.14 Robot tondeuse Landroid Worx</span></a></p>
</section>
<section id="utlisation-de-vis-2-0">
<h4>1.5.4.2 Utlisation de Vis 2.0<a class="headerlink" href="#utlisation-de-vis-2-0" title="Lien permanent vers cette rubrique"></a></h4>
<p>l’adaptateur est installé: <a class="reference internal" href="../_images/image1523.webp"><img alt="image1523" src="../_images/image1523.webp" style="width: 300px;" /></a></p>
<div class="admonition-allumage-et-l-extinction-de-l-eclairage-et-affichage-de-la-temperature admonition">
<p class="admonition-title"><strong>Allumage et l’extinction de l’éclairage et affichage de la température</strong></p>
<blockquote>
<div><blockquote>
<div><p><a class="reference internal" href="../_images/image1525.webp"><img alt="image1525" src="../_images/image1525.webp" style="width: 700px;" /></a></p>
<p><a class="reference internal" href="../_images/image1524.webp"><img alt="image1524" src="../_images/image1524.webp" style="width: 447px;" /></a></p>
</div></blockquote>
<p>Ajouter une image d’arrière plan:</p>
<p><a class="reference internal" href="../_images/image1526.webp"><img alt="image1526" src="../_images/image1526.webp" style="width: 660px;" /></a></p>
<p><a class="reference internal" href="../_images/image1527.webp"><img alt="image1527" src="../_images/image1527.webp" style="width: 700px;" /></a></p>
<p>Ajouter une lampe:</p>
<p><a class="reference internal" href="../_images/image1528.webp"><img alt="image1528" src="../_images/image1528.webp" style="width: 441px;" /></a></p>
<p><a class="reference internal" href="../_images/image1529.webp"><img alt="image1529" src="../_images/image1529.webp" style="width: 700px;" /></a></p>
<p>Ajouter la température</p>
<p><a class="reference internal" href="../_images/image1530.webp"><img alt="image1530" src="../_images/image1530.webp" style="width: 700px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour ajouter quand a eu lieu la dernière mesure</p>
<p><a class="reference internal" href="../_images/image1531.webp"><img alt="image1531" src="../_images/image1531.webp" style="width: 550px;" /></a></p>
</div>
<p>Pour ajouter une icone devant la température</p>
</div></blockquote>
<p><a class="reference internal" href="../_images/image1532.webp"><img alt="image1532" src="../_images/image1532.webp" style="width: 700px;" /></a></p>
<blockquote>
<div><p>Résultat en direct</p>
<p><a class="reference internal" href="../_images/image1533.webp"><img alt="image1533" src="../_images/image1533.webp" style="width: 550px;" /></a></p>
</div></blockquote>
</div>
<p>Affichage dans Monitor:</p>
<p><a class="reference internal" href="../_images/image1534.webp"><img alt="image1534" src="../_images/image1534.webp" style="width: 500px;" /></a></p>
<p>Voir aussi le § <a class="reference internal" href="mon_installation.html#io-broker"><span class="std std-ref">21.13 Io.Broker</span></a></p>
</section>
</section>
</section>
<section id="lien-avec-la-base-de-donnees-sql">
<h2>1.6 Lien avec la base de données SQL<a class="headerlink" href="#lien-avec-la-base-de-donnees-sql" title="Lien permanent vers cette rubrique"></a></h2>
<section id="exemple-avec-la-date-de-ramassage-des-poubelles">
<h3>1.6.1- exemple avec la date de ramassage des poubelles<a class="headerlink" href="#exemple-avec-la-date-de-ramassage-des-poubelles" title="Lien permanent vers cette rubrique"></a></h3>
<p>En Dordogne, les poubelles jaunes sont ramassées toutes les 2 semaines mais les poubelles grises sont ramassées selon une procédure différente :</p>
<ul class="simple">
<li><p>Le contrat annuel comprend 12 ramassages mais le ramassage est possible chaque semaine,</p></li>
</ul>
<p>il faut donc gérer au mieux le nombre de ramassages pour éviter des facturations supplémentaires.</p>
<p>c’est le script décrit ici qui enregistre les dates des ramassages réels effectués.</p>
<p><em>Il faut au préalable ajouter une table dans la base de données</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> -- Structure de la table `date_poub`
 --
 CREATE TABLE `date_poub` (
`num` int(11) NOT NULL,
`date` text NOT NULL,
`valeur` text NOT NULL,
`icone` text NOT NULL
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre></div>
</div>
<ul class="simple">
<li><p>Les 2 icones svg : <a class="reference internal" href="../_images/image209.webp"><img alt="image209" src="../_images/image209.webp" style="width: 153px;" /></a></p></li>
<li><p>La table</p></li>
</ul>
<p><a class="reference internal" href="../_images/image210.webp"><img alt="image210" src="../_images/image210.webp" style="width: 695px;" /></a></p>
<ul class="simple">
<li><p>La page d’accueil :</p></li>
</ul>
<p><a class="reference internal" href="../_images/image211.webp"><img alt="image211" src="../_images/image211.webp" style="width: 638px;" /></a></p>
<p>un script est ajouté dans footer.php</p>
<p>Idx_idimg existe déjà dans footer.php , sa valeur est « poubelle_grise » ou « poubelle_jaune » suivant les valeurs choisies dans le script LUA de Domoticz ;</p>
<p>on va <strong>ajouter une variable pour l’icône dans les données json</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$(&quot;#poubelle&quot;).click(function () {
var date_poub=new Date();
var jour_poub=date_poub.getDate();
var an_poub=date_poub.getFullYear();
var months=new Array(&#39;Janvier&#39;,&#39;Février&#39;,&#39;Mars&#39;,&#39;Avril&#39;,&#39;Mai&#39;,&#39;Juin&#39;,&#39;Juillet&#39;,&#39;Aout&#39;,&#39;Septembre&#39;,&#39;Octobre&#39;,&#39;Novembre&#39;,&#39;Décembre&#39;);
var mois_poub=months[date_poub.getMonth()];
var date_poub=jour_poub+&#39; &#39;+mois_poub+&quot; &quot;+an_poub;
         $.ajax({
          url: &quot;ajax.php&quot;,
          data: &quot;app=sql&amp;idx=0&amp;variable=date_poub&amp;type=&quot;+idx_idimg+&quot;&amp;command=&quot;+
                      date_poub+&quot;&amp;name=&quot;+idx_ico,
         }).done(function() {
          alert(&#39;date ramassage enregigistrée:&#39;  +date_poub);
         });
     });
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image212.webp"><img alt="image212" src="../_images/image212.webp" style="width: 700px;" /></a></p>
<p>Dans ajax.php</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if ($app==&quot;sql&quot;) {$retour=sql_app($idx,$variable,$type,$command,$name);echo $retour;}//$choix,$table,$valeur,$date,$icone
</pre></div>
</div>
<p>Dans fonctions.php , la fonction <span class="darkblue">sql_app</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function sql_app($choix,$table,$valeur,$date,$icone=&#39;&#39;){
// SERVEUR SQL connexion
$conn = new mysqli(SERVEUR,UTILISATEUR,MOTDEPASSE,DBASE);
if ($choix==0) {// Pour insertion des données
$sql=&quot;INSERT INTO &quot;.$table.&quot; (`num`, `date`, `valeur`, `valeur`) VALUES (NULL, &#39;&quot;.$date.&quot;&#39;, &#39;&quot;.$valeur.&quot;&#39;, &#39;&quot;.$icone.&quot;&#39;);&quot;;
$result = $conn-&gt;query($sql);;}
if ($choix==1) { // Pour lecture des données
$sql=&quot;SELECT * FROM &quot;.$table.&quot; ORDER BY num DESC LIMIT 24&quot;;
$result = $conn-&gt;query($sql);
$number = $result-&gt;num_rows;
while($row = $result-&gt;fetch_array(MYSQLI_ASSOC)){
 echo $row[&#39;date&#39;].&#39;  &#39;.$row[&#39;valeur&#39;].&#39; &lt;img style=&quot;width:30px;vertical-align:middle&quot; src=&quot;&#39;.$row[&#39;icone&#39;].&#39;&quot;/&gt;&lt;br&gt;&#39;;}
}
$conn-&gt;close();
return;}
</pre></div>
</div>
<p>Et pour ajouter l’icône au fichier json concernant les variables :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function status_variables($xx){
$p=0;$n=0;
if(IPDOMOTIC != &quot;&quot;){
$L=URLDOMOTIC.&quot;json.htm?type=command&amp;param=getuservariables&quot;;
$json_string = file_get_curl($L);
$resultat = json_decode($json_string, true);
...
...
$data[$n+1] = [
             &#39;idx&#39; =&gt; $idx,
             &#39;ID&#39; =&gt; $ID,
             &#39;Type&#39; =&gt; $type,
             &#39;Name&#39; =&gt; $name,
             &#39;Value&#39; =&gt; $value,
             &#39;contenu&#39; =&gt; $content,
             &#39;ID_img&#39; =&gt; $id_m_img,
             &#39;image&#39; =&gt; $image,
     ---&gt;    &#39;icone&#39; =&gt; $icone,
             &#39;ID_txt&#39; =&gt; $id_m_txt,
             &#39;exist_id&#39; =&gt; $exist_id
             ];}
</pre></div>
</div>
<p>Le fichier Json reçu par monitor :</p>
<p><a class="reference internal" href="../_images/image216.webp"><img alt="image216" src="../_images/image216.webp" style="width: 369px;" /></a></p>
<p>Les enregistrements sont sauvegardés,</p>
<p>pour afficher l’historique des dates, voir le paragraphe  <a class="reference internal" href="app_diverses.html#edition-de-lhistorique-du-ramassage-des-poubelles"><span class="std std-ref">12.1.1 Edition de l’historique du ramassage des poubelles</span></a></p>
<p><a class="reference internal" href="../_images/image218.webp"><img alt="image218" src="../_images/image218.webp" style="width: 526px;" /></a></p>
</section>
</section>
<section id="ajuster-le-menu-au-nombre-de-pages">
<h2>1.7 Ajuster le menu au nombre de pages<a class="headerlink" href="#ajuster-le-menu-au-nombre-de-pages" title="Lien permanent vers cette rubrique"></a></h2>
<p>Au-delà de 12 pages il faut étendre en largeur le menu ; il faut aussi le descendre de 50 px
pour ne pas cacher le menu hamburger</p>
<p><a class="reference internal" href="../_images/image219.webp"><img alt="image219" src="../_images/image219.webp" style="width: 526px;" /></a></p>
<p><em>Modification à apporter au fichier : /js/big-Slide.js :</em></p>
<p><a class="reference internal" href="../_images/image220.webp"><img alt="image220" src="../_images/image220.webp" style="width: 316px;" /></a></p>
<p>Pour descendre le menu : modifier la class .nav dans css/mes_css.css</p>
<p><a class="reference internal" href="../_images/image221.webp"><img alt="image221" src="../_images/image221.webp" style="width: 338px;" /></a></p>
<p>On peut aussi augmenter la hauteur:</p>
<p><a class="reference internal" href="../_images/image1182.webp"><img alt="image1182" src="../_images/image1182.webp" style="width: 292px;" /></a>  <a class="reference internal" href="../_images/image1183.webp"><img alt="image1183" src="../_images/image1183.webp" style="width: 138px;" /></a></p>
</section>
<section id="complement-pour-les-notifications-sur-l-ecran-d-accueil">
<h2>1.8 Complément pour les notifications sur l’écran d’accueil<a class="headerlink" href="#complement-pour-les-notifications-sur-l-ecran-d-accueil" title="Lien permanent vers cette rubrique"></a></h2>
<section id="les-notifications-incluses-dans-le-programme">
<h3>1.8.1 les notifications incluses dans le programme<a class="headerlink" href="#les-notifications-incluses-dans-le-programme" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image1146.webp"><img alt="image1146" src="../_images/image1146.webp" style="width: 474px;" /></a></p>
<p>Domoticz met à jour une variable et HA met à jour un dispositifs virtuel;monitor compare la valeur de ces variables ou dispositifs avec la Base de données et affiche la notification.</p>
<p><a class="reference internal" href="../_images/image1147.webp"><img alt="image1147" src="../_images/image1147.webp" style="width: 480px;" /></a></p>
</section>
<section id="mode-d-emploi-pour-ajouter-une-notification">
<h3>1.8.2 Mode d’emploi pour ajouter une notification<a class="headerlink" href="#mode-d-emploi-pour-ajouter-une-notification" title="Lien permanent vers cette rubrique"></a></h3>
<section id="ecriture-d-un-script-dzvent-ou-yaml">
<h4>1.8.2.1 Ecriture d’un script Dzvent ou yaml<a class="headerlink" href="#ecriture-d-un-script-dzvent-ou-yaml" title="Lien permanent vers cette rubrique"></a></h4>
<p>l’ajout concerne « Vu pour la dernière fois » (lastSeen) et « Dernière mise à jour » (LastUpdate) des dispositifs</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Domotiz et Home assistant n’affiche pas ces 2 paramètres , ZwaveJsMqtt et Zigbee2mqtt ne les envoient pas de la même façon, c’est très difficile de trouver les bonnes informations.</p>
<p>Un exemple concret dans Domoticz et Home Assistant avec Zigbee2mqtt et un interrupteur de volet roulant Tuya:</p>
</div>
<div class="admonition-les-differents-dispositifs-pour-cet-appareil-zigbee admonition">
<p class="admonition-title"><strong>les différents dispositifs pour cet appareil Zigbee</strong></p>
<p><a class="reference internal" href="../_images/image1172.webp"><img alt="image1172" src="../_images/image1172.webp" style="width: 650px;" /></a></p>
<p>Prenons 2 dispositifs Domoticz qui n’affichent pas le même last_updated:</p>
<p><a class="reference internal" href="../_images/image1173.webp"><img alt="image1173" src="../_images/image1173.webp" style="width: 379px;" /></a></p>
<p><a class="reference internal" href="../_images/image1174.webp"><img alt="image1174" src="../_images/image1174.webp" style="width: 370px;" /></a></p>
<p>l’un envoie des informations toutes les 2 ou 3 minutes tandis que l’autre attend de recevoir des informations (une commande du volet roulant pour ce dispositif); l’un est d’un type « general », l’autre d’un type « light/switch » et les subtype sont aussi différents.</p>
<p>Prenons ces 2 mêmes dispositifs dans Home Assistant qui affichent, l’un last_seen et l’autre last_updated, mais le dispositif qui nous intéresse est le même pour les 2 serveurs ce qui simplifie l’information dans la BD SQL de monitor.</p>
<p><a class="reference internal" href="../_images/image213.webp"><img alt="image213" src="../_images/image213.webp" style="width: 420px;" /></a></p>
<p><a class="reference internal" href="../_images/image214.webp"><img alt="image214" src="../_images/image214.webp" style="width: 420px;" /></a></p>
<p>c’est sensiblement identique , un vrai lastseen pour l’un des dispositifs et pour le plus utilisé un lastupdate</p>
<div class="admonition-en-conclusion-pour-zigbee admonition">
<p class="admonition-title"><strong>En conclusion pour Zigbee</strong>,</p>
<p><span class="red">il faut tenir compte de ces informations pour écrire un script qui fera le travail pour afficher un vrai LastSeen</span></p>
<p><span class="green">Pour résoudre définitivement le problème avec Zigbee, c’est de demander l’information pour un appareil à l’un des dispositifs qui affiche l’information même si ce dispositif n’est pas celui utilisé couramment</span>.</p>
<p><span class="darkblue">pour Domoticz il suffit d’utiliser les dispositifs dont le type est « general »</span></p>
<p><span class="darkblue">pour Home Assistant il suffit d’utiliser les dispositifs qui ont comme attribut « last_seen »</span></p>
</div>
</div>
<div class="admonition-lastseen-existe-peu-pour-les-appareils-zwave admonition">
<p class="admonition-title">Lastseen existe peu pour les appareils Zwave**</p>
<blockquote>
<div><p>Les informations reçues par les dispositifs Zwave sont parfois identiques aux appareils Zigbee mais souvent c’est plus compliqué; les niveaux de batterie signalés sont souvent erronés; ci dessous un exemple pour une prise de courant; Le voltage est rafraichis toutes les 2 ou 3 minutes mais la partie switch de la prise attend une commande.Les PIR, les sirènes , les contacts de portes et fenêtres, etc n’ont pas de dispositifs rafraichis aussi souvent, le Lastupdate ne correspond pas à celui affiché dans l’application Zwave-JS-UI.</p>
<p><a class="reference internal" href="../_images/image1175.webp"><img alt="image1175" src="../_images/image1175.webp" style="width: 700px;" /></a></p>
<p>Exemple pour un PIR Zwave: on ne prend pas en compte l’info « motion » car en cas d’absence cette info ne sera pas rafraichie</p>
<p><a class="reference internal" href="../_images/image259.webp"><img alt="image259" src="../_images/image259.webp" style="width: 393px;" /></a></p>
<p>Pour les contacts de porte ,le lastupdate correspond aux ouvertures ou fermetures alors que sur l’App Zwave-JS-UI le rafraichissement a lieu périodiquement.</p>
</div></blockquote>
<p><a class="reference internal" href="../_images/image249.webp"><img alt="image249" src="../_images/image249.webp" style="width: 700px;" /></a></p>
</div>
<div class="admonition-les-bases-pour-l-ecriture-d-un-script admonition">
<p class="admonition-title"><strong>les bases pour l’écriture d’un script</strong></p>
<p>Pour Zigbee, il est facile de trouver la bonne information, mais, pour les appareils Zwave ( la sirène, les PIR , etc ) les dispositifs ne fournissent cette info ni à DZ, ni à HA, pourtant présente dans Zwave-JS-UI, ce qui ne simplifie pas l’écriture d’un script.</p>
<p><a class="reference internal" href="../_images/image1176.webp"><img alt="image1176" src="../_images/image1176.webp" style="width: 550px;" /></a></p>
<p><a class="reference internal" href="../_images/image1177.webp"><img alt="image1177" src="../_images/image1177.webp" style="width: 530px;" /></a></p>
</div>
<section id="domoticz">
<h5>1.8.2.1.1 Domoticz<a class="headerlink" href="#domoticz" title="Lien permanent vers cette rubrique"></a></h5>
<p>En premier , création d’une variable, noter son nom :</p>
<p><a class="reference internal" href="../_images/image1150.webp"><img alt="image1150" src="../_images/image1150.webp" style="width: 700px;" /></a></p>
<p>En second , création de 3 variables dans le tableau de variables (string_tableaux.lua) :</p>
<ul class="simple">
<li><p>max_lastseen, pour la valeur qui considère l’appareil en défaut</p></li>
<li><p>max_lastupdate , ….idem……</p></li>
<li><p>max_bat , <em>voir ci-après le pourquoi de cette variable</em></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>à partir de monitor (<span class="darkblue">Administration-&gt;Configuation variable dz maj_services</span>) ou avec la console</p>
<p><a class="reference internal" href="../_images/image1152.webp"><img alt="image1152" src="../_images/image1152.webp" style="width: 396px;" /></a></p>
<p><a class="reference internal" href="../_images/image1153.webp"><img alt="image1153" src="../_images/image1153.webp" style="width: 441px;" /></a></p>
</div>
<div class="admonition-script-dzvent admonition">
<p class="admonition-title"><strong>Script DzVent</strong></p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Comme on vient de le voir, <span class="darkblue">Vu pour la dernière fois</span> pour l’appareil n’est pas stocké dans la base de données aussi DZ ne l’exporte pas vers le système d’événements. L’info n’est disponible que pour les dispositifs qui envoient l’information (exemple le dispositif indiquant la valeur de la tension pour une prise de courant, le dispositif on/off de la prise attend une commande et ce n’est qu’à ce moment que <span class="darkblue">vu pour la dernière fois</span> sera mis à jour). La seule façon de l’obtenir est de récupérer l’information avec l’API pour les dispositifs qui la fournissent car il n’est pas envisageable de le faire systématiquement pour tous les appareils car cela prendrait beaucoup trop de ressources système.</p>
</div>
<p>L’écriture d’un script est donc nécessaire pour obtenir la propriété lastSeen des appareils. J’ai choisi cet exemple car il permet d’appréhender l’écriture de scripts pour l’affichage ou l’envoi de notifications complexes.</p>
<p>Le script tient compte des recommandations précédentes,</p>
<ul class="simple">
<li><p>seront concernés les dispositifs de Type « General ».</p></li>
<li><p>pour Zigbee, une table des appareils avec indication du dispositif de type « general » ;</p></li>
<li><p>les dispositifs appartiennent à un Plan</p></li>
<li><p>les dispositifs virtuels et de surveillance réseau sont exclus</p></li>
<li><p>une valeur max en minutes de LastSeen est définie</p></li>
<li><p>une valeur max en heures de LastUpdate est définie</p></li>
<li><p>pour les appareils Zwave dont on ne peut obtenir un Lastseen on teste le % de la batterie et au dela d’un seuil défini</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">Script</span> <span class="n">dzVents</span> <span class="n">destiné</span> <span class="n">à</span> <span class="n">détecter</span> <span class="n">les</span> <span class="n">périphériques</span> <span class="n">morts</span> <span class="n">ou</span> <span class="n">offline</span><span class="o">.</span>

<span class="o">--</span> <span class="n">chargement</span> <span class="n">fichier</span> <span class="n">contenant</span> <span class="n">les</span> <span class="n">variable</span> <span class="n">de</span> <span class="n">configuration</span>
<span class="n">package</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;;www/modules_lua/?.lua&quot;</span>
<span class="n">require</span> <span class="s1">&#39;string_tableaux&#39;</span> <span class="o">--</span> <span class="n">variable</span> <span class="n">concernée</span> <span class="p">:</span> <span class="n">max_lastseen</span>  <span class="nb">max</span> <span class="n">update</span> <span class="n">et</span> <span class="n">max_bat</span>
<span class="n">require</span> <span class="s1">&#39;connect&#39;</span>
<span class="n">require</span> <span class="s1">&#39;table_zb_zw&#39;</span>
<span class="n">adresse_mail</span><span class="o">=</span><span class="n">mail_gmail</span> <span class="o">--</span> <span class="n">mail_gmail</span> <span class="n">dans</span> <span class="n">connect</span><span class="o">.</span><span class="n">lua</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s</span><span class="o">..</span><span class="n">delimiter</span><span class="p">):</span><span class="n">gmatch</span><span class="p">(</span><span class="s1">&#39;(.-)&#39;</span><span class="o">..</span><span class="n">delimiter</span><span class="p">)</span> <span class="n">do</span>
          <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
  <span class="n">end</span>
  <span class="k">return</span> <span class="n">result</span>
<span class="n">end</span>

<span class="n">local</span> <span class="n">ls</span><span class="o">=</span><span class="mi">0</span>
<span class="n">local</span> <span class="n">scriptVar</span> <span class="o">=</span> <span class="s1">&#39;lastSeen&#39;</span>
<span class="n">local</span> <span class="n">test</span><span class="o">=</span><span class="mi">0</span>
<span class="k">return</span> <span class="p">{</span>
    <span class="n">on</span> <span class="o">=</span> <span class="p">{</span> <span class="n">timer</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;at 17:50&#39;</span><span class="p">},</span> <span class="n">httpResponses</span> <span class="o">=</span> <span class="p">{</span> <span class="n">scriptVar</span> <span class="p">}},</span>
    <span class="n">logging</span> <span class="o">=</span> <span class="p">{</span> <span class="n">level</span>   <span class="o">=</span> <span class="n">domoticz</span><span class="o">.</span><span class="n">LOG_ERROR</span><span class="p">,</span> <span class="n">marker</span>  <span class="o">=</span> <span class="n">scriptVar</span> <span class="p">},</span>

    <span class="n">execute</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">dz</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">isHTTPResponse</span><span class="p">)</span> <span class="n">then</span>
            <span class="n">dz</span><span class="o">.</span><span class="n">openURL</span><span class="p">({</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Domoticz url&#39;</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39;/json.htm?type=command&amp;param=getdevices&#39;</span><span class="p">,</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="n">scriptVar</span> <span class="p">})</span>
        <span class="k">else</span>
            <span class="n">local</span> <span class="n">Time</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">);</span><span class="n">local</span> <span class="n">lastup</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="n">listidx</span><span class="o">=</span><span class="s2">&quot;lastseen#&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="n">do</span>
                <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nombre_enr</span> <span class="n">do</span>
                  <span class="k">if</span> <span class="n">liste_ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">idx</span> <span class="ow">and</span> <span class="n">liste_ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;lastseen&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s2">&quot;non&quot;</span>  <span class="n">then</span> <span class="n">test</span><span class="o">=</span><span class="mi">1</span>
                  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------essai&#39;</span><span class="p">,</span><span class="s1">&#39;l=&#39;</span><span class="p">,</span><span class="n">liste_ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                  <span class="k">else</span> <span class="n">test</span><span class="o">=</span><span class="mi">0</span>
                  <span class="n">end</span>
                <span class="n">end</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">HardwareName</span> <span class="o">~=</span> <span class="s2">&quot;virtuels&quot;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">HardwareName</span> <span class="o">~=</span> <span class="s2">&quot;surveillance réseau&quot;</span>  <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">HardwareType</span> <span class="o">~=</span> <span class="s2">&quot;Linky&quot;</span>  <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">PlanID</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span> <span class="n">test</span><span class="o">==</span><span class="mi">0</span> <span class="n">then</span>

                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;General&quot;</span> <span class="n">then</span>
                          <span class="n">local</span> <span class="n">lastSeen</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LastUpdate</span><span class="p">)</span><span class="o">.</span><span class="n">minutesAgo</span>
                          <span class="k">if</span> <span class="n">lastSeen</span> <span class="o">&gt;=</span><span class="n">max_lastseen</span> <span class="n">then</span> <span class="o">--</span> <span class="n">limite</span> <span class="n">en</span> <span class="n">heure</span> <span class="n">pour</span> <span class="n">considérer</span> <span class="n">le</span> <span class="n">dispositif</span> <span class="n">on</span> <span class="n">line</span>
                          <span class="n">lastup</span> <span class="o">=</span> <span class="n">lastup</span><span class="o">..</span><span class="s1">&#39;idx:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">idx</span><span class="o">..</span><span class="s1">&#39;,&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">Name</span><span class="o">..</span><span class="s1">&#39; lastseen:&#39;</span><span class="o">..</span><span class="n">lastSeen</span><span class="o">..</span><span class="s1">&#39;&lt;br&gt;&#39;</span>
                          <span class="n">listidx</span><span class="o">=</span><span class="n">listidx</span><span class="o">..</span><span class="s1">&#39; &#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">idx</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">Name</span><span class="o">..</span><span class="s1">&#39;Lastseen:&#39;</span><span class="o">..</span><span class="n">tostring</span><span class="p">(</span><span class="n">lastSeen</span><span class="p">)</span><span class="o">..</span><span class="s1">&#39; / &#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">LastUpdate</span><span class="o">..</span><span class="s1">&#39;&lt;br&gt;&#39;</span>
                          <span class="n">ls</span><span class="o">=</span><span class="mi">1</span>
                          <span class="n">end</span>
                    <span class="n">elseif</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;zwavejs2mqtt&quot;</span><span class="p">)</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
                          <span class="n">local</span> <span class="n">lastUpdated</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LastUpdate</span><span class="p">)</span><span class="o">.</span><span class="n">hoursAgo</span>
                          <span class="k">if</span> <span class="n">lastUpdated</span> <span class="o">&gt;</span> <span class="n">max_lastupdate</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">BatteryLevel</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="n">then</span>
                           <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                          <span class="n">lastup</span> <span class="o">=</span> <span class="n">lastup</span><span class="o">..</span><span class="s1">&#39;idx:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">idx</span><span class="o">..</span><span class="s1">&#39;,&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">Name</span><span class="o">..</span><span class="s1">&#39;,LastUpdate:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">LastUpdate</span><span class="o">..</span><span class="s1">&#39;bat:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">BatteryLevel</span><span class="o">..</span><span class="s1">&#39;&lt;br&gt;&#39;</span>
                          <span class="n">listidx</span><span class="o">=</span><span class="n">listidx</span><span class="o">..</span><span class="s1">&#39; &#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">idx</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">Name</span><span class="o">..</span><span class="s1">&#39;LastUpdate:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">LastUpdate</span><span class="o">..</span><span class="s1">&#39;bat:&#39;</span><span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">BatteryLevel</span><span class="o">..</span><span class="s1">&#39;&lt;br&gt;&#39;</span>
                          <span class="n">ls</span><span class="o">=</span><span class="mi">3</span>
                          <span class="n">end</span>
                     <span class="n">end</span>
            <span class="n">end</span>
                  <span class="o">--</span><span class="n">dz</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;id &#39;</span><span class="o">..</span>  <span class="n">node</span><span class="o">.</span><span class="n">idx</span> <span class="o">..</span> <span class="s1">&#39;(&#39;</span>  <span class="o">..</span><span class="n">node</span><span class="o">.</span><span class="n">Name</span> <span class="o">..</span> <span class="s1">&#39;) lastSeen &#39;</span> <span class="o">..</span> <span class="n">lastSeen</span> <span class="p">,</span><span class="n">dz</span><span class="o">.</span><span class="n">LOG_FORCE</span><span class="p">)</span>
         <span class="n">end</span>
       <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ls=&quot;</span><span class="o">..</span><span class="n">ls</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">ls</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">then</span>
       <span class="n">dz</span><span class="o">.</span><span class="n">variables</span><span class="p">(</span><span class="s1">&#39;lastseen&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">listidx</span><span class="p">)</span>
       <span class="n">obj</span><span class="o">=</span><span class="s1">&#39;alarme lastseen: &#39;</span><span class="o">..</span><span class="n">listidx</span><span class="p">;</span><span class="n">dz</span><span class="o">.</span><span class="n">email</span><span class="p">(</span><span class="s1">&#39;LastSeen&#39;</span><span class="p">,</span><span class="n">lastup</span><span class="p">,</span><span class="n">adresse_mail</span><span class="p">)</span>
       <span class="n">ls</span><span class="o">=</span><span class="mi">0</span>
       <span class="n">end</span>
    <span class="n">end</span>
 <span class="n">end</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>objet domoticz</strong> : <em>domoticz ou dz mais c’est l’un ou l’autre dans le script</em></p>
</div>
</div>
<p>La table des dispositifs  Zigbee &amp; Zwave</p>
<p><a class="reference internal" href="../_images/image149.webp"><img alt="image149" src="../_images/image149.webp" style="width: 500px;" /></a></p>
<p>Cette table est créée automatquement par monitor à partir des infos de la base de données, voir ce § <a class="reference internal" href="bien_debuter.html#les-dispositifs"><span class="std std-ref">0.3.2 Les Dispositifs</span></a></p>
<p>Elle permet de sélectionner le meilleur dispositif qui affiche le dernier « vu pour la dernière fois »</p>
</section>
<section id="la-variable-lastseen">
<h5>1.8.2.1.2 La variable lastseen<a class="headerlink" href="#la-variable-lastseen" title="Lien permanent vers cette rubrique"></a></h5>
<blockquote>
<div><p><a class="reference internal" href="../_images/image1151.webp"><img alt="image1151" src="../_images/image1151.webp" style="width: 459px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Quelques explications</strong></p>
<p>Comme on peut le voir le caactère # sépare le texte pour la table « text_image » (affichage de l’icone) et le contenu de la notification; on peut retrouver ce contenu  dans la donnée « contenu » du fichier Json reçu par monitor.</p>
<p><a class="reference internal" href="../_images/image1162.webp"><img alt="image1162" src="../_images/image1162.webp" style="width: 523px;" /></a></p>
</div>
</div></blockquote>
</section>
<section id="home-assistant">
<h5>1.8.2.1.3 Home Assistant<a class="headerlink" href="#home-assistant" title="Lien permanent vers cette rubrique"></a></h5>
<p><span class="red">Comme pour Domoticz, Zwave-JS-UI est le problème</span></p>
<p>Dans HA, on ne peut, comme dans DZ utiliser des variables globales aussi les valeurs max seront définies dans le script.</p>
<p>Pour l’annulation de la notification, création d’un switch binaire, nommé ici « essai1 »:</p>
<p><a class="reference internal" href="../_images/image130.webp"><img alt="image130" src="../_images/image130.webp" style="width: 317px;" /></a></p>
<p>Créer 2 automatisations :</p>
<ul class="simple">
<li><p>la première pour déterminer les dispositifs concernés par « lastseen » et envoyer des notifications</p></li>
<li><p>la 2eme pour effacer la notification</p></li>
</ul>
<div class="admonition-script-yaml-lastseen admonition">
<p class="admonition-title"><strong>script yaml « lastseen »</strong></p>
<div class="admonition-notification-sur-l-appli admonition">
<p class="admonition-title"><strong>notification sur l’appli</strong></p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>C’est cette notification dans un « input_text » que monitor va utiliser pour l’afficher sur son écran d’accueil, mais pour la composition des messages on va utiliser un fichier qui ne limite pas le texte à 255 caractères.</p>
<p>Les notifications sont redontantes, il suffit de supprimer celles qui ne vous seront pas utiles.</p>
<p><a class="reference internal" href="../_images/image144.webp"><img alt="image144" src="../_images/image144.webp" style="width: 400px;" /></a></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><a class="reference internal" href="../_images/image173.webp"><img alt="image173" src="../_images/image173.webp" style="width: 335px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>lastseen ou lastseen1 ou ..autre, voir § suivant</p>
</div>
</div>
</div>
<p>merci à <strong>OzGav</strong> <em>https://community.home-assistant.io/u/OzGav</em>, je me suis inspiré de son script et je l’ai simplifié.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- id: lastseen_alerte_dispositifs
  alias: LastSeen Alerte Dispositifs
  trigger:
   - platform: time
       at: &#39;23:11:00&#39;
  condition:
  - condition: template
    value_template: &#39;{% set ns = namespace(break = false) %} {% for state in states
    -%} {%- if state.attributes.last_seen %} {%- if (as_timestamp(now()) - as_timestamp(state.attributes.last_seen)
    &gt; (60 * 25) ) and ns.break == false %} {%- set ns.break = true %} true   {%-
    endif -%} {%- endif -%}{%- endfor %}&#39;
  action:
- service: input_text.set_value
    target:
    entity_id: input_text.essai
    data:
      value: &quot;Certains appareils Zigbee n’ont pas été vus dernièrement...\n  {% for
        state in (expand(states.sensor, states.binary_sensor, states.light, states.switch)
          | selectattr(&#39;attributes.last_seen&#39;, &#39;defined&#39;)) -%}\n    {%- if not (state.name
          | regex_search(&#39;linkquality|button_fan|update state|voltage|temperature|battery|illuminance&#39;))
          %}\n      {%- if (as_timestamp(now()) - as_timestamp(state.attributes.last_seen)
          &gt; (60 * 25) ) %}\n        {{ ((as_timestamp(now()) - as_timestamp(state.attributes.last_seen))
          / (3600)) | round(1) }} hours ago for {{ state.name }}            \n      {%-
          endif -%}\n    {%- endif -%}\n  {%- endfor %}\n&quot;
- service: rest_command.domoticz_1
  data:
    svalue: &quot;{{ states(&#39;input_text.essai&#39;) }}&quot;
- service: persistent_notification.create
  data:
    notification_id: not_lastseen
    title: Lastseen
    message: !include message2.yaml
- service: notify.email
  data:
    title: alerte dispositifs
    message: !include message2.yaml
- service: notify.mobile_app_RMO_NX1
  data:
    message: !include message2.yaml
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Le script précédent montre les possibilités pour le texte des messages pour éviter des répétitions;</p>
<p>Qelques explications : le fichier message2.yaml contient (aux n remplcé par &lt;br&gt;) près la valeur pour input_text.essai</p>
<p><a class="reference internal" href="../_images/image411.webp"><img alt="image411" src="../_images/image411.webp" style="width: 700px;" /></a></p>
<p>Pour la rest_command on utilise la valeur de (et non pour) de input_text.essai</p>
<p><a class="reference internal" href="../_images/image412.webp"><img alt="image412" src="../_images/image412.webp" style="width: 700px;" /></a></p>
<p>pour cet essai j’ai crée un dispostif virtuel dans Domoticz appelé « message1 » qui reçoit par l’API la valeur de input_text.essai</p>
<p><a class="reference internal" href="../_images/image413.webp"><img alt="image413" src="../_images/image413.webp" style="width: 383px;" /></a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour une notification par Email , dans <span class="darkblue">/config/configuration.yaml</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">notify</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span>
    <span class="n">platform</span><span class="p">:</span> <span class="n">smtp</span>
    <span class="n">server</span><span class="p">:</span> <span class="s2">&quot;smtp.orange.fr&quot;</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">587</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="mi">15</span>
    <span class="n">encryption</span><span class="p">:</span> <span class="n">starttls</span>
    <span class="n">username</span><span class="p">:</span> <span class="s2">&quot;NOM_UTILISATEUR&quot;</span>
    <span class="n">password</span><span class="p">:</span> <span class="s2">&quot;MOT DE PASSE&quot;</span>
    <span class="n">sender</span><span class="p">:</span> <span class="s2">&quot;EMAIL_EXPEDITEUR&quot;</span>
    <span class="n">recipient</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;EMAIL_DESTINATAIRE&quot;</span>
    <span class="n">sender_name</span><span class="p">:</span> <span class="s2">&quot;NOM_EXPEDITEUR&quot;</span>
    <span class="n">debug</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<p><a class="reference internal" href="../_images/image1169.webp"><img alt="image1169" src="../_images/image1169.webp" style="width: 650px;" /></a></p>
<p>Pour la notification dans l’Appli HA, Vérifier que dans la config par defaut, <span class="green">mobile_app</span> est présent</p>
<p><a class="reference internal" href="../_images/image1170.webp"><img alt="image1170" src="../_images/image1170.webp" style="width: 421px;" /></a></p>
<p>Les notifications sur le smartphone :</p>
<p><a class="reference internal" href="../_images/image1171.webp"><img alt="image1171" src="../_images/image1171.webp" style="width: 300px;" /></a> <a class="reference internal" href="../_images/image154.webp"><img alt="image154" src="../_images/image154.webp" style="width: 250px;" /></a></p>
</div>
<p><strong>Second script automation:</strong></p>
<div class="admonition-effacement-de-la-notification admonition">
<p class="admonition-title"><strong>Effacement de la notification</strong></p>
<p><em>à partir du bouton binaire crée précédemment</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">-</span> <span class="nb">id</span><span class="p">:</span> <span class="n">d9988583</span><span class="o">-</span><span class="mi">5210</span><span class="o">-</span><span class="mf">456e-9</span><span class="n">e98</span><span class="o">-</span><span class="mi">5</span><span class="n">c242d484566</span>
<span class="n">alias</span><span class="p">:</span> <span class="n">annulation</span> <span class="n">notification</span> <span class="n">lastseen</span>
<span class="n">trigger</span><span class="p">:</span>
<span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">state</span>
  <span class="n">entity_id</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">input_boolean</span><span class="o">.</span><span class="n">essai</span>
  <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;on&#39;</span>
  <span class="n">from</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span>
<span class="n">condition</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">action</span><span class="p">:</span>
<span class="o">-</span> <span class="n">delay</span><span class="p">:</span>
    <span class="n">milliseconds</span><span class="p">:</span> <span class="mi">500</span>
<span class="o">-</span> <span class="n">service</span><span class="p">:</span> <span class="n">input_boolean</span><span class="o">.</span><span class="n">turn_off</span>
  <span class="n">target</span><span class="p">:</span>
    <span class="n">entity_id</span><span class="p">:</span> <span class="n">input_boolean</span><span class="o">.</span><span class="n">essai</span>
<span class="o">-</span> <span class="n">service</span><span class="p">:</span> <span class="n">input_text</span><span class="o">.</span><span class="n">set_value</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
  <span class="n">target</span><span class="p">:</span>
    <span class="n">entity_id</span><span class="p">:</span> <span class="n">input_text</span><span class="o">.</span><span class="n">essai</span>
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image131.webp"><img alt="image131" src="../_images/image131.webp" style="width: 589px;" /></a></p>
</div>
<p><strong>Essai à partir de monitor:</strong></p>
<p><a class="reference internal" href="../_images/image157.webp"><img alt="image157" src="../_images/image157.webp" style="width: 700px;" /></a></p>
</section>
<section id="io-broker">
<h5>1.8.2.1.4 Io.Broker<a class="headerlink" href="#io-broker" title="Lien permanent vers cette rubrique"></a></h5>
<p>en cours de rédaction</p>
</section>
</section>
<section id="la-page-d-accueil-de-monitor-include-accueil-php">
<h4>1.8.2.2  La page d’accueil de monitor : include/accueil.php<a class="headerlink" href="#la-page-d-accueil-de-monitor-include-accueil-php" title="Lien permanent vers cette rubrique"></a></h4>
<p><a class="reference internal" href="../_images/image127.webp"><img alt="image127" src="../_images/image127.webp" style="width: 500px;" /></a></p>
<p>Soit un emplacement disponible est utilisé (voir le § suivant), soit on définit un emplacement:</p>
<ul class="simple">
<li><p>on indique l’idx de Domoticz ou l’ID de HA ( utilisé pour l’effacement de la notification)</p></li>
<li><p>on indique l’ID de l’image</p></li>
<li><p>on indique la class de la &lt;div si besoin, en  plus de la class « confirm »</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!-- 1ere ligne pour DZ, la 2eme pour HA--&gt;
&lt;!-- Les ID sont différentes afin de pouvoir utiliser les 2 sources--&gt;
&lt;div class=&quot;confirm lastseen&quot;&gt;&lt;a href=&quot;#&quot; id=&quot;annul_lastseen&quot; rel=&quot;34&quot; title=&quot;Annulation de l&#39;alerte lastseen&quot;&gt;&lt;img id=&quot;lastseen&quot; src=&quot;&quot;/&gt;&lt;/a&gt;&lt;/div&gt;
&lt;div class=&quot;confirm lastseen1&quot;&gt;&lt;a href=&quot;#&quot; id=&quot;annul_lastseen1&quot; rel=&quot;input_text.essai&quot; title=&quot;Annulation de l&#39;alerte lastseen&quot;&gt;&lt;img id=&quot;lastseen1&quot; src=&quot;&quot;/&gt;&lt;/a&gt;&lt;/div&gt;
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image128.webp"><img alt="image128" src="../_images/image128.webp" style="width: 500px;" /></a></p>
<ul class="simple">
<li><p>on choisit une image placée dans le répertoire <span class="darkblue">image</span></p></li>
</ul>
<p><a class="reference internal" href="../_images/image129.webp"><img alt="image129" src="../_images/image129.webp" style="width: 155px;" /></a></p>
</section>
</section>
<section id="les-emplacements-disponibles-et-les-styles-css">
<h3>1.8.3 les emplacements disponibles et les styles css<a class="headerlink" href="#les-emplacements-disponibles-et-les-styles-css" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pour cet exemple l’ID (lastseen) est imposé mais 4 id’s pré programmés sont disponibles; les styles associés sont déclarés dans le fichier <span class="darkblue">custom/css/styles.css</span>:</p>
<p>la classe .lastseen créee:</p>
<p><a class="reference internal" href="../_images/image1155.webp"><img alt="image1155" src="../_images/image1155.webp" style="width: 250px;" /></a></p>
<p>les classes pré programmées :notif1, notif2, notif3, notif4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">notif1</span><span class="p">,</span><span class="o">.</span><span class="n">notif2</span><span class="p">,</span><span class="o">.</span><span class="n">notif3</span><span class="p">,</span><span class="o">.</span><span class="n">notif4</span><span class="p">{</span><span class="n">width</span><span class="p">:</span> <span class="mi">50</span><span class="n">px</span><span class="p">;</span>
 <span class="n">height</span><span class="p">:</span> <span class="mi">50</span><span class="n">px</span><span class="p">;</span>
 <span class="n">position</span><span class="p">:</span> <span class="n">absolute</span><span class="p">;</span>
 <span class="n">Top</span><span class="p">:</span> <span class="mi">600</span><span class="n">px</span><span class="p">;</span>
 <span class="p">}</span>
<span class="o">.</span><span class="n">notif1</span><span class="p">{</span><span class="n">left</span><span class="p">:</span><span class="mi">50</span><span class="n">px</span><span class="p">;</span><span class="n">display</span><span class="p">:</span><span class="n">none</span><span class="p">}</span>
<span class="o">.</span><span class="n">notif2</span><span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="mi">120</span><span class="n">px</span><span class="p">;</span><span class="n">display</span><span class="p">:</span><span class="n">none</span><span class="p">}</span>
<span class="o">.</span><span class="n">notif3</span><span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="mi">190</span><span class="n">px</span><span class="p">;</span><span class="n">display</span><span class="p">:</span><span class="n">none</span><span class="p">}</span>
<span class="o">.</span><span class="n">notif4</span><span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="mi">260</span><span class="n">px</span><span class="p">;</span><span class="n">display</span><span class="p">:</span><span class="n">none</span><span class="p">}</span>
</pre></div>
</div>
<p>Les emplacements de ces IDs disponibles sur la page d’accueil:</p>
<p><a class="reference internal" href="../_images/image1156.webp"><img alt="image1156" src="../_images/image1156.webp" style="width: 524px;" /></a></p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>chaque icone sera celle indiquée dans la table SQL <span class="darkblue">text-image</span></p>
</div>
<p>les ID étant soit notif1, notif2, notif3 ou notif4</p>
</section>
<section id="enregistrement-de-la-variable-dans-la-base-sql">
<h3>1.8.4 Enregistrement de la variable dans la base SQL<a class="headerlink" href="#enregistrement-de-la-variable-dans-la-base-sql" title="Lien permanent vers cette rubrique"></a></h3>
<p><em>et pour HA du switch binaire, option facultative</em></p>
<ul class="simple">
<li><p><em>Avec monitor</em>:</p></li>
</ul>
<p><a class="reference internal" href="../_images/image1158.webp"><img alt="image1158" src="../_images/image1158.webp" style="width: 414px;" /></a></p>
<ul class="simple">
<li><p><em>Avec PhpMyAdmin</em>: les tables <span class="darkblue">text-image`text-image</span> et <span class="green">dispositifs</span></p></li>
</ul>
<p><a class="reference internal" href="../_images/image1159.webp"><img alt="image1159" src="../_images/image1159.webp" style="width: 561px;" /></a></p>
<p><a class="reference internal" href="../_images/image1160.webp"><img alt="image1160" src="../_images/image1160.webp" style="width: 700px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le switch binaire de HA est activé par la commande « CLOSE » du popup qui affiche la notification; il n’y a donc pas d’ID utilisé par JQuery pour commander ce switch.</p>
<p>La création des scripts pour les switches étant automatique , <span class="red">un ID vide n’est pas permit d’ou cet ID: inactif</span></p>
<p><span class="green">Il est aussi possible de ne pas enregistrer ce switch binaire dans la BD bien qu’il soit utlisé par monitor, c’est la solution la plus simple.</span></p>
</div>
<p>La variable <span class="darkblue">contenu</span> du fichier Json reçu par monitor un jour de défaillance de la clé zigbee:</p>
<p><a class="reference internal" href="../_images/image1157.webp"><img alt="image1157" src="../_images/image1157.webp" style="width: 533px;" /></a></p>
<p>La même variable lors d’un seul dispositif en défaut:</p>
<p><a class="reference internal" href="../_images/image1166.webp"><img alt="image1166" src="../_images/image1166.webp" style="width: 577px;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>la valeur de Lastseen est en heures , le delta correspond à la différence entre LastUpdate et Lasteen.</p></li>
</ul>
</div>
</section>
<section id="affichage-dans-monitor">
<h3>1.8.5 Affichage dans monitor<a class="headerlink" href="#affichage-dans-monitor" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image1161.webp"><img alt="image1161" src="../_images/image1161.webp" style="width: 500px;" /></a></p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>il y a un nombre important de dispositifs du au réglage des valeurs max : avec d’autres valeurs plus normales  , seulement un dispositif n’a pas communiqué depuis la valeur max choisie.</p>
<p>Pour <strong>Zigbee</strong>, sur mon installation, « vu pour la dernière fois » ne dépasse pas <span class="red">22 minutes</span>.</p>
</div>
<p><a class="reference internal" href="../_images/image1167.webp"><img alt="image1167" src="../_images/image1167.webp" style="width: 500px;" /></a></p>
<p>accueil.php, css et table « text_image » concernant cet affichage:</p>
<p><a class="reference internal" href="../_images/image146.webp"><img alt="image146" src="../_images/image146.webp" style="width: 700px;" /></a></p>
<section id="function-status-variables-xx-dans-fonctions-php">
<h4>1.8.5.1 function status_variables($xx) dans fonctions.php<a class="headerlink" href="#function-status-variables-xx-dans-fonctions-php" title="Lien permanent vers cette rubrique"></a></h4>
<p><a class="reference internal" href="../_images/image1163.webp"><img alt="image1163" src="../_images/image1163.webp" style="width: 600px;" /></a></p>
<p>La variable « lastseen » de domoticz ou l’input_text de Home Assistant « essai » ont pour valeur une chaine composée du nom du texte de la table « text-image » et du contenu correspondant aux disposifs off line ou morts, ces 2 valeurs séparés par le caractère <span class="red">#</span>; voir ce § <a class="reference internal" href="#la-variable-lastseen"><span class="std std-ref">1.8.2.1.2 La variable lastseen</span></a></p>
<p>Pour décomposer cette chaîne en 2 valeurs d’un tableau, on utilise la fonction PHP <span class="green">explode</span>: pour résumer, <em>si « value » contient # on la découpe en value et contenu</em>.</p>
</section>
<section id="script-jquery-dans-footer-php">
<h4>1.8.5.2 script Jquery dans footer.php<a class="headerlink" href="#script-jquery-dans-footer-php" title="Lien permanent vers cette rubrique"></a></h4>
<p><a class="reference internal" href="../_images/image1164.webp"><img alt="image1164" src="../_images/image1164.webp" style="width: 600px;" /></a></p>
<p>on récupére la valeur de contenu pour l’afficher dans un popup qui permet d’annuler la notification</p>
<p><a class="reference internal" href="../_images/image148.webp"><img alt="image148" src="../_images/image148.webp" style="width: 700px;" /></a></p>
<p>Suivant le serveur domotique la fonction pour l’effacement de la notification est différente.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Split est utilisé pour découper l” input_text.NOM_DE_L_ENTITE et récuperer le nom de l’entité pour ainsi créer le input_boolean.NOM_DE_L_ENTITE.</p>
<p>Il n’est pas necessaire de créer ce switch binaire dans SQL mais les <span class="red">2 entités doivent porter le même nom</span></p>
</div>
</section>
</section>
<section id="reception-du-mail-de-notification">
<h3>1.8.6 Réception du mail de notification<a class="headerlink" href="#reception-du-mail-de-notification" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference internal" href="../_images/image1165.webp"><img alt="image1165" src="../_images/image1165.webp" style="width: 449px;" /></a></p>
<p><a class="reference internal" href="../_images/image1168.webp"><img alt="image1168" src="../_images/image1168.webp" style="width: 450px;" /></a></p>
</section>
</section>
<section id="acces-distant-https">
<h2>1.9 Accès distant HTTPS<a class="headerlink" href="#acces-distant-https" title="Lien permanent vers cette rubrique"></a></h2>
<p>voir cette page web : <a class="reference external" href="http://domo-site.fr/accueil/dossiers/3">http://domo-site.fr/accueil/dossiers/3</a></p>
<section id="monitor-conf">
<h3>1.9.1 monitor.conf<a class="headerlink" href="#monitor-conf" title="Lien permanent vers cette rubrique"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>upstream monitor {
     server 192.168.1.9;
}
server {
 server_name  monitor.&lt;DOMAINE&gt;;
 root /var/www/html/monitor;
 index  index.php index.html index.htm;

location ~ \.php$ {
     fastcgi_split_path_info ^(.+\.php)(/.+)$;
     fastcgi_pass   unix:/var/run/php/php8.2-fpm.sock;
     fastcgi_index  index.php;
     fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
     include        fastcgi_params;
 }

 listen 443 ssl; # managed by Certbot
 ssl_certificate /etc/letsencrypt/live/&lt;DOMAINE&gt;fullchain.pem; # managed by Certbot
 ssl_certificate_key /etc/letsencrypt/live/&lt;DOMAINE&gt;/privkey.pem; # managed by Certbot
 include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
 ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
 if ($host = monitor.&lt;DOMAINE&gt;) {
     return 301 https://$host$request_uri;
 } # managed by Certbot

 listen       80;
 server_name  monitor.&lt;DOMAINE&gt;;
 return 404; # managed by Certbot
}
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ce fichier est pour un accès en https, avec PHP 8.2</p>
<p><em>un nom de domaine doit être demandé auprès d’un fournisseur</em></p>
<p><em>le certificat peut être fourni gratuitement par Let’sEncrypt</em></p>
<p>Comment installer Let’s Encrypt sur Nginx : <a class="reference external" href="https://upcloud.com/resources/tutorials/install-lets-encrypt-nginx">https://upcloud.com/resources/tutorials/install-lets-encrypt-nginx</a></p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="bien_debuter.html" class="btn btn-neutral float-left" title="0. Infos pour bien débuter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="plan_interieur.html" class="btn btn-neutral float-right" title="2. Une 1ere PAGE : LE PLAN INTERIEUR" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2024, Gravier.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>