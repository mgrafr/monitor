
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&lt;no title&gt; &#8212; monitor-domotique 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="toctree-wrapper compound">
</div>
<div class="line-block">
<div class="line"><a class="reference internal" href="media/image1.webp"><img alt="image1" src="media/image1.webp" style="width: 0.27917in; height: 0.27917in;" /></a> <strong>Logiciel monitor version 2.2.0</strong> <em>maj manuel 2.2.1 du
27/07/2023</em></div>
<div class="line"><strong>Compatible Domoticz &amp; Home assistant</strong></div>
</div>
<p><strong>Dernières modifications :</strong></p>
<p><span class="xref std std-doc">guides/modifications</span></p>
<p><a class="reference internal" href="_images/image2.webp"><img alt="image2" src="_images/image2.webp" style="width: 0.64583in; height: 0.61389in;" /></a> Tous les fichiers sont sur Github :</p>
<div class="line-block">
<div class="line"><strong>Sommaire :</strong></div>
</div>
<dl>
<dt>:doc:’sommaire’</dt><dd><p><strong>0._Infos pour bien débuter</strong></p>
<p><strong>0.1Prérequis, installation :</strong> différents choix</p>
<ul class="simple">
<li><p>Après <em>l’installation de Proxmox :</em></p></li>
</ul>
<p>Installation automatique : conteneur LXC, LEMP (Linux, Nginx, Maria
DB, PHP),</p>
<p>monitor :</p>
<ul class="simple">
<li><p>installation automatique : LEMP + monitor (pour installation dans</p></li>
</ul>
<p>une VM ou une partition Linux) :</p>
<ul class="simple">
<li><p>installation uniquement de monitor (pour une installation avec</p></li>
</ul>
<p>LAMP, MySQL,) :</p>
<p><strong>0.1.1 installation automatique d’un conteneur LXC +LEMP+ monitor</strong>
- L’installation de Proxmox voir ce <em>paragraphe.</em></p>
<ul class="simple">
<li><p>Création d’un conteneur LXC</p></li>
<li><p>Debian 12, et les dépendances sudo, curl, ….</p></li>
</ul>
<div class="line-block">
<div class="line">- Nginx, PHP 8.2, maria db, phpMyAdmin, monitor - Quelques
programme python utiles : pip, Paho-mqtt - Un utilisateur système
est crée</div>
<div class="line">- Un utilisateur MySQL PMA et monitor est aussi crée</div>
</div>
<div class="line-block">
<div class="line">Télécharger depuis le Shell de PVE le fichier d’installation
install.sh :</div>
<div class="line">wget</div>
</div>
<a class="reference internal image-reference" href="_images/image3.webp"><img alt="_images/image3.webp" src="_images/image3.webp" style="width: 6.3in; height: 1.83472in;" /></a>
<p>Donner des autorisations au fichier « create_ct_lxc_monitor.sh »
chmod +x create_ct_lxc_monitor.sh</p>
<a class="reference internal image-reference" href="_images/image4.webp"><img alt="_images/image4.webp" src="_images/image4.webp" style="width: 3.42778in; height: 0.30278in;" /></a>
</dd>
</dl>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">Si des problèmes de lecture existent, convertir le fichier en
UNIX – installer do2unix <em>: apt install dos2unix</em></div>
<div class="line">ocommande : dos2unix NOM_FICHIER (<em>ex : dos2unix</em>
<em>lemp_install.sh)</em></div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>Installation :</strong> ./create_ct_lxc_monitor.sh</p>
<a class="reference internal image-reference" href="media/image5.png"><img alt="media/image5.png" src="media/image5.png" style="width: 3.42778in; height: 0.3125in;" /></a>
<a class="reference internal image-reference" href="media/image6.png"><img alt="media/image6.png" src="media/image6.png" style="width: 4.21944in; height: 1.08333in;" /></a>
<a class="reference internal image-reference" href="media/image7.png"><img alt="media/image7.png" src="media/image7.png" style="width: 5.60556in; height: 2.02083in;" /></a>
</div></blockquote>
<a class="reference internal image-reference" href="media/image8.png"><img alt="media/image8.png" src="media/image8.png" style="width: 5.66806in; height: 1.77083in;" /></a>
<a class="reference internal image-reference" href="media/image9.png"><img alt="media/image9.png" src="media/image9.png" style="width: 5.77222in; height: 2.875in;" /></a>
<p>Choisir le langage UTF-8 : fr_FR.UTF-8</p>
<a class="reference internal image-reference" href="media/image10.png"><img alt="media/image10.png" src="media/image10.png" style="width: 6.30139in; height: 5.00694in;" /></a>
<a class="reference internal image-reference" href="media/image11.png"><img alt="media/image11.png" src="media/image11.png" style="width: 5.78333in; height: 2.33333in;" /></a>
<a class="reference internal image-reference" href="media/image12.png"><img alt="media/image12.png" src="media/image12.png" style="width: 5.80278in; height: 2.80278in;" /></a>
<a class="reference internal image-reference" href="media/image13.png"><img alt="media/image13.png" src="media/image13.png" style="width: 5.75139in; height: 1.89583in;" /></a>
<a class="reference internal image-reference" href="media/image14.png"><img alt="media/image14.png" src="media/image14.png" style="width: 6.30139in; height: 5.84583in;" /></a>
<a class="reference internal image-reference" href="media/image15.png"><img alt="media/image15.png" src="media/image15.png" style="width: 5.63611in; height: 1.83333in;" /></a>
<a class="reference internal image-reference" href="media/image16.png"><img alt="media/image16.png" src="media/image16.png" style="width: 5.69861in; height: 2.77083in;" /></a>
<a class="reference internal image-reference" href="media/image17.png"><img alt="media/image17.png" src="media/image17.png" style="width: 5.82222in; height: 5.10417in;" /></a>
<p>Sécuriser Maria DB, mot passe root</p>
<a class="reference internal image-reference" href="media/image18.png"><img alt="media/image18.png" src="media/image18.png" style="width: 5.86528in; height: 1.99028in;" /></a>
<a class="reference internal image-reference" href="media/image19.png"><img alt="media/image19.png" src="media/image19.png" style="width: 6.05278in; height: 2.37083in;" /></a>
<a class="reference internal image-reference" href="media/image20.png"><img alt="media/image20.png" src="media/image20.png" style="width: 6.05278in; height: 2.08333in;" /></a>
<a class="reference internal image-reference" href="media/image21.png"><img alt="media/image21.png" src="media/image21.png" style="width: 6.07361in; height: 1.9375in;" /></a>
<p><strong>créer un certificat SSL auto-signé pour Nginx</strong></p>
<p>Il suffit de répondre (O)ui pour créer ce certificat, sinon taper (N)on</p>
<div class="line-block">
<div class="line">http reste disponible ce qui permet d’éviter les restrictions CORS
pour afficher d’autres serveurs comme Zigbee, Zwave, Nagios, ……</div>
<div class="line">Pour une installation manuelle de ce certificat, <em>voir le paragraphe
0.1.3</em></div>
<div class="line">Pour l’utiliser avec HA, ajouter dans /config/configuration.yaml</div>
</div>
<a class="reference internal image-reference" href="media/image22.png"><img alt="media/image22.png" src="media/image22.png" style="width: 2.60555in; height: 1.25972in;" /></a>
<a class="reference internal image-reference" href="media/image23.png"><img alt="media/image23.png" src="media/image23.png" style="width: 5.62639in; height: 2.75in;" /></a>
<p>TAB, ENTER</p>
<a class="reference internal image-reference" href="media/image24.png"><img alt="media/image24.png" src="media/image24.png" style="width: 5.05278in; height: 3.8125in;" /></a>
<p><strong>Vérifications en cas de problèmes :</strong></p>
<a class="reference internal image-reference" href="media/image25.png"><img alt="media/image25.png" src="media/image25.png" style="width: 2.42778in; height: 2.1625in;" /></a>
<p><strong>Pour accéder en écriture aux fichiers dans /www/html/monitor, donner
des droits :</strong></p>
<p>chmod -R 777 /www/html/*</p>
<a class="reference internal image-reference" href="media/image26.png"><img alt="media/image26.png" src="media/image26.png" style="width: 2.84444in; height: 0.29167in;" /></a>
<p>MySQL :</p>
<p>mysql -u root</p>
<a class="reference internal image-reference" href="media/image27.png"><img alt="media/image27.png" src="media/image27.png" style="width: 5.80278in; height: 4.07361in;" /></a>
<div class="line-block">
<div class="line">phpMyAdmin :</div>
<div class="line">Accès par monitor :</div>
</div>
<a class="reference internal image-reference" href="media/image28.png"><img alt="media/image28.png" src="media/image28.png" style="width: 3.03194in; height: 4.30278in;" /></a>
<p>Ou en ajoutant l’adresse dans le navigateur :</p>
<a class="reference internal image-reference" href="media/image29.png"><img alt="media/image29.png" src="media/image29.png" style="width: 3.13611in; height: 3.4in;" /></a>
<a class="reference internal image-reference" href="media/image30.png"><img alt="media/image30.png" src="media/image30.png" style="width: 4.83333in; height: 2.5375in;" /></a>
<p>Les tables installées lors de l’installation :</p>
<a class="reference internal image-reference" href="media/image31.png"><img alt="media/image31.png" src="media/image31.png" style="width: 2.14722in; height: 1.01111in;" /></a>
<div class="line-block">
<div class="line">La suite, mode découverte : <em>§ 0.1.3.1</em></div>
<div class="line"><strong>0.1.2 -Installation automatique de LEMP et Monitor :</strong></div>
<div class="line"><strong>Installer auparavant un système Debian 12 ou supérieur</strong></div>
<div class="line">Télécharger le script : lemp_monitor_install.sh,</div>
</div>
<p><strong>La suite : ICI</strong></p>
<div class="line-block">
<div class="line"><strong>0.1.3 – Installation de monitor uniquement</strong></div>
<div class="line">Après l’installation d’un OS (Debian, Ubuntu…et LEMP ou LAMP, Maria DB
ou MySQL …</div>
</div>
<div class="line-block">
<div class="line">Quelques liens utiles :</div>
<div class="line">ophpMyAdmin, voir</div>
<div class="line">oLAMP :</div>
<div class="line">o LEMP : <em>voir ce paragraphe</em></div>
<div class="line">Installation :</div>
<div class="line">- Soit télécharger et extraire le fichier :</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image34.png"><img alt="media/image34.png" src="media/image34.png" style="width: 3.3125in; height: 2.98333in;" /></a>
<div class="line-block">
<div class="line">- Soit cloner le référentiel :</div>
<div class="line">Commande : git clone &lt;REPERTOIRE_DESTINATION&gt; Git doit avoir été
installé : sur Debian ou Ubuntu, apt install git</div>
<div class="line">- soit télécharger en bash avec wget :</div>
</div>
<p>Et apprès avoir rendu exécutable le fichier, le lancer :</p>
<a class="reference internal image-reference" href="media/image35.png"><img alt="media/image35.png" src="media/image35.png" style="width: 6.3in; height: 1.87361in;" /></a>
<a class="reference internal image-reference" href="media/image36.png"><img alt="media/image36.png" src="media/image36.png" style="width: 2.85278in; height: 0.32222in;" /></a>
<p>Choisir le serveur web pour une installation de monitor dans le bon
répertoire ;</p>
<p>Choisir « autre » si Apache ou Nginx ne sont pas utilisé, monitor
sera installé dans « /tmp » il suffira alors de créer un lien
symbolique vers le serveur web.</p>
<p>Si un répertoire « monitor » existe déjà sur le chemin choisi
(précédente installation), le supprimer</p>
<a class="reference internal image-reference" href="media/image37.png"><img alt="media/image37.png" src="media/image37.png" style="width: 5.70694in; height: 2.65694in;" /></a>
<a class="reference internal image-reference" href="media/image38.png"><img alt="media/image38.png" src="media/image38.png" style="width: 4.15556in; height: 1.3125in;" /></a>
</div></blockquote>
<p><strong>0.1.3.1 mode « découverte »</strong></p>
<p><strong>IMPORTANT</strong> : après l’installation le programme est en mode «
découverte », pour utiliser Domoticz et toutes les fonctions nécessitant
des tables de la base de données, <strong>désactiver le mode « découverte »
;</strong></p>
<p>En profiter pour changer le mot de passe actuel 1234</p>
<p>Pour cela soit :</p>
<blockquote>
<div><ul class="simple">
<li><p>Utiliser la fonction du programme</p></li>
</ul>
<a class="reference internal image-reference" href="media/image39.png"><img alt="media/image39.png" src="media/image39.png" style="width: 3.55139in; height: 4.39861in;" /></a>
<a class="reference internal image-reference" href="media/image40.png"><img alt="media/image40.png" src="media/image40.png" style="width: 3.58472in; height: 3.96806in;" /></a>
<ul class="simple">
<li><p>Modifier le fichier /admin/config.php</p></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image41.png"><img alt="media/image41.png" src="media/image41.png" style="width: 5.41528in; height: 1.05278in;" /></a>
<a class="reference internal image-reference" href="media/image42.png"><img alt="media/image42.png" src="media/image42.png" style="width: 5.41667in; height: 0.71944in;" /></a>
<p>Pour utiliser Domoticz ou Home Assistant ou les 2 : Indiquer l‘ IP et le
port</p>
<a class="reference internal image-reference" href="media/image43.png"><img alt="media/image43.png" src="media/image43.png" style="width: 6.30139in; height: 1.37639in;" /></a>
<div class="line-block">
<div class="line"><strong>Logiciels utiles :</strong></div>
<div class="line">- Logiciel d’édition d’images svg : Adobe Illustrator ou Inkscape</div>
<div class="line">- Pour les autres images webp, un convertisseur en ligne :</div>
</div>
<div class="line-block">
<div class="line"><strong>0.1.3.2 -Création d’un certificat SSL auto-signé pour Nginx</strong> :</div>
<div class="line">Dans le cas où l’installation n’est pas automatique ; en automatique
il suffit d’accepter la création du certificat.</div>
</div>
<div class="line-block">
<div class="line">Avant de commencer, vous devez avoir un utilisateur non root configuré
avec des privilèges ; si vous avez installé Monitor en suivant ce
tuto, c’est déjà fait</div>
<div class="line"><strong>Étape 1 : Créer le certificat SSL</strong></div>
<div class="line">sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout
/etc/ssl/private/nginx-</div>
<div class="line">selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt</div>
</div>
<a class="reference internal image-reference" href="media/image44.png"><img alt="media/image44.png" src="media/image44.png" style="width: 5.81528in; height: 3.61389in;" /></a>
<div class="line-block">
<div class="line"><em>Explications :</em></div>
<div class="line">- openssl : l’outil en ligne de commande pour créer et gérer des
certificats, clés ,….</div>
</div>
<ul class="simple">
<li><p>req : cette commande spécifie que nous voulons utiliser la gestion des</p></li>
</ul>
<p>demandes de signature de certificat (CSR) X.509. (C’est une norme
d’infrastructure à clé publique à laquelle SSL et TLS adhèrent pour sa
gestion des clés et des certificats).</p>
<div class="line-block">
<div class="line">-x509 : pour compléter la commande précédente en indiquant que nous
voulons créer un -</div>
<div class="line">certificat auto-signé.</div>
</div>
<ul class="simple">
<li><p>-nodes: pour ignorer l’option de sécurisation de notre certificat avec</p></li>
</ul>
<p>une phrase secrète. Une phrase secrète empêcherait Nginx de démarrer
normalement car il faudrait saisir la phrase secrète à chaque démarrage.</p>
<div class="line-block">
<div class="line">- -days 365 : la durée en jours de validité du certificat</div>
<div class="line">- -newkey rsa:2048 : pour générer un nouveau certificat et une
nouvelle clé en une seule fois.</div>
</div>
<div class="line-block">
<div class="line">Il est indiqué de créer une clé RSA de 2048 bits</div>
<div class="line">- -keyout : emplacement du fichier de la clé privée généré.</div>
</div>
<ul class="simple">
<li><p>-out: emplacement du certificat créé.</p></li>
</ul>
<p>Les deux fichiers créés sont placés dans les sous-répertoires appropriés
du répertoire /etc/ssl</p>
<a class="reference internal image-reference" href="media/image45.png"><img alt="media/image45.png" src="media/image45.png" style="width: 3.67778in; height: 0.54167in;" /></a>
<div class="line-block">
<div class="line"><strong>Confidentialité persistante</strong></div>
<div class="line">sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</div>
</div>
<a class="reference internal image-reference" href="media/image46.png"><img alt="media/image46.png" src="media/image46.png" style="width: 6.30139in; height: 3.40417in;" /></a>
<p>C’est assez long</p>
<div class="line-block">
<div class="line"><strong>Étape 2 : Configurer Nginx pour utiliser SSL</strong></div>
<div class="line">Créer 2 lignes de configuration dans un fichier pointant vers la clé
SSL et le certificat - Créer le fichier self-signed.conf dans
/etc/nginx/snippets</div>
<div class="line">- cd /etc/nginx/snippets</div>
<div class="line">- sudo nano self-signed.conf</div>
<div class="line">Ajouter</div>
<div class="line">#certificat et clé privée</div>
<div class="line">ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;</div>
<div class="line">ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image47.png"><img alt="media/image47.png" src="media/image47.png" style="width: 4.5in; height: 0.84306in;" /></a>
</div></blockquote>
<p>Ctrl X, Enter, ctrl X</p>
<div class="line-block">
<div class="line">Créer un bloc de configuration avec des paramètres de chiffrement
forts - Comme précédemment créer fichier ssl-params.conf</div>
<div class="line">- sudo nano ssl-params.conf</div>
<div class="line">Ajouter :</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># from <a class="reference external" href="https://cipherli.st/">https://cipherli.st/</a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># and
<a class="reference external" href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html">https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</a></p>
<div class="line-block">
<div class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div>
<div class="line">ssl_prefer_server_ciphers on;</div>
<div class="line">ssl_ciphers “EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH”;
ssl_ecdh_curve secp384r1;</div>
<div class="line">ssl_session_cache shared:SSL:10m;</div>
<div class="line">ssl_session_tickets off;</div>
<div class="line">ssl_stapling on;</div>
<div class="line">ssl_stapling_verify on;</div>
<div class="line">resolver 8.8.8.8 8.8.4.4 valid=300s;</div>
<div class="line">resolver_timeout 5s;</div>
<div class="line"># Disable preloading HSTS for now. You can use the commented out
header line that includes</div>
<div class="line"># the “preload” directive if you understand the implications.</div>
</div>
<div class="line-block">
<div class="line">#add_header Strict-Transport-Security “max-age=63072000;</div>
<div class="line">includeSubdomains; preload”;</div>
<div class="line">add_header Strict-Transport-Security “max-age=63072000;
includeSubdomains”; add_header X-Frame-Options DENY;</div>
<div class="line">add_header X-Content-Type-Options nosniff;</div>
</div>
<p>ssl_dhparam /etc/ssl/certs/dhparam.pem;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image48.png"><img alt="media/image48.png" src="media/image48.png" style="width: 6.30139in; height: 4.54861in;" /></a>
<p>Ajustez la configuration Nginx pour utiliser SSL : extrait de
monitor.conf</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>server {</p>
<div class="line-block">
<div class="line">listen 80 ;</div>
<div class="line">listen [::]:80 ;</div>
<div class="line">server_name 192.168.1.127;</div>
</div>
<div class="line-block">
<div class="line"># SSL configuration</div>
<div class="line">listen 443 ssl ;</div>
<div class="line">listen [::]:443 ssl;</div>
<div class="line">include /etc/nginx/snippets/selfsigned.conf;</div>
<div class="line">include /etc/nginx/snippets/ssl-params.conf;</div>
</div>
<div class="line-block">
<div class="line">root /www/html;</div>
<div class="line">index index.php index.html index.htm;</div>
</div>
<div class="line-block">
<div class="line">location ~ \.php$ {</div>
<div class="line">fastcgi_split_path_info ^(.+\.php)(/.+)$;</div>
<div class="line">fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;</div>
<div class="line">fastcgi_index index.php;</div>
<div class="line">fastcgi_param SCRIPT_FILENAME
$document_root$fastcgi_script_name; include fastcgi_params;</div>
<div class="line">……</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image49.png"><img alt="media/image49.png" src="media/image49.png" style="width: 6.30139in; height: 4.54028in;" /></a>
<div class="line-block">
<div class="line">Vérifier la config</div>
<div class="line">sudo nginx -t</div>
</div>
<a class="reference internal image-reference" href="media/image50.png"><img alt="media/image50.png" src="media/image50.png" style="width: 6.30139in; height: 0.9375in;" /></a>
<div class="line-block">
<div class="line">Vous devrez confirmer manuellement que vous faites confiance au
serveur pour y accéder.= ; les navigateurs ne peuvent vérifier les
certificats auto-signés</div>
<div class="line">sudo systemctl restart nginx</div>
</div>
<div class="line-block">
<div class="line"><em>Noter l’Idx du plan</em></div>
<div class="line"><em>L’Idx (Domoticz) du dispositif 285</em></div>
<div class="line"><em>Id , il est le premier dispositif : 1</em></div>
<div class="line"><strong>Ajoutons ces données qans la base SQL , soit avec phpmyadmin ou plus
simplement avec l’appli :</strong></div>
</div>
<a class="reference internal image-reference" href="media/image60.png"><img alt="media/image60.png" src="media/image60.png" style="width: 4.78194in; height: 0.77083in;" /></a>
<p><em>Avec OpenWeather l’API fournit la température ressentie, pour l’ajouter
enregistrer le dispositif et</em></p>
<p><em>ajouter à accueil.php :</em></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><em>&lt;p class=”text-centre”&gt;T° ressentie :&lt;span id=”temp_ressentie”
style=”color:#ffc107;”&gt;&lt;/span&gt;&lt;/p&gt;</em></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Script de remplacement</strong></p>
<p><em>fonctions.php -&gt;function meteo_concept($choix)</em></p>
<a class="reference internal image-reference" href="media/image62.png"><img alt="media/image62.png" src="media/image62.png" style="width: 6.30139in; height: 1.27222in;" /></a>
<p><em>footer.php</em></p>
<a class="reference internal image-reference" href="media/image63.png"><img alt="media/image63.png" src="media/image63.png" style="width: 4.20972in; height: 2.47917in;" /></a>
<p><strong>0.3 _ Base de données Maria DB</strong> ; La base de données a été créée
lors de l’installation du</p>
<p>serveur : nom=<strong>monitor</strong> (donnée lors de la création, il peut être
différent)</p>
<blockquote>
<div><p>Connexion en local : IP/phpMyAdmin</p>
<a class="reference internal image-reference" href="media/image72.png"><img alt="media/image72.png" src="media/image72.png" style="width: 3.12361in; height: 3.39028in;" /></a>
</div></blockquote>
<p>Pour les autorisations d’accès, voir le paragraphe concernant la
configuration /admin/config.php</p>
<p><strong>Elles ont été créées lors de l’installation automatique, pour
l’installation manuelle :</strong></p>
<a class="reference internal image-reference" href="media/image73.png"><img alt="media/image73.png" src="media/image73.png" style="width: 3.325in; height: 1.04583in;" /></a>
<p>En cas d ‘absence de base de données ou de mauvais paramétrages :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image74.png"><img alt="media/image74.png" src="media/image74.png" style="width: 5.42639in; height: 2.07361in;" /></a>
</div></blockquote>
<p>Ajout à la base de données des données fournie par Domoticz</p>
<p><strong>0.3.1 Les variables</strong></p>
<p>La correspondance entre les variables Domoticz ou HA et l’affichage sur
les pages perso se fait par</p>
<p>l’intermédiaire de la BD « Domoticz » ; tables :</p>
<blockquote>
<div><ul class="simple">
<li><p>text-image</p></li>
<li><p>dispositifs (gère également les dispositifs</p></li>
<li><ul>
<li><p>…….</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p>Ex :</p>
<a class="reference internal image-reference" href="media/image75.png"><img alt="media/image75.png" src="media/image75.png" style="width: 2.25139in; height: 2.47917in;" /></a>
<div class="line-block">
<div class="line">Table « text-image » :</div>
<div class="line">Pour un texte contenu dans une variable Domoticz correspond une image
ou 0 ou « none »</div>
</div>
<a class="reference internal image-reference" href="media/image76.png"><img alt="media/image76.png" src="media/image76.png" style="width: 6.22917in; height: 4.39583in;" /></a>
<p>Table « dispositifs», ne sont concernés que les champs :</p>
<a class="reference internal image-reference" href="media/image77.png"><img alt="media/image77.png" src="media/image77.png" style="width: 3.57361in; height: 3.58333in;" /></a>
<a class="reference internal image-reference" href="media/image78.png"><img alt="media/image78.png" src="media/image78.png" style="width: 6.30139in; height: 3.35278in;" /></a>
<div class="line-block">
<div class="line">num : ne sert qu’à éditer plus facilement la BD</div>
<div class="line"><em>Pour modifier plus facilement la table, ajouter au début un
enregistrement (num par exemple) afin de pouvoir éditer les
enregistrements</em></div>
</div>
<a class="reference internal image-reference" href="media/image79.png"><img alt="media/image79.png" src="media/image79.png" style="width: 6.49583in; height: 0.55833in;" /></a>
<div class="line-block">
<div class="line">Id1_html : ID de l’image dans la page ou #shell (voir ci-dessous)</div>
<div class="line">Id2_html : ID du texte dans la page, concerne surtout l’alarme mais
peut afficher d’autres notifications ; commande Bash (voir image
ci-dessous)</div>
</div>
<p>Accès au Shell par SSH2 depuis Domoticz sous Docker : sous Docker
l’accès au Shell du serveur n’est pas possible, la parade consiste à
passer par monitor.</p>
<p>Dans Domoticz, créer une variable avec les données ci-dessous :</p>
<a class="reference internal image-reference" href="media/image80.png"><img alt="media/image80.png" src="media/image80.png" style="width: 6.30139in; height: 0.41667in;" /></a>
<p>Dans SQL :</p>
<a class="reference internal image-reference" href="media/image81.png"><img alt="media/image81.png" src="media/image81.png" style="width: 3.63611in; height: 1.89583in;" /></a>
<p>Ou par Monitor : <a class="reference internal" href="media/image82.png"><img alt="image3" src="media/image82.png" style="width: 3.08333in; height: 0.30139in;" /></a></p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image83.png"><img alt="media/image83.png" src="media/image83.png" style="width: 3.3125in; height: 4.05556in;" /></a>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"><strong>Exemple : redémarrer script après modifications</strong></div>
<div class="line">Ici systemctl restart sms_dz (script chargé de l’envoi des sms
et qui doit être redémarré si le fichier « connect.py » a été
modifié (ajout, remplacement de N° de tel)</div>
</div>
<p>Dans Domoticz :</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Nom_idx : nom de la variable du serveur domotique (dz)</div>
<div class="line">IMPORTANT : le nom de la variable Domoticz ne doit pas comporter
d’espace (le programme fonctionne mais l’API renvoie « NULL »)</div>
<div class="line">Idx : id de la variable du serveur domotique(dz)</div>
<div class="line">ex : idx de Domoticz</div>
</div>
<a class="reference internal image-reference" href="media/image87.png"><img alt="media/image87.png" src="media/image87.png" style="width: 4.23055in; height: 1.34444in;" /></a>
<div class="line-block">
<div class="line">Nom appareil : non obligatoire</div>
<div class="line">ID : id de la variable (ha)</div>
<div class="line">Ex : Home Assistant, nom essai, ID input_text.essai</div>
</div>
<a class="reference internal image-reference" href="media/image88.png"><img alt="media/image88.png" src="media/image88.png" style="width: 3.64583in; height: 1.81389in;" /></a>
<div class="line-block">
<div class="line">Pourquoi une correspondance ? : cela évite, lors d’une modification
dans Domoticz ou HA, de modifier tous les ID (idm) dans monitor</div>
<div class="line">Installation des tables : lors de l’installation automatique, elles
sont installées, sinon télécharger le référentiel :</div>
</div>
<a class="reference internal image-reference" href="media/image89.png"><img alt="media/image89.png" src="media/image89.png" style="width: 3.22917in; height: 2.93194in;" /></a>
<div class="line-block">
<div class="line">Les API de Domoticz et Home assistant pour les variables :</div>
<div class="line">- DZ : URL :PORT/json.htm?type=command&amp;param=getuservariables ,(
renvoie la liste de toutes les variables et leurs valeurs)</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>HA : <em>URL:8123/api/states/sensor.liste_var</em> (renvoie la liste des</p></li>
</ul>
<p>dispositifs enregistrés comme input text)</p>
<p>Le template sensor : sensor.liste_var</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">template:</div>
<div class="line">- sensor:</div>
<div class="line">- name: “liste_var”</div>
<div class="line">unique_id : 1234567890</div>
<div class="line">state: &gt;</div>
<div class="line">{% for input_text in states.input_text %}</div>
<div class="line">{{input_text.entity_id ~ “=” ~ input_text.state ~ “, ” }} {%
endfor %}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image90.png"><img alt="media/image90.png" src="media/image90.png" style="width: 5.31389in; height: 1.30278in;" /></a>
<p><strong>0.3.2 Les Dispositifs</strong></p>
<p>Comme pour les variables, la table fournie une correspondance entre les
dispositifs dans Domoticz ou HA et Monitor et une info sur le matériel
(Zgbee, Zwave, et n° de nœud.) (Pour les dispositifs Domoticz
n’enregistre pas le type de matériel)</p>
<p>Table « dispositifs »</p>
<a class="reference internal image-reference" href="media/image91.png"><img alt="media/image91.png" src="media/image91.png" style="width: 5.04306in; height: 6.82361in;" /></a>
<a class="reference internal image-reference" href="media/image92.png"><img alt="media/image92.png" src="media/image92.png" style="width: 6.30139in; height: 4.78611in;" /></a>
<p>La table permet en plus de gérer et modifier si besoin l’affichage de
tous les dispositifs sans intervenir sur la page HTML ; pour les
switches, les scripts pour commander l’allumage ou l’extinction sont
générés automatiquement à partir des données de cette table.</p>
<div class="line-block">
<div class="line">num : ne sert qu’à éditer plus facilement la BD</div>
<div class="line"><em>Pour modifier plus facilement la table , ajouter au début un
enregistrement (num par exemple) afin de pouvoir éditer les
enregistrements</em></div>
</div>
<a class="reference internal image-reference" href="media/image79.png"><img alt="media/image79.png" src="media/image79.png" style="width: 6.49583in; height: 0.55833in;" /></a>
<div class="line-block">
<div class="line">Nom appareil : nom usuel</div>
<div class="line">nom_dz : nom du dispositif Domoticz</div>
<div class="line">idx : celui de Domoticz</div>
<div class="line">ID : celui de Home Assistant</div>
</div>
<p>idm : idm de monitor peut-être la même que idx ; c’est utile pour
l’affichage des infos concernant un dispositif ; de plus cela permet de
retrouver facilement un dispositif dans l’image svg du plan en faisant
une recherche ;dans l’image cet idm est indiqué par « rel=idm »</p>
<p>Voir le paragraphe concernant les images svg</p>
<p>Matériel : pour les types zwave ou Zigbee</p>
<p>maj_js : types de mise à jour java script</p>
<blockquote>
<div><div class="line-block">
<div class="line">- control // détecteur présence(on/off)</div>
<div class="line">- etat //porte, volet ,(closed/open)</div>
<div class="line">- Temp ou data // température, humidité, ph, M3/h, orp,…. toutes
données ; temp est utilisé pour une raison historique, à l’époque
où seules des mesures de températures étaient exploitées….il est
préférable d’utiliser « data »</div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="media/image93.png"><img alt="media/image93.png" src="media/image93.png" style="width: 6.14583in; height: 0.56389in;" /></a>
<div class="line-block">
<div class="line">id1_html , Id2_html : id d’affichage pour un idx ou idm, souvent 1
seul ID, le 2eme lorsque l’image comporte de nombreuses zones,</div>
<div class="line">car_max_id1 : nb de caractères maximum affichés (concerne Data avec
plusieurs données (T°,%hum) F() N° case de la fonction «
pour_data($nc,$l_device) » , fichier fonctions.php</div>
<div class="line">class_lamp : utilisé pour les lampes en plus de l’interrupteur associé
; c’est une class car il peut y avoir plusieurs lampes</div>
<div class="line">coul_id1_id2_ON, coul_id1_id2_OFF, coul_lamp_ON, coul_lamp_ON :
couleur des ID ou de la class des dispositifs suivant leur position,
(class_lamp pour les lampes des différents interrupteurs) pass : par
défaut « 0 » pas de mot de passe , pwalarm pour mot de passe de
l’alarme et pwcommand pour les commandes (on/off ,…)</div>
<div class="line">doc : pour associer un document au dispositif</div>
</div>
<div class="line-block">
<div class="line">Pour créer cette table l’importer depuis le référentiel « monitor »
API Domoticz et HA pour les dispositifs :</div>
<div class="line">DZ : URL :PORT/json.htm?type=devices&amp;plan=NUMERO DU PLAN HA :
URL:8123/api/states</div>
<div class="line">Dans les 2 cas, un fichier json de tous lis dispositifs et les valeurs
……………ha :</div>
</div>
<a class="reference internal image-reference" href="media/image97.png"><img alt="media/image97.png" src="media/image97.png" style="width: 5.60556in; height: 1.39583in;" /></a>
<div class="line-block">
<div class="line"><strong>0.3.3 caméras</strong></div>
<div class="line">On crée une table dans la base de données : cameras</div>
<div class="line">Si l’on veut un accès extérieur il est utile d’indiquer également le
domaine</div>
<div class="line">Si l’on utilise Zoneminder, il est nécessaire d’assurer la
correspondance des Numéros de dispositifs</div>
</div>
<p>téléchargement : cameras.sql</p>
<p>Enregistrements de températures, tension ,…..</p>
<a class="reference internal image-reference" href="media/image99.png"><img alt="media/image99.png" src="media/image99.png" style="width: 5.89722in; height: 1.47917in;" /></a>
<p>Exemple pour une table temp_meteo :</p>
<a class="reference internal image-reference" href="media/image100.png"><img alt="media/image100.png" src="media/image100.png" style="width: 5.17778in; height: 3.25in;" /></a>
<div class="line-block">
<div class="line">num : n° auto incrémenté pour faciliter les modifications date : la
date et l’heure</div>
<div class="line">valeur : la température</div>
</div>
<p>Téléchargement de temp_meteo.sql</p>
<p><strong>0.4_ Le serveur http de NGINX :</strong></p>
<a class="reference internal image-reference" href="media/image101.png"><img alt="media/image101.png" src="media/image101.png" style="width: 3.19861in; height: 2.15555in;" /></a>
<p><strong>Configuration : /admin/config.php</strong></p>
<a class="reference internal image-reference" href="media/image102.png"><img alt="media/image102.png" src="media/image102.png" style="width: 2.10556in; height: 2.57361in;" /></a>
<p>Extrait du fichier, fichier complet :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;?php</div>
<div class="line">// NE PAS MODIFIER LES VALEURS EN MAJUSCULES——</div>
<div class="line">//general monitor</div>
<div class="line">define(‘URLMONITOR’, ‘monitor.xxxxxxx.ovh’);//domaine</div>
<div class="line">define(‘IPMONITOR’, ‘192.168.1.7’);//ip</div>
<div class="line">define(‘MONCONFIG’, ‘admin/config.php’);//fichier config</div>
<div class="line">define(‘DZCONFIG’, ‘admin/dz/temp.lua’);//fichier temp</div>
<div class="line">define(‘FAVICON’, ‘favicon.ico’);//fichier favicon , icone du
domaine dans barre url</div>
<div class="line">// répertoire des images</div>
<div class="line">$rep=’images/’;//ne pas changer</div>
<div class="line">// images logo et titres</div>
<div class="line">define(‘IMAGEACCUEIL’, $rep.’maison.jpg’);//image page accueil
pour écrans &gt;534 px</div>
<div class="line">define(‘IMAGEACCUEILSMALL’, $rep.’maison_small.jpg’);//image
page accueil pour écrans &lt;535 px define(‘IMGLOGO’,
$rep.’logo.png’);//image logo</div>
<div class="line">define(‘NOMSITE’, ‘Domoticz’);//nom principal du site</div>
<div class="line">define(‘NOMSLOGAN’, xxxxxx’);//nom secondaire ou slogan</div>
<div class="line">//</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Les fichiers à la racine du site :</strong></p>
<a class="reference internal image-reference" href="media/image106.png"><img alt="media/image106.png" src="media/image106.png" style="width: 5.95833in; height: 6.5625in;" /></a>
<div class="line-block">
<div class="line"><strong>0.5_ Le Framework Bootstrap</strong></div>
<div class="line">Pour des mises en page faciles, des fenêtres modales ,…..</div>
</div>
<a class="reference internal image-reference" href="media/image107.png"><img alt="media/image107.png" src="media/image107.png" style="width: 2.81389in; height: 3.70833in;" /></a>
<p><strong>0.6_ Les styles CSS</strong></p>
<a class="reference internal image-reference" href="media/image108.png"><img alt="media/image108.png" src="media/image108.png" style="width: 3.23055in; height: 2.38611in;" /></a>
<p>Un extrait :</p>
<a class="reference internal image-reference" href="media/image109.png"><img alt="media/image109.png" src="media/image109.png" style="width: 4.36528in; height: 4.28194in;" /></a>
<p>Les Media queries pour les différents écrans</p>
<a class="reference internal image-reference" href="media/image110.png"><img alt="media/image110.png" src="media/image110.png" style="width: 6.26806in; height: 5.34167in;" /></a>
<div class="line-block">
<div class="line"><strong>0.7_ Les images</strong></div>
<div class="line">Toutes sont au format svg ou webp sauf les caméras <strong>Avantages du
format SVG</strong></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">Les images SVG peuvent être créées et modifiées un éditeur de
texte</div>
<div class="line">Les images SVG peuvent contenir du javascript</div>
<div class="line">Les images SVG sont zoomables</div>
<div class="line">Les graphiques SVG ne perdent aucune qualité s’ils sont zoomés
ou redimensionnés SVG est open source</div>
<div class="line">Les fichiers SVG sont du pur XML</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image111.png"><img alt="media/image111.png" src="media/image111.png" style="width: 1.29306in; height: 0.45833in;" /></a>
<p>WebP est un format d’image moderne qui offre une compression supérieure
avec perte et sans perte pour les images du Web</p>
<p>Les caméras sont au format jpg :</p>
<a class="reference internal image-reference" href="media/image112.png"><img alt="media/image112.png" src="media/image112.png" style="width: 3.07361in; height: 4.97917in;" /></a>
<p><strong>0.8_ Les fichiers PHP</strong></p>
<p>Ils sont regroupés dans le dossier « include », sauf</p>
<blockquote>
<div><ul class="simple">
<li><p>fonctions.php, ajax.php, à la racine de monitor</p></li>
<li><p>/admin/config. PHP</p></li>
<li><p>/jpgraph</p></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image113.png"><img alt="media/image113.png" src="media/image113.png" style="width: 3.34444in; height: 4.09444in;" /></a>
<p><strong>Affichage de graphique avec jpgraph</strong></p>
<a class="reference internal image-reference" href="media/image114.png"><img alt="media/image114.png" src="media/image114.png" style="width: 2.76111in; height: 4.05278in;" /></a>
<div class="line-block">
<div class="line"><strong>0.9_ Les fichiers javascript</strong></div>
<div class="line">Avec jQuery</div>
</div>
<a class="reference internal image-reference" href="media/image115.png"><img alt="media/image115.png" src="media/image115.png" style="width: 2.11528in; height: 3.25in;" /></a>
<p><strong>Les scripts python</strong></p>
<a class="reference internal image-reference" href="media/image116.png"><img alt="media/image116.png" src="media/image116.png" style="width: 3.05278in; height: 2.69722in;" /></a>
<div class="line-block">
<div class="line"><strong>1._ Configuration minimum : la page d’accueil</strong> Permet d’afficher</div>
<div class="line">- La température extérieure,</div>
<div class="line">- Le jour (changement à 0H pour une tablette connectée en permanence),</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>La sortie des poubelles,</p></li>
<li><p>La gestion de la fosse septique,</p></li>
<li><p>La surveillance de la pression de la chaudière</p></li>
<li><p>Les anniversaires</p></li>
<li><p>Rappel pour la prise de médicaments</p></li>
<li><p>La prévision de pluie à 1 heure de Météo France</p></li>
<li><p>L’arrivée du courrier</p></li>
<li><p>La mise en service de l’alarme de nuit</p></li>
<li><p>Le remplacement des piles pour les capteurs concernés</p></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image117.png"><img alt="media/image117.png" src="media/image117.png" style="width: 5.53194in; height: 7.46944in;" /></a>
<a class="reference internal image-reference" href="media/image118.png"><img alt="media/image118.png" src="media/image118.png" style="width: 4.95972in; height: 1.67639in;" /></a>
<p>Pour afficher cette page, les fichiers nécessaires en jaune</p>
<p><strong>1.1– Configuration :/admin.config.php Il faut fournir un minimum de
renseignements : 1.1.1 -Adresse IP , domaine, favicon de monitor,</strong></p>
<a class="reference internal image-reference" href="media/image119.png"><img alt="media/image119.png" src="media/image119.png" style="width: 5.00139in; height: 1.5625in;" /></a>
<p>Pour faciliter la réinitialisation des dispositifs dans Domoticz ou un
transfert (ex, zwavejs2mqtt , zigbee2mqtt sous docker) ; en créant une
copie de la table dispositifs (« dispositifs » par défaut), il est
possible de préparer le transfert ; ici la table dispositifs a été
renommer Dispositifs</p>
<a class="reference internal image-reference" href="media/image120.png"><img alt="media/image120.png" src="media/image120.png" style="width: 3.71944in; height: 0.51111in;" /></a>
<a class="reference internal image-reference" href="media/image121.png"><img alt="media/image121.png" src="media/image121.png" style="width: 2.49028in; height: 1.75in;" /></a>
<p>1.1.1.a _Pour l’image de fond suivant la résolution d’écran et le logo
:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">// Monitor</div>
<div class="line">define(‘IMAGEACCUEIL’, ‘images/maison.webp’);//image page
accueil pour écrans &gt;534 px define(‘IMAGEACCUEILSMALL’,
‘images/maison_small.webp’);//image page accueil pour écrans
&lt;535 px</div>
<div class="line">define(‘IMGLOGO’, ‘images/logo.png’);//image logo</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image122.png"><img alt="media/image122.png" src="media/image122.png" style="width: 5.77222in; height: 0.64583in;" /></a>
<div class="line-block">
<div class="line">Pour les titres, slogans et lexique</div>
<div class="line">Pour le lexique :</div>
<div class="line">- true = lexique par défaut</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>false= lexique à modifier
/include/lexique_no.php</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">define(‘NOMSITE’, ‘Domoticz’);//nom principal du site</div>
<div class="line">define(‘NOMSLOGAN’, xxxxxxxxxxx);//nom secondaire ou slogan //
affichage lexique</div>
<div class="line">define(‘LEXIQUE’, true);</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image123.png"><img alt="media/image123.png" src="media/image123.png" style="width: 5.55278in; height: 0.85417in;" /></a>
<p><strong>1.1.2 intervalles de maj, maj temps réel</strong></p>
<p>L’intervalle de mise à jour pour les services (poubelles, anniversaires,
…) : il est de ½ heure (1800000 milli secondes), il peut être changé</p>
<a class="reference internal image-reference" href="media/image124.png"><img alt="media/image124.png" src="media/image124.png" style="width: 6.30139in; height: 0.87917in;" /></a>
<a class="reference internal image-reference" href="media/image125.png"><img alt="media/image125.png" src="media/image125.png" style="width: 6.26806in; height: 0.625in;" /></a>
<p>TEMPO_DEVICES pour tous les dispositifs</p>
<p>TEMPO_DEVICES_DZ : pour les dispositifs qui mettent à 1 une variable
pour indiquer à monitor d’effectuer une mise à jour, ici toutes les 30
secondes rafraichissement des dispositifs si par exemple un PIR, un
contact de porte qui sont déclaré prioritaire dans DZ passent à ON</p>
<a class="reference internal image-reference" href="media/image126.png"><img alt="media/image126.png" src="media/image126.png" style="width: 6.29167in; height: 1.82361in;" /></a>
<p>La fonction JS :</p>
<a class="reference internal image-reference" href="media/image127.png"><img alt="media/image127.png" src="media/image127.png" style="width: 6.01111in; height: 1.51111in;" /></a>
<p>La fonction PHP qui récupère la valeur de la variable :</p>
<a class="reference internal image-reference" href="media/image128.png"><img alt="media/image128.png" src="media/image128.png" style="width: 5.92778in; height: 1.41667in;" /></a>
<div class="line-block">
<div class="line"><strong>1.1.3 Autres données</strong></div>
<div class="line">Idx de Domoticz ou idm de monitor :</div>
<div class="line">Pour une première installation choisir idx ; pour une réinstallation
de Domoticz, il sera alors préférable de choisir idm pour éviter de
renommer tous les dispositifs dans les images svg La création d’un
plan qui regroupe les dispositifs sur Domoticz est nécessaire : noter
le N° du plan</div>
</div>
<a class="reference internal image-reference" href="media/image129.png"><img alt="media/image129.png" src="media/image129.png" style="width: 5.43889in; height: 1.19861in;" /></a>
<p>Paramètres de la base de données :</p>
<a class="reference internal image-reference" href="media/image130.png"><img alt="media/image130.png" src="media/image130.png" style="width: 2.79305in; height: 0.91667in;" /></a>
<p>Paramètres pour Domoticz :</p>
<a class="reference internal image-reference" href="media/image131.png"><img alt="media/image131.png" src="media/image131.png" style="width: 6.26806in; height: 1.12639in;" /></a>
<p>Le programme démarre avec 11 pages :</p>
<blockquote>
<div><ul class="simple">
<li><p>Accueil</p></li>
<li><p>1 Plan intérieur</p></li>
<li><p>Page d’administration, pour afficher cette page, le mot de passe</p></li>
</ul>
<p>est obligatoire ; il est</p>
<p>toujours possible de modifier le fichier de configuration avec un
éditeur.</p>
<p>Par défaut « admin »</p>
</div></blockquote>
<p><strong>1.2- Les fichiers à la racine du site, les styles, le javascript</strong></p>
<blockquote>
<div><p><strong>1.2.1 - à la racine du site :</strong></p>
<p>o<strong>Index.php</strong></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;?php</div>
<div class="line">echo ‘&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body style=”background-color:
cornsilk;”&gt;’;</div>
</div>
<div class="line-block">
<div class="line">$rep=”/”; $domaine=$_SERVER[‘HTTP_HOST’];</div>
<div class="line">if ($domaine==”192.168.1.7”) $rep=”/monitor/”;</div>
<div class="line">echo ‘</div>
<div class="line">&lt;script&gt;</div>
<div class="line">var larg = screen.width;</div>
<div class="line">if (larg&lt;769 ){ window.location.href=”’.$rep.’index_loc.php”;}</div>
<div class="line">&lt;/script&gt;’;</div>
<div class="line">echo ‘</div>
<div class="line">&lt;iframe id=”inline_monitor”</div>
<div class="line">style=”width:768px;height:1024px;margin:0 30%;background-color:
cornsilk;” src=”’.$rep.’index_loc.php”&gt;</div>
<div class="line">&lt;/iframe&gt;&lt;/body&gt;&lt;/html&gt;’;</div>
<div class="line">?&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>o<strong>index_loc.php</strong></p>
<p><strong>extrait , le fichier complet :</strong></p>
<a class="reference internal image-reference" href="media/image133.png"><img alt="media/image133.png" src="media/image133.png" style="width: 4.65694in; height: 4.77639in;" /></a>
<div class="line-block">
<div class="line"><strong>fonctions.php,</strong></div>
<div class="line"><em>Extrait, voir le fichier à jour sur Github</em></div>
<div class="line">Principales fonctions :</div>
<div class="line">- fonction status_variables($xx)</div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="media/image134.png"><img alt="media/image134.png" src="media/image134.png" style="width: 4.6875in; height: 3.33333in;" /></a>
<a class="reference internal image-reference" href="media/image135.png"><img alt="media/image135.png" src="media/image135.png" style="width: 6.30139in; height: 6.51944in;" /></a>
<a class="reference internal image-reference" href="media/image136.png"><img alt="media/image136.png" src="media/image136.png" style="width: 6.30139in; height: 6.81667in;" /></a>
<p><strong>API HA pour récupérer les valeurs des dispositifs</strong></p>
<a class="reference internal image-reference" href="media/image137.png"><img alt="media/image137.png" src="media/image137.png" style="width: 6.30139in; height: 3.18472in;" /></a>
<p>Fonction maj_variable et sql_variable : pour mettre à jour une variable
et pour lire les tables</p>
<p>variables_dz et text_image SQL</p>
<a class="reference internal image-reference" href="media/image138.png"><img alt="media/image138.png" src="media/image138.png" style="width: 6.32222in; height: 3.85417in;" /></a>
<p>API Domoticz pour les devices :</p>
<a class="reference internal image-reference" href="media/image139.png"><img alt="media/image139.png" src="media/image139.png" style="width: 6.30139in; height: 6.14444in;" /></a>
<blockquote>
<div><div class="line-block">
<div class="line"><strong>1.2.3 – Le javascript :</strong></div>
<div class="line"><strong>1.2.3 a</strong>- Les fichiers footer.php , <em>voir ce script</em></div>
<div class="line"><strong>1.2.3 b</strong>- le fichier mes_js.js : scripts principaux , fichier
complet :</div>
</div>
<a class="reference internal image-reference" href="media/image144.png"><img alt="media/image144.png" src="media/image144.png" style="width: 6.26806in; height: 4.65139in;" /></a>
<p><strong>1.2.3 b.1 fenêtre modale modallink</strong></p>
<a class="reference internal image-reference" href="media/image145.png"><img alt="media/image145.png" src="media/image145.png" style="width: 4.99028in; height: 4.125in;" /></a>
</div></blockquote>
<p><strong>1.3-Les fichiers principaux dans /include</strong></p>
<blockquote>
<div><p><strong>1.3.1 entete_html.php</strong></p>
<p><strong>p</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image146.png"><img alt="media/image146.png" src="media/image146.png" style="width: 6.26806in; height: 4.18056in;" /></a>
<p>Le HTML du navigateur :</p>
<a class="reference internal image-reference" href="media/image147.png"><img alt="media/image147.png" src="media/image147.png" style="width: 5.62639in; height: 0.90694in;" /></a>
<p><strong>1.3.2 Test de la base de données, test_db.php :</strong></p>
<a class="reference internal image-reference" href="media/image148.png"><img alt="media/image148.png" src="media/image148.png" style="width: 6.26806in; height: 2.55972in;" /></a>
<p><strong>1.3.3 le menu, header.php :</strong> les pages configurées avec config.php
sont ajoutées automatiquement au menu</p>
<div class="line-block">
<div class="line">Extrait du fichier, le fichier</div>
<div class="line">complet :</div>
</div>
<a class="reference internal image-reference" href="media/image149.png"><img alt="media/image149.png" src="media/image149.png" style="width: 6.26806in; height: 2.59722in;" /></a>
<p>Pour modifier la largeur, Du menu :</p>
<a class="reference internal image-reference" href="media/image150.png"><img alt="media/image150.png" src="media/image150.png" style="width: 5.19861in; height: 2.47917in;" /></a>
<p>Le HTML:</p>
<a class="reference internal image-reference" href="media/image152.png"><img alt="media/image152.png" src="media/image152.png" style="width: 6.30139in; height: 4.14861in;" /></a>
<p>La fonction pour le rafraichissement des données à partir d’un
changement d’état d’un dispositif dans Domoticz</p>
<a class="reference internal image-reference" href="media/image155.png"><img alt="media/image155.png" src="media/image155.png" style="width: 6.05278in; height: 1.625in;" /></a>
<p>Dans les scripts lua :</p>
<a class="reference internal image-reference" href="media/image156.png"><img alt="media/image156.png" src="media/image156.png" style="width: 3.93889in; height: 1.02083in;" /></a>
<a class="reference internal image-reference" href="media/image157.png"><img alt="media/image157.png" src="media/image157.png" style="width: 5.78194in; height: 0.5625in;" /></a>
<a class="reference internal image-reference" href="media/image158.png"><img alt="media/image158.png" src="media/image158.png" style="width: 6.30139in; height: 0.50417in;" /></a>
<p>La variable</p>
<blockquote>
<div><p><em>1.3.5.2 Quelques infos supplémentaires :</em></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image159.png"><img alt="media/image159.png" src="media/image159.png" style="width: 5.58472in; height: 3.1875in;" /></a>
<p>substring(0, 32) : modif du 11/05/2022 tronqué affichage ID ZWAVE très
long</p>
<p>.substring(0, 11)==”Set Level: ajouté le 15/5/2022</p>
<a class="reference internal image-reference" href="media/image160.png"><img alt="media/image160.png" src="media/image160.png" style="width: 6.26806in; height: 1.65278in;" /></a>
<p>La fonction maj_services récupère les valeurs de toutes les variables.
La fonction maj_variable modifie la valeur d’une variable.</p>
<blockquote>
<div><p>La fonction maj_devices(plan) récupère les données des dispositifs Un
exemple avec set ou get Attribute</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image161.png"><img alt="media/image161.png" src="media/image161.png" style="width: 6.26806in; height: 5.30972in;" /></a>
<p>Voir le <em>paragraphe concernant les volets</em></p>
<div class="line-block">
<div class="line">La fonction switchOnOff_setpoint() exécute des commandes</div>
<div class="line">La ligne en PHP « &lt;?php if ($_SESSION[“exeption_db”]!=”pas de
connexion à la BD”) {sql_plan(0);}?&gt; » crée pour chaque dispositif
on/off le script correspondant à partir de la BD</div>
</div>
<a class="reference internal image-reference" href="media/image162.png"><img alt="media/image162.png" src="media/image162.png" style="width: 5.57361in; height: 2.19861in;" /></a>
<p>Le HTML :</p>
<a class="reference internal image-reference" href="media/image163.png"><img alt="media/image163.png" src="media/image163.png" style="width: 6.26111in; height: 4.77083in;" /></a>
<div class="line-block">
<div class="line">maj_sevices()</div>
<div class="line">Copie d’écran le jour de l’entretien de la fosse septique</div>
</div>
<a class="reference internal image-reference" href="media/image164.png"><img alt="media/image164.png" src="media/image164.png" style="width: 5.36806in; height: 6.77778in;" /></a>
<a class="reference internal image-reference" href="media/image165.png"><img alt="media/image165.png" src="media/image165.png" style="width: 6.27083in; height: 7.19861in;" /></a>
<p>Maj_devices(plan) : pour l’installation minimale, ne concerne que la maj
de la température extérieure et de la date ; lorsqu’une tablette reste
connectée en permanence, donc sans rafraichissement , la date affichée
doit être rafraichie.</p>
<p>Une autre solution pour la maj de la date : un script qui tourne en
permanence sur la tablette : je n’ai pas retenu cette solution car un
script dans Domoticz gère très bien la gestion du temps.</p>
<p>Pour info cette autre solution :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">fonction date_heure(id)</div>
<div class="line">{</div>
<div class="line">date = new Date;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">annee = date.getFullYear();</div>
<div class="line">moi = date.getMonth();</div>
<div class="line">mois = new Array(‘Janvier’, ‘F&amp;eacute;vrier’, ‘Mars’, ‘Avril’,
‘Mai’, ‘Juin’, ‘Juillet’, ‘Ao&amp;ucirc;t’, ‘Septembre’, ‘Octobre’,
‘Novembre’, ‘D&amp;eacute;cembre’);</div>
<div class="line">j = date.getDate();</div>
<div class="line">jour = date.getDay();</div>
<div class="line">jours = new Array(‘Dimanche’, ‘Lundi’, ‘Mardi’, ‘Mercredi’,
‘Jeudi’, ‘Vendredi’, ‘Samedi’);</div>
<div class="line">h = date.getHours();</div>
<div class="line">if(h&lt;10)</div>
<div class="line">{</div>
<div class="line">h = “0”+h;</div>
<div class="line">}</div>
<div class="line">m = date.getMinutes();</div>
<div class="line">if(m&lt;10)</div>
<div class="line">{</div>
<div class="line">m = “0”+m;</div>
<div class="line">}</div>
<div class="line">s = date.getSeconds();</div>
<div class="line">if(s&lt;10)</div>
<div class="line">{</div>
<div class="line">s = “0”+s;</div>
<div class="line">}</div>
<div class="line">resultat = ‘Nous sommes le ‘+jours[jour]+’ ‘+j+’ ‘+mois[moi]+’
‘+annee+’ il est ‘+h+’:’+m+’:’+s;</div>
<div class="line">document.getElementById(id).innerHTML = resultat;</div>
<div class="line">setTimeout(‘date_heure(“’+id+’”);’,’1000’);</div>
<div class="line">return true;</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image166.png"><img alt="media/image166.png" src="media/image166.png" style="width: 6.26806in; height: 6.71528in;" /></a>
<p>Pour que les icones sur la page d’accueil soient affichées, il faut
enregistrer les variables dans</p>
<p>la base de Données Maria DB,</p>
<p>La table dispositifs</p>
<a class="reference internal image-reference" href="media/image167.png"><img alt="media/image167.png" src="media/image167.png" style="width: 6.30139in; height: 2.1125in;" /></a>
<p>La table d’équivalence texte -&gt;images : text_image</p>
<a class="reference internal image-reference" href="media/image168.png"><img alt="media/image168.png" src="media/image168.png" style="width: 3.66805in; height: 6.63611in;" /></a>
<a class="reference internal image-reference" href="media/image169.png"><img alt="media/image169.png" src="media/image169.png" style="width: 3.52222in; height: 0.90694in;" /></a>
<p>Pour les Anniversaires, il faut entrer chaque prénom ou nom dans la base
de données, ces noms correspondent à ceux du script LUA décrit ci-après
:</p>
<a class="reference internal image-reference" href="media/image170.png"><img alt="media/image170.png" src="media/image170.png" style="width: 6.49583in; height: 0.72917in;" /></a>
<a class="reference internal image-reference" href="media/image171.png"><img alt="media/image171.png" src="media/image171.png" style="width: 5.51111in; height: 2.25972in;" /></a>
<div class="line-block">
<div class="line">L’image peut être personnalisée pour chaque nom</div>
<div class="line">Sur la page d’accueil, il est possible d’ajouter d’autres icones, il
suffit d’ajouter un ID dans accueil.php et de renseigner la base de
données</div>
</div>
<a class="reference internal image-reference" href="media/image172.png"><img alt="media/image172.png" src="media/image172.png" style="width: 6.49583in; height: 4.1625in;" /></a>
<p><strong>1.4 Le lexique et la température extérieure :</strong></p>
<p><strong>1.4.1 Le lexique :</strong></p>
<p>L’image est inline dans header.php</p>
<p>La fenêtre modale dans /include lexique .php ou lexique_no.php (le
fichier est choisi par la</p>
<p>configuration) :</p>
<a class="reference internal image-reference" href="media/image173.png"><img alt="media/image173.png" src="media/image173.png" style="width: 2.41806in; height: 0.32222in;" /></a>
<a class="reference internal image-reference" href="media/image174.png"><img alt="media/image174.png" src="media/image174.png" style="width: 5.14583in; height: 2.59861in;" /></a>
<div class="line-block">
<div class="line">Les fenêtres qui affichent les infos :</div>
<div class="line">- Lexique.php</div>
</div>
<a class="reference internal image-reference" href="media/image176.png"><img alt="media/image176.png" src="media/image176.png" style="width: 5.5625in; height: 3.59167in;" /></a>
<p>Pour ne pas utiliser de lexique et donc de supprimer l’icône : <a class="reference internal" href="media/image177.png"><img alt="image4" src="media/image177.png" style="width: 0.6875in; height: 0.61389in;" /></a></p>
<blockquote>
<div><ul class="simple">
<li><p>Supprimer ou mettre en commentaire</p></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image178.png"><img alt="media/image178.png" src="media/image178.png" style="width: 4.24028in; height: 3.83889in;" /></a>
<p><strong>1.4.2 La température extérieure (valable pour d’autres dispositifs)
:</strong></p>
<a class="reference internal image-reference" href="media/image179.png"><img alt="media/image179.png" src="media/image179.png" style="width: 4.56389in; height: 2.61528in;" /></a>
<p>Le fichier Json reçu par monitor après une demande de la fonction
devices(plan):</p>
<a class="reference internal image-reference" href="media/image180.png"><img alt="media/image180.png" src="media/image180.png" style="width: 2.98055in; height: 3.70833in;" /></a>
<p><strong>1.5 liens avec Domoticz ou Home Assistant</strong></p>
<p><strong>1.5.1 Liens avec Domoticz</strong></p>
<p>Le script maj_services : concerne :</p>
<blockquote>
<div><div class="line-block">
<div class="line">- les poubelles</div>
<div class="line">- la fosse septique</div>
<div class="line">- les anniversaires</div>
<div class="line">- la gestion des piles des dispositifs</div>
<div class="line">- ….et plus encore</div>
</div>
</div></blockquote>
<p>Affichage sur monitor, sur la TV et notifications SMS</p>
<p>Ce script met à jour, suivant l’horaire et la date, des variables
Domoticz ; quand javascript demande une mise à jour, il appelle, par
l’intermédiaire d’un fichier ajax.php, une fonction PHP
(status_variables), qui récupère toutes les infos (API Domoticz) et
renvoi un fichier Json</p>
<p>Variables Domoticz :</p>
<p><em>les 2 variables not_tv_* : pour le script notifications_tv.lua</em></p>
<a class="reference internal image-reference" href="media/image181.png"><img alt="media/image181.png" src="media/image181.png" style="width: 6.5in; height: 1.56667in;" /></a>
<p>.</p>
<a class="reference internal image-reference" href="media/image182.png"><img alt="media/image182.png" src="media/image182.png" style="width: 2.96944in; height: 4.22917in;" /></a>
<p>Le fichier LUA</p>
<a class="reference internal image-reference" href="media/image183.png"><img alt="media/image183.png" src="media/image183.png" style="width: 3.19861in; height: 1.52083in;" /></a>
<a class="reference internal image-reference" href="media/image184.png"><img alt="media/image184.png" src="media/image184.png" style="width: 5.88611in; height: 2.35417in;" /></a>
<p><strong>Remarque :</strong></p>
<p><strong>D’une année à l’autre, certains jours de ramassage des poubelles
peuvent être modifiés :</strong></p>
<p>Pour en tenir compte dans Domoticz, voir ci-dessous (§1.5.1) les lignes
de code à ajouter :</p>
<p>Il est possible de mettre les variables (string et tableau dans un
fichier, voir ci-dessous 1.8.1</p>
<p>Dans Log :</p>
<a class="reference internal image-reference" href="media/image185.png"><img alt="media/image185.png" src="media/image185.png" style="width: 6.1625in; height: 0.68472in;" /></a>
<p><strong>1.5.1.1 les variables lua de configuration dans un fichier externe</strong></p>
<p>Les jour de ramassage des poubelles peuvent changer, le nombre
d’anniversaires augmenter, toutes les variables correspondantes à ces
valeurs peuvent être inséré dans un fichier appelé dans le script lua ;
pour les anniversaires on utilise un tableau multidimensionnel, plus
facile à compléter que 2 tableaux, si les données sont importantes.</p>
<p>De plus ce fichier peut alors être modifié dans monitor sans intervenir
dans Domoticz, voir le paragraphe concernant l’administration</p>
<p>Dans ce cas il faut que le fichier soit accessible en http, il faut donc
créer un répertoire « modules_lua » dans « /home/USER/domoticz/www »</p>
<p>Exemple le fichier
/home/USER/domoticz/www/modules_lua/string_tableaux.lua, affichage dans
monitor</p>
<a class="reference internal image-reference" href="media/image186.png"><img alt="media/image186.png" src="media/image186.png" style="width: 4.32361in; height: 3.9375in;" /></a>
<p>Utilisation dans dz event pour une maj depuis monitor, voir le
paragraphe « administration »</p>
<a class="reference internal image-reference" href="media/image187.png"><img alt="media/image187.png" src="media/image187.png" style="width: 5.96944in; height: 1.8125in;" /></a>
<p>On place le fichier string_tableaux.lua dans ce répertoire</p>
<a class="reference internal image-reference" href="media/image188.png"><img alt="media/image188.png" src="media/image188.png" style="width: 4.18889in; height: 2.04167in;" /></a>
<p>Dans le script LUA, on appelle ce fichier, en ayant indiqué le chemin :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>– chargement fichier contenant les variables de configuration
package.path..”;/home/USER/domoticz/www/modules_lua/?.lua” require
‘string_tableaux’</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Le script maj_services devient :</p>
<a class="reference internal image-reference" href="media/image189.png"><img alt="media/image189.png" src="media/image189.png" style="width: 5.60556in; height: 0.99028in;" /></a>
<a class="reference internal image-reference" href="media/image190.png"><img alt="media/image190.png" src="media/image190.png" style="width: 4.80278in; height: 2.05139in;" /></a>
<p><strong>Extrait du fichier maj_services modifié</strong></p>
<a class="reference internal image-reference" href="media/image192.png"><img alt="media/image192.png" src="media/image192.png" style="width: 6.26806in; height: 1.21806in;" /></a>
<p><strong>1.5.1.2 les scripts de notifications gérées par Domoticz</strong></p>
<p><strong>Alarmes SMS ou Mail , le script LUA</strong> : ‘notifications_variables’</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_variables.lua">https://raw.githubusercontent.com/mgrafr/monitor/main/scripts_dz/lua/notification_variables.lua</a></p>
<a class="reference internal image-reference" href="media/image193.png"><img alt="media/image193.png" src="media/image193.png" style="width: 6.26806in; height: 4.87222in;" /></a>
<p>Le script DZEvent : notifications_devices :</p>
<a class="reference internal image-reference" href="media/image194.png"><img alt="media/image194.png" src="media/image194.png" style="width: 6.26806in; height: 4.60833in;" /></a>
<p>notification-timer.lua :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>– notifications_timer</p>
<div class="line-block">
<div class="line">local time = string.sub(os.date(“%X”), 1, 5)</div>
<div class="line">return {</div>
<div class="line">on = {</div>
<div class="line">timer = {</div>
<div class="line">‘at 23:00’,</div>
<div class="line">‘at 06:00’,</div>
<div class="line">}</div>
<div class="line">},</div>
<div class="line">execute = function(domoticz, item)</div>
<div class="line">domoticz.log(‘alarme nuit: ‘ .. item.trigger)</div>
<div class="line">if (time==’23:00’) then</div>
<div class="line">if(domoticz.devices(‘al_nuit_auto’).state == “On”) then</div>
<div class="line">domoticz.devices(‘alarme_nuit’).switchOn();print(‘al_nuit=ON’)
end</div>
<div class="line">elseif (time==’06:00’) then</div>
<div class="line">if(domoticz.devices(‘al_nuit_auto’).state == “On”) then</div>
<div class="line">domoticz.variables(‘alarme’).set(‘alarme_auto’);</div>
<div class="line">domoticz.devices(‘alarme_nuit’).switchOff();print(‘al_nuit=OFF’)
end</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image195.png"><img alt="media/image195.png" src="media/image195.png" style="width: 5.75139in; height: 3.55278in;" /></a>
<div class="line-block">
<div class="line"><strong>1.5.2 Liens avec Home Assistant</strong></div>
<div class="line"><strong>1.5.2.1 Exemple d’un ON OFF sur un interrupteur virtuel</strong></div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image196.png"><img alt="media/image196.png" src="media/image196.png" style="width: 4.58333in; height: 2.00972in;" /></a>
<a class="reference internal image-reference" href="media/image197.png"><img alt="media/image197.png" src="media/image197.png" style="width: 3.97083in; height: 2.72917in;" /></a>
<a class="reference internal image-reference" href="media/image198.png"><img alt="media/image198.png" src="media/image198.png" style="width: 4.06528in; height: 1.55278in;" /></a>
</div></blockquote>
<p>Réponse de l’API sur l’état :</p>
<a class="reference internal image-reference" href="media/image199.png"><img alt="media/image199.png" src="media/image199.png" style="width: 6.30139in; height: 0.68611in;" /></a>
<a class="reference internal image-reference" href="media/image200.png"><img alt="media/image200.png" src="media/image200.png" style="width: 5.69861in; height: 2.88611in;" /></a>
<a class="reference internal image-reference" href="media/image201.png"><img alt="media/image201.png" src="media/image201.png" style="width: 6.30139in; height: 0.86806in;" /></a>
<p><strong>La fonction PHP</strong></p>
<a class="reference internal image-reference" href="media/image202.png"><img alt="media/image202.png" src="media/image202.png" style="width: 6.30139in; height: 3.42778in;" /></a>
<p>Comme pour Domoticz une commande dans monitor appelle l’api qui exécute
la commande</p>
<p>footer.php : départ de la commande avec le script créé automatiquement
depuis la base de données</p>
<a class="reference internal image-reference" href="media/image203.png"><img alt="media/image203.png" src="media/image203.png" style="width: 6.30139in; height: 1.04861in;" /></a>
<a class="reference internal image-reference" href="media/image204.png"><img alt="media/image204.png" src="media/image204.png" style="width: 5.84444in; height: 4.19861in;" /></a>
<p>ajax.php :</p>
<a class="reference internal image-reference" href="media/image205.png"><img alt="media/image205.png" src="media/image205.png" style="width: 6.30139in; height: 0.4875in;" /></a>
<p>La fonction PHP ci-dessus retourne pour les capteurs binaires :</p>
<a class="reference internal image-reference" href="media/image206.png"><img alt="media/image206.png" src="media/image206.png" style="width: 3.40694in; height: 2.27083in;" /></a>
<p>En plus clair :</p>
<a class="reference internal image-reference" href="media/image207.png"><img alt="media/image207.png" src="media/image207.png" style="width: 4.73056in; height: 3.5625in;" /></a>
<p>……………….Pour les interrupteurs réels : l’API retourne un tableau vide ,
d’où un appel de l’API/states pour avoir une confirmation du changement
d’état.</p>
<p>Pour faire des essais à partir d’un navigateur :</p>
<a class="reference internal image-reference" href="media/image208.png"><img alt="media/image208.png" src="media/image208.png" style="width: 6.30139in; height: 0.98611in;" /></a>
<p><strong>1.6 – Lien avec la base de données SQL</strong></p>
<p><strong>1.6.1- exemple avec la date de ramassage des poubelles</strong></p>
<p>En Dordogne, les poubelles jaunes sont ramassées toutes les 2 semaines
mais les poubelles grises sont ramassées selon une procédure différente
:</p>
<div class="line-block">
<div class="line">Le contrat annuel comprend 12 ramassages mais le ramassage est
possible chaque semaine, il faut donc gérer au mieux le nombre de
ramassages pour éviter des facturations</div>
<div class="line">supplémentaires…c’est le script décrit ici qui enregistre les dates
des ramassages réels effectués.</div>
</div>
<p>Il faut au préalable ajouter une table dans la base de données</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>–</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>– Structure de la table `date_poub` –</p>
<div class="line-block">
<div class="line">CREATE TABLE `date_poub` (</div>
<div class="line">`num` int(11) NOT NULL,</div>
<div class="line">`date` text NOT NULL,</div>
<div class="line">`valeur` text NOT NULL,</div>
<div class="line">`icone` text NOT NULL</div>
<div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Les 2 icones svg</p></th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image209.png</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>1.59306in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>0.83333in</p>
</dd>
</dl>
</div></blockquote>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image210.png"><img alt="media/image210.png" src="media/image210.png" style="width: 6.26111in; height: 2.46806in;" /></a>
<p>La page d’accueil :</p>
<a class="reference internal image-reference" href="media/image211.png"><img alt="media/image211.png" src="media/image211.png" style="width: 6.26806in; height: 3.86389in;" /></a>
<div class="line-block">
<div class="line">On ajoute un script dans <strong>footer.php</strong></div>
<div class="line">Idx_idimg existe déjà dans footer.php , sa valeur est « poubelle_grise
» ou</div>
<div class="line">« poubelle_jaune » suivant les valeurs choisies dans le script LUA de
Domoticz ; on va ajouter une variable pour l’icône dans les données
json</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">$(“#poubelle”).click(function () {</div>
<div class="line">var date_poub=new Date();</div>
<div class="line">var jour_poub=date_poub.getDate();</div>
<div class="line">var an_poub=date_poub.getFullYear();</div>
<div class="line">var months=new</div>
<div class="line">Array(‘Janvier’,’Février’,’Ma</div>
</div>
</div></blockquote>
<dl>
<dt>rs’,’Avril’,’Mai’,’Juin’,’Juillet’,’Aout’,’Septembre’,’Octobre’,’Nove</dt><dd><blockquote>
<div><p>mbre’,’Décembre’);</p>
</div></blockquote>
<div class="line-block">
<div class="line">var mois_poub=months[date_poub.getMonth()];</div>
<div class="line">var date_poub=jour_poub+’ ‘+mois_poub+” “+an_poub;</div>
<div class="line">$.ajax({</div>
<div class="line">url: “ajax.php”,</div>
<div class="line">data:</div>
<div class="line">“app=s</div>
</div>
</dd>
<dt>ql&amp;idx=0&amp;&amp;variable=date_poub&amp;type=”+idx_idimg+”&amp;command=”+date_poub+”</dt><dd><blockquote>
<div><p>&amp;name=”+idx_ico,</p>
</div></blockquote>
<div class="line-block">
<div class="line">}).done(function() {</div>
<div class="line">alert(‘date ramassage enregigistrée:’ +date_poub);</div>
<div class="line">});</div>
<div class="line">});</div>
</div>
<p>});</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image213.png"><img alt="media/image213.png" src="media/image213.png" style="width: 6.26111in; height: 0.64583in;" /></a>
<div class="line-block">
<div class="line"><strong>Dans fonctions .php</strong></div>
<div class="line">On ajoute la fonction :</div>
</div>
<a class="reference internal image-reference" href="media/image214.png"><img alt="media/image214.png" src="media/image214.png" style="width: 6.26806in; height: 3.20694in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">function sql_app($choix,$table,$valeur,$date,$icone=’’){</div>
<div class="line">// SERVEUR SQL connexion</div>
<div class="line">$conn = new mysqli(SERVEUR,UTILISATEUR,MOTDEPASSE,DBASE);</div>
<div class="line">if ($choix==0) {</div>
<div class="line">$sql=”INSERT INTO “.$table.” (<cite>num</cite>, `date`, `valeur`,
`valeur`) VALUES (NULL, ‘”.$date.”’, ‘”.$valeur.”’,
‘”.$icone.”’);”;</div>
<div class="line">$result = $conn-&gt;query($sql);</div>
<div class="line">;}</div>
<div class="line">if ($choix==1) {</div>
<div class="line">$sql=”SELECT * FROM “.$table.” ORDER BY num DESC LIMIT 24”;</div>
<div class="line">$result = $conn-&gt;query($sql);</div>
<div class="line">$number = $result-&gt;num_rows;</div>
<div class="line">while($row = $result-&gt;fetch_array(MYSQLI_ASSOC)){</div>
<div class="line">echo $row[‘date’].’ ‘.$row[‘valeur’].’ &lt;img
style=”width:30px;vertical-align:middle”
src=”’.$row[‘icone’].’”/&gt;&lt;br&gt;’;</div>
<div class="line">}</div>
<div class="line">}</div>
</div>
<div class="line-block">
<div class="line">$conn-&gt;close();</div>
<div class="line">return;}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Et pour ajouter l’icône au fichier json concernant les variables :</p>
<a class="reference internal image-reference" href="media/image215.png"><img alt="media/image215.png" src="media/image215.png" style="width: 5.54306in; height: 5.91667in;" /></a>
<p>Le json :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image216.png"><img alt="media/image216.png" src="media/image216.png" style="width: 3.84444in; height: 2.125in;" /></a>
</div></blockquote>
<p>Avec phpMyAdmin :</p>
<a class="reference internal image-reference" href="media/image217.png"><img alt="media/image217.png" src="media/image217.png" style="width: 5.50139in; height: 1.24028in;" /></a>
<p>Les enregistrements sont sauvegardés, pour afficher l’historique des
dates, voir le <em>paragraphe 11</em> concernant les app diverses (l’affichage
log de dz et Nagios, …)</p>
<a class="reference internal image-reference" href="media/image218.png"><img alt="media/image218.png" src="media/image218.png" style="width: 5.48056in; height: 2.70833in;" /></a>
<div class="line-block">
<div class="line"><strong>1.7 – Ajuster le menu au nombre de pages</strong></div>
<div class="line">Au-delà de 12 pages il faut étendre en largeur le menu ; il faut aussi
le descendre de 50 px pour ne pas cacher le menu hamburger</div>
</div>
<a class="reference internal image-reference" href="media/image219.png"><img alt="media/image219.png" src="media/image219.png" style="width: 5.48056in; height: 2.67639in;" /></a>
<p>Modification à apporter au fichier <strong>: /js/big-Slide.js</strong> :</p>
<a class="reference internal image-reference" href="media/image220.png"><img alt="media/image220.png" src="media/image220.png" style="width: 3.29305in; height: 3.59444in;" /></a>
<p>Pour descendre le menu : modifier la class .nav dans <strong>css/mes_css.css</strong></p>
<a class="reference internal image-reference" href="media/image221.png"><img alt="media/image221.png" src="media/image221.png" style="width: 3.52222in; height: 1.1875in;" /></a>
<p><strong>2._ Une 1ere PAGE : LE PLAN INTERIEUR</strong></p>
<p><strong>2.1 l’image</strong></p>
<p>Pour construire l’image du plan au format svg on utilise</p>
<div class="line-block">
<div class="line">1 Adobe Illustrateur, payant mais (version hackée sur le net)</div>
<div class="line">2 Inskape gratuit open source :</div>
</div>
<p>Les avantages d’utiliser des images svg c’est de pouvoir manipuler le
contenu avec javascript dans le DOM. Pour cela l’image doit faire partie
complètement du HTML, l’url de l’image ne suffit pas.</p>
<p>Comme on ne peut pas charger uniquement cette url avec par exemple &lt;img
src= ’’image.svg ‘’&gt;, il faut inclure cette image dans un fichier PHP et
faire un include : &lt; ?php include (‘image_svg.php’) ;?&gt;</p>
<p>Il n’est pas facile au début d’utiliser ces logiciels pour construire
complètement un plan ; une autre solution est de construire le plan au
format jpg ou png avec un outil graphique plus facile à utiliser,
Photofiltre, Paint ou Gimp et de convertir ensuite l’image au format svg
en ligne avec par exemple :</p>
<div class="line-block">
<div class="line">C’est une bonne solution pour débuter mais quand tout fonctionne, il
est alors temps de réaliser un plan directement avec AI, le poids du
fichier sera réduit de beaucoup et la qualité sera excellente <strong>Les
deux solutions :</strong></div>
<div class="line"><strong>2.1.1 Avec un logiciel de conception graphique vectorielle</strong></div>
<div class="line"><strong>– 2.1.1.a avec Inkscape qui est gratuit</strong></div>
<div class="line">On délimite le terrain en traçant un rectangle et en choisissant la
couleur</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image222.png"><img alt="media/image222.png" src="media/image222.png" style="width: 5in; height: 3.76111in;" /></a>
</div></blockquote>
<p>On construit les murs extérieurs de la même façon ; on peut ajuster
l’épaisseur en utilisant la barre supérieure</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image223.png"><img alt="media/image223.png" src="media/image223.png" style="width: 4.63889in; height: 4.50694in;" /></a>
<p>Pour modifier les objets :</p>
<a class="reference internal image-reference" href="media/image224.png"><img alt="media/image224.png" src="media/image224.png" style="width: 5.84444in; height: 3.4875in;" /></a>
<p>Toujours avec un rectangle, on ajoute les pièces</p>
<a class="reference internal image-reference" href="media/image225.png"><img alt="media/image225.png" src="media/image225.png" style="width: 6.02917in; height: 4.07361in;" /></a>
<p>On peut faire du copier/coller</p>
<a class="reference internal image-reference" href="media/image226.png"><img alt="media/image226.png" src="media/image226.png" style="width: 4.25in; height: 4.29861in;" /></a>
</div></blockquote>
<p>Pour regrouper des objets de même couleur ou d’un même ensemble :
GROUPER</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image227.png"><img alt="media/image227.png" src="media/image227.png" style="width: 4.27222in; height: 4.89583in;" /></a>
<p>Pour dégrouper :</p>
<a class="reference internal image-reference" href="media/image228.png"><img alt="media/image228.png" src="media/image228.png" style="width: 3.64583in; height: 4.52083in;" /></a>
<p>Pour les textes</p>
<a class="reference internal image-reference" href="media/image229.png"><img alt="media/image229.png" src="media/image229.png" style="width: 4.02083in; height: 3.81667in;" /></a>
<div class="line-block">
<div class="line">Améliorer l’emplacement des ouvertures :</div>
<div class="line">On reste dégroupé et on trace un rectangle autour des murs</div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="media/image230.png"><img alt="media/image230.png" src="media/image230.png" style="width: 5.36944in; height: 4.15556in;" /></a>
<p>Contrairement à Adobe Illustrator , Inkscape ne gère pas les feuilles de
style mais celles indiquées sont afficher dans les navigateurs.</p>
<p>Pour ajouter des class pour gérer les changements de couleur dans
monitor pour certains dispositifs :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image233.png"><img alt="media/image233.png" src="media/image233.png" style="width: 5.5in; height: 5.53889in;" /></a>
<p>On donne un nom à cette classe :</p>
<a class="reference internal image-reference" href="media/image234.png"><img alt="media/image234.png" src="media/image234.png" style="width: 5.38194in; height: 3.90556in;" /></a>
<p>L’objet avec la class :</p>
<a class="reference internal image-reference" href="media/image235.png"><img alt="media/image235.png" src="media/image235.png" style="width: 3.69861in; height: 4.79167in;" /></a>
<p>Lans le fichier .svg</p>
<a class="reference internal image-reference" href="media/image236.png"><img alt="media/image236.png" src="media/image236.png" style="width: 3.09306in; height: 3.45139in;" /></a>
<p>Remarque :</p>
<a class="reference internal image-reference" href="media/image237.png"><img alt="media/image237.png" src="media/image237.png" style="width: 5.44861in; height: 3.72222in;" /></a>
<p>On ajoute aussi une class aux textes</p>
<a class="reference internal image-reference" href="media/image238.png"><img alt="media/image238.png" src="media/image238.png" style="width: 4.28194in; height: 5.14861in;" /></a>
<p>La feuille de style complète pour le plan</p>
<a class="reference internal image-reference" href="media/image239.png"><img alt="media/image239.png" src="media/image239.png" style="width: 2.19861in; height: 2.54167in;" /></a>
<p>L’image est centrée au milieu du calque , on la déplace à l’angle
droit haut</p>
<a class="reference internal image-reference" href="media/image240.png"><img alt="media/image240.png" src="media/image240.png" style="width: 5.54167in; height: 3.24028in;" /></a>
<p>On fait correspondre l’image avec la page</p>
<a class="reference internal image-reference" href="media/image241.png"><img alt="media/image241.png" src="media/image241.png" style="width: 5.38611in; height: 3.69861in;" /></a>
<p>On sauvegarde l l’image</p>
</div></blockquote>
<p>On nettoie le code et on créer un fichier PHP qui contiendra l’image ;
pour que cette image soit modifiable par le DOM, elle ne peut être
appelée directement comme pour les formats classiques mais chargée
entièrement dans le fichier HTML.</p>
<p><strong>Avant nettoyage :</strong></p>
<a class="reference internal image-reference" href="media/image242.png"><img alt="media/image242.png" src="media/image242.png" style="width: 4.99028in; height: 6.68194in;" /></a>
<p><strong>Après nettoyage : on</strong> supprime la partie ci-dessus (jusqu’à «
&lt;style&gt;) et on la remplace par :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>&lt;svg version=”1.1” id=”Calque_1” viewBox=”0 0 150 150”&gt;</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image243.png"><img alt="media/image243.png" src="media/image243.png" style="width: 5.46944in; height: 1.60417in;" /></a>
<p><strong>Pour comprendre viewbox :</strong></p>
<p>Affichage dans monitor (on peut ajouter une marge pour centrer l’image)
534x720 : tablette chinoise</p>
<a class="reference internal image-reference" href="media/image244.png"><img alt="media/image244.png" src="media/image244.png" style="width: 4.49028in; height: 4.54722in;" /></a>
<a class="reference internal image-reference" href="media/image245.png"><img alt="media/image245.png" src="media/image245.png" style="width: 4.53194in; height: 4.0625in;" /></a>
<p>PC : 1200x612</p>
<p>La construction est sensiblement la même, la différence pour notre
sujet, réside dans la description</p>
<p>des ID ; Inkscape ajoute des id partout, AI en ajoute aucun, sauf si on
le spécifie, comme ci-dessous ;</p>
<p>Il est impératif pour retrouver facilement les objets d’ajouter les id à
la construction.</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image247.png"><img alt="media/image247.png" src="media/image247.png" style="width: 4.96944in; height: 5.68056in;" /></a>
<a class="reference internal image-reference" href="media/image248.png"><img alt="media/image248.png" src="media/image248.png" style="width: 6.3in; height: 1.78194in;" /></a>
</div></blockquote>
<p>Les cercles ici indiquent lorsqu’ils clignotent, un changement de piles
à prévoir ; le N° qui sui « cercle » est l’id du dispositif.</p>
<p>Dans Inkscape, lors de la construction, il est possible d’ajouter du
javascript, avec AI, il faut l’ajouter avec un éditeur de texte ou
dreamweaver.</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image249.png"><img alt="media/image249.png" src="media/image249.png" style="width: 6.3in; height: 2.60556in;" /></a>
<p>Attention aux styles après construction :</p>
<a class="reference internal image-reference" href="media/image250.png"><img alt="media/image250.png" src="media/image250.png" style="width: 5.91667in; height: 1.83333in;" /></a>
<p>Un style qui existe alors qu’il n’est pas utilisé crée une erreur</p>
<p><strong>Mon plan avec AI</strong> : dans le paragraphe suivant la première version
de ce plan faite</p>
</div></blockquote>
<p>avec une conversion png-&gt;svg</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image251.png"><img alt="media/image251.png" src="media/image251.png" style="width: 5.44861in; height: 7.5125in;" /></a>
<p><strong>2.1.2 – 2eme solution pour le plan, conversion en ligne</strong></p>
<a class="reference internal image-reference" href="media/image252.png"><img alt="media/image252.png" src="media/image252.png" style="width: 4.00972in; height: 3.5375in;" /></a>
</div></blockquote>
<p><strong>Mon fichier floorplan.png</strong></p>
<a class="reference internal image-reference" href="media/image253.png"><img alt="media/image253.png" src="media/image253.png" style="width: 5.53194in; height: 5.59306in;" /></a>
<p><strong>Conversion avec Autotracer :</strong></p>
<a class="reference internal image-reference" href="media/image254.png"><img alt="media/image254.png" src="media/image254.png" style="width: 4.67778in; height: 4.1875in;" /></a>
<a class="reference internal image-reference" href="media/image255.png"><img alt="media/image255.png" src="media/image255.png" style="width: 5.00139in; height: 4.9375in;" /></a>
<p><strong>Avec Inkscape :</strong></p>
<p>Les textes transformés ne sont pas toujours lisibles, il faut modifier
le plan, on ajoute des rectangles de la même couleur :</p>
<a class="reference internal image-reference" href="media/image258.png"><img alt="media/image258.png" src="media/image258.png" style="width: 6.26806in; height: 4.275in;" /></a>
<p><strong>2.1.3 – Les couleurs</strong></p>
<p>Choisir des couleurs web : 6 familles (#00xxxx, #33xxxx, #66xxxx,
#99xxxx, #CCxxxx, #FFxxxx),</p>
<p>216 couleurs, ce qui limite ne nombre de class ; un seul fichier de
class pour tout le site… la</p>
<p>construction est plus longue et là aussi il faut le faire depuis le
début</p>
<blockquote>
<div><p><a class="reference internal" href="media/image259.png"><img alt="image5" src="media/image259.png" style="width: 0.54306in; height: 0.11389in;" /></a><a class="reference internal" href="media/image259.png"><img alt="image6" src="media/image259.png" style="width: 0.54167in; height: 0.11389in;" /></a></p>
<a class="reference internal image-reference" href="media/image260.png"><img alt="media/image260.png" src="media/image260.png" style="width: 2.19722in; height: 2.675in;" /></a>
</div></blockquote>
<div class="line-block">
<div class="line"><strong>2.1.4 - ajout d’un ou plusieurs dispositifs</strong></div>
<div class="line">Sur le net on trouve des icones au format svg, sinon on transforme les
png avec Autotracer Les icones que j’ai choisies : contact d’ouverture
de porte et détecteur de présence</div>
</div>
<p><strong>3</strong> <a class="reference internal" href="media/image261.png"><img alt="image7" src="media/image261.png" style="width: 1.78194in; height: 1.75972in;" /></a></p>
<div class="line-block">
<div class="line">4Pour les textes il suffit par exemple d’ajouter « tmp » qui sera en
javascript remplacé par la température enregistrée par le dispositif</div>
<div class="line">Importer l’icone</div>
</div>
<a class="reference internal image-reference" href="media/image262.png"><img alt="media/image262.png" src="media/image262.png" style="width: 3.63611in; height: 2.94861in;" /></a>
<a class="reference internal image-reference" href="media/image263.png"><img alt="media/image263.png" src="media/image263.png" style="width: 6.26806in; height: 4.49444in;" /></a>
<a class="reference internal image-reference" href="media/image264.png"><img alt="media/image264.png" src="media/image264.png" style="width: 5.35556in; height: 5.23889in;" /></a>
<a class="reference internal image-reference" href="media/image265.png"><img alt="media/image265.png" src="media/image265.png" style="width: 5.24028in; height: 3.53194in;" /></a>
<p>Redimensionner l’(les)objet(s) :</p>
<a class="reference internal image-reference" href="media/image266.png"><img alt="media/image266.png" src="media/image266.png" style="width: 3.06389in; height: 2.08333in;" /></a>
<p>Comme on peut le voir, avec les images svg le remplacement de couleur,
de textes s’effectuent rapidement lors de la création ; il en est de
même dans le HTML en utilisant javascript</p>
<p>Ajouter un texte « tmp » par exemple pour l’affichage de la température
; ce texte sera remplacé par la valeur de la température ; les
détecteurs de présence peuvent souvent enregistrer la température.</p>
<a class="reference internal image-reference" href="media/image267.png"><img alt="media/image267.png" src="media/image267.png" style="width: 5.12639in; height: 3.95833in;" /></a>
<p>Pour les dispositifs et les textes, ajouter un ID :</p>
<p>Avec Inkscape, il est possible d’ajouter facilement un ID lors de la
construction de l’image</p>
<a class="reference internal image-reference" href="media/image268.png"><img alt="media/image268.png" src="media/image268.png" style="width: 5.67778in; height: 6.08333in;" /></a>
<p>La couleur de l’objet :</p>
<a class="reference internal image-reference" href="media/image269.png"><img alt="media/image269.png" src="media/image269.png" style="width: 6.26806in; height: 4.41528in;" /></a>
<p>Avec Adobe Illustrator :</p>
<a class="reference internal image-reference" href="media/image270.png"><img alt="media/image270.png" src="media/image270.png" style="width: 6.03194in; height: 3.84444in;" /></a>
<p>Enregistrer le fichier, j’ai choisi « interieur.svg », le nom de ma page</p>
<a class="reference internal image-reference" href="media/image271.png"><img alt="media/image271.png" src="media/image271.png" style="width: 6.26806in; height: 1.17361in;" /></a>
<p>Pour les textes c’est la même façon de procéder</p>
<a class="reference internal image-reference" href="media/image272.png"><img alt="media/image272.png" src="media/image272.png" style="width: 5.25139in; height: 4.16667in;" /></a>
<p>Aperçu d’une image avec de nombreux dispositifs</p>
<a class="reference internal image-reference" href="media/image273.png"><img alt="media/image273.png" src="media/image273.png" style="width: 5.20972in; height: 5.125in;" /></a>
<p><strong>2.2 Des exemples d’autres dispositifs :</strong></p>
<p><strong>2.2.1 Ajout du détecteur de fumée :</strong></p>
<blockquote>
<div><p>Ajout de l’icône avec Inkscape :</p>
</div></blockquote>
<p><a class="reference internal" href="media/image274.png"><img alt="image8" src="media/image274.png" style="width: 1.98056in; height: 2.36389in;" /></a><a class="reference internal" href="media/image275.png"><img alt="image9" src="media/image275.png" style="width: 3.88194in; height: 1.72083in;" /></a></p>
<p>Dans les paramètres de l’objet on a ajouté :</p>
<blockquote>
<div><p>Un href, un id, un titre et un onclick avec un id (idm ou idx) ;
option choisie dans /admin/config.php</p>
<a class="reference internal image-reference" href="media/image276.png"><img alt="media/image276.png" src="media/image276.png" style="width: 3.53194in; height: 0.35417in;" /></a>
</div></blockquote>
<p><strong>2.2.2 Ajout de caméras</strong></p>
<p>Comme il n’existe pas d’idx Domoticz, nous réserverons la plage &gt;= 10
000 pour cela ; cette valeur peut être modifiée, voir le paragraphe
2.2.1</p>
<p><strong>2.3 le fichier PHP de l’image</strong></p>
<p>Avec Notepad, on supprime les premières lignes (Inkscape), comme indiqué
au <em>§2.1.1</em> ou les 2 ou 3 premières lignes (AI) :</p>
<a class="reference internal image-reference" href="media/image279.png"><img alt="media/image279.png" src="media/image279.png" style="width: 6.19861in; height: 0.61389in;" /></a>
<p>Enregistrer l’image au format PHP dans le dossier /include:
interieur_svg.php (utilisé ici)</p>
<p>Récupérer dans Domoticz les noms et les idx des dispositifs</p>
<a class="reference internal image-reference" href="media/image280.png"><img alt="media/image280.png" src="media/image280.png" style="width: 6.26111in; height: 0.88472in;" /></a>
<p>Dans la table « dispositifs » de la base de données Maria DB Domoticz,
enregistrer ces données ; si c’est une première installation de monitor,
idm peut être le même qu’idx ; dans l’exemple ci-dessous idm est
différent après une réinstallation de Domoticz.</p>
<a class="reference internal image-reference" href="media/image281.png"><img alt="media/image281.png" src="media/image281.png" style="width: 6.26111in; height: 1.01111in;" /></a>
<p>Autre exemple :</p>
<a class="reference internal image-reference" href="media/image282.png"><img alt="media/image282.png" src="media/image282.png" style="width: 6.26806in; height: 3.53056in;" /></a>
<a class="reference internal image-reference" href="media/image283.png"><img alt="media/image283.png" src="media/image283.png" style="width: 6.26111in; height: 3.42778in;" /></a>
<p>Que fait le script javascript qui gère les dispositifs :</p>
<a class="reference internal image-reference" href="media/image284.png"><img alt="media/image284.png" src="media/image284.png" style="width: 6.26111in; height: 5.66667in;" /></a>
<p>L’appel ajax : appelle la fonction PHP devices_plan($variable), la
variable est le N° du Plan</p>
<a class="reference internal image-reference" href="media/image285.png"><img alt="media/image285.png" src="media/image285.png" style="width: 6.26806in; height: 0.19444in;" /></a>
<p>La fonction PHP :</p>
<a class="reference internal image-reference" href="media/image286.png"><img alt="media/image286.png" src="media/image286.png" style="width: 6.21944in; height: 6.8125in;" /></a>
<p>Le Json renvoyé :</p>
<a class="reference internal image-reference" href="media/image287.png"><img alt="media/image287.png" src="media/image287.png" style="width: 3.77222in; height: 5.33333in;" /></a>
<p>Monitor peut afficher un changement de couleur du dispositif, une
température mais à condition de retrouver l’ID du dispositif ou l’ID du
texte dans le DOM.</p>
<p>C’est pourquoi nous avons ajouté des ID lors de la construction du plan.</p>
<p>Un aperçu du fichier interieur_svg.php :</p>
<p>Pour une icône avec une seule couleur, l’ID de l’icône est suffisant
mais avec une icône où une seule partie est colorée comme pour
l’ouverture de porte, ii est facile, avec F12 d’inspecter la partie de
l’icône qui nous intéresse et de rajouter un ID dans le &lt;path concerné :</p>
<a class="reference internal image-reference" href="media/image288.png"><img alt="media/image288.png" src="media/image288.png" style="width: 6.26806in; height: 3.91528in;" /></a>
<p>C’est alors cet ID qu’il faudra entrer pour le dispositif dans la Base
de données SQL.</p>
<a class="reference internal image-reference" href="media/image289.png"><img alt="media/image289.png" src="media/image289.png" style="width: 6.21944in; height: 0.49028in;" /></a>
<p>Pour les textes, si l’ID n’a pas été spécifié à la construction de
l’image, ils sont faciles à retrouver avec une recherche sur Notepad
pour ajouter un ID ;</p>
<p>Sur AI il faudra souvent modifier légèrement l’ID</p>
<a class="reference internal image-reference" href="media/image290.png"><img alt="media/image290.png" src="media/image290.png" style="width: 6.26111in; height: 2.20833in;" /></a>
<p><strong>2.3.1 Pour afficher le statut complet du dispositif :</strong></p>
<div class="line-block">
<div class="line">C’est la fonction javascript du fichier footer.php qui ouvre cette
fenêtre :</div>
<div class="line">Remarque : les caméras ne sont pas des dispositifs dans Domoticz,
aussi des ID &gt;= à 10000 leur sont attribués ; cette valeur peut être
modifiée en modifiant le programme qui suit.</div>
</div>
<a class="reference internal image-reference" href="media/image294.png"><img alt="media/image294.png" src="media/image294.png" style="width: 5.53194in; height: 6.65694in;" /></a>
<p>Cette fonction est activée par un onclick que l’on ajoute dans l’image ;
par contre la BD n’est pas nécessaire pour cet affichage, à condition
que le onclick possède comme id l’idx de Domoticz.</p>
<a class="reference internal image-reference" href="media/image295.png"><img alt="media/image295.png" src="media/image295.png" style="width: 6.00139in; height: 1.03194in;" /></a>
<p>Avec Inkscape ce onclick peut être ajouter lors de la construction, avec
AI il faut l’ajouter manuellement comme ci-dessus :</p>
<a class="reference internal image-reference" href="media/image296.png"><img alt="media/image296.png" src="media/image296.png" style="width: 4.43889in; height: 4.11528in;" /></a>
<a class="reference internal image-reference" href="media/image297.png"><img alt="media/image297.png" src="media/image297.png" style="width: 4.09167in; height: 4.18889in;" /></a>
<p>Pour indiquer que l’élément est cliquable, comme pour le HTML, on ajoute
une balise &lt;a ; non nécessaire surtout pour les tablettes.</p>
<a class="reference internal image-reference" href="media/image298.png"><img alt="media/image298.png" src="media/image298.png" style="width: 6.26111in; height: 1.95833in;" /></a>
<p>Ou lors de la construction avec Inkscape :</p>
<a class="reference internal image-reference" href="media/image299.png"><img alt="media/image299.png" src="media/image299.png" style="width: 6.26806in; height: 3.68611in;" /></a>
<p>Où :</p>
<a class="reference internal image-reference" href="media/image300.png"><img alt="media/image300.png" src="media/image300.png" style="width: 2.99028in; height: 2.30139in;" /></a>
<p><strong>2.3.2 Affichage des caméras :</strong></p>
<p>Pour les caméras génériques chinoises, pour les configurer : Internet
explorer est le seul navigateur qui permet d’afficher Net Surveillance</p>
<a class="reference internal image-reference" href="media/image301.png"><img alt="media/image301.png" src="media/image301.png" style="width: 4.85417in; height: 3.70278in;" /></a>
<p>La table « cameras » dans la base de données SQL a été remplie, voir le
paragraphe concernant la base de données au début de ce document</p>
<a class="reference internal image-reference" href="media/image302.png"><img alt="media/image302.png" src="media/image302.png" style="width: 6.26667in; height: 1.15555in;" /></a>
<p>Seulement si Zoneminder est utilisé :</p>
<p>Pour retrouver l’ID Zoneminder pour toutes les cameras :</p>
<p>Dans un navigateur : IP DE ZONEMINDER/zm/api/monitor.json</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image303.png"><img alt="media/image303.png" src="media/image303.png" style="width: 4.07361in; height: 2.69861in;" /></a>
<a class="reference internal image-reference" href="media/image304.png"><img alt="media/image304.png" src="media/image304.png" style="width: 4.41528in; height: 4.86111in;" /></a>
</div></blockquote>
<p>Les icones, les onclick, les &lt;a pour le lien, ont été ajoutés sur le
plan ; une fenêtre (modal) est ajoutée</p>
<p>sur la page.</p>
<p>Voir paragraphe 2.1.2 : ajout dans l’image du plan</p>
<p>Voir paragraphe 2.3 : fichier PHP de la page avec les fenêtres modales
<strong>La modale pour la fenêtre de l’image :</strong></p>
<a class="reference internal image-reference" href="media/image305.png"><img alt="media/image305.png" src="media/image305.png" style="width: 5.4375in; height: 2.51389in;" /></a>
<p>C’est la fonction PHP « upload_img($idx) » appelée par ajax qui renvoi
l’image de la caméra</p>
<a class="reference internal image-reference" href="media/image306.png"><img alt="media/image306.png" src="media/image306.png" style="width: 5.84444in; height: 5.16667in;" /></a>
<p>Le script JS dans footer.php :</p>
<a class="reference internal image-reference" href="media/image307.png"><img alt="media/image307.png" src="media/image307.png" style="width: 6.26806in; height: 4.70556in;" /></a>
<div class="line-block">
<div class="line"><strong>Affichage de la configuration des caméras</strong>:</div>
<div class="line">Pour les caméras Dahua, il existe un script spécifique ; pour les
autres caméras, le script ne fonctionne que si Zoneminder est installé
et la configuration effectuée :</div>
<div class="line">Le fichier de configuration admin/config.php :</div>
<div class="line">Si Zoneminder est utilisé</div>
</div>
<a class="reference internal image-reference" href="media/image308.png"><img alt="media/image308.png" src="media/image308.png" style="width: 6.20833in; height: 2.54167in;" /></a>
<p>L’affichage de cette config est géré par un script JS : modalink et non
par une fenêtre modale</p>
<p>qui est déjà ouverte pour l’image ; appel de ce script par le bouton
dans la modale de</p>
<p>l’image : voir également paragraphe 2.3</p>
<a class="reference internal image-reference" href="media/image312.png"><img alt="media/image312.png" src="media/image312.png" style="width: 4.10833in; height: 0.7125in;" /></a>
<p>Les script JS, dans footer.php et dans mes_js.js : <em>Dans footer.php :</em></p>
<a class="reference internal image-reference" href="media/image313.png"><img alt="media/image313.png" src="media/image313.png" style="width: 6.26806in; height: 2.55139in;" /></a>
<a class="reference internal image-reference" href="media/image314.png"><img alt="media/image314.png" src="media/image314.png" style="width: 6.26806in; height: 1.54722in;" /></a>
<p><em>Dans mes_js.js :</em></p>
<p>Le fichier ajax.php et Le script PHP, function
cam_config($marque,$type,$ip,$cam,$idzm), (dans fonctions.php)</p>
<a class="reference internal image-reference" href="media/image317.png"><img alt="media/image317.png" src="media/image317.png" style="width: 6.26806in; height: 0.45833in;" /></a>
<p>Extrait de la fonction cam_config du fichier :</p>
<p>Pour caméras DAHUA :</p>
<a class="reference internal image-reference" href="media/image318.png"><img alt="media/image318.png" src="media/image318.png" style="width: 5.13611in; height: 6.03472in;" /></a>
<p>Modification CURL pour les différents types d’Autorisation des caméras
Dahua :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">3.2Authentication</div>
<div class="line">The IP Camera supplies two authentication ways: basic
authentication and digest authentication. Client can login
through:</div>
<div class="line"><a class="reference external" href="http:/">http:/</a>/&lt;ip&gt;/cgi-bin/global.login?userName=admin. The IP camera
returns 401. Then the client inputs a username and password to
authorize.</div>
</div>
<div class="line-block">
<div class="line">For example:</div>
<div class="line">1. When basic authentication, the IP camera response:</div>
<div class="line">401 Unauthorized</div>
<div class="line">WWW-Authenticate: Basic realm=”XXXXXX”</div>
<div class="line">Then the client encode the username and password with base64,
send the following request: Authorization: Basic VXZVXZ.</div>
</div>
<div class="line-block">
<div class="line">2. When digest authentication, the IP camera response:</div>
<div class="line">WWW-Authenticate: Digest realm=”DH_00408CA5EA04”,</div>
<div class="line">nonce=”000562fdY631973ef04f77a3ede7c1832ff48720ef95ad”,</div>
<div class="line">stale=FALSE, qop=”auth”;</div>
<div class="line">The client calculates the digest using username, password,
nonce, realm and URI with MD5, then send the following request:</div>
<div class="line">Authorization: Digest username=”admin”, realm=”DH_00408CA5EA04”,
nc=00000001,cnonce=”0a4f113b”,qop=”auth”
nonce=”000562fdY631973ef04f7</div>
</div>
</div></blockquote>
<dl class="simple">
<dt>7a3ede7c1832ff48720ef95ad”,uri=”cgi-bin/global.login?userName=admin”,</dt><dd><p>response=”65002de02df697e946b750590b44f8bf”</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Dire à Curl d’accepter plusieurs méthodes comme ceci :</div>
<div class="line">curl_easy_setopt(curl, CURLOPT_HTTPAUTH, CURLAUTH_BASIC |
CURLAUTH_DIGEST);</div>
</div>
<a class="reference internal image-reference" href="media/image319.png"><img alt="media/image319.png" src="media/image319.png" style="width: 6.07361in; height: 2.88472in;" /></a>
<p>Pour caméras onvif autres :</p>
<p>Assurée par la fonction PHP devices_plan (), vue précédemment ; la
variable dans la base de</p>
<blockquote>
<div><p>données SQL a aussi été décrite lors de la configuration minimale</p>
<p>Table « dispositifs » : variables</p>
<a class="reference internal image-reference" href="media/image322.png"><img alt="media/image322.png" src="media/image322.png" style="width: 5.28194in; height: 2.13611in;" /></a>
<p>Table « text_image » :</p>
<a class="reference internal image-reference" href="media/image323.png"><img alt="media/image323.png" src="media/image323.png" style="width: 6.26111in; height: 1.33333in;" /></a>
<p><strong>accueil.php</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image324.png"><img alt="media/image324.png" src="media/image324.png" style="width: 6.26806in; height: 1.20833in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>css</strong> :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Pour une meilleure visualisation des dispositifs dont la pile est à
remplacer, un ajout sur l’image du plan d’un signe distinctifs : un
cercle clignotant.</p>
<p>Pour une meilleure compréhension, toute la gestion des piles sera
décrite ici ;</p>
<p>Dans un cadre jaune, ce qui devra être ajouté, le reste ayant déjà été
créé (variables Domoticz et SQL, images svg, …</p>
<a class="reference internal image-reference" href="media/image326.png"><img alt="media/image326.png" src="media/image326.png" style="width: 6.26111in; height: 2.78056in;" /></a>
<a class="reference internal image-reference" href="media/image327.png"><img alt="media/image327.png" src="media/image327.png" style="width: 4.25139in; height: 1.02083in;" /></a>
<a class="reference internal image-reference" href="media/image328.png"><img alt="media/image328.png" src="media/image328.png" style="width: 4.63472in; height: 2.85in;" /></a>
<p>Variables Domoticz :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image329.png"><img alt="media/image329.png" src="media/image329.png" style="width: 6.01944in; height: 1.23611in;" /></a>
</div></blockquote>
<blockquote>
<div><p>Le script dz :</p>
</div></blockquote>
<blockquote>
<div><p>Sur la page d’accueil</p>
<a class="reference internal image-reference" href="media/image332.png"><img alt="media/image332.png" src="media/image332.png" style="width: 1.85694in; height: 1.12639in;" /></a>
<p>Sur la page des dispositifs</p>
<p><a class="reference internal" href="media/image333.png"><img alt="image10" src="media/image333.png" style="width: 1.84444in; height: 1.59306in;" /></a> <a class="reference internal" href="media/image334.png"><img alt="image11" src="media/image334.png" style="width: 3.28056in; height: 0.82222in;" /></a></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image335.png"><img alt="media/image335.png" src="media/image335.png" style="width: 3.94861in; height: 4.60417in;" /></a>
<p>En plus d’une gestion globale, un cercle clignotant indique que la pile
devra être remplacée</p>
<p>sur le dispositif concerné.</p>
<p>Ce cercle visible selon l’état de la batterie est ajouté au plan :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image336.png"><img alt="image12" src="media/image336.png" style="width: 6.26111in; height: 4.0625in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Il suffit d’ajouter en copier/coller des cercles à tous les
dispositifs sur piles.</p>
</div></blockquote>
<blockquote>
<div><p>Les valeurs sont définies dans le fichier de configuration
/admin/config.php :</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image339.png"><img alt="media/image339.png" src="media/image339.png" style="width: 6.26111in; height: 2.1875in;" /></a>
<p><strong>2.3 4 Le contrôle de la tension d’alimentation :</strong></p>
<a class="reference internal image-reference" href="media/image340.png"><img alt="media/image340.png" src="media/image340.png" style="width: 5.49028in; height: 2.88472in;" /></a>
<div class="line-block">
<div class="line">Le fichier voltmetre_svg.php</div>
<div class="line">Comme pour les dispositifs on télécharge une image svg ; comme pour le
plan, sur Inkscape ou AI on ajoute un texte (tmp ou autre) qui sera
remplacé par la valeur de la tension.</div>
</div>
<p>On enregistre cette image dans un fichier PHP (on supprime les lignes
inutiles).</p>
<p>On ajoute aussi un ID</p>
<a class="reference internal image-reference" href="media/image341.png"><img alt="media/image341.png" src="media/image341.png" style="width: 6.26806in; height: 1.56528in;" /></a>
<p>Le dispositif Domoticz :</p>
<a class="reference internal image-reference" href="media/image342.png"><img alt="media/image342.png" src="media/image342.png" style="width: 4.03194in; height: 1.21944in;" /></a>
<p>La base de données SQL :</p>
<a class="reference internal image-reference" href="media/image343.png"><img alt="media/image343.png" src="media/image343.png" style="width: 6.26806in; height: 0.59444in;" /></a>
<a class="reference internal image-reference" href="media/image344.png"><img alt="media/image344.png" src="media/image344.png" style="width: 1.38472in; height: 0.75in;" /></a>
<div class="line-block">
<div class="line">Pour maj_js, au lieu de temp il est possible de remplacer le type par
un autre texte ; pour cela il faut modifier le script JS</div>
<div class="line">Le script JS dans le fichier footer.php, déjà vu précédemment :</div>
</div>
<a class="reference internal image-reference" href="media/image345.png"><img alt="media/image345.png" src="media/image345.png" style="width: 6.26806in; height: 1.07639in;" /></a>
<div class="line-block">
<div class="line"><strong>2.3 5 ajouter des lampes :</strong></div>
<div class="line">Voir un exemple dans le paragraphe 4.1.1 consacré à l’extérieur de la
maison, les lampe de jardin</div>
<div class="line"><strong>2.3.6 ajouter un capteur de T° extérieur Zigbee</strong></div>
</div>
<a class="reference internal image-reference" href="media/image346.png"><img alt="media/image346.png" src="media/image346.png" style="width: 5.51111in; height: 3.36528in;" /></a>
<p><strong>2.3.6.1 Le capteur dans Domoticz :</strong></p>
<a class="reference internal image-reference" href="media/image347.png"><img alt="media/image347.png" src="media/image347.png" style="width: 3.95972in; height: 1.28194in;" /></a>
<a class="reference internal image-reference" href="media/image348.png"><img alt="media/image348.png" src="media/image348.png" style="width: 3.58472in; height: 0.69722in;" /></a>
<p><em>Dans le plan de Domoticz :</em></p>
<a class="reference internal image-reference" href="media/image349.png"><img alt="media/image349.png" src="media/image349.png" style="width: 2.59444in; height: 1.60417in;" /></a>
<p><strong>2.3.6.2 Le capteur dans la BD :</strong></p>
<a class="reference internal image-reference" href="media/image350.png"><img alt="media/image350.png" src="media/image350.png" style="width: 6.26806in; height: 0.3625in;" /></a>
<p>On a choisi de limiter le nb de caractère à 4, à l’origine : <a class="reference internal" href="media/image351.png"><img alt="image13" src="media/image351.png" style="width: 0.96805in; height: 0.375in;" /></a></p>
<div class="line-block">
<div class="line"><strong>2.3.6.3 Le capteur dans Monitor :</strong></div>
<div class="line"><strong>L’image :</strong></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">&lt;svg version=”1.1” id=”th_1” xmlns=”<a class="reference external" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>”</div>
<div class="line">xmlns:xlink=”http://www.w3.org/1999/xlink” x=”0px” y=”0px”</div>
<div class="line">viewBox=”0 0 20 20” style=”enable-background:new 0 0 20 20;”
xml:space=”preserve”&gt; &lt;a xlink:href=”#interieur”
onclick=”popup_device(23)”&gt;&lt;path style=”fill: #84bef1;” rel=”23”
d=”M9,11.2V7h2v4.2c1.6,0.6,2.4,2.3,1.8,3.8c-0.6,1.6-2.3,2.4-</div>
<div class="line">3.8,1.8S6.6,14.6,7.2,13C7.5,12.1,8.1,11.5,9,11.2z M8,10.5</div>
<div class="line">c-1.9,1.1-2.6,3.6-1.5,5.5s3.6,2.6,5.5,1.5c1.9-1.1,2.6-</div>
</div>
</div></blockquote>
<dl>
<dt>3.6,1.5-5.5c-0.4-0.6-0.9-1.1-1.5-1.5V4c0-1.1-0.9-2-2-2S8,2.9,8,4V10.5</dt><dd><div class="line-block">
<div class="line">L8,10.5z
M6,9.5V4c0-2.2,1.8-4,4-4s4,1.</div>
</div>
</dd>
<dt>8,4,4v5.5c2.5,2.2,2.7,6,0.5,8.5c-1.1,1.3-2.8,2-4.5,2c-3.3,0-6-2.7-6-6</dt><dd><div class="line-block">
<div class="line">C4,12.3,4.7,10.7,6,9.5z”/&gt;&lt;/a&gt;</div>
<div class="line">&lt;text id=”temp_ext_cuisine” transform=”matrix(0.6725 0 0 1
7.4663 15.254)” class=”st33 st36b”&gt;tmp&lt;/text&gt;</div>
<div class="line">&lt;/svg&gt;</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image352.png"><img alt="media/image352.png" src="media/image352.png" style="width: 6.26806in; height: 2.09305in;" /></a>
<p>Le fichier Json</p>
<a class="reference internal image-reference" href="media/image353.png"><img alt="media/image353.png" src="media/image353.png" style="width: 3.48055in; height: 4.10417in;" /></a>
<a class="reference internal image-reference" href="media/image354.png"><img alt="media/image354.png" src="media/image354.png" style="width: 3.94861in; height: 4.85833in;" /></a>
<div class="line-block">
<div class="line"><strong>2.4 le fichier PHP de la page</strong></div>
<div class="line">Il faut maintenant ajouter la page sur le site</div>
<div class="line">Un modèle de page pour toutes les pages du site :</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;!– section TITRE start –&gt;</div>
<div class="line">&lt;!– ================ –&gt;</div>
<div class="line">&lt;div id=”ID DE LA PAGE” class=”CLASS DE LA PAGE OPTIONNEL”&gt; &lt;div
class=”container”&gt;</div>
<div class="line">&lt;div class=”col-md-12”&gt;</div>
<div class="line">&lt;h1 class=”title_TITRE text-center”&gt; exemple Prévisions&lt;span&gt;
météo&lt;/span&gt;&lt;/h1&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;div class=”CLASS DU CONTENU” style=”color:black;”&gt; &lt;div id=”ID
DE CETTE LIGNE” &gt;LIGNE OPTIONNELLE&lt;/div&gt;</div>
<div class="line">&lt;div id=”CONTENU” class=”table-responsive”&gt;&lt;/div&gt; &lt;div id=”AUTRE
CONTENU OPTIONNEL”&gt;&lt;/div&gt;</div>
<div class="line">&lt;/div&gt; &lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;!– fin de la section TITRE –&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>En Bleu du contenu optionnel</p>
<a class="reference internal image-reference" href="media/image355.png"><img alt="media/image355.png" src="media/image355.png" style="width: 6.26111in; height: 2.66667in;" /></a>
<p>Sur cette page, des fenêtres(modal) peuvent être ajoutées si besoin,
Bootstrap facilite la création ; sur la page décrite en suivant, 2
fenêtres sont ajoutées.</p>
<p>Le menu :</p>
<a class="reference internal image-reference" href="media/image356.png"><img alt="media/image356.png" src="media/image356.png" style="width: 5.16806in; height: 2.1875in;" /></a>
<p>Le fichier interieur .php</p>
<a class="reference internal image-reference" href="media/image357.png"><img alt="media/image357.png" src="media/image357.png" style="width: 6.26111in; height: 5.21806in;" /></a>
<p>Le fichier index_loc.php : pour info, en général ne pas modifier ce
fichier</p>
<a class="reference internal image-reference" href="media/image358.png"><img alt="media/image358.png" src="media/image358.png" style="width: 5.94861in; height: 4.03194in;" /></a>
<p>Le fichier include/header.php :</p>
<a class="reference internal image-reference" href="media/image359.png"><img alt="media/image359.png" src="media/image359.png" style="width: 6.26111in; height: 1.24028in;" /></a>
<a class="reference internal image-reference" href="media/image360.png"><img alt="media/image360.png" src="media/image360.png" style="width: 4.16805in; height: 4.85417in;" /></a>
<div class="line-block">
<div class="line">CSS : css/mes_css.css</div>
<div class="line">Le style existe déjà pour toutes les pages , pour les modifier :</div>
</div>
<a class="reference internal image-reference" href="media/image361.png"><img alt="media/image361.png" src="media/image361.png" style="width: 5.91806in; height: 2.1875in;" /></a>
<a class="reference internal image-reference" href="media/image362.png"><img alt="media/image362.png" src="media/image362.png" style="width: 5.53194in; height: 7.49167in;" /></a>
<p><strong>2.5 F12 des navigateurs pour faciliter la construction</strong></p>
<p>Pour les PIR, les capteurs d’ouverture, pour le changement de couleur :</p>
<a class="reference internal image-reference" href="media/image363.png"><img alt="media/image363.png" src="media/image363.png" style="width: 6.26806in; height: 8.17222in;" /></a>
<p><strong>2.6 Les dispositifs virtuels Domoticz et MQTT</strong></p>
<p>Pour monitor ça n’a pas d’importance, il n’y a pas de notion « virtuel –
réel » mais la mise à</p>
<p>jour de ces dispositifs dans Domoticz n’est pas toujours facile surtout
pour les dispositifs</p>
<p>avec plusieurs valeurs tels que température+ Humidité température
+batterie, …</p>
<p><strong>Un script dz : séparation_valeurs.lua</strong></p>
<a class="reference internal image-reference" href="media/image364.png"><img alt="media/image364.png" src="media/image364.png" style="width: 6.26806in; height: 4.325in;" /></a>
<p>Depuis Domoticz 2021.1</p>
<a class="reference internal image-reference" href="media/image365.png"><img alt="media/image365.png" src="media/image365.png" style="width: 4.69861in; height: 2.45833in;" /></a>
<p><strong>3._ Météo</strong></p>
<div class="line-block">
<div class="line">2 affichages :</div>
<div class="line">5Une page de prévision à 14 jours de Météo Concept 6Une alerte pluie
imminent (à 1 h de météo France) <strong>3.1_ Page météo</strong></div>
<div class="line">Cette page n’a PAS DE LIAISON AVEC DOMOTICZ</div>
<div class="line">Voir également le site</div>
</div>
<a class="reference internal image-reference" href="media/image366.png"><img alt="media/image366.png" src="media/image366.png" style="width: 6.26806in; height: 2.70972in;" /></a>
<p>L’API est gratuite chez Météo Concept mais il faut s’enregistrer pour
obtenir une clé Le PHP : dans fonctions.php</p>
<a class="reference internal image-reference" href="media/image367.png"><img alt="media/image367.png" src="media/image367.png" style="width: 5.91806in; height: 5.72917in;" /></a>
<a class="reference internal image-reference" href="media/image368.png"><img alt="media/image368.png" src="media/image368.png" style="width: 6.26111in; height: 2.91667in;" /></a>
<p>Le JS dans footer.php</p>
<a class="reference internal image-reference" href="media/image369.png"><img alt="media/image369.png" src="media/image369.png" style="width: 4.70972in; height: 3.125in;" /></a>
<p>Pour la mise à jour auto chaque matin :</p>
<a class="reference internal image-reference" href="media/image370.png"><img alt="media/image370.png" src="media/image370.png" style="width: 6.16667in; height: 2.32222in;" /></a>
<p>Le HTML : la page meteo.php</p>
<a class="reference internal image-reference" href="media/image371.png"><img alt="media/image371.png" src="media/image371.png" style="width: 5.46944in; height: 7.53333in;" /></a>
<a class="reference internal image-reference" href="media/image372.png"><img alt="media/image372.png" src="media/image372.png" style="width: 6.25in; height: 3.72917in;" /></a>
<p>Il faut ajouter la page au site ; la procédure est toujours la même : :
dans config.php, Mettre la variable à « true » ; <strong>il faut au préalable
demander un token gratuit.</strong></p>
<a class="reference internal image-reference" href="media/image373.png"><img alt="media/image373.png" src="media/image373.png" style="width: 5.30278in; height: 0.85417in;" /></a>
<p>Dans header.php, l’affichage dans le menu est alors automatique.</p>
<a class="reference internal image-reference" href="media/image374.png"><img alt="media/image374.png" src="media/image374.png" style="width: 6.24028in; height: 0.9375in;" /></a>
<p>La page meteo.php :</p>
<a class="reference internal image-reference" href="media/image375.png"><img alt="media/image375.png" src="media/image375.png" style="width: 6.26111in; height: 5.3125in;" /></a>
<p>Les css : en plus du style pour la page :</p>
<a class="reference internal image-reference" href="media/image376.png"><img alt="media/image376.png" src="media/image376.png" style="width: 4.04305in; height: 0.70833in;" /></a>
<p>Les icones :</p>
<a class="reference internal image-reference" href="media/image377.png"><img alt="media/image377.png" src="media/image377.png" style="width: 5.63611in; height: 3.63611in;" /></a>
<a class="reference internal image-reference" href="media/image378.png"><img alt="media/image378.png" src="media/image378.png" style="width: 5.52222in; height: 5.14583in;" /></a>
<div class="line-block">
<div class="line"><strong>3.2_ La Météo à 1 heure de Météo France :</strong></div>
<div class="line">Ne fait pas partie de la page météo : affichage sur la page d’accueil</div>
</div>
<a class="reference internal image-reference" href="media/image379.png"><img alt="media/image379.png" src="media/image379.png" style="width: 5.46944in; height: 3.625in;" /></a>
<a class="reference internal image-reference" href="media/image380.png"><img alt="media/image380.png" src="media/image380.png" style="width: 6.17778in; height: 5.20833in;" /></a>
<p>accueil.php :</p>
<a class="reference internal image-reference" href="media/image381.png"><img alt="media/image381.png" src="media/image381.png" style="width: 5.55278in; height: 1in;" /></a>
<p>Les icones svg « pluie imminente » et « pas de pluie » :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image382.png"><img alt="image14" src="media/image382.png" style="width: 0.97361in; height: 0.81111in;" /></a></p></th>
<th class="head"><p><a class="reference internal" href="media/image383.png"><img alt="image15" src="media/image383.png" style="width: 0.97083in; height: 0.91528in;" /></a></p></th>
<th class="head"><p><a class="reference internal" href="media/image384.png"><img alt="image16" src="media/image384.png" style="width: 0.96805in; height: 1.29167in;" /></a></p></th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>vertopal_6e277a
ed43794de08da72
29da055806a/med
ia/image385.png</p>
<dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>0.625in
:he</p>
</dd>
</dl>
<p>ight: 1.04167in</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Footer.php :</strong></p>
<a class="reference internal image-reference" href="media/image386.png"><img alt="media/image386.png" src="media/image386.png" style="width: 6.30139in; height: 4.01667in;" /></a>
<p>PHP : ajax.php et fonction PHP « app_met($choix) » ajax.php :</p>
<a class="reference internal image-reference" href="media/image387.png"><img alt="media/image387.png" src="media/image387.png" style="width: 6.26806in; height: 0.36111in;" /></a>
<p>Dans fonctions.php :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>2</p></th>
<th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>Choix :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td><p>(1) en HTML sur le
site</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><div class="line-block">
<div class="line">Indiquer Commune-Code postal</div>
<div class="line">- (2) par météo France et son API avec un Token</div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="media/image388.png"><img alt="media/image388.png" src="media/image388.png" style="width: 6.26806in; height: 5.23194in;" /></a>
<p>La base de données : correspondance texte – image, la table
<strong>text_image</strong></p>
<a class="reference internal image-reference" href="media/image389.png"><img alt="media/image389.png" src="media/image389.png" style="width: 6.26806in; height: 1.35417in;" /></a>
<p>Voir le site</p>
<a class="reference internal image-reference" href="media/image390.png"><img alt="media/image390.png" src="media/image390.png" style="width: 6.26111in; height: 2.09444in;" /></a>
<p><strong>3.3_ Autres prévisions météo depuis météo Concept :</strong></p>
<ul class="simple">
<li><p>relevés temps réel depuis une station :</p></li>
<li><p>prévision heure par heure : peut remplacer Darsky (devenu payant) ou</p></li>
</ul>
<p>OpenWeatherMap,</p>
<p>c’est français et plus facile d’utilisation, nombreux exemple sur le
site web Méteoconcept</p>
<a class="reference internal image-reference" href="media/image391.png"><img alt="media/image391.png" src="media/image391.png" style="width: 6.30139in; height: 2.73333in;" /></a>
<a class="reference internal image-reference" href="media/image392.png"><img alt="media/image392.png" src="media/image392.png" style="width: 5.77222in; height: 1.1875in;" /></a>
<p><strong>4._ La page du plan extérieur</strong></p>
<a class="reference internal image-reference" href="media/image393.png"><img alt="media/image393.png" src="media/image393.png" style="width: 5.63611in; height: 7.49167in;" /></a>
<p>La construction est la même que pour la page inteieur.php.</p>
<p>Le chargement des pages se faisant dès l’appel de l’url, pour éviter les
class similaires dans l’image svg, si <strong>elle a été créée avec Adobe
Illustrateur)</strong>, il est impératif de les renommer.</p>
<div class="line-block">
<div class="line">Avec Inkscape, la feuille de style n’est pas gérée par le logiciel,
mais insérer par l’utilisateur lors de la construction :</div>
<div class="line">UNIQUEMENT POUR AI</div>
</div>
<p>Nettoyage : Ces lignes ne servent à rien : les enlever</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image396.png"><img alt="media/image396.png" src="media/image396.png" style="width: 2.51111in; height: 0.98056in;" /></a>
</div></blockquote>
<p>L’image est sauvegardée par exemple en « exterieur_svg.php » (un fichier
avec l’extension</p>
<p>.php) :</p>
<p><strong>4.1 – La page PHP : exterieur.php :</strong></p>
<div class="line-block">
<div class="line">Les infos des dispositifs : la fenêtre modale est commune avec
interieur.php Les dispositifs en plus des capteurs classiques déjà
décrits :</div>
<div class="line">- Eclairage du jardin</div>
<div class="line">- Arrosage automatique</div>
<div class="line">- Portier vidéo</div>
<div class="line">- Boite aux lettres, ….</div>
</div>
<div class="line-block">
<div class="line">Ils sont chargés avec un seul script, celui décrit dans footer.php
(voir interieur.php)</div>
<div class="line">Pour les caméras une fenêtre modale, identique à celle de
interieur.php, (aux ID près) est ajouter sur la page</div>
</div>
<a class="reference internal image-reference" href="media/image397.png"><img alt="media/image397.png" src="media/image397.png" style="width: 5.26111in; height: 5.52639in;" /></a>
<a class="reference internal image-reference" href="media/image398.png"><img alt="media/image398.png" src="media/image398.png" style="width: 6.02222in; height: 3.55278in;" /></a>
<a class="reference internal image-reference" href="media/image399.png"><img alt="media/image399.png" src="media/image399.png" style="width: 5.54306in; height: 5.46944in;" /></a>
<p><strong>4.1 .1– Ajouter des lampes</strong></p>
<p>Apres avoir téléchargé une image svg ajouter les icones au plan</p>
<p>Pour commander les lampes : un interrupteur virtuel dans Domoticz ou un
interrupteur réel (Zigbee ou Zwave) avec son double dans Domoticz</p>
<a class="reference internal image-reference" href="media/image402.png"><img alt="media/image402.png" src="media/image402.png" style="width: 4.15694in; height: 1.45833in;" /></a>
<p>Un double de cet interrupteur sera aussi ajouté à Monitor, c’est l’objet
du chapitre « mur ON/OFF »</p>
<p>La table « dispositifs » SQL :</p>
<a class="reference internal image-reference" href="media/image403.png"><img alt="media/image403.png" src="media/image403.png" style="width: 4.77222in; height: 0.83333in;" /></a>
<a class="reference internal image-reference" href="media/image404.png"><img alt="media/image404.png" src="media/image404.png" style="width: 6.26806in; height: 0.70833in;" /></a>
<p>Pour chaque lampe, on indique la class dans l’image svg : avec le
navigateur et F12 c’est le plus simple car une class pour la couleur
existe déjà, il suffit d’ajouter la class choisie ; dans l’attribut
class, il faut séparer les class avec un espace.</p>
<a class="reference internal image-reference" href="media/image405.png"><img alt="media/image405.png" src="media/image405.png" style="width: 5.13611in; height: 1.99861in;" /></a>
<p>La fonction maj_devices, déjà décrite pour les IDs des dispositifs, la
partie du script consacrée aux lampes :</p>
<a class="reference internal image-reference" href="media/image406.png"><img alt="media/image406.png" src="media/image406.png" style="width: 6.1875in; height: 4.34444in;" /></a>
<p>Il n’existe pas de commande simple en javascript, comme pour les IDs,
pour effectuer des changements d’attribut ; les ID sont uniques alors
que les class peuvent être utilisées de nombreuses fois ; il faut donc
balayer tous les éléments pour les rechercher, c’est ce que fait la
fonction « class_name »</p>
<p><strong>4.2. – affichage :</strong></p>
<p>Il suffit, comme pour toutes les pages optionnelles ne mettre la
variable à « true » :</p>
<a class="reference internal image-reference" href="media/image407.png"><img alt="media/image407.png" src="media/image407.png" style="width: 5.48889in; height: 0.64444in;" /></a>
<p><strong>5. – L’ALARME</strong></p>
<p>Pour l’activation ou l’arrêt par GSM voire ce paragraphe qui traite du
script python avec les codes retenus pour l’alarme. <em>$ 18.4</em></p>
<a class="reference internal image-reference" href="media/image408.png"><img alt="media/image408.png" src="media/image408.png" style="width: 5.64444in; height: 5.56389in;" /></a>
<p>Pour entrer le mot de passe : redirection vers la page administration</p>
<p><strong>5.1 Dans Domoticz, les interrupteurs virtuels</strong></p>
<p>Les boutons poussoir marche/arrêt pour les commandes :</p>
<blockquote>
<div><div class="line-block">
<div class="line">- m/a alarme de nuit</div>
<div class="line">- m/a alarme absence</div>
<div class="line">- m/a al_nuit_auto</div>
<div class="line">- m/a sirène</div>
<div class="line">- m/a mode detect des caméras</div>
<div class="line">- poussoir de reset des valeurs de Domoticz,</div>
<div class="line">- activation/désactivation de la sirène : permet de faire des
essais sans nuisances sonores ; la sirène est toutefois indiquée ON
ou OFF</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Option : allumages de lampes :</div>
<div class="line">-Dans ce tuto : lampe_salon (lampe commandée par le 433MHz avec une
interface Sonoff modifié, voir le site domo-site.fr</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image409.png"><img alt="media/image409.png" src="media/image409.png" style="width: 4.44861in; height: 2.625in;" /></a>
<p>Pour le test sirène : un interrupteur « PUSH »</p>
<a class="reference internal image-reference" href="media/image410.png"><img alt="media/image410.png" src="media/image410.png" style="width: 4.68889in; height: 1.75in;" /></a>
<a class="reference internal image-reference" href="media/image411.png"><img alt="media/image411.png" src="media/image411.png" style="width: 6.5in; height: 0.51111in;" /></a>
<a class="reference internal image-reference" href="media/image412.png"><img alt="media/image412.png" src="media/image412.png" style="width: 6.26806in; height: 0.45in;" /></a>
<a class="reference internal image-reference" href="media/image413.png"><img alt="media/image413.png" src="media/image413.png" style="width: 6.26806in; height: 0.5in;" /></a>
<p>On ajoute les dispositifs au plan ; le plan peut se résumer à un
simple cadre ou être très simplifié, il ne sert qu’à regrouper les
dispositifs pour récupérer les données avec un seul appel à l’API
json</p>
<a class="reference internal image-reference" href="media/image414.png"><img alt="media/image414.png" src="media/image414.png" style="width: 5.26111in; height: 4.39444in;" /></a>
<a class="reference internal image-reference" href="media/image415.png"><img alt="media/image415.png" src="media/image415.png" style="width: 6.26806in; height: 0.21111in;" /></a>
<a class="reference internal image-reference" href="media/image416.png"><img alt="media/image416.png" src="media/image416.png" style="width: 4.05278in; height: 0.57222in;" /></a>
<a class="reference internal image-reference" href="media/image417.png"><img alt="media/image417.png" src="media/image417.png" style="width: 5.55278in; height: 4.65694in;" /></a>
</div></blockquote>
<p><strong>Création de variables, initialisée à 0</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>ma-alarme :</p></li>
</ul>
<a class="reference internal image-reference" href="media/image418.png"><img alt="media/image418.png" src="media/image418.png" style="width: 4.51944in; height: 1.61389in;" /></a>
<p>o alarme non activée,</p>
<p>o1 alarme absence activée, les capteurs PIR sont pris en compte</p>
<p>o2 alarme nuit activée, les capteurs PIR sont ignorés</p>
<ul class="simple">
<li><p>modect : pour la mise en service de la détection par caméras (non</p></li>
</ul>
<p>utilisé actuellement, pour</p>
<p>une notification en page d’accueil ou autre …)</p>
<a class="reference internal image-reference" href="media/image419.png"><img alt="media/image419.png" src="media/image419.png" style="width: 6.26667in; height: 0.77222in;" /></a>
<ul class="simple">
<li><p>porte-ouverte</p></li>
<li><p>intrusion</p></li>
</ul>
<div class="line-block">
<div class="line">- alarme : sera utilisée pour un affichage sur la page d’accueil ;
il est plus facile de créer une variable supplémentaire qui
contiendra un texte pour pouvoir faire une équivalence texte- image
dans la BD</div>
<div class="line">- activation-sir-txt, texte activation de la sirène : <em>activer ou
désactiver</em></div>
</div>
<a class="reference internal image-reference" href="media/image420.png"><img alt="media/image420.png" src="media/image420.png" style="width: 6.5in; height: 0.85694in;" /></a>
<a class="reference internal image-reference" href="media/image421.png"><img alt="media/image421.png" src="media/image421.png" style="width: 6.26806in; height: 0.2875in;" /></a>
<a class="reference internal image-reference" href="media/image422.png"><img alt="media/image422.png" src="media/image422.png" style="width: 6.26806in; height: 0.84306in;" /></a>
</div></blockquote>
<p>Notifications : notifications_devices.lua</p>
<a class="reference internal image-reference" href="media/image423.png"><img alt="media/image423.png" src="media/image423.png" style="width: 3.94861in; height: 2.88611in;" /></a>
<a class="reference internal image-reference" href="media/image424.png"><img alt="media/image424.png" src="media/image424.png" style="width: 6.26806in; height: 5.11111in;" /></a>
<div class="line-block">
<div class="line">ATTENTION :</div>
<div class="line">L’utilisation du modem 4G Ebyte n’autorise pas, pour les textes, les
accents et les espaces, utiliser des Under scores pour séparer les
mots</div>
<div class="line">Script notifications_variables.lua, lignes concernées :</div>
</div>
<a class="reference internal image-reference" href="media/image425.png"><img alt="media/image425.png" src="media/image425.png" style="width: 6.05278in; height: 1.52083in;" /></a>
<p>Script notifications_timer.lua, lignes concernées :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>– notifications_timer</p>
<div class="line-block">
<div class="line">local time = string.sub(os.date(“%X”), 1, 5)</div>
<div class="line">return {</div>
<div class="line">on = {</div>
<div class="line">timer = {</div>
<div class="line">‘at 23:00’,</div>
<div class="line">‘at 06:00’,</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">},</div>
<div class="line">execute = function(domoticz, item)</div>
<div class="line">domoticz.log(‘alarme nuit: ‘ .. item.trigger)</div>
<div class="line">if (time==’23:00’) then</div>
<div class="line">if(domoticz.devices(‘al_nuit_auto’).state == “On”) then</div>
<div class="line">domoticz.devices(‘alarme_nuit’).switchOn();print(‘al_nuit=ON’)
end</div>
<div class="line">elseif (time==’06:00’) then</div>
<div class="line">if(domoticz.devices(‘al_nuit_auto’).state == “On”) then</div>
<div class="line">domoticz.variables(‘alarme’).set(‘alarme_auto’);</div>
<div class="line">domoticz.devices(‘alarme_nuit’).switchOff();print(‘al_nuit=OFF’)
end</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image426.png"><img alt="media/image426.png" src="media/image426.png" style="width: 6.26806in; height: 3.77361in;" /></a>
<p>L’utilisation de timer= at hh :mm-hh :mm ne peut être utilisé ; j’ai
essayé isTimer mais ça ne</p>
<p>fonctionne que pour ON ; else avec isTimer ne fonctionne pas.</p>
<p>Ajout du script « alarme_intrusion.lua dans évènements de Domoticz :</p>
<a class="reference internal image-reference" href="media/image427.png"><img alt="media/image427.png" src="media/image427.png" style="width: 6.26806in; height: 5.37361in;" /></a>
<a class="reference internal image-reference" href="media/image428.png"><img alt="media/image428.png" src="media/image428.png" style="width: 6.26806in; height: 4.22778in;" /></a>
<a class="reference internal image-reference" href="media/image429.png"><img alt="media/image429.png" src="media/image429.png" style="width: 6.26806in; height: 6.00694in;" /></a>
<div class="line-block">
<div class="line"><strong>Pour activer ou désactiver la sirène :</strong></div>
<div class="line">Pour les textes : notifications_devices.lua</div>
</div>
<a class="reference internal image-reference" href="media/image430.png"><img alt="media/image430.png" src="media/image430.png" style="width: 6.26806in; height: 0.69722in;" /></a>
<p>Pour l’activation ou la désactivation :</p>
<a class="reference internal image-reference" href="media/image431.png"><img alt="media/image431.png" src="media/image431.png" style="width: 6.26806in; height: 1.48055in;" /></a>
<p>Pour allumer des lampes :</p>
<a class="reference internal image-reference" href="media/image432.png"><img alt="media/image432.png" src="media/image432.png" style="width: 5.41806in; height: 1.625in;" /></a>
<p>Pour ajouter des dispositifs :</p>
<a class="reference internal image-reference" href="media/image433.png"><img alt="media/image433.png" src="media/image433.png" style="width: 6.21944in; height: 2.91667in;" /></a>
<p>Le fichier pushover.sh :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">#!/bin/bash</div>
<div class="line">TITLE=”Alerte”</div>
<div class="line">APP_TOKEN=”xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx”
USER_TOKEN=”xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx” MESSAGE=$1</div>
<div class="line">echo $1</div>
<div class="line">curl -s -F “token=$APP_TOKEN” \</div>
<div class="line">-F “user=$USER_TOKEN” \</div>
<div class="line">-F “title=$TITLE” \</div>
<div class="line">-F “message=$MESSAGE” \</div>
<div class="line"><a class="reference external" href="https://api.pushover.net/1/messages.json">https://api.pushover.net/1/messages.json</a></div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Ou en Python :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>#!/bin/python</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">import requests,sys</div>
<div class="line">x= str(sys.argv[1])</div>
<div class="line">r = requests.post(“<a class="reference external" href="https://api.pushover.net/1/messages.json">https://api.pushover.net/1/messages.json</a>”,
data = { “token”: “xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx”,</div>
<div class="line">“user”: “xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx”,</div>
<div class="line">“message”: x</div>
<div class="line">})</div>
<div class="line">print(r.text)</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Voir les pages du site ,</p>
<p>Et</p>
<p>Résumé des scripts Domoticz concernés :</p>
<a class="reference internal image-reference" href="media/image434.png"><img alt="media/image434.png" src="media/image434.png" style="width: 6.26806in; height: 4.45139in;" /></a>
<p><strong>5.1.1 explications concernant MODECT</strong></p>
<p>Si l’alarme absence est activée les caméras autorisées passent en mode
MODECT</p>
<p>automatiquement.</p>
<p>Dans les autres cas Modect peut être activé manuellement.</p>
<a class="reference internal image-reference" href="media/image435.png"><img alt="media/image435.png" src="media/image435.png" style="width: 4.22917in; height: 3.63472in;" /></a>
<a class="reference internal image-reference" href="media/image436.png"><img alt="media/image436.png" src="media/image436.png" style="width: 4.70972in; height: 4.47917in;" /></a>
<p><strong>Il faut avoir installé Zoneminder</strong></p>
<blockquote>
<div><p><strong>5.1.1.1 Jeton ZM</strong></p>
<p>Dans fonctions.php :</p>
<a class="reference internal image-reference" href="media/image437.png"><img alt="media/image437.png" src="media/image437.png" style="width: 6.26806in; height: 3.91667in;" /></a>
<a class="reference internal image-reference" href="media/image438.png"><img alt="media/image438.png" src="media/image438.png" style="width: 6.26806in; height: 5.73333in;" /></a>
<p>Le format du fichier est json pour une exploitation facile avec
Domoticz <strong>5.1.1.2 le script lua :</strong></p>
<a class="reference internal image-reference" href="media/image439.png"><img alt="media/image439.png" src="media/image439.png" style="width: 6.26806in; height: 3.18611in;" /></a>
<p>Le fichier string_modect est écrit automatiquement dans «
administration »</p>
<a class="reference internal image-reference" href="media/image440.png"><img alt="media/image440.png" src="media/image440.png" style="width: 3.3125in; height: 2.54861in;" /></a>
<a class="reference internal image-reference" href="media/image441.png"><img alt="media/image441.png" src="media/image441.png" style="width: 4.35694in; height: 2.75972in;" /></a>
<p>Le choix des caméras se fait dans la BD :</p>
<a class="reference internal image-reference" href="media/image442.png"><img alt="media/image442.png" src="media/image442.png" style="width: 2.76111in; height: 2.8125in;" /></a>
</div></blockquote>
<p><strong>5.2 Construction de l’image</strong></p>
<p>On ajoute les composants avec Inkscape, les ID pour les changements de
couleur, pas besoin de onclick, il n’y a que des dispositifs virtuels.</p>
<p>La construction de la page est identique à celle du plan intérieur.</p>
<p>Les boutons M/A sont réalisés avec 2 cercles de grandeur et de couleur
différentes, les poussoirs simples (les mains) sont des icones
téléchargées ; l’icône png de Domoticz a été convertie en svg.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image445.png"><img alt="image17" src="media/image445.png" style="width: 1.54306in; height: 1.6875in;" /></a></p></th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>:: vertopal_6e277aed4
3794de08da7229da05580
6a/media/image446.png</p>
<blockquote>
<div><blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>1.05278in</p>
</dd>
</dl>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">height</dt>
<dd class="field-odd"><p>1.13472in</p>
</dd>
</dl>
</div></blockquote>
</th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>:: vertopal_6e277aed4
3794de08da7229da05580
6a/media/image447.png</p>
<blockquote>
<div><blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>0.84444in</p>
</dd>
</dl>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">height</dt>
<dd class="field-odd"><p>1.17778in</p>
</dd>
</dl>
</div></blockquote>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>On ajoute des zones de textes pour la date, les messages ,….</p>
<a class="reference internal image-reference" href="media/image448.png"><img alt="media/image448.png" src="media/image448.png" style="width: 5.28194in; height: 6.25in;" /></a>
<a class="reference internal image-reference" href="media/image449.png"><img alt="media/image449.png" src="media/image449.png" style="width: 4.50139in; height: 1.16667in;" /></a>
<p>On enregistre l’image dans un fichier PHP, comme indiqué au paragraphe
2.2</p>
<p>On peut aussi ajouter les ID avec F12 du navigateur</p>
<a class="reference internal image-reference" href="media/image450.png"><img alt="media/image450.png" src="media/image450.png" style="width: 5.94861in; height: 1.4375in;" /></a>
<div class="line-block">
<div class="line">Vérifier avec un navigateur qu’il n’y a pas de doublon d’ID (F12) ;
dans ce cas faire des</div>
<div class="line">remplacements : ex remplacer « pathxxxx » ou avec Notepad tous les
’’path remplacé par ‘’patha</div>
</div>
<p>Un extrait concernant le bouton « activation/désactivation de la sirène
»</p>
<a class="reference internal image-reference" href="media/image451.png"><img alt="media/image451.png" src="media/image451.png" style="width: 6.26806in; height: 4.91389in;" /></a>
<div class="line-block">
<div class="line"><strong>5.3- Base de données,</strong></div>
<div class="line"><strong>Table « dispositifs »</strong></div>
<div class="line">Après avoir ajouté les ID : enregistrement des dispositifs virtuels
dans la base de données ; On ajoute au dispositif dans la colonne pass
: « pwdalarm » pour limiter l’accès ;(cette valeur peut être modifiée
dans config.php)</div>
</div>
<a class="reference internal image-reference" href="media/image452.png"><img alt="media/image452.png" src="media/image452.png" style="width: 6.26111in; height: 1.83333in;" /></a>
<a class="reference internal image-reference" href="media/image453.png"><img alt="media/image453.png" src="media/image453.png" style="width: 6.26806in; height: 0.28611in;" /></a>
<p>Comme on peut le voir pour l’alarme absence il a été préféré l’ID du
cercle à l’ID de Inkscape</p>
<a class="reference internal image-reference" href="media/image454.png"><img alt="media/image454.png" src="media/image454.png" style="width: 5.77222in; height: 1.01111in;" /></a>
<a class="reference internal image-reference" href="media/image455.png"><img alt="media/image455.png" src="media/image455.png" style="width: 6.26806in; height: 3.03472in;" /></a>
<p>Il est aussi possible de renommer l’ID du cercle. <strong>Partie concernant
les variables</strong></p>
<a class="reference internal image-reference" href="media/image456.png"><img alt="media/image456.png" src="media/image456.png" style="width: 6.19861in; height: 4.25972in;" /></a>
<p><strong>5.4- Le PHP</strong></p>
<p><strong>alarme.php :</strong></p>
<a class="reference internal image-reference" href="media/image457.png"><img alt="media/image457.png" src="media/image457.png" style="width: 5.10139in; height: 6.14583in;" /></a>
<p><strong>test_pass.php :</strong> surligné en jaune : pour admin.php, voir le <em>§ 13.2</em></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">&lt;?php</div>
<div class="line">session_start();</div>
<div class="line">echo ‘&lt;script&gt;text1=””;&lt;/script&gt;’;</div>
<div class="line">if (isset($_SESSION[‘time’])) {$tt=$_SESSION[‘time’];}</div>
<div class="line">else {$tt=0;echo “&lt;p id=’mp1’ style=’float:left;’&gt;entrer mot de
passe - &lt;/p&gt;”;} if (isset($_SESSION[‘passworda’]) &amp;&amp;
(($_SESSION[‘passworda’]) != PWDALARM)){$tt=0;echo “mot de passe
non valide - “;}</div>
<div class="line">else {echo “&lt;script&gt;text1=’pwd:ok’;&lt;/script&gt;”;$style1=”block”;}</div>
<div class="line">if ($tt&lt;time()) {$tt=0;echo “&lt;p id=’mp2’ &gt;temps pwd dépassé -
&lt;/p&gt;”;} if ($tt==0){</div>
<div class="line">echo</div>
<div class="line">“&lt;scrip</div>
</div>
</div></blockquote>
<dl>
<dt>t&gt;text1=’pwd:absent’;document.getElementById(‘d_btn_a’).style.display</dt><dd><blockquote>
<div><p>=</p>
</div></blockquote>
<div class="line-block">
<div class="line">‘block’;document.getElementById(‘d_btn_al’).style.display =
‘block’;</div>
<div class="line">&lt;/script&gt;”;}</div>
<div class="line">else {echo
“&lt;script&gt;document.getElementById(‘info_admin’).style.display =
‘none’;&lt;/script&gt;”;}</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">echo “&lt;script&gt;</div>
<div class="line">document.getElementById(‘tspan7024’).innerHTML=jour;
document.getElementById(‘console1’).innerHTML=text1;
document.getElementById(‘not’).innerHTML=’’;</div>
<div class="line">&lt;/script&gt;”;</div>
<div class="line">?&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image458.png"><img alt="media/image458.png" src="media/image458.png" style="width: 6.26806in; height: 1.87639in;" /></a>
<a class="reference internal image-reference" href="media/image459.png"><img alt="media/image459.png" src="media/image459.png" style="width: 5.85417in; height: 6.00972in;" /></a>
<p>Le fichier config.php gère les mots de passe de l’alarme et de la
commande des dispositifs (on/off)</p>
<a class="reference internal image-reference" href="media/image462.png"><img alt="media/image462.png" src="media/image462.png" style="width: 5.78194in; height: 1.74028in;" /></a>
<p>Dans fonctions.php :</p>
<a class="reference internal image-reference" href="media/image463.png"><img alt="media/image463.png" src="media/image463.png" style="width: 5.19861in; height: 2.77083in;" /></a>
<p>Le script qui commande les poussoirs M/A</p>
<a class="reference internal image-reference" href="media/image464.png"><img alt="media/image464.png" src="media/image464.png" style="width: 6.26111in; height: 3.13611in;" /></a>
<p><strong>5.5- Le Javascript, dans footer.php et mes_js.js</strong> Les scripts pour
les mots de passe, dans mes_js.js</p>
<a class="reference internal image-reference" href="media/image465.png"><img alt="media/image465.png" src="media/image465.png" style="width: 6.20833in; height: 4.40556in;" /></a>
<p>Et le script pour le clavier affiché dans administration</p>
<a class="reference internal image-reference" href="media/image466.png"><img alt="media/image466.png" src="media/image466.png" style="width: 4.58472in; height: 4.40694in;" /></a>
<div class="line-block">
<div class="line">Sans mot de passe les commandes sont impossibles ; si le temps est
dépassé pour</div>
<div class="line">l’utilisation du mot de passe, le bouton « Entrer votre mot de passe »
apparait lors d’un click.</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image467.png"><img alt="media/image467.png" src="media/image467.png" style="width: 3.51111in; height: 2.57361in;" /></a>
<a class="reference internal image-reference" href="media/image468.png"><img alt="media/image468.png" src="media/image468.png" style="width: 5.57361in; height: 3.4375in;" /></a>
<p>La fonction maj_services (footer.php) permet la mise à jour des
textes « <em>activer ou désactiver</em> »</p>
<p>Le script pour afficher une modale « modalink »</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image469.png"><img alt="media/image469.png" src="media/image469.png" style="width: 5.92778in; height: 3.54167in;" /></a>
<div class="line-block">
<div class="line"><strong>5.6 -Comme pour les autres pages</strong>,</div>
<div class="line">Il ne reste qu’à :</div>
<div class="line">- Ajouter cette page dans config.php</div>
</div>
<p><strong>5.7- Affichage d’une icône sur la page d’accueil :</strong></p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image472.png"><img alt="media/image472.png" src="media/image472.png" style="width: 3.94722in; height: 5.32222in;" /></a>
</div></blockquote>
<p>Pour l’alarme de nuit, pour ne pas oublier de l’annuler le matin si la
fonction auto n’a pas été choisie</p>
<p><strong>css</strong></p>
<a class="reference internal image-reference" href="media/image473.png"><img alt="media/image473.png" src="media/image473.png" style="width: 4.05278in; height: 0.59444in;" /></a>
<a class="reference internal image-reference" href="media/image474.png"><img alt="media/image474.png" src="media/image474.png" style="width: 6.5in; height: 0.21528in;" /></a>
<p><strong>accueil.php :</strong></p>
<a class="reference internal image-reference" href="media/image475.png"><img alt="media/image475.png" src="media/image475.png" style="width: 6.26806in; height: 1.43194in;" /></a>
<p><strong>Dans Domoticz :</strong> la variable a déjà été crée</p>
<p>Quand l’alarme nuit est activée, son contenu :</p>
<a class="reference internal image-reference" href="media/image476.png"><img alt="media/image476.png" src="media/image476.png" style="width: 6.26806in; height: 0.52083in;" /></a>
<p><strong>La table text_images</strong> : correspondance entre le texte et l’image</p>
<a class="reference internal image-reference" href="media/image477.png"><img alt="media/image477.png" src="media/image477.png" style="width: 6.26111in; height: 0.50972in;" /></a>
<p><strong>La table variables_dz</strong> : la variable existe déjà, vérifier l’ID pour
l’icone</p>
<a class="reference internal image-reference" href="media/image478.png"><img alt="media/image478.png" src="media/image478.png" style="width: 6.5in; height: 0.34306in;" /></a>
<a class="reference internal image-reference" href="media/image479.png"><img alt="media/image479.png" src="media/image479.png" style="width: 5.57361in; height: 4.99028in;" /></a>
<p><strong>5.8 - Améliorations utiles</strong></p>
<p><strong>5.8.1- la mise en marche automatiquement de l’alarme de nuit</strong>à
certaines</p>
<p>heures ;</p>
<p>On ajoute un bouton avec Inkscape ; pour cela :</p>
<blockquote>
<div><ul class="simple">
<li><p>On charge dans Inkscape le fichier PHP de l’image ; on accepte</p></li>
</ul>
<p>l’avertissement car ce</p>
<p>n’est pas une extension svg.</p>
<ul class="simple">
<li><p>On modifie l’image ; on ajoute un bouton</p></li>
<li><p>On sauvegarde l’image sous un autre nom, l’extension sera .svg</p></li>
<li><p>Comme précédemment avec les images, on la copie dans le fichier</p></li>
</ul>
<p>avec l’extension</p>
<p>PHP.</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image480.png"><img alt="media/image480.png" src="media/image480.png" style="width: 6.26806in; height: 4.59167in;" /></a>
<p><strong>5.8.1.1 Dans Domoticz</strong>,</p>
<blockquote>
<div><ul class="simple">
<li><p>On ajoute un poussoir virtuel : al_nuit_auto</p></li>
</ul>
</div></blockquote>
<ul>
<li><p><a class="reference internal" href="media/image481.png"><img alt="image19" src="media/image481.png" style="width: 2.46389in; height: 1.41528in;" /></a><a class="reference internal" href="media/image482.png"><img alt="image20" src="media/image482.png" style="width: 3.24028in; height: 1.19861in;" /></a></p>
<p>On ajout le switch au plan</p>
<a class="reference internal image-reference" href="media/image483.png"><img alt="media/image483.png" src="media/image483.png" style="width: 5.69722in; height: 1.9875in;" /></a>
<a class="reference internal image-reference" href="media/image484.png"><img alt="media/image484.png" src="media/image484.png" style="width: 5.06389in; height: 2.99028in;" /></a>
</li>
</ul>
<p>Le script lua notification_timer.lua :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">return {</div>
<div class="line">on = {</div>
<div class="line">timer = {</div>
<div class="line">‘at 23:00-11:00’,</div>
<div class="line">}</div>
<div class="line">},</div>
<div class="line">execute = function(domoticz, item)</div>
<div class="line">domoticz.log(‘The rule that triggered the event was: ‘ ..
item.trigger)</div>
</div>
<div class="line-block">
<div class="line">if(domoticz.devices(‘al_nuit_auto’).state == “On” and
item.isTimer ) then
domoticz.devices(‘alarme_nuit’).switchOn();print(‘al_nuit=ON’)
else
domoticz.devices(‘alarme_nuit’).switchOff();print(‘al_nuit=OFF’)
end</div>
<div class="line">end</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Le script lua notification_devices.lua :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">execute = function(domoticz, device)</div>
<div class="line">domoticz.log(‘device ‘..device.name..’ was changed’,
domoticz.LOG_INFO)</div>
</div>
<div class="line-block">
<div class="line">– alarme auto</div>
<div class="line">if (device.name == ‘al_nuit_auto’ and device.state==’On’) then
txt=’alarme_nuit_auto_activee’;alerte_gsm(txt);
domoticz.variables(‘alarme’).set(“alarme_auto”);</div>
<div class="line">elseif (device.name == ‘al_nuit_auto’ and device.state==’Off’)
then</div>
<div class="line">txt=’alarme_nuit_au</div>
</div>
</div></blockquote>
<dl>
<dt>to_desactivee’;alerte_gsm(txt);domoticz.variables(‘alarme’).set(“0”);</dt><dd><div class="line-block">
<div class="line">end</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Log :</p>
<a class="reference internal image-reference" href="media/image485.png"><img alt="media/image485.png" src="media/image485.png" style="width: 6.26806in; height: 0.8125in;" /></a>
<p><strong>5.8.1.2 Dans Monitor,</strong></p>
<p>Pour cela on met à jour la table « dispositifs »</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image486.png"><img alt="media/image486.png" src="media/image486.png" style="width: 6.00972in; height: 3.67778in;" /></a>
<a class="reference internal image-reference" href="media/image487.png"><img alt="media/image487.png" src="media/image487.png" style="width: 3.49028in; height: 2.10417in;" /></a>
</div></blockquote>
<p>Comme pour tous les switch la commande a été ajoutée automatiquement sur
la page HTML :</p>
<a class="reference internal image-reference" href="media/image488.png"><img alt="media/image488.png" src="media/image488.png" style="width: 6.26111in; height: 1.57222in;" /></a>
<p><strong>En page d’accueil</strong></p>
<a class="reference internal image-reference" href="media/image489.png"><img alt="media/image489.png" src="media/image489.png" style="width: 4.65694in; height: 3.51111in;" /></a>
<p>La table text_image :</p>
<p>L’image : L’image :</p>
<div class="line-block">
<div class="line"><strong>5.8.2 – Alarme par sms GSM (si un modem GSM installé) 5.8.2.1
Version avec une variable Domoticz,</strong></div>
<div class="line"><strong>Dans Domoticz</strong></div>
<div class="line">- Création d’une variable</div>
</div>
<p>Emplacement du script :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image496.png"><img alt="media/image496.png" src="media/image496.png" style="width: 2.47917in; height: 3.25in;" /></a>
<p><strong>5.8.2.1.2 aperçus</strong></p>
<p>On simule un intru en modifiant manuellement la variable :</p>
</div></blockquote>
<div class="line-block">
<div class="line">C’est la version que j’ai retenue</div>
<div class="line">On utilise un module python en import reload et on modifie ce module :</div>
<div class="line">- Avec Domoticz pour envoyer un message</div>
<div class="line">- Avec python pour arrêter l’envoi du message</div>
<div class="line">Création d’un fichier python : aldz.py, il ne contient qu’une variable
avec la valeur « 0 », pour « pas de message » ; il contiendra x= «
texte du SMS » en cas l’alarme</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>#!/usr/bin/env python3.7 -<em>- coing: utf-8 -</em>- x=’0’</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image499.png"><img alt="media/image499.png" src="media/image499.png" style="width: 4.06389in; height: 0.50972in;" /></a>
<p>On fait une copie de ce fichier : aldz.bak.py : ce fichier remplacera le
fichier original pour remettre à 0 la variable et cesser d’envoyer des
messages.</p>
<a class="reference internal image-reference" href="media/image500.png"><img alt="media/image500.png" src="media/image500.png" style="width: 3.24028in; height: 1.875in;" /></a>
<p>Dans Domoticz, pas besoin de créer une variable, simplement modifier le
fichier aldz.py pour inclure à la variable x, le texte du SMS</p>
<a class="reference internal image-reference" href="media/image501.png"><img alt="media/image501.png" src="media/image501.png" style="width: 5.99028in; height: 2.64583in;" /></a>
<p>Attention : si modem Ebyte, pas d’espaces et accents Le fichier sms_dz
est modifié (simplifié) :</p>
<a class="reference internal image-reference" href="media/image502.png"><img alt="media/image502.png" src="media/image502.png" style="width: 6.26111in; height: 6.02083in;" /></a>
<p><strong>5.8.2.3- Option supplémentaire : le test de l’envoi de SMS</strong></p>
<a class="reference internal image-reference" href="media/image503.png"><img alt="media/image503.png" src="media/image503.png" style="width: 5.10417in; height: 3.37361in;" /></a>
<p>L’image de l’alarme : on ajoute,</p>
<a class="reference internal image-reference" href="media/image504.png"><img alt="media/image504.png" src="media/image504.png" style="width: 6.26111in; height: 2.51111in;" /></a>
<a class="reference internal image-reference" href="media/image505.png"><img alt="media/image505.png" src="media/image505.png" style="width: 6.26806in; height: 1.66944in;" /></a>
<p>Domoticz : on ajoute un interrupteur virtuel</p>
<a class="reference internal image-reference" href="media/image506.png"><img alt="media/image506.png" src="media/image506.png" style="width: 6.26806in; height: 0.45972in;" /></a>
<a class="reference internal image-reference" href="media/image507.png"><img alt="media/image507.png" src="media/image507.png" style="width: 3.45972in; height: 1.1875in;" /></a>
<a class="reference internal image-reference" href="media/image508.png"><img alt="media/image508.png" src="media/image508.png" style="width: 4.18889in; height: 1.5in;" /></a>
<p>On ajoute le dispositif au plan :</p>
<a class="reference internal image-reference" href="media/image509.png"><img alt="media/image509.png" src="media/image509.png" style="width: 4.6875in; height: 4.06667in;" /></a>
<a class="reference internal image-reference" href="media/image510.png"><img alt="media/image510.png" src="media/image510.png" style="width: 4.68889in; height: 3.79167in;" /></a>
<p>On ajoute qq lignes de script dans évènements dz
<strong>notifications_devices.lua</strong></p>
<a class="reference internal image-reference" href="media/image511.png"><img alt="media/image511.png" src="media/image511.png" style="width: 6.26806in; height: 3.29028in;" /></a>
<div class="line-block">
<div class="line">ATTENTION NOTIFICATIONS SANS ESPACES SI MODEM EBYTE (le modem Ebyte
n’accepte pas les espaces texte)</div>
<div class="line">Dans la BD :</div>
</div>
<a class="reference internal image-reference" href="media/image512.png"><img alt="media/image512.png" src="media/image512.png" style="width: 6.26806in; height: 0.83333in;" /></a>
<a class="reference internal image-reference" href="media/image513.png"><img alt="media/image513.png" src="media/image513.png" style="width: 1.96944in; height: 0.30278in;" /></a>
<p>L’exemple est intéressant car le clic s’effectue sur une partie de
l’image transparente</p>
<p>footer.php</p>
<p>Le script est ajouté automatiquement à partir des données de la BD</p>
<a class="reference internal image-reference" href="media/image514.png"><img alt="media/image514.png" src="media/image514.png" style="width: 6.26111in; height: 1.96806in;" /></a>
<p>Affichage de l’alarme, une ellipse rouge est affichée sur l’icône ‘
smartphone’ ; elle reste affichée jusqu’à la prochaine mise à jour de
devices_plan() au plus tard : 3minutes par défaut mais modifiable dans
config.php</p>
<a class="reference internal image-reference" href="media/image515.png"><img alt="media/image515.png" src="media/image515.png" style="width: 4.80278in; height: 3.17639in;" /></a>
<p><strong>5.8.3- Affichage de la liste des caméras Modect</strong></p>
<p>Cette liste est établie automatiquement avec une fonction dans «
administration »</p>
<a class="reference internal image-reference" href="media/image516.png"><img alt="media/image516.png" src="media/image516.png" style="width: 3.86528in; height: 3.25in;" /></a>
<p><strong>Ajout d’une icone</strong></p>
<a class="reference internal image-reference" href="media/image517.png"><img alt="media/image517.png" src="media/image517.png" style="width: 4.26111in; height: 3.38194in;" /></a>
<p>alarmes.php :</p>
<a class="reference internal image-reference" href="media/image518.png"><img alt="media/image518.png" src="media/image518.png" style="width: 6.26111in; height: 3.33333in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;svg version=”1.1” id=”zm” xmlns=”<a class="reference external" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>”</div>
<div class="line">xmlns:xlink=”http://www.w3.org/1999/xlink” x=”0px” y=”0px”</div>
<div class="line">viewBox=”0 0 326 18” style=”width:500px” xml:space=”preserve”&gt;</div>
<div class="line">&lt;style type=”text/css”&gt;</div>
<div class="line">.st208{fill:#03A8F3;}</div>
<div class="line">.st207{font-size:13.5px;}</div>
<div class="line">&lt;/style&gt;&lt;a id=”zm” href=”#alarmes”&gt;</div>
<div class="line">&lt;rect x=”0.9” y=”-0.7” class=”st208” width=”31.2”
height=”18.8”/&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 5.4312 13.3434)” class=”st203
st33 st207”&gt;Z M&lt;/text&gt;&lt;/a&gt; &lt;/svg&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Dans footer.php , on appelle la fonction php sql_app() qui est déjà
utilisé dans « administration »</p>
<a class="reference internal image-reference" href="media/image519.png"><img alt="media/image519.png" src="media/image519.png" style="width: 6.26806in; height: 1.60972in;" /></a>
<a class="reference internal image-reference" href="media/image520.png"><img alt="media/image520.png" src="media/image520.png" style="width: 6.02222in; height: 5.9375in;" /></a>
<p>Affichage :</p>
<a class="reference internal image-reference" href="media/image521.png"><img alt="media/image521.png" src="media/image521.png" style="width: 4.77083in; height: 4.19722in;" /></a>
<p><strong>5.8.5- Copie écran de la dernière version</strong></p>
<p>Version 2.1.0 réécrite en DzVent avec :</p>
<blockquote>
<div><ul class="simple">
<li><p>1 script pour le timer</p></li>
<li><p>1 script pour les notifications à partir des dispositifs</p></li>
<li><p>1 script ppour les notifications à partir des variables</p></li>
<li><p>Le script principal de l’alarme</p></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image522.png"><img alt="media/image522.png" src="media/image522.png" style="width: 5.67639in; height: 5.88472in;" /></a>
<p><strong>6. – GRAHIQUES &amp; BASE DE DONNEES</strong></p>
<a class="reference internal image-reference" href="media/image523.png"><img alt="media/image523.png" src="media/image523.png" style="width: 6.26806in; height: 6.42778in;" /></a>
<p>Voir ces pages pour installer les scripts :</p>
<blockquote>
<div><ul class="simple">
<li></li>
<li></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image524.png"><img alt="media/image524.png" src="media/image524.png" style="width: 6.26806in; height: 1.80694in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><p>Jpgraph est installé avec le
cache <a class="reference internal" href="media/image526.png"><img alt="image21" src="media/image526.png" style="width: 2.1875in; height: 0.24028in;" /></a></p>
<p>php-gd est installé <a class="reference internal" href="media/image527.png"><img alt="image22" src="media/image527.png" style="width: 3.50972in; height: 0.27083in;" /></a></p>
<p>la bibliothèque python fabric
est importé</p>
<p>le module python
mysql.connector est importé</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><strong>6.1 Les table SQL</strong> ,</div>
<div class="line"><strong>Pour le nom des tables concernant les graphiques, NE PAS UTILISER le
CARACTERE –(moins)</strong></div>
<div class="line">Ce caractère est utilisé comme séparateur pour l’indication de
l’ensemble table-champ pour les graphiques</div>
</div>
<a class="reference internal image-reference" href="media/image528.png"><img alt="media/image528.png" src="media/image528.png" style="width: 6.26806in; height: 0.54167in;" /></a>
<p>En absence de champ c’est le champ « valeur » qui est utilisé sinon :
Value= « &lt;TABLE&gt;-&lt;CHAMP&gt; »</p>
<a class="reference internal image-reference" href="media/image529.png"><img alt="media/image529.png" src="media/image529.png" style="width: 1.95972in; height: 4.40694in;" /></a>
<p>Avec 2 champs ou 3 champs</p>
<p><strong>Création de la table avec phpMyAdmin :</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">CREATE TABLE `pression_chaudiere` (</div>
<div class="line">`num` int(5) NOT NULL,</div>
<div class="line">`date` timestamp NOT NULL DEFAULT current_timestamp() ON
UPDATE current_timestamp(),</div>
<div class="line">`valeur` varchar(4) NOT NULL</div>
<div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div>
<div class="line">ALTER TABLE `pression_chaudiere` CHANGE `num` `num` INT(4)
NOT NULL AUTO_INCREMENT, add PRIMARY KEY (<cite>num</cite>);</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>6.2 Dans Domoticz,</strong></p>
<p>Les données à enregistrer peuvent provenir de capteurs réels ou
virtuels. Pour éviter un trop grand nombre de valeurs, il est utile pour
certains dispositifs, de créer des variables pour comparer les valeurs
et les limiter aux valeurs entières (c’est le cas de la météo Darsky,
des capteurs de température Onoff).</p>
<p>Pour utiliser des données de la base SQL, il faut au préalable les avoir
enregistrées depuis Domoticz : c’est le rôle de la bibliothèque fabric</p>
<a class="reference internal image-reference" href="media/image532.png"><img alt="media/image532.png" src="media/image532.png" style="width: 6.19861in; height: 1.23889in;" /></a>
<p>Une fois crée un premier enregistrement pour une température dans la
base, il suffira pour un nouvel enregistrement d’une autre t° d’ajouter
dans le script LUA « évènement /export_sql » cette T°</p>
<a class="reference internal image-reference" href="media/image533.png"><img alt="media/image533.png" src="media/image533.png" style="width: 6.26806in; height: 6.12917in;" /></a>
<a class="reference internal image-reference" href="media/image534.png"><img alt="media/image534.png" src="media/image534.png" style="width: 6.26806in; height: 6.00278in;" /></a>
<p>Pour limiter le nb d’enregistrements :</p>
<a class="reference internal image-reference" href="media/image535.png"><img alt="media/image535.png" src="media/image535.png" style="width: 5.93889in; height: 2.74028in;" /></a>
<p>Dans cet exemple, il a été créer 3 variables qui permettent des
enregistrements dans la BD à chaque changement de valeurs limité au
degré.:</p>
<a class="reference internal image-reference" href="media/image536.png"><img alt="media/image536.png" src="media/image536.png" style="width: 4.98056in; height: 0.73889in;" /></a>
<p><strong>Le script fabric.sh,</strong> installé ici dans le répertoire « scripts » de
Domoticz</p>
<a class="reference internal image-reference" href="media/image537.png"><img alt="media/image537.png" src="media/image537.png" style="width: 2.66805in; height: 1.82361in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>#!/bin/bash</p>
<div class="line-block">
<div class="line">echo $1</div>
<div class="line">echo $2</div>
<div class="line">a=”#”</div>
<div class="line">c=$1$a$2</div>
</div>
<div class="line-block">
<div class="line">echo $c</div>
<div class="line">cd /home/michel/python</div>
<div class="line">fab maintask –don=$c &gt; /home/michel/fab.log 2&gt;&amp;1</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Pour tester le script, il est plus facile de travailler dans le
répertoire USER, c’est l’objet de la création du lien symbolique vers le
dossier python de Domoticz</p>
<a class="reference internal image-reference" href="media/image538.png"><img alt="media/image538.png" src="media/image538.png" style="width: 6.26111in; height: 0.46944in;" /></a>
<a class="reference internal image-reference" href="media/image539.png"><img alt="media/image539.png" src="media/image539.png" style="width: 5.70972in; height: 2.52083in;" /></a>
<p><strong>Le script fabfile.py</strong></p>
<a class="reference internal image-reference" href="media/image540.png"><img alt="media/image540.png" src="media/image540.png" style="width: 3.18889in; height: 2.15694in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">#!/usr/bin/env python2.7</div>
<div class="line"># -<em>- coding: utf-8 -</em>-</div>
<div class="line">from fabric import Connection</div>
<div class="line">from fabric.tasks import task</div>
</div>
<div class="line-block">
<div class="line">&#64;task</div>
<div class="line">def subtask(ctx, donn):</div>
<div class="line">with ctx.cd(“/www/monitor/python”): ctx.run(donn)</div>
</div>
<div class="line-block">
<div class="line">&#64;task( optional = [‘don’])</div>
<div class="line">def maintask(ctx, don = None ):</div>
<div class="line">con = Connection(host = ‘192.168.1.7’, user = ‘michel’,
connect_kwargs = {‘password’:’PASS’})</div>
<div class="line">file = “python3 sqlite_mysql.py “</div>
<div class="line">donn = file+don</div>
</div>
<p>print(subtask(con,donn))</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Le script fabfile.py appelle sur le serveur qui héberge la BD le
script sqlite_mysql.py; <strong>sqlite_mysql.py n’est exécuté que lorsqu’il
est appelé, il n’écoute pas en permanence si des données sont
envoyées</strong></p>
<a class="reference internal image-reference" href="media/image541.png"><img alt="media/image541.png" src="media/image541.png" style="width: 5.65694in; height: 3.32222in;" /></a>
<p>POUR RESUMER : sur le serveur de Domoticz</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>-script LUA→MENU Domoticz évènements</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>-script fabric.sh→ ../domoticz/scripts/</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>-script fabfile.py→../domoticz/scripts/python/ avec ls
/home/USER/python/</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li><p>fab.log→ /home/USER</p></li>
</ul>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><div class="line-block">
<div class="line"><strong>6.3 Sur le serveur de la base de données,</strong></div>
<div class="line">Le serveur Nginx avec aussi Monitor, réception des datas <strong>Le
script python sqlite_mysql.py</strong> :</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">#!/usr/bin/env python3</div>
<div class="line"># -<em>- coding: utf-8 -</em>-</div>
<div class="line">import sys</div>
<div class="line">import mysql.connector</div>
<div class="line">from mysql.connector import Error</div>
<div class="line">total_arg = len(sys.argv)</div>
<div class="line">if (total_arg&gt;0) :</div>
<div class="line">x= str(sys.argv[1])</div>
<div class="line">temp = x.split(‘#’)</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">table=temp[0]</div>
<div class="line">champ=temp[1]</div>
<div class="line">val1=temp[2]</div>
<div class="line">val=temp[3]+” “+temp[4]</div>
<div class="line">if (len(temp)==7) :</div>
<div class="line">champ2=temp[5]</div>
<div class="line">val2=temp[6]</div>
<div class="line">try:</div>
<div class="line">connection = mysql.connector.connect(</div>
<div class="line">host = “127.0.0.1”,</div>
<div class="line">user = “michel”,</div>
<div class="line">password = xxxxxxxx”,</div>
<div class="line">database = “domoticz”)</div>
</div>
<div class="line-block">
<div class="line">if connection.is_connected():</div>
<div class="line">db_Info = connection.get_server_info()</div>
<div class="line">print(“Connected to MySQL Server version “, db_Info)</div>
<div class="line">cursor = connection.cursor()</div>
<div class="line">cursor.execute(“select database();”)</div>
<div class="line">record = cursor.fetchone()</div>
<div class="line">print(“You’re connected to database: “, record)</div>
<div class="line">if (len(temp)==7) :</div>
<div class="line">query = “INSERT INTO “+table+” (date,”+champ+”,”+champ2+”)
VALUES(%&gt; values = (val, val1, val2)</div>
<div class="line">else :</div>
<div class="line">query = “INSERT INTO “+table+” (date,”+champ+”) VALUES(%s, %s)”
values = (val, val1)</div>
<div class="line">cursor.execute(query, values)</div>
</div>
<div class="line-block">
<div class="line">connection.commit()</div>
<div class="line">print(cursor.rowcount, “Record inserted successfully into Laptop
table”)</div>
</div>
<div class="line-block">
<div class="line">except Error as e:</div>
<div class="line">print(“Error while connecting to MySQL”, e) finally:</div>
<div class="line">if (connection.is_connected()):</div>
<div class="line">cursor.close()</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image542.png"><img alt="media/image542.png" src="media/image542.png" style="width: 6.26806in; height: 7.46528in;" /></a>
<p><strong>6.4 Dans Monitor :</strong></p>
<p>Le cache pour jpgraph est présent :</p>
<a class="reference internal image-reference" href="media/image543.png"><img alt="media/image543.png" src="media/image543.png" style="width: 2.13611in; height: 2.02083in;" /></a>
<p>Jpgraph est installé à la racine de monitor</p>
<a class="reference internal image-reference" href="media/image544.png"><img alt="media/image544.png" src="media/image544.png" style="width: 2.24028in; height: 2.20833in;" /></a>
<p><strong>6.4.1 la page graphique.php</strong></p>
<a class="reference internal image-reference" href="media/image545.png"><img alt="media/image545.png" src="media/image545.png" style="width: 6.26806in; height: 7.61111in;" /></a>
<ul class="simple">
<li><p>css</p></li>
</ul>
<a class="reference internal image-reference" href="media/image546.png"><img alt="media/image546.png" src="media/image546.png" style="width: 5.44861in; height: 1.0625in;" /></a>
<p><strong>6.4.2 la fonction graph,</strong> dans fonctions.php et appelée par ajax.php
<strong>ajax.php</strong></p>
<a class="reference internal image-reference" href="media/image547.png"><img alt="media/image547.png" src="media/image547.png" style="width: 4.62639in; height: 0.3125in;" /></a>
<p><strong>fonctions.php</strong></p>
<a class="reference internal image-reference" href="media/image548.png"><img alt="media/image548.png" src="media/image548.png" style="width: 5.95833in; height: 3.19722in;" /></a>
<p>Accès base de données :export_tab_sqli.php et traitement des données par
la BD</p>
<a class="reference internal image-reference" href="media/image549.png"><img alt="media/image549.png" src="media/image549.png" style="width: 6.17778in; height: 5.10417in;" /></a>
<p>Suite de graph()</p>
<a class="reference internal image-reference" href="media/image550.png"><img alt="media/image550.png" src="media/image550.png" style="width: 6.26806in; height: 9.11111in;" /></a>
<p>Voir la documentation sur jpgraph :</p>
<p><strong>6.4.3 autres fichiers PHP :</strong></p>
<blockquote>
<div><div class="line-block">
<div class="line">- index_loc.php (en général ne pas modifier), config.php,
header.php (en général ne pas modifier),</div>
<div class="line">Mettre la variable à « true » dans config.php</div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="media/image551.png"><img alt="media/image551.png" src="media/image551.png" style="width: 6.26111in; height: 2.00972in;" /></a>
<p><strong>6.4.4 copies d’écran :</strong></p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image552.png"><img alt="media/image552.png" src="media/image552.png" style="width: 4.23889in; height: 5.74167in;" /></a>
<a class="reference internal image-reference" href="media/image553.png"><img alt="media/image553.png" src="media/image553.png" style="width: 4.42639in; height: 3.63889in;" /></a>
</div></blockquote>
<a class="reference internal image-reference" href="media/image554.png"><img alt="media/image554.png" src="media/image554.png" style="width: 5.57361in; height: 5.02083in;" /></a>
<div class="line-block">
<div class="line"><strong>7. – MUR de CAMERAS</strong></div>
<div class="line">Zoneminder doit être installé</div>
<div class="line">Pour éviter des problèmes de capacité mémoire, vider le cache
périodiquement avec CRON : <strong>crontab -e</strong></div>
</div>
<a class="reference internal image-reference" href="media/image555.png"><img alt="media/image555.png" src="media/image555.png" style="width: 3.45972in; height: 0.24028in;" /></a>
<div class="line-block">
<div class="line">Avec nano ou vim :</div>
<div class="line"><strong>0 12 * * * sync; echo 3 &gt; /proc/sys/vm/drop_caches</strong></div>
</div>
<a class="reference internal image-reference" href="media/image556.png"><img alt="media/image556.png" src="media/image556.png" style="width: 6.30139in; height: 3.36389in;" /></a>
<p>Ici la mémoire sera libérée des données cache et tampontous les jours à
12H ; plus d’ infos :</p>
<a class="reference internal image-reference" href="media/image557.png"><img alt="media/image557.png" src="media/image557.png" style="width: 5.58472in; height: 7.45972in;" /></a>
<p><strong>Il est important d’ajouter les caméras dans Zoneminder les unes après
les autres sans en supprimer</strong></p>
<p><strong>afin que ces cameras suivent un ordre chronologique (1,2,3,4,5, 6,
……)</strong></p>
<p><strong>Voir la page :</strong></p>
<a class="reference internal image-reference" href="media/image558.png"><img alt="media/image558.png" src="media/image558.png" style="width: 6.26806in; height: 1.66667in;" /></a>
<p><strong>7.1- les pages index_loc.php, header.php, entete_html.php</strong>
Index_loc.php : en général, ne pas modifier</p>
<a class="reference internal image-reference" href="media/image559.png"><img alt="media/image559.png" src="media/image559.png" style="width: 5.60556in; height: 0.54167in;" /></a>
<p><strong>config.php</strong></p>
<a class="reference internal image-reference" href="media/image560.png"><img alt="media/image560.png" src="media/image560.png" style="width: 5.94861in; height: 2.125in;" /></a>
<p><strong>header.php</strong></p>
<a class="reference internal image-reference" href="media/image561.png"><img alt="media/image561.png" src="media/image561.png" style="width: 5.93889in; height: 2.30139in;" /></a>
<p><strong>entete_html.php :</strong> pour le switch</p>
<a class="reference internal image-reference" href="media/image562.png"><img alt="media/image562.png" src="media/image562.png" style="width: 6.26806in; height: 0.80139in;" /></a>
<p><strong>7.2- la page de monitor : mur_cam.php</strong></p>
<a class="reference internal image-reference" href="media/image563.png"><img alt="media/image563.png" src="media/image563.png" style="width: 6.26111in; height: 6.3125in;" /></a>
<p>Le script du bouton On/Off , dans footer :</p>
<a class="reference internal image-reference" href="media/image564.png"><img alt="media/image564.png" src="media/image564.png" style="width: 5.44861in; height: 0.72917in;" /></a>
<a class="reference internal image-reference" href="media/image565.png"><img alt="media/image565.png" src="media/image565.png" style="width: 6.05278in; height: 0.9375in;" /></a>
<p><strong>mur_cameras.php :</strong></p>
<a class="reference internal image-reference" href="media/image566.png"><img alt="media/image566.png" src="media/image566.png" style="width: 6.26111in; height: 0.99028in;" /></a>
<p><strong>IMPORTANT</strong> : le fichier include/mur_cameras.php est indépendant du
programme (‘est une image en retour) et de ce fait on ne peut utiliser
les constantes définies dans admin/config.php</p>
<p>On va donc pour remédier à ce problème :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>passer l’url en paramètre
ainsi que l’Idx</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>utiliser les variables de
session pour le login et le
mot de passe car ces données
sont sensibles</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><ul class="simple">
<li></li>
</ul>
</div></blockquote>
<a class="reference internal image-reference" href="media/image567.png"><img alt="media/image567.png" src="media/image567.png" style="width: 6.26111in; height: 0.40694in;" /></a>
<p><strong>Les fichiers sont tous UTF-8 sans BOM et l’url des caméras doit se
trouver dans mur_cam.php</strong>. (ZMURL dans mur_cam.php et non dans
mur_cameras.php)<strong>;</strong></p>
<a class="reference internal image-reference" href="media/image568.png"><img alt="media/image568.png" src="media/image568.png" style="width: 6.26806in; height: 0.97639in;" /></a>
<p><strong>7.3- Les scripts JS pour la vidéo dans footer.php :</strong></p>
<p>Le Zoom Bootstrap :</p>
<a class="reference internal image-reference" href="media/image569.png"><img alt="media/image569.png" src="media/image569.png" style="width: 6.26806in; height: 4.91528in;" /></a>
<div class="line-block">
<div class="line">Rafraichissement des images ; pour limiter l’utilisation de la bande
passante, le</div>
<div class="line">rafraichissement des images n’a lieu que si le bouton est sur ON ; par
contre même sur OFF le zoom d’une caméra est opérationnel</div>
</div>
<a class="reference internal image-reference" href="media/image570.png"><img alt="media/image570.png" src="media/image570.png" style="width: 4.67778in; height: 3.725in;" /></a>
<a class="reference internal image-reference" href="media/image571.png"><img alt="media/image571.png" src="media/image571.png" style="width: 5.60556in; height: 5.33472in;" /></a>
<p>Les caméras ne sont pas en https, pour éviter les certificats, mais
comme l’accès se fait en local (sur le réseau 192.168.1.x) et enregistre
une image, sur le serveur, chaque 100ms pour recréer une vidéo, l’accès
distant en https est assuré.</p>
<a class="reference internal image-reference" href="media/image572.png"><img alt="media/image572.png" src="media/image572.png" style="width: 5.89722in; height: 3.78056in;" /></a>
<p><strong>7.4- Ajouter une caméra</strong></p>
<a class="reference internal image-reference" href="media/image573.png"><img alt="media/image573.png" src="media/image573.png" style="width: 5.00139in; height: 0.89583in;" /></a>
<p>Il suffit d’indiquer dans /admin/config.php le nb de caméras</p>
<p><strong>8.- MUR de COMMANDES ON/OFF</strong></p>
<a class="reference internal image-reference" href="media/image574.png"><img alt="media/image574.png" src="media/image574.png" style="width: 5.50139in; height: 7.59306in;" /></a>
<p>Les lampes :</p>
<a class="reference internal image-reference" href="media/image575.png"><img alt="media/image575.png" src="media/image575.png" style="width: 6.26806in; height: 5.30139in;" /></a>
<p><strong>8.1 les fichiers de base :</strong></p>
<p>Index_loc.php en général ne pas modifier</p>
<a class="reference internal image-reference" href="media/image576.png"><img alt="media/image576.png" src="media/image576.png" style="width: 4.68889in; height: 0.5625in;" /></a>
<p>header.php</p>
<a class="reference internal image-reference" href="media/image577.png"><img alt="media/image577.png" src="media/image577.png" style="width: 6.49583in; height: 2.47639in;" /></a>
<p>mes_css.css</p>
<a class="reference internal image-reference" href="media/image578.png"><img alt="media/image578.png" src="media/image578.png" style="width: 5.34306in; height: 2.18056in;" /></a>
<div class="line-block">
<div class="line"><strong>8.1.1 écriture automatique du javascript</strong></div>
<div class="line">Effectuée par une fonction PHP à partir de la base de données Dans le
fichier footer.php :</div>
</div>
<a class="reference internal image-reference" href="media/image579.png"><img alt="media/image579.png" src="media/image579.png" style="width: 6.26806in; height: 0.6875in;" /></a>
<p>Extrait de la page html pour des commandes pour Domoticz et Home
Assistant:</p>
<a class="reference internal image-reference" href="media/image580.png"><img alt="media/image580.png" src="media/image580.png" style="width: 6.30139in; height: 2.43056in;" /></a>
<p>Le PHP :</p>
<a class="reference internal image-reference" href="media/image581.png"><img alt="media/image581.png" src="media/image581.png" style="width: 6.30139in; height: 6.40278in;" /></a>
<p><strong>8.2- mur_inter.php</strong></p>
<a class="reference internal image-reference" href="media/image582.png"><img alt="media/image582.png" src="media/image582.png" style="width: 6.26806in; height: 3.19028in;" /></a>
<div class="line-block">
<div class="line"><strong>8.2.1 Exemple pour éclairage jardin :</strong></div>
<div class="line">L’interrupeur mécanique de l’éclairage extérieur de l’entrée commande
également en zigbee l’éclairage du jardin :</div>
</div>
<a class="reference internal image-reference" href="media/image583.png"><img alt="media/image583.png" src="media/image583.png" style="width: 3.76389in; height: 1.23194in;" /></a>
<a class="reference internal image-reference" href="media/image584.png"><img alt="media/image584.png" src="media/image584.png" style="width: 3.84028in; height: 1.57639in;" /></a>
<p><strong>Domoticz</strong></p>
<a class="reference internal image-reference" href="media/image585.png"><img alt="media/image585.png" src="media/image585.png" style="width: 6.37917in; height: 0.42361in;" /></a>
<p><strong>Les capteurs virtuels sont mis à jour par MQTT et node-red depuis
zigbee2mqtt</strong> Les script node-red : envoi vers domoticz/in</p>
<a class="reference internal image-reference" href="media/image586.png"><img alt="media/image586.png" src="media/image586.png" style="width: 3.80278in; height: 8.82083in;" /></a>
<p>La réponse de Domoticz</p>
<a class="reference internal image-reference" href="media/image587.png"><img alt="media/image587.png" src="media/image587.png" style="width: 4.14444in; height: 2.225in;" /></a>
<div class="line-block">
<div class="line"><strong>REMARQUE : ce script automatique de Domoticz ne suffit pas en cas de
commande de l’interrupteur car le délai de réponse peut atteindre plus
de 10 s, il faut donc envoyer un message MQTT à partir de
l’interrupteur virtuel</strong></div>
<div class="line">Le script python lancé par la « lampe_ext_entree » :</div>
<div class="line">Ce script publie un message MQTT vers zigbee2mqtt pour allumer
l’éclairage du jardin si l’interrupteur « lampe_ext_entree » est
actionné</div>
</div>
<a class="reference internal image-reference" href="media/image588.png"><img alt="media/image588.png" src="media/image588.png" style="width: 6.5in; height: 2.30139in;" /></a>
<p>…./domoticz/scripts/python/mqtt.py zigbee2mqtt/eclairage_ext/set
state_l2 ON …./domoticz/scripts/python/mqtt.py
zigbee2mqtt/eclairage_ext/set state_l2 OFF</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">#!/usr/bin/env python3.7</div>
<div class="line"># -<em>- coding: utf-8 -</em>-</div>
</div>
<div class="line-block">
<div class="line">import paho.mqtt.client as mqtt</div>
<div class="line">import json</div>
<div class="line">import sys</div>
<div class="line"># Variables et Arguments</div>
<div class="line">topic= str(sys.argv[1])</div>
<div class="line">etat= str(sys.argv[2])</div>
<div class="line">valeur= str(sys.argv[3])</div>
<div class="line">MQTT_HOST = “192.168.1.42”</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">MQTT_PORT = 1883</div>
<div class="line">MQTT_KEEPALIVE_INTERVAL = 45</div>
<div class="line">MQTT_TOPIC = topic</div>
</div>
<div class="line-block">
<div class="line">MQTT_MSG=json.dumps({etat: valeur});</div>
<div class="line">#</div>
<div class="line">def on_publish(client, userdata, mid):</div>
<div class="line">print (“Message Publié…”)</div>
</div>
<div class="line-block">
<div class="line">def on_connect(client, userdata, flags, rc):</div>
<div class="line">client.subscribe(MQTT_TOPIC)</div>
<div class="line">client.publish(MQTT_TOPIC, MQTT_MSG)</div>
</div>
<div class="line-block">
<div class="line">def on_message(client, userdata, msg):</div>
<div class="line">print(msg.topic)</div>
<div class="line">print(msg.payload)</div>
<div class="line">payload = json.loads(msg.payload) # convertion en json
print(payload[‘state_l2’])</div>
<div class="line">client.disconnect()</div>
</div>
<div class="line-block">
<div class="line"># Initiatlisation MQTT Client</div>
<div class="line">mqttc = mqtt.Client()</div>
</div>
<div class="line-block">
<div class="line"># callback funRction</div>
<div class="line">mqttc.on_publish = on_publish</div>
<div class="line">mqttc.on_connect = on_connect</div>
<div class="line">mqttc.on_message = on_message</div>
</div>
<div class="line-block">
<div class="line"># Connection avec le serveur MQTT</div>
<div class="line">mqttc.connect(MQTT_HOST, MQTT_PORT, MQTT_KEEPALIVE_INTERVAL)</div>
</div>
<div class="line-block">
<div class="line"># Loop forever</div>
<div class="line">mqttc.loop_forever()</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="https://www.eclipse.org/paho/index.php?page=clients/python/docs/index.php">https://www.eclipse.org/paho/index.php?page=clients/python/docs/index.php</a></p>
<p>Pour éviter des erreurs (512, 256), penser à convertir le fichier python
en Unix s’il a été créé</p>
<p>avec <strong>Notepad++</strong></p>
<a class="reference internal image-reference" href="media/image589.png"><img alt="media/image589.png" src="media/image589.png" style="width: 6.26806in; height: 3.16805in;" /></a>
<p>Pour convertir le fichier en Unix : dos2unix CHEMIN/NOM DU FICHIER
Attention aussi aux autorisations</p>
<a class="reference internal image-reference" href="media/image590.png"><img alt="media/image590.png" src="media/image590.png" style="width: 3.26111in; height: 2.68611in;" /></a>
<a class="reference internal image-reference" href="media/image591.png"><img alt="media/image591.png" src="media/image591.png" style="width: 4.65in; height: 6.79306in;" /></a>
<p>Le plan : l’interrupteur est ajouté</p>
<a class="reference internal image-reference" href="media/image592.png"><img alt="media/image592.png" src="media/image592.png" style="width: 5.32361in; height: 4.47917in;" /></a>
<div class="line-block">
<div class="line"><strong>exterieur.php</strong></div>
<div class="line"><strong>css pour svg</strong></div>
</div>
<a class="reference internal image-reference" href="media/image593.png"><img alt="media/image593.png" src="media/image593.png" style="width: 5.08472in; height: 0.60417in;" /></a>
<a class="reference internal image-reference" href="media/image594.png"><img alt="media/image594.png" src="media/image594.png" style="width: 5.80278in; height: 1.25139in;" /></a>
<p>Les lampes concernées en gris</p>
<a class="reference internal image-reference" href="media/image595.png"><img alt="media/image595.png" src="media/image595.png" style="width: 5.47778in; height: 4.83611in;" /></a>
<a class="reference internal image-reference" href="media/image596.png"><img alt="media/image596.png" src="media/image596.png" style="width: 4.81111in; height: 3.36111in;" /></a>
<p><strong>La BD</strong></p>
<p>un idm est nécessaire pour le tableau json en retour de la fonction «
device_plan ». Pour afficher les propriétés de l’appareil</p>
<a class="reference internal image-reference" href="media/image597.png"><img alt="media/image597.png" src="media/image597.png" style="width: 6.26806in; height: 6.08611in;" /></a>
<p><strong>footer.php : pour la mise à jour de tous les dispositifs, mais avec un
temps de réponse,</strong></p>
<p><strong>aussi pour la commande des interrupteurs un second script permet une
mise à jour</strong></p>
<p><strong>instantanée</strong></p>
<a class="reference internal image-reference" href="media/image598.png"><img alt="media/image598.png" src="media/image598.png" style="width: 6.26806in; height: 5.28472in;" /></a>
<a class="reference internal image-reference" href="media/image599.png"><img alt="media/image599.png" src="media/image599.png" style="width: 6.30139in; height: 3.07222in;" /></a>
<div class="line-block">
<div class="line"><strong>8.2.2 Exemple pour arrosage jardin :</strong></div>
<div class="line">Relais Sonoff wifi ip 192.168.1.146 :8081</div>
</div>
<p>DOMOTICZ :Capteur virtuel :</p>
<a class="reference internal image-reference" href="media/image600.png"><img alt="media/image600.png" src="media/image600.png" style="width: 6.5in; height: 0.42361in;" /></a>
<a class="reference internal image-reference" href="media/image601.png"><img alt="media/image601.png" src="media/image601.png" style="width: 5.23056in; height: 3.09306in;" /></a>
<a class="reference internal image-reference" href="media/image602.png"><img alt="media/image602.png" src="media/image602.png" style="width: 4.81111in; height: 4.19861in;" /></a>
<p>Le script python :</p>
<a class="reference internal image-reference" href="media/image603.png"><img alt="media/image603.png" src="media/image603.png" style="width: 5.62639in; height: 2.49028in;" /></a>
<a class="reference internal image-reference" href="media/image604.png"><img alt="media/image604.png" src="media/image604.png" style="width: 5.71944in; height: 1.60417in;" /></a>
<p><strong>Mur_inter.php</strong></p>
<a class="reference internal image-reference" href="media/image605.png"><img alt="media/image605.png" src="media/image605.png" style="width: 6.26806in; height: 2.90417in;" /></a>
<p>Base de données :</p>
<a class="reference internal image-reference" href="media/image606.png"><img alt="media/image606.png" src="media/image606.png" style="width: 6.49583in; height: 0.65833in;" /></a>
<a class="reference internal image-reference" href="media/image607.png"><img alt="media/image607.png" src="media/image607.png" style="width: 2.78472in; height: 1.50417in;" /></a>
<p><strong>8.2.3 - Exemple éclairage simple, une lampe de salon</strong> :</p>
<p><em>Dans Domoticz :</em></p>
<a class="reference internal image-reference" href="media/image608.png"><img alt="media/image608.png" src="media/image608.png" style="width: 4.25972in; height: 1.41111in;" /></a>
<p>On ajoute le matériel au plan qui regroupe tous les matériels</p>
<a class="reference internal image-reference" href="media/image609.png"><img alt="media/image609.png" src="media/image609.png" style="width: 5.70417in; height: 4.82222in;" /></a>
<p>On le place sur le plan :</p>
<a class="reference internal image-reference" href="media/image610.png"><img alt="media/image610.png" src="media/image610.png" style="width: 5.1625in; height: 7.0625in;" /></a>
<a class="reference internal image-reference" href="media/image611.png"><img alt="media/image611.png" src="media/image611.png" style="width: 2.80278in; height: 2.40139in;" /></a>
<p><em>Dans monitor :</em></p>
<p>mur_inter.php</p>
<a class="reference internal image-reference" href="media/image612.png"><img alt="media/image612.png" src="media/image612.png" style="width: 6.26111in; height: 2.19722in;" /></a>
<p>Exemple : Image lampe_bureau.svg</p>
<a class="reference internal image-reference" href="media/image613.png"><img alt="media/image613.png" src="media/image613.png" style="width: 0.85556in; height: 0.80278in;" /></a>
<p>Image lampe: <a class="reference internal" href="media/image614.png"><img alt="image23" src="media/image614.png" style="width: 0.52083in; height: 0.67778in;" /></a></p>
<a class="reference internal image-reference" href="media/image615.png"><img alt="media/image615.png" src="media/image615.png" style="width: 6.06389in; height: 8.10556in;" /></a>
<a class="reference internal image-reference" href="media/image616.png"><img alt="media/image616.png" src="media/image616.png" style="width: 5.35556in; height: 6.58333in;" /></a>
<p>La base de données « monitor » (aussi appelée domoticz), table
dispositifs</p>
<a class="reference internal image-reference" href="media/image617.png"><img alt="media/image617.png" src="media/image617.png" style="width: 6.26111in; height: 6.20833in;" /></a>
<p>Résultat :</p>
<a class="reference internal image-reference" href="media/image618.png"><img alt="media/image618.png" src="media/image618.png" style="width: 2.82361in; height: 1.65694in;" /></a>
<p><strong>8.2.4 - Exemple volet roulant</strong> :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image619.png"><img alt="media/image619.png" src="media/image619.png" style="width: 2.775in; height: 1.63611in;" /></a>
</div></blockquote>
<a class="reference internal image-reference" href="media/image620.png"><img alt="media/image620.png" src="media/image620.png" style="width: 4.86528in; height: 5.25in;" /></a>
<p><em>Le moteur est à 4 fils, piloté par une commande TUYA FT30F et
Zigbee2mqtt.</em></p>
<p><strong>Remarque</strong> : pour éviter que les commandes soient inversées dans
Domoticz, mettre à TRUE le paramètre spécifique concernant cet
interrupteur, dans le fronted de zigbee2mqtt</p>
<a class="reference internal image-reference" href="media/image621.png"><img alt="media/image621.png" src="media/image621.png" style="width: 6.26806in; height: 2.41528in;" /></a>
<p>Pour utiliser le Javascript (comme pour le plan) il ne faut pas charger
l’image par son nom mais l’incorporer dans un fichier PHP.</p>
<a class="reference internal image-reference" href="media/image622.png"><img alt="media/image622.png" src="media/image622.png" style="width: 6.26806in; height: 1.26806in;" /></a>
<p>L’image svg :</p>
<a class="reference internal image-reference" href="media/image623.png"><img alt="media/image623.png" src="media/image623.png" style="width: 6.30139in; height: 2.50139in;" /></a>
<p>Cette image a déjà été ajoutée au plan avec cette CLASS les ID étant
uniques ;</p>
<p>ID « volet_bureau » (1er &lt;rect ) pour indiquer le % d’ouverture</p>
<p>ID « volet_bureau1 » (2eme &lt;rect ) pour pouvoir cliquer n’importe où sur
l’image.</p>
<p><strong>8.2.4 .1 Affichage sur le plan :</strong></p>
<p>Le plan :</p>
<a class="reference internal image-reference" href="media/image624.png"><img alt="media/image624.png" src="media/image624.png" style="width: 5.84444in; height: 2.51111in;" /></a>
<p>Pour un clic qui fonctionne sans problème, on peut ajouter un rectangle
:</p>
<a class="reference internal image-reference" href="media/image625.png"><img alt="media/image625.png" src="media/image625.png" style="width: 5.44861in; height: 0.80278in;" /></a>
<a class="reference internal image-reference" href="media/image626.png"><img alt="media/image626.png" src="media/image626.png" style="width: 4.56389in; height: 3.96944in;" /></a>
<p>Ci-dessous le dispositif concerné dans Domoticz</p>
<a class="reference internal image-reference" href="media/image627.png"><img alt="media/image627.png" src="media/image627.png" style="width: 4.14722in; height: 3.05139in;" /></a>
<p>Enregistrer dans la base SQL le dispositif avec l’ID pour le mur de
commande et une CLASS pour le plan (permet de visualiser, comme pour les
lampes l’ouverture ou la fermeture des volets :</p>
<p>Dans la BD</p>
<a class="reference internal image-reference" href="media/image628.png"><img alt="media/image628.png" src="media/image628.png" style="width: 6.26806in; height: 0.4in;" /></a>
<p>Dans le plan on indique simplement si les volets sont fermés ou ouverts
(même partiellement :</p>
<a class="reference internal image-reference" href="media/image629.png"><img alt="media/image629.png" src="media/image629.png" style="width: 2.18889in; height: 1.63611in;" /></a>
<p>Le fichier footer.php, la fonction maj_devices_plan () modifiée :</p>
<a class="reference internal image-reference" href="media/image630.png"><img alt="media/image630.png" src="media/image630.png" style="width: 6.26806in; height: 5.53611in;" /></a>
<p>L’ouverture est Open ou les 12 premiers caractères sont « Set Level : »
La fermeture est Closed</p>
<a class="reference internal image-reference" href="media/image631.png"><img alt="media/image631.png" src="media/image631.png" style="width: 2.49028in; height: 1.47917in;" /></a>
<div class="line-block">
<div class="line"><strong>8.2.4 .2 Dans le mur ON/OFF:</strong></div>
<div class="line"><strong>Pour afficher le % d’ouverture :</strong></div>
<div class="line">Pour indiquer le % d’ouverture on ajoute un rectangle dans l’image, la
hauteur sera fonction du % d’ouverture ; pour cela il faut indiquer
dans l’image la hauteur de référence ; sinon un pourcentage
s’appliquera à la hauteur déjà modifiée qui diminuera au fil des mises
à jour</div>
</div>
<p>Height de l’image sera suivant le % d’ouverture sera modifiée dans le
Dom, c’est pourquoi on crée un attribut h qui est le reflet du height
d’origine</p>
<a class="reference internal image-reference" href="media/image632.png"><img alt="media/image632.png" src="media/image632.png" style="width: 6.30139in; height: 2.725in;" /></a>
<p>Le volume d’ouverture est indiqué dans Data : Set Level : VALEUR en %</p>
<a class="reference internal image-reference" href="media/image633.png"><img alt="media/image633.png" src="media/image633.png" style="width: 3.84167in; height: 4.11528in;" /></a>
<p>On applique ce pourcentage au rectangle de l’mage :</p>
<p>Dans footer.php :</p>
<p><em>On récupère la valeur h de l’image</em></p>
<div class="line-block">
<div class="line">var h=document.getElementById(val.ID1).getAttribute(“h”);</div>
<div class="line"><em>On attribue à l’image la bonne hauteur qui tient compte du %
d’ouverture</em></div>
<div class="line">document.getElementById(val.ID1).setAttribute(“height”,parseInt((h*pourcent[2])/100));
Ou suivant que les 100% soit pour l’ouverture ou la fermeture :</div>
<div class="line">document.getElementById(val.ID1).setAttribute(“height”,parseInt((h*(100-</div>
<div class="line">pourcent[2]))/100));</div>
<div class="line">Résultat :</div>
</div>
<a class="reference internal image-reference" href="media/image634.png"><img alt="media/image634.png" src="media/image634.png" style="width: 1.99028in; height: 1.63611in;" /></a>
<p>La fonction complète maj_devices(plan) dans footer.php</p>
<a class="reference internal image-reference" href="media/image635.png"><img alt="media/image635.png" src="media/image635.png" style="width: 6.26806in; height: 3.90417in;" /></a>
<div class="line-block">
<div class="line"><strong>Pour commander le volet :</strong></div>
<div class="line">Le rectangle indiquant le % d’ouverture peut être très petit, aussi
pour pouvoir cliquer n’importe où sur l’image, il suffit d’ajouter un
rectangle incolore comme déjà indiqué dans ce paragraphe :</div>
</div>
<a class="reference internal image-reference" href="media/image636.png"><img alt="media/image636.png" src="media/image636.png" style="width: 6.30139in; height: 1.05694in;" /></a>
<p>On ajoute l’id de ce rectangle dans la base de données :</p>
<a class="reference internal image-reference" href="media/image637.png"><img alt="media/image637.png" src="media/image637.png" style="width: 6.26806in; height: 0.3375in;" /></a>
<p>Comme pour les commandes onoff , les scripts des commandes onoff+stop
sont écrits automatiquement par la fonction <strong>function sql_plan($t) ;</strong></p>
<a class="reference internal image-reference" href="media/image638.png"><img alt="media/image638.png" src="media/image638.png" style="width: 6.30139in; height: 1.04167in;" /></a>
<p>Mais pour les volets, pour les commandes avec « level » un simple
interrupteur ne peut suffire, aussi le script écrit automatiquement est
fait afin d’ouvrir une fenêtre pour des données complémentaires</p>
<p>Le wiki de Domoticz concernant ces commandes :</p>
<a class="reference internal image-reference" href="media/image639.png"><img alt="media/image639.png" src="media/image639.png" style="width: 6.30139in; height: 1.73611in;" /></a>
<p><strong>La fonction PHP :</strong></p>
<a class="reference internal image-reference" href="media/image640.png"><img alt="media/image640.png" src="media/image640.png" style="width: 6.26806in; height: 2.83333in;" /></a>
<p>La fenêtre complémentaire :</p>
<a class="reference internal image-reference" href="media/image641.png"><img alt="media/image641.png" src="media/image641.png" style="width: 4.40694in; height: 4.78194in;" /></a>
<a class="reference internal image-reference" href="media/image642.png"><img alt="media/image642.png" src="media/image642.png" style="width: 5.55278in; height: 2.36528in;" /></a>
<div class="line-block">
<div class="line">C’est cette fenêtre qui va envoyer les commandes d’ouverture,
fermeture <strong>8.2.4.3 le script JS</strong></div>
<div class="line"><strong>8.2.4.3.1 avec Ajax et PHP, dans footer.php</strong></div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image643.png"><img alt="media/image643.png" src="media/image643.png" style="width: 6.3in; height: 1.17222in;" /></a>
<p>Ci-dessus, on récupère idx idm et la commande</p>
<a class="reference internal image-reference" href="media/image644.png"><img alt="media/image644.png" src="media/image644.png" style="width: 6.3in; height: 3.20278in;" /></a>
<p>Mise à jour instantanée :</p>
<a class="reference internal image-reference" href="media/image645.png"><img alt="media/image645.png" src="media/image645.png" style="width: 5.45833in; height: 2.33333in;" /></a>
<div class="line-block">
<div class="line"><strong>8.2.4.3.2 avec MQTT</strong></div>
<div class="line"><em>C’est une autre solution qui peut s’appliquer pour tout
dispositifs non gérer par le programme. Il faut installer la
bibliothèque ci-dessous paho-mqtt</em></div>
<div class="line"><a class="reference external" href="https://www.eclipse.org/paho/index.php?page=clients/js/index.php">https://www.eclipse.org/paho/index.php?page=clients/js/index.php</a></div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>var result = JSON.stringify(value);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>La commande :</strong></p>
<a class="reference internal image-reference" href="media/image652.png"><img alt="media/image652.png" src="media/image652.png" style="width: 5.44861in; height: 1.20833in;" /></a>
</div></blockquote>
<div class="line-block">
<div class="line"><strong>9. – Dispositifs Zigbee</strong></div>
<div class="line"><strong>Avec zigbee2mqtt</strong></div>
</div>
<a class="reference internal image-reference" href="media/image653.png"><img alt="media/image653.png" src="media/image653.png" style="width: 5.58472in; height: 7.58472in;" /></a>
<p>Affichage du Frontend de Zigbee2mqtt</p>
<p>Voir la page du site consacrée à frontend : <strong>la page zigbee.php</strong></p>
<a class="reference internal image-reference" href="media/image658.png"><img alt="media/image658.png" src="media/image658.png" style="width: 6.26806in; height: 1.6375in;" /></a>
<div class="line-block">
<div class="line"><strong>9.1 accès distant :</strong></div>
<div class="line">Il faut configurer NGINX :</div>
</div>
<p>Exemple de fichier .conf avant de demander un certificat cerbot :</p>
<a class="reference internal image-reference" href="media/image660.png"><img alt="media/image660.png" src="media/image660.png" style="width: 6.01111in; height: 4.40694in;" /></a>
<p>Demande de certificat :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image661.png"><img alt="media/image661.png" src="media/image661.png" style="width: 4.76111in; height: 0.22917in;" /></a>
</div></blockquote>
<p>Le fichier modifié par cerbot lors de la demande de certificat</p>
<p>d’info</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image664.png"><img alt="media/image664.png" src="media/image664.png" style="width: 6.26806in; height: 2.47639in;" /></a>
<p>Le fichier admin/config.php :</p>
<a class="reference internal image-reference" href="media/image665.png"><img alt="media/image665.png" src="media/image665.png" style="width: 5.52222in; height: 0.85417in;" /></a>
<p>Le fichier index_loc.php : pour info, ne pas modifier</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">server {</div>
<div class="line">server_name zwave.DOMAINE.ovh;</div>
</div>
<div class="line-block">
<div class="line">location / {</div>
<div class="line">proxy_pass <a class="reference external" href="http://192.168.1.76:8091/">http://192.168.1.76:8091/</a>;</div>
<div class="line">proxy_set_header Host $host;</div>
<div class="line">proxy_set_header X-Real-IP $remote_addr;</div>
<div class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; }</div>
</div>
<div class="line-block">
<div class="line">location /api {</div>
<div class="line">proxy_pass <a class="reference external" href="http://192.168.1.76:8091/api">http://192.168.1.76:8091/api</a>;</div>
<div class="line">proxy_set_header Host $host;</div>
</div>
<div class="line-block">
<div class="line">proxy_http_version 1.1;</div>
<div class="line">proxy_set_header Upgrade $http_upgrade;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">proxy_set_header Connection “upgrade”;</div>
<div class="line">}</div>
<div class="line">server_name zwave.DOMAINE.ovh;</div>
</div>
<div class="line-block">
<div class="line">auth_basic “Mot de Passe Obligatoire”;</div>
<div class="line">auth_basic_user_file /etc/nginx/.htpasswd;</div>
</div>
<div class="line-block">
<div class="line">listen 443 ssl; # managed by Certbot</div>
<div class="line">ssl_certificate
/etc/letsencrypt/live/zwave.DOMAINE.ovh/fullchain.pem;$
ssl_certificate_key
/etc/letsencrypt/live/zwave.DOMAINE.ovh/privkey.pe$ include
/etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by
Certbot</div>
</div>
<div class="line-block">
<div class="line">}</div>
<div class="line">server {</div>
<div class="line">if ($host = zwave.DOMAINE.ovh) {</div>
<div class="line">return 301 <a class="reference external" href="https://$host$request_uri">https://$host$request_uri</a>;</div>
<div class="line">} # managed by Certbot</div>
</div>
<p>server_name zwave.DOMAINE.ovh;</p>
<div class="line-block">
<div class="line">listen 80;</div>
<div class="line">server_name zwaveDOMAINE.ovh;</div>
<div class="line">return 404; # managed by Certbot</div>
</div>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>11.- MONITORING Nagios</strong></p>
<div class="line-block">
<div class="line">Avec Nagios ou Nagios mobile sur monitor,</div>
<div class="line">L’app Nagios PC est installée sur un Raspberry 4 8Go, celui qui
gère également les sauvegardes et la com GSM</div>
</div>
<a class="reference internal image-reference" href="media/image668.png"><img alt="media/image668.png" src="media/image668.png" style="width: 5.375in; height: 7.24167in;" /></a>
</div></blockquote>
<a class="reference internal image-reference" href="media/image669.png"><img alt="media/image669.png" src="media/image669.png" style="width: 5.59444in; height: 7.56389in;" /></a>
<p>Nagios effectue le monitoring des VM Proxmox avec un plugin : voir le
site domo-site.fr</p>
<a class="reference internal image-reference" href="media/image670.png"><img alt="media/image670.png" src="media/image670.png" style="width: 6.26806in; height: 1.6625in;" /></a>
<p>La page a la même structure que zigbee2mqtt exceptés les ID (css) et
liens local et distant,</p>
<p><strong>config.php</strong> :</p>
<a class="reference internal image-reference" href="media/image671.png"><img alt="media/image671.png" src="media/image671.png" style="width: 6.26806in; height: 0.76389in;" /></a>
<p><strong>css</strong> :</p>
<a class="reference internal image-reference" href="media/image672.png"><img alt="media/image672.png" src="media/image672.png" style="width: 5.91111in; height: 0.79306in;" /></a>
<p><strong>Le html :</strong></p>
<p>Index_loc.php</p>
<a class="reference internal image-reference" href="media/image673.png"><img alt="media/image673.png" src="media/image673.png" style="width: 6.26806in; height: 1.06528in;" /></a>
<p>header.php</p>
<a class="reference internal image-reference" href="media/image674.png"><img alt="media/image674.png" src="media/image674.png" style="width: 6.5in; height: 2.73333in;" /></a>
<div class="line-block">
<div class="line"><strong>nagios.php</strong></div>
<div class="line">on ajoute une iframe :</div>
</div>
<a class="reference internal image-reference" href="media/image675.png"><img alt="media/image675.png" src="media/image675.png" style="width: 6.19861in; height: 3.46944in;" /></a>
<div class="line-block">
<div class="line">Surveillance par Domoticz du PI : voir scripts <em>paragraphe 13.4</em></div>
<div class="line">Voir la page consacrée à ce sujet sur</div>
</div>
<div class="line-block">
<div class="line"><strong>11.1 accès distant</strong></div>
<div class="line">Il faut configurer Nginx et ensuite demander un certificat
Letsencrypt,</div>
<div class="line">Voir paragraphe 9, un exemple de configuration avant de faire une
demande de certificat ; le fichier.conf sera mis à jour par Cerbot</div>
</div>
<a class="reference internal image-reference" href="media/image676.png"><img alt="media/image676.png" src="media/image676.png" style="width: 2.05278in; height: 0.375in;" /></a>
<a class="reference internal image-reference" href="media/image677.png"><img alt="media/image677.png" src="media/image677.png" style="width: 6.1875in; height: 8.84444in;" /></a>
<p><strong>11.2 Supprimer l’affichage YouTube</strong></p>
<p>Dans le fichier , <strong>/usr/local/nagios/share/main.php ,</strong> supprimer les
lignes suivantes</p>
<a class="reference internal image-reference" href="media/image679.png"><img alt="media/image679.png" src="media/image679.png" style="width: 6.30139in; height: 5.15694in;" /></a>
<a class="reference internal image-reference" href="media/image680.png"><img alt="media/image680.png" src="media/image680.png" style="width: 4.66667in; height: 3.975in;" /></a>
<p>Les fichiers header.php ont été modifié , voir les exemples précédents.
Le fichier <strong>app_diverses.php</strong> :</p>
<a class="reference internal image-reference" href="media/image681.png"><img alt="media/image681.png" src="media/image681.png" style="width: 6.04167in; height: 3.63611in;" /></a>
<a class="reference internal image-reference" href="media/image682.png"><img alt="media/image682.png" src="media/image682.png" style="width: 5.57361in; height: 7.52222in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;?php</div>
<div class="line">session_start();</div>
<div class="line">$domaine=$_SESSION[“domaine”];</div>
<div class="line">if ($domaine==URLMONITOR) $lien_img=””;</div>
<div class="line">if ($domaine==IPMONITOR) $lien_img=”/monitor”; ?&gt;</div>
<div class="line">&lt;!– section App diverses start –&gt;</div>
<div class="line">&lt;!– ================ –&gt;</div>
<div class="line">&lt;div id=”app_diverses” class=”app_div”&gt; &lt;div class=”container”&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;div class=”col-md-12”&gt;</div>
<div class="line">&lt;h1 class=”title_ext text-center”&gt;App&lt;span&gt;
diverses&lt;/span&gt;&lt;/h1&gt;&lt;br&gt; &lt;img src=”&lt;?php echo
$lien_img;?&gt;/images/dz.png”</div>
<div class="line">style=”width:50px;height:auto;margin:10px 0 10px 120px”
alt=”dz”&gt;</div>
<div class="line">&lt;form2&gt;</div>
<div class="line">&lt;p class=”txt_app”&gt;&lt;input type=”button” rel=”1”
style=”margin-left: 60px;” class=”btn_appd” value=”afficher
fichier log normal”&gt;&lt;/p&gt;</div>
<div class="line">&lt;p class=”txt_app”&gt;&lt;input type=”button” rel=”2”
style=”margin-left: 60px;” class=”btn_appd” value=”afficher
fichier log statut”&gt;&lt;/p&gt;</div>
<div class="line">&lt;p class=”txt_app”&gt;&lt;input type=”button” rel=”4”
style=”margin-left: 60px;” class=”btn_appd” value=”afficher
fichier log erreur”&gt;&lt;/p&gt;</div>
<div class="line">&lt;img src=”&lt;?php echo $lien_img;?&gt;/images/nagios.png”</div>
<div class="line">style=”width:100px;height:auto;margin:10px 0 10px 100px”
alt=”dz”&gt;</div>
<div class="line">&lt;p class=”txt_app”&gt;&lt;input type=”button” rel=”hostlist”
style=”margin-left: 60px;” class=”btn_appd” value=”afficher
hosts Nagios”&gt;&lt;/p&gt;</div>
<div class="line">&lt;/form&gt;</div>
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
</div>
<p>&lt;/div&gt;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>footer.php</strong></p>
<a class="reference internal image-reference" href="media/image683.png"><img alt="media/image683.png" src="media/image683.png" style="width: 5.90694in; height: 2.91667in;" /></a>
<p>Fonctions.php , les fonctions log_dz() et app_nagios()</p>
<a class="reference internal image-reference" href="media/image684.png"><img alt="media/image684.png" src="media/image684.png" style="width: 5.78194in; height: 2.23333in;" /></a>
<div class="line-block">
<div class="line"><strong>12.1 AJOUT SQL</strong></div>
<div class="line"><strong>12.1.1 Edition de l’historique du ramassage des poubelles</strong></div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image687.png"><img alt="media/image687.png" src="media/image687.png" style="width: 4.28194in; height: 5.42639in;" /></a>
<a class="reference internal image-reference" href="media/image688.png"><img alt="media/image688.png" src="media/image688.png" style="width: 4.84444in; height: 7.23056in;" /></a>
</div></blockquote>
<p>Le fichier <strong>app_diverses.php</strong> :</p>
<p>Une icône est téléchargée ou celle du fichier image (celle-ci-dessus)
est utilisée</p>
<a class="reference internal image-reference" href="media/image689.png"><img alt="media/image689.png" src="media/image689.png" style="width: 6.26806in; height: 2.25972in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;img src=”&lt;?php echo $lien_img;?&gt;/images/serveur-sql.svg”</div>
<div class="line">style=”width:40px;height:auto;margin:0 0 10px 118px” alt=”dz”&gt;</div>
<div class="line">&lt;p class=”txt_app”&gt;&lt;input type=”button” rel=”sql1”
style=”margin-left: 60px;” class=”btn_appd” value=”afficher
historique poubelles”&gt;&lt;/p&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Le fichier fonctions.php : la fonction déjà vu au §1.6.1</p>
<a class="reference internal image-reference" href="media/image691.png"><img alt="media/image691.png" src="media/image691.png" style="width: 6.26111in; height: 2.38611in;" /></a>
<p>Extrait modifié :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">else if
(logapp==”hostli</div>
</div>
</div></blockquote>
<dl>
<dt>st”){urllog=”ajax.php?app=infos_nagios&amp;variable=”+logapp;titre=”Hosts</dt><dd><blockquote>
<div><p>Nagios”;}</p>
</div></blockquote>
<div class="line-block">
<div class="line">else if (logapp==”sql”){var table_sql = $(this).attr(‘title’);</div>
<div class="line">urllog=”ajax.</div>
</div>
</dd>
<dt>php?app=sql&amp;idx=1&amp;variable=”+table_sql+”&amp;type=&amp;command=”;titre=”histo</dt><dd><blockquote>
<div><p>rique poubelles”;}</p>
</div></blockquote>
<div class="line-block">
<div class="line">else {urllog=”erreur”;}</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>12.1.2 Ajout d’une icône à l’historique des poubelles</strong> Dans la BD :
on ajoute une colonne pour l’icône : - dans date_poub et dans text_img</p>
<a class="reference internal image-reference" href="media/image692.png"><img alt="media/image692.png" src="media/image692.png" style="width: 5.20972in; height: 1.61528in;" /></a>
<a class="reference internal image-reference" href="media/image693.png"><img alt="media/image693.png" src="media/image693.png" style="width: 5.77222in; height: 3.29167in;" /></a>
<p>footer.php ;</p>
<a class="reference internal image-reference" href="media/image694.png"><img alt="media/image694.png" src="media/image694.png" style="width: 6.26806in; height: 2.19722in;" /></a>
<a class="reference internal image-reference" href="media/image695.png"><img alt="media/image695.png" src="media/image695.png" style="width: 5.31389in; height: 2.50972in;" /></a>
<div class="line-block">
<div class="line">fonctions.php</div>
<div class="line">pour que maj_services (footer.php) récupère le chemin de l’icône la
fonction sql_app doit envoyer la donnée</div>
</div>
<a class="reference internal image-reference" href="media/image696.png"><img alt="media/image696.png" src="media/image696.png" style="width: 4.63611in; height: 6.11944in;" /></a>
<p>Pour la restitution de l’historique :</p>
<a class="reference internal image-reference" href="media/image697.png"><img alt="media/image697.png" src="media/image697.png" style="width: 5.38611in; height: 3.49028in;" /></a>
<p>Résultat</p>
<a class="reference internal image-reference" href="media/image698.png"><img alt="media/image698.png" src="media/image698.png" style="width: 4.57361in; height: 2.1875in;" /></a>
<p><strong>13. – APPLICATIONS externes en lien avec Domoticz ou monitor</strong></p>
<div class="line-block">
<div class="line"><strong>13.1 Affichage des notifications sur un téléviseur LG</strong> Le script
optionnel pour la notification sur un téléviseur LG (web os) sudo et
Node.js doit être installés</div>
<div class="line">lgtv et superagent doivent être installés</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>npm install lgtv</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>npm install superagent</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image699.png"><img alt="media/image699.png" src="media/image699.png" style="width: 4.40694in; height: 2.8125in;" /></a>
<p>Les variables à ajouter :</p>
<a class="reference internal image-reference" href="media/image700.png"><img alt="media/image700.png" src="media/image700.png" style="width: 5.46806in; height: 1.3875in;" /></a>
<p>Le script : notifications_tv.lua à ajouter à Domoticz-&gt;Evènements :</p>
<a class="reference internal image-reference" href="media/image701.png"><img alt="media/image701.png" src="media/image701.png" style="width: 1.91806in; height: 0.6875in;" /></a>
<a class="reference internal image-reference" href="media/image702.png"><img alt="media/image702.png" src="media/image702.png" style="width: 6.49583in; height: 5.90139in;" /></a>
<p>Les valeurs transmises par dz au script dans l’ordre : texte, idx,
vtype, vvalue</p>
<a class="reference internal image-reference" href="media/image703.png"><img alt="media/image703.png" src="media/image703.png" style="width: 6.49583in; height: 1.29722in;" /></a>
<div class="line-block">
<div class="line">Script notification_lg.js à ajouter à Home/user/</div>
<div class="line">Script node_modules/lgtv/index.js à remplacer</div>
<div class="line">Voir le dossier</div>
<div class="line">Essai avec la console :</div>
</div>
<a class="reference internal image-reference" href="media/image704.png"><img alt="media/image704.png" src="media/image704.png" style="width: 6.08333in; height: 2.4125in;" /></a>
<div class="line-block">
<div class="line"><strong>13.2 Portier Dahua VTO 2000 et VTO 2022 13.2.1 VTO 2000A</strong></div>
<div class="line">Voir les pages</div>
</div>
<a class="reference internal image-reference" href="media/image705.png"><img alt="media/image705.png" src="media/image705.png" style="width: 6.26806in; height: 1.63194in;" /></a>
<p>Et :</p>
<a class="reference internal image-reference" href="media/image706.png"><img alt="media/image706.png" src="media/image706.png" style="width: 6.26806in; height: 2.03056in;" /></a>
<p>Domoticz , on crée une variable « sonnette »</p>
<a class="reference internal image-reference" href="media/image707.png"><img alt="media/image707.png" src="media/image707.png" style="width: 6.5in; height: 0.41389in;" /></a>
<p><strong>Le script LUA :</strong></p>
<a class="reference internal image-reference" href="media/image708.png"><img alt="media/image708.png" src="media/image708.png" style="width: 5.44861in; height: 2.07361in;" /></a>
<div class="line-block">
<div class="line">pushover_img.sh</div>
<div class="line">Après passage sous docker modification du script</div>
</div>
<a class="reference internal image-reference" href="media/image709.png"><img alt="media/image709.png" src="media/image709.png" style="width: 6.12639in; height: 2.75972in;" /></a>
<a class="reference internal image-reference" href="media/image710.png"><img alt="media/image710.png" src="media/image710.png" style="width: 6.26806in; height: 2.03472in;" /></a>
<p><strong>En utilisant connect.lua,</strong> pour éviter une mise à jour si changement
d’IP : connect.lua :</p>
<a class="reference internal image-reference" href="media/image711.png"><img alt="media/image711.png" src="media/image711.png" style="width: 3.00139in; height: 1.4375in;" /></a>
<p>Dans DZ :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>package.path = package.path..”;www/modules_lua/?.lua” require
‘connect’</p>
<div class="line-block">
<div class="line">commandArray = {}</div>
<div class="line">if (uservariables[‘sonnette’]==”1”) then</div>
<div class="line">– –envoi image pushover —————</div>
<div class="line">os.execute(“/bin/bash userdata/scripts/bash/pushover_img.sh
“..ip_domoticz..”&gt;&gt; /home/michel/push.log 2&gt;&amp;1”);</div>
<div class="line">commandArray[‘Variable:sonnette’] = ‘0’</div>
<div class="line">end</div>
<div class="line">return commandArray</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Et dans pushover_img.sh :</div>
<div class="line">wget <a class="reference external" href="http://$1:8086/camsnapshot.jpg?idx=1">http://$1:8086/camsnapshot.jpg?idx=1</a> -O
/opt/domoticz/userdata/camsnapshot.jpg <strong>asterisk</strong></div>
</div>
<a class="reference internal image-reference" href="media/image712.png"><img alt="media/image712.png" src="media/image712.png" style="width: 4.68889in; height: 5.78194in;" /></a>
<p><strong>VTO2000A</strong></p>
<a class="reference internal image-reference" href="media/image713.png"><img alt="media/image713.png" src="media/image713.png" style="width: 3.01806in; height: 3.26944in;" /></a>
<a class="reference internal image-reference" href="media/image714.png"><img alt="media/image714.png" src="media/image714.png" style="width: 6.26806in; height: 4.38333in;" /></a>
<div class="line-block">
<div class="line"><strong>VTO2000A</strong></div>
<div class="line"><strong>configTools</strong> →<strong>VDPConfig</strong></div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image715.png"><img alt="media/image715.png" src="media/image715.png" style="width: 5.36389in; height: 3.90278in;" /></a>
<a class="reference internal image-reference" href="media/image716.png"><img alt="media/image716.png" src="media/image716.png" style="width: 2.91667in; height: 2.79028in;" /></a>
<a class="reference internal image-reference" href="media/image717.png"><img alt="media/image717.png" src="media/image717.png" style="width: 5.16528in; height: 2.0875in;" /></a>
<a class="reference internal image-reference" href="media/image718.png"><img alt="media/image718.png" src="media/image718.png" style="width: 5.24861in; height: 1.88472in;" /></a>
<a class="reference internal image-reference" href="media/image719.png"><img alt="media/image719.png" src="media/image719.png" style="width: 5.69722in; height: 4.01944in;" /></a>
<a class="reference internal image-reference" href="media/image713.png"><img alt="media/image713.png" src="media/image713.png" style="width: 2.84306in; height: 3.08194in;" /></a>
<p><strong>13.3 -La boite aux lettres,</strong></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Voir domo-site pour la programmation de l’esp8266 , de dzvent et
Python</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Le matériel :</strong></p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
</div>
</td>
<td><p>2 ILS (pour le volet , pour la
porte 1 esp 01 et une alim
12V/3,3 Volts</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Voir la page consacrée à la réalisation et la programmation de
l’ESP pour une communication MQTT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Les images svg :</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="media/image721.png"><img alt="image24" src="media/image721.png" style="width: 0.89306in; height: 0.9666in;" /></a><a class="reference internal" href="media/image722.png"><img alt="image25" src="media/image722.png" style="width: 0.89583in; height: 0.96875in;" /></a><a class="reference internal" href="media/image723.png"><img alt="image26" src="media/image723.png" style="width: 6.5in; height: 0.29081in;" /></a><a class="reference internal" href="media/image724.png"><img alt="image27" src="media/image724.png" style="width: 6.34722in; height: 9.5in;" /></a></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>lettres</p></th>
<th class="head"><p>colis</p></th>
<th class="head"><p>lettre &amp; colis</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Le fichier accueil.php :</p>
<div class="line-block">
<div class="line">Le fichier footer.php, le script pour afficher une demande de
confirmation de la relève du courrier</div>
<div class="line">/<em>—popup boite_lettres———————————–</em>/</div>
<div class="line">var bl=0;var modalContainer = document.createElement(‘div’);</div>
<div class="line">modalContainer.setAttribute(‘id’, ‘modal_bl’);</div>
<div class="line">var customBox = document.createElement(‘div’);</div>
<div class="line">customBox.className = ‘custom-box’;</div>
<div class="line">// Affichage boîte de confirmation</div>
<div class="line">document.getElementById(‘confirm-box’).addEventListener(‘click’,
function() {</div>
<div class="line">customBox.innerHTML = ‘&lt;p&gt;Confirmation de la relève du courrier&lt;/p&gt;’;</div>
<div class="line">customBox.innerHTML += ‘&lt;button style=”margin-right: 20px;” id=”modal-</div>
<div class="line">confirm”&gt;Confirmer&lt;/button&gt;’;</div>
<div class="line">customBox.innerHTML += ‘&lt;button id=”modal-close”&gt;Annuler&lt;/button&gt;’;</div>
<div class="line">modalShow();</div>
<div class="line">console.log(bl);</div>
<div class="line">});</div>
<div class="line">function modalShow() {</div>
<div class="line">modalContainer.appendChild(customBox);</div>
<div class="line">document.body.appendChild(modalContainer);</div>
<div class="line">document.getElementById(‘modal-close’).addEventListener(‘click’,
function() {</div>
<div class="line">modalClose();</div>
<div class="line">});</div>
<div class="line">if (document.getElementById(‘modal-confirm’)) {</div>
<div class="line">document.getElementById(‘modal-confirm’).addEventListener(‘click’,
function () {</div>
<div class="line">console.log(‘Confirmé !’);bl=1;</div>
<div class="line">modalClose(bl);</div>
<div class="line">});</div>
<div class="line">} else if (document.getElementById(‘modal-submit’)) {</div>
<div class="line">document.getElementById(‘modal-submit’).addEventListener(‘click’,
function () {</div>
<div class="line">console.log(document.getElementById(‘modal-prompt’).value);</div>
<div class="line">bl=0;modalClose(bl);</div>
<div class="line">});</div>
<div class="line">}</div>
<div class="line">}</div>
<div class="line">function modalClose(bl) {</div>
<div class="line">while (modalContainer.hasChildNodes()) {</div>
<div class="line">modalContainer.removeChild(modalContainer.firstChild);</div>
<div class="line">}</div>
<div class="line">document.body.removeChild(modalContainer);</div>
<div class="line">console.log(bl);if (bl==1)
{maj_variable(19,”boite_lettres”,”0”,2);maj_services(0);bl=0;} }</div>
<div class="line">/<em>——————————————</em>/</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image725.png"><img alt="image28" src="media/image725.png" style="width: 6.49583in; height: 4.36944in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Un clique sur la BL fait apparaitre le popup de confirmation</p>
</div></blockquote>
<blockquote>
<div><p>Les css :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>La variable Domoticz</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image728.png"><img alt="media/image728.png" src="media/image728.png" style="width: 6.5in; height: 0.41944in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Les tables sql :</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>Variables dans la table «
dispositifs » :</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image729.png"><img alt="image29" src="media/image729.png" style="width: 6.30139in; height: 2.82222in;" /></a></p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>La table « text_image »</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image730.png"><img alt="image30" src="media/image730.png" style="width: 6.49583in; height: 1.27917in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Après confirmation de la relève, la confirmation de la maj de la
variable Domoticz</p>
</div></blockquote>
<blockquote>
<div><p>Domoticz envoi par MQTT la confirmation de la mise à zéro de la
variable boite lettres</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Le script dzvents :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">– script notifications_autres</div>
<div class="line">return {</div>
<div class="line">on = {</div>
<div class="line">variables = {</div>
<div class="line">‘alarme_bat’,</div>
<div class="line">‘boite_lettres’,</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">}</div>
<div class="line">},</div>
<div class="line">execute = function(domoticz, variable)</div>
<div class="line">domoticz.log(‘Variable ‘ .. variable.name .. ‘ was changed’,
domoticz.LOG_INFO) if (domoticz.variables(‘alarme_bat’).changed)
then</div>
<div class="line">if (domoticz.variables(‘alarme_bat’).value == “batterie_faible”)
then if domoticz.variables(‘not_alarme_bat’).value == “0” then</div>
<div class="line">os.execute(“curl –insecure ‘<a class="reference external" href="https://smsapi.free">https://smsapi.free</a>-</div>
<div class="line">mobile.fr/sendmsg?user=xxxxxxx&amp;pass=xxxxxxxxxx&amp;msg=pile faible’
&gt;&gt;</div>
<div class="line">/home/michel/OsExecute1.log 2&gt;&amp;1”)</div>
<div class="line">domoticz.variables(‘not_alarme_bat’).set(‘1’)</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">if (domoticz.variables(‘boite_lettres’).changed) then</div>
<div class="line">if (domoticz.variables(‘boite_lettres’).value == “0”) then</div>
<div class="line">print(“topic envoyé : esp/in/boite_lettres”)</div>
<div class="line">local command = “/home/michel/domoticz/scripts/python/mqtt.py</div>
<div class="line">esp/in/boite_lettres valeur 0 &gt;&gt; /home/michel/esp.log 2&gt;&amp;1” ;</div>
<div class="line">os.execute(command);</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">end</div>
<div class="line">}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Voir cette page : <em>http://domo-site.fr/accueil/dossiers/44</em></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Les tables SQL text_image et variables_dz :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Ce sont les scripts :</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>js « maj_services » qui gère
l’affichage de la page
d’accueil</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image736.png</p>
<blockquote>
<div><blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>5.28056in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>4.25278in</p>
</dd>
</dl>
</div></blockquote>
<p>DZEvent «
notifications_devices » qui à
partir de l’info du matériel «
System</p>
<p>Alive Checker » modifie le
contenu de la variable «
pi-alarme »</p>
</div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image737.png</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>6.26667in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>1.96389in</p>
</dd>
</dl>
</div></blockquote>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image738.png"><img alt="image31" src="media/image738.png" style="width: 6.26806in; height: 3.55556in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div></div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image739.png</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>5.71944in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>2.09305in</p>
</dd>
</dl>
</div></blockquote>
</th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>Sur la page « nagios » c’est le
script JS « maj_devices(plan) »
qui gère le changement</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>de couleur de l’icône, à partir du dispositif dans Domoticz</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.5- Capteur de pression -chaudière</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Réalisé avec un
microcontrôleur Wemos D1 :
pour la partie réalisation du
capteur, voir le site web :
domo-site.fr</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Envoie les données de
pression sur le serveur MQTT</div>
<div class="line">Domoticz récupère et traites
les données</div>
<div class="line">Monitor affiche en temps
réel les données,
l’historique des données, un
graphique ,….</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.5.1 l’image SVG :</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Elle est ajoutée à interieur.php(ci-dessous) et accueil.php
(ci-dessus)</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Accueil.php :</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image744.png"><img alt="image32" src="media/image744.png" style="width: 6.26806in; height: 1.80694in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pour annuler l’alarme, le fichier <strong>footer.php</strong>: la fenêtre
modale est déjà utilisée pour la boite aux lettres, ajout d’une
variable « ch » 0 pour la BL et 1 pour la pression</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Une variable doit être créée dans Domoticz, voir le paragraphe
suivant</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image745.png"><img alt="image33" src="media/image745.png" style="width: 6.26806in; height: 5.675in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>L’image :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">&lt;svg version=”1.1” id=”svgpression”
xmlns=”<a class="reference external" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>”</div>
<div class="line">xmlns:xlink=”http://www.w3.org/1999/xlink” x=”0px”</div>
<div class="line">y=”0px” viewBox=”0 0 111.7 136.9” style=”enable-background:new 0
0 111.7 136.9;” xml:space=”preserve”&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;g id=”chaudiere”&gt;</div>
<div class="line">&lt;path id=”path14834” class=”st1”
d=”M25.1,15.8v-4</div>
</div>
</div></blockquote>
<dl>
<dt>.2c2.1,0,3.2,2,5.4,1.8c4-0.4,5.2-5.3,1.4-6.9c-1.1-0.5-2.6-0.4-3.6,0.1</dt><dd><div class="line-block">
<div class="line">c-1.2,0.6-1.8,1.4-3.2,1.4c0-0.9,0.3-2.2-0.4-3c-</div>
</div>
</dd>
<dt>0.9-1.1-2.7-1-3.3,0.3c-0.4,0.8-0.2,1.9-0.2,2.8c-1.5,0-2.1-0.7-3.2-1.4</dt><dd><div class="line-block">
<div class="line">c-1.1-0.5-2.6-0.6-3.8-0.1c-3.6,1.6-2.4,6.5,1.6,6.9c2.2</div>
</div>
</dd>
<dt>,0.2,3.3-1.8,5.4-1.8v4.5c-1.6,0-3.2,0.3-4.8,0.5c-4,0.5-8.2,1.3-12,2.7</dt><dd><div class="line-block">
<div class="line">c-1.2,0.5-2.6,1-3.6,1.8c-0.6,0.5-0.9,1-</div>
<div class="line">0.5,1.8c0.</div>
</div>
</dd>
<dt>6,0.9,2,1.5,3.1,1.9c2.1,0.8,4.3,1.5,6.6,1.9c9.5,2.1,19.7,2.5,29.5,2.3</dt><dd><div class="line-block">
<div class="line">c7.5-0.2,15.5-0.8,22.7-2.9c1.9-0.5,3.8-1,5.5-1.9c0.7</div>
</div>
</dd>
<dt>-0.3,1.5-0.8,1.9-1.4c0.4-0.6,0.1-1.2-0.4-1.6c-0.9-0.8-2.1-1.3-3.2-1.7</dt><dd><div class="line-block">
<div class="line">c-2.8-1-5.6-1.6-8.5-2.3c-2.1-0.5-4.5-0.9-6.</div>
</div>
</dd>
<dt>7-1c0.5-1.9,1.6-3.8,3.1-5.1c1.9-1.9,4.2-3.3,7-4c6.2-1.6,13.1,1,16.5,6</dt><dd><div class="line-block">
<div class="line">c1.4,2.1,2,4.4,2,6.9h7.6c0-3.2-0.8-6.4-2.3-9.2c-1.</div>
</div>
</dd>
<dt>1-2.1-2.7-4-4.6-5.6c-7.4-6.2-19-7.1-27.3-2.1c-3.2,1.9-5.8,4.6-7.6,7.7</dt><dd><div class="line-block">
<div class="line">c-0.6,1-1.1,2.2-1.5,3.4c-0.1,0.4-0.1,1.1-0.6,1.3c-0.6,0</div>
</div>
</dd>
</dl>
<p>.2-1.3,0-1.9-0.1c-1.5-0.1-2.9,0-4.4-0.1C32.7,15.3,28.9,15.8,25.1,15.8</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">M76.5,21.6c-0.4,0.1-0.7,0.5-0.9,0.8c-0.1,0.4-0.1,0.8-0.1,1.2c0,1-
| 0.4,2.9,0.8,3.5c0.8,0.4,2.2,0.1,3.1,0.1h6.8
| c0.9,0,2.2,0.2,3-0.1c1.2-0.6,0.9-2.2,0.9-3.2c0-0.5,0</div>
</div>
</div></blockquote>
<dl>
<dt>.1-0.8-0.1-1.3c-0.1-0.4-0.4-0.7-0.8-0.9c-0.9-0.4-2.3-0.1-3.2-0.1h-6.6</dt><dd><div class="line-block">
<div class="line">C78.7,21.5,77.4,21.3,76.5,21.6 M0,27.1v64.6v16.8v4.3c0,0.6-</div>
<div class="line">0.1,1.4,0.3,2c0.9,1.2,2.9,1.8,4.3,2.3c3.6,1.2,7.2,1.9,10.9,2.5</div>
<div class="line">c5.5,0.9,11,1.1,16.5,1.2c7.8,0.2,15.6-0.3,23.4-1.4c3.4-</div>
</div>
</dd>
<dt>0.5,6.9-1.3,10.1-2.4c1.3-0.5,3-1.1,4-2.1c0.9-0.9,0.4-2.7,0.4-3.8v-9.9</dt><dd><div class="line-block">
<div class="line">h9.4c0,2.5-0.1,5.1,0.3,7.6c1.1,5.9,5.1,11,10.8,14c1.</div>
</div>
</dd>
<dt>9,1,4.5,2.2,6.8,2.3v-5c0-0.5,0.2-1.5-0.1-1.9c-0.3-0.3-1.1-0.5-1.6-0.6</dt><dd><div class="line-block">
<div class="line">c-1-0.4-1.8-0.9-2.7-1.4c-3.4-2.3-5.5-5.7-5.9-9.5c-0.</div>
</div>
</dd>
<dt>3-2.8,0-5.8,0-8.6V80.8v-52h-7.6v8.6c-1.2-0.2-2.4-0.1-3.6-0.1h-5.8v-10</dt><dd><div class="line-block">
<div class="line">c-2.1,0.8-4.1,1.8-6.3,2.3c-9.4,2.5-19.5,3-29.3,3c-8.</div>
</div>
</dd>
<dt>7,0-17.8-0.5-26.2-2.6c-1.6-0.4-3.3-0.8-4.9-1.5C2.1,28,1.1,27.5,0,27.1</dt><dd><div class="line-block">
<div class="line">M79.3,42.2v53.9C76.3,95.8,73,96,69.9,96V42.2H79.3
M17,71c1.2-0.1,2.6-0.1,3.8,0.3c5.5,1.4,7.5,7.5,4.2,11.6</div>
<div class="line">c-0.6,0.8-1.4,1.5-2.4,1.9c-1,0.5-2.1,0.9-3.2,1c-1.1,</div>
</div>
</dd>
<dt>0.1-2.2,0.1-3.2-0.2c-5.5-1.2-7.8-7.3-4.8-11.4c0.6-0.8,1.5-1.6,2.4-2.1</dt><dd><div class="line-block">
<div class="line">C14.7,71.5,15.8,71.2,17,71
M17.3,74.4c</div>
</div>
</dd>
<dt>-0.6,0.1-1.3,0.4-1.8,0.7c-3.1,2.1-1.9,6.7,1.9,7.3c0.5,0.1,1,0.1,1.6,0</dt><dd><div class="line-block">
<div class="line">c0.7-</div>
</div>
</dd>
<dt>0.1,1.4-0.4,1.9-0.8c1.1-0.8,1.8-2,1.8-3.3C22.6,75.9,20,73.9,17.3,74.4</dt><dd><blockquote>
<div><p>M17.8,91.1c4.9-0.5,9.1,4,8.7,8.1</p>
</div></blockquote>
<div class="line-block">
<div class="line">c</div>
</div>
</dd>
<dt>-0.4,3.8-3.6,6.5-7.7,6.9c-0.7,0.1-1.5,0-2.2-0.1c-5.5-0.9-8.2-6.5-5.7-</dt><dd><blockquote>
<div><div class="line-block">
<div class="line">10.9C12.3,92.6,14.9,91.3,17.8,91.1 M17.3,94.6</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">c-3.6,0.6-4.8,4.7-2.3,6.9c1.1,1,2.7,1.3,4.3,1c2.9-0.5,4.2-3.7,2.9-
| 5.9C21.2,95,19.2,94.2,17.3,94.6 M99.8,115.2
| c-0.5,0.1-0.9,0.5-1.1,1c-0.4,1.1-0.1,2.7-0.1,3.8v5.6c0,0.8-
| 0.1,1.7,0.6,2.3s2.1,0.4,3,0.4c0.6,0,1.3,0.1,1.8-0.1
| c0.6-0.2,1-0.6,1.1-1.2c0.2-</div>
</div>
</dd>
<dt>1.2,0.1-2.5,0.1-3.7v-5.1c0-0.7,0.2-1.7-0.3-2.3c-0.7-1-2.5-0.7-3.6-0.7</dt><dd><div class="line-block">
<div class="line">C100.8,115.1,100.3,115.1,99.8,115.2
M106.5,118.6v6.9h5.2v-6.9H106.5
M6.6,121.2v7.9c0,1-0.3,2.3,0.6,3.1c0.9,0.8,2.2,1.4,3.3,1.7</div>
<div class="line">c2.3,0.8,4.7,1.2,7.1,1.8c4.2,0.8,8.6,1,12.9,1.2c6.</div>
</div>
</dd>
<dt>6,0.3,13.2-0.1,19.7-0.9c3.1-0.4,6.3-1,9.3-2.1c1.1-0.4,2.6-0.9,3.4-1.8</dt><dd><div class="line-block">
<div class="line">c0.6-0.8,0.4-2.2,0.4-3.1v-7.8c-2</div>
</div>
</dd>
<dt>.8,0.5-5.6,1.3-8.5,1.7c-11,1.6-22.4,1.7-33.4,0.7c-3-0.3-6.1-0.6-9-1.2</dt><dd><div class="line-block">
<div class="line">C10.4,122,8.5,121.4,6.6,121.2L6.6,121.2z”/&gt;</div>
<div class="line">&lt;rect x=”6.5” y=”37” class=”st185” width=”56.9” height=”25”/&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;text id=”text_chaudiere” transform=”matrix(1 0 0 1 7 55)”
class=”st33 st36a”&gt;tmp&lt;/text&gt; &lt;/svg&gt;</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><em>Pour la notification (chaudière rouge en page d’accueil)
supprimer les dernières lignes &lt;rect et &lt;text et modifier les ID
(les id doivent être uniques)</em></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Annulation de l’alarme</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>interieur.php</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image748.png"><img alt="image34" src="media/image748.png" style="width: 6.26806in; height: 1.95694in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image750.png"><img alt="image35" src="media/image750.png" style="width: 6.26806in; height: 2.40417in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.5.2 Dans Domoticz, le capteur, le plan, les variables et les
scripts</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>- le capteur</strong></p>
</div></blockquote>
<blockquote>
<div><p>Pour éviter des erreurs comme celles-ci :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image753.png"><img alt="image36" src="media/image753.png" style="width: 6.26528in; height: 0.99861in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>L’envoie des données doivent être un tableau json de cette forme :</p>
</div></blockquote>
<blockquote>
<div><p>Le topic étant « <strong>domoticz/in</strong> » , voir la page de domo-site.fr
consacré à ce sujet</p>
<p>L’affichage après réception des données :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Le plan</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Le capteur est ajouté au plan pour une communication automatique
avec Monitor ou toute autre application, les données sont
récupérées dans un fichier json</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image756.png"><img alt="image37" src="media/image756.png" style="width: 3.04444in; height: 2.61528in;" /></a><a class="reference internal" href="media/image757.png"><img alt="image38" src="media/image757.png" style="width: 2.90694in; height: 2.08333in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Le fichier json appelé par la fonction « devices_plan » , voir le <em>§
1.3</em></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image758.png"><img alt="image39" src="media/image758.png" style="width: 6.26806in; height: 5.58194in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Le script export_sql.lua</strong></p>
<div class="line-block">
<div class="line">Les modifications à apporter :</div>
<div class="line">Pour n’envoyer à la BD que les changements de pression (pour
limiter le nombre d’enregistrements) , il faut :</div>
<div class="line">- Soit créer une user variable</div>
<div class="line">- Soit utiliser une donnée persistante, solution retenue ici</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Avec LUA, il faut enregistrer la valeur dans un fichier</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Le script : les lignes à ajouter pour l’enregistrement dans la BD
et le déclenchement d’une alarme</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">package.path = package.path..”;www/modules_lua/?.lua” require
‘datas’</div>
<div class="line">require ‘string_tableaux’</div>
</div>
<div class="line-block">
<div class="line">function write_datas(data)</div>
<div class="line">f = io.open(“www/modules_lua/datas.lua”, “w”)
f:write(“pression=”..data)</div>
<div class="line">f:close()</div>
<div class="line">end</div>
</div>
<div class="line-block">
<div class="line">elseif (deviceName==’pression_chaudière’) then</div>
<div class="line">pressionch=tonumber(deviceValue);</div>
<div class="line">print (“pression_chaudiere:”..pressionch..”–”..pression); if
(pression~=pressionch) then</div>
<div class="line">libelle=”pression_chaudiere#valeur”;don=”</div>
<div class="line">“..libelle..”#”..tostring(deviceValue)..”#”..datetime</div>
<div class="line">envoi_fab(don)</div>
<div class="line">–donnees[‘pression’]=tonumber(deviceValue)</div>
<div class="line">write_datas(tonumber(deviceValue),data1)</div>
<div class="line">–pression_chaudiere: variable du fichier ‘string_tableaux’</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">if (pressionch&lt;pression_chaudiere and
uservariables[‘pression-chaudiere’]==”ras”) then</div>
<div class="line">commandArray[‘Variable:pression-chaudiere’] = “manque_pression”;</div>
<div class="line">print(“pression basse”)</div>
<div class="line">elseif (pressionch&lt;pression_chaudiere and
uservariables[‘pression-</div>
<div class="line">chaudiere’]~=”pression_basse”) then</div>
<div class="line">commandArray[‘Variable:pression-chaudiere’]=”ras”</div>
<div class="line">end</div>
<div class="line">end</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image760.png"><img alt="image40" src="media/image760.png" style="width: 6.30139in; height: 4.30694in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pour l’alarme « pression basse », il faut créer une variable, qui
associée à un id affichera ce manque de pression sur une tablette
et enverra une notification par mail et sms</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image762.png"><img alt="image41" src="media/image762.png" style="width: 6.26806in; height: 0.82917in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Le script notifications_variables.lua: les lignes à ajouter</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">return {</div>
<div class="line">on = {</div>
<div class="line">variables = {</div>
<div class="line">‘alarme_bat’,</div>
<div class="line">‘boite_lettres’,</div>
<div class="line">‘upload’,</div>
<div class="line">‘zm_cam’,</div>
<div class="line">‘pression-chaudiere’,</div>
<div class="line">}</div>
<div class="line">},</div>
<div class="line">execute = function(domoticz, variable)</div>
<div class="line">domoticz.log(‘Variable ‘ .. variable.name .. ‘ was changed’,
domoticz.LOG_INFO) if
(domoticz.variables(‘pression-chaudiere’).value ==
“manque_pression”) then
txt=tostring(domoticz.variables(‘pression-chaudiere’).value)</div>
<div class="line">domoticz.variables(‘pression-chaudiere’).set(‘pression_basse’)</div>
<div class="line">print(“envoi SMS pression-chaudiere”)</div>
<div class="line">alerte_gsm(‘<a href="#id11"><span class="problematic" id="id12">alarme_</span></a>’..txt)</div>
<div class="line">end</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.5.3 Dans la Base de données SQL</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li><p><strong>Créer une nouvelle table</strong>:</p></li>
</ul>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">CREATE TABLE `pression_chaudiere` (</div>
<div class="line">`num` int(5) NOT NULL,</div>
<div class="line">`date` timestamp NOT NULL DEFAULT current_timestamp() ON
UPDATE current_timestamp(),</div>
<div class="line">`valeur` varchar(4) NOT NULL</div>
<div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div>
<div class="line">ALTER TABLE `pression_chaudiere` CHANGE `num` `num` INT(4)
NOT NULL AUTO_INCREMENT, add PRIMARY KEY (<cite>num</cite>);</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div></div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image763.png</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>5.26111in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>2.64583in</p>
</dd>
</dl>
</div></blockquote>
</th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p><strong>Mettre à jour la table des
dispositifs :</strong></p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image764.png"><img alt="media/image764.png" src="media/image764.png" style="width: 6.26667in; height: 4.30972in;" /></a>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><blockquote>
<div></div></blockquote>
<p>age:: vertopal_6e277aed43794de08d
a7229da055806a/media/image765.png</p>
<blockquote>
<div><blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">width</dt>
<dd class="field-odd"><p>5.35278in</p>
</dd>
<dt class="field-even">height</dt>
<dd class="field-even"><p>5.4875in</p>
</dd>
</dl>
</div></blockquote>
<p><strong>Mettre à jour la table des
variables DZ pour l’affichage
d’une notification sur l’app
donc la tablette ou le
smartphone</strong></p>
</div></blockquote>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>On a choisi d’afficher une image</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image767.png"><img alt="image42" src="media/image767.png" style="width: 5.94722in; height: 7.52083in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>Mise à jour de la table txt-image</strong>:</p>
<p>Pour afficher comme ci-dessus une image plutôt qu’un texte,</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image768.png"><img alt="media/image768.png" src="media/image768.png" style="width: 6.26806in; height: 0.68333in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.5.4 Styles CSS</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Ajuster l’emplacement les couleurs pour les différents écrans</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image770.png"><img alt="image43" src="media/image770.png" style="width: 6.26806in; height: 2.62639in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>13.6- SMS réception et émission</strong></p>
<p><strong>13.6.1 réception SMS</strong></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Voir les pages consacrées au modem GSM et la communication série
entre Domoticz et un RPI</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Les fichiers sont sauvegardés dans le RAID1 :</p>
<p>sudo cp rec_sms.py
/pve/raid_usb/scripts_python_sh/SMS_ebyte/rec_sms.py</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>sudo cp /pve/raid_usb/scripts_python_sh/SMS_ebyte/envoi_sms.py
/home/michel</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable Domoticz :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image771.png"><img alt="media/image771.png" src="media/image771.png" style="width: 6.5in; height: 0.63472in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>: <strong>Le script et les variables</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Le script export_sql fait déjà ce travail d’exporter les données
vers la base de données</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.6.2 émission SMS</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Explications :</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Un fichier python : sms_dz.py
surveille en permanence la
variable x de aldz.py et
déclenche l’envoi d’un sms si
celle-ci est différente de « 0
» ; priority indique la
priorité pour l’envoi des SMS
:</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">0 envoi à tous les numéros</div>
<div class="line">1 envoi au 1er numéro</div>
<div class="line">2 envoi au 2eme numéro</div>
<div class="line">3 ………….3eme ……….</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Si ces numéros existent</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Cela est possible avec l’utilisation du module « importlib »</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>On import aussi aldz (b) et la variable lue est donc b.x</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Le fichier aldz.py est modifié par Domoticz (scripts LUA
notifications_devices et notifications_variables)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="media/image776.png"><img alt="image44" src="media/image776.png" style="width: 6.30139in; height: 2.99306in;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.6.2.1 Enregistrement des n° de téléphone</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Depuis la version 2.1.3 il est possible d’envoyé plusieurs SMS à
des numéros différents ; pour cela, il faut ajouter les numéros à
connect.lua (la maj est automatique vers connec.py)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Le nombre de numéros n’est pas limité :
tel={‘xxxxxxxxxx’,’yyyyyyyyyy’,’zzzzzzzzzz’,…)</p>
<p>Le tableau est LUA avec des {}, remplacés par des crochets dans
connect.py et connect.js</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">Importer sur Github le fichier complet :</div>
<div class="line"><a href="#id1"><span class="problematic" id="id2">*</span></a><a class="reference external" href="https://raw.git">https://raw.git</a></div>
</div>
</div></blockquote>
<p>hubusercontent.com/mgrafr/monitor/main/share/scripts_dz/py/sms_dz.py*</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pour un démarrage automatique du fichier après installation de
Domoticz, utiliser systemd de Debian ; le fichier à créer :
sms_dz.service</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><p><a href="#id3"><span class="problematic" id="id4">*</span></a><a class="reference external" href="https://raw.github">https://raw.github</a></p>
</div></blockquote>
<dl class="simple">
<dt>usercontent.com/mgrafr/monitor/main/share/debian/systemd/system/sms_d</dt><dd><p>z.service*</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Ne pas oublier d’activer le script avant de le démarrer :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>systemctl enable sms_dz systemctl start sms_dz</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>13.7- afficher les données du compteur Linky</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A partir des données reçues par Domoticz par le plugin
domoticz-linky</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><em>https://github.com/guillaumezin/DomoticzLinky</em></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>L’image svg :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;svg version=”1.1” id=”Calque_1”
xmlns=”<a class="reference external" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>”
xmlns:xlink=”http://www.w3.org/1999/xlink” x=”0px” y=”0px”</div>
<div class="line">viewBox=”0 0 162.2 321.9” style=”enable-background:new 0 0 162.2
321.9;” xml:space=”preserve”&gt; &lt;style type=”text/css”&gt;</div>
<div class="line">.linky0{fill:#BAC174;}</div>
<div class="line">.linky1{fill:#CDCDA6;}</div>
<div class="line">.linky2{fill:#D3D860;}</div>
<div class="line">.linky3{fill:#E2E2E3;}</div>
<div class="line">.linky4{fill#96CD32;}</div>
<div class="line">.linky5{fill:#3B3F00;}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">.linky6{fill:#FCFFBF;}</div>
<div class="line">.linky7{fill:#FFE42A;}</div>
<div class="line">.linky8{fill:#FFDA15;}</div>
<div class="line">.linky10{font-size:48px;}</div>
<div class="line">.linky11{fill:#FFFFFF;}</div>
<div class="line">.linky12{font-size:60px;}</div>
<div class="line">&lt;/style&gt;&lt;a xlink:href=”#interieur” onclick=”popup_device(71)”&gt;</div>
<div class="line">&lt;path class=”linky0”</div>
</div>
<p>d=”M3.5,56.5c-0.1,0.1-0.1,1.1,0.3,0.7C3.9,57.1,4,56.1,3.5,56.5z”/&gt;
| &lt;path class=”linky1”</p>
<blockquote>
<div><p>d=”M84.2,250.9c0</p>
</div></blockquote>
</div></blockquote>
<dl>
<dt>,2.5,0.2,4-1,6l-1-1c2.3,1.7,3.2,1.7,6,1c-2.3-1.8-1.7-3.2-1-6H84.2z”/&gt;</dt><dd><blockquote>
<div><p>&lt;path class=”linky2” d=”M82.2,251.9l1,1L82.2,251.9z”/&gt;</p>
</div></blockquote>
<div class="line-block">
<div class="line">&lt;path class=”linky3”
d=”M83.2,251.9c-0.5,2.2-0.5,2.8,0,5C84,254.8,84,253.9,83.2,251.9</div>
<div class="line">M86.2,251.9v5C87.7,254.7,87.7,254,86.2,251.9z</div>
<div class="line">“/&gt;</div>
<div class="line">&lt;path class=”linky2” d=”M87.2,251.9l1,1L87.2,251.9z”/&gt;</div>
<div class="line">&lt;path class=”linky3” d=”M3.2,308.9c0.7,3.6,1.8,5.3,5,7L3.2,308.9
M163.2,309.9c-2,2.8-3.9,4.4-7,6</div>
<div class="line">C160.3,317.2,164.4,314.2,163.2,309.9z”/&gt;</div>
<div class="line">&lt;path class=”linky0” d=”M5.2,310.9l1,0.5L5.2,310.9
M162.2,310.9c-0.1,0.2,1-5,1-5S162.3,310.6,162.2,310.9z”/&gt; &lt;rect
y=”0” class=”linky4” width=”162.2” height=”321.9”/&gt;</div>
<div class="line">&lt;rect x=”338” y=”0” class=”linky4” width=”0” height=”0”/&gt;</div>
<div class="line">&lt;rect x=”15” y=”103” class=”linky5” width=”130” height=”76”/&gt;</div>
<div class="line">&lt;circle class=”linky5” cx=”76.6” cy=”74.6” r=”5.6”/&gt;</div>
<div class="line">&lt;circle class=”linky6” cx=”73.8” cy=”17.8” r=”2.8”/&gt;</div>
<div class="line">&lt;circle class=”linky7” cx=”76.1” cy=”22.8” r=”5”/&gt;</div>
<div class="line">&lt;circle class=”linky8” cx=”77.4” cy=”270.5” r=”6.4”/&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 15 57)” class=”st33 linky10”&gt;P
Max&lt;/text&gt;</div>
<div class="line">&lt;text id=”txtlinky” transform=”matrix(1 0 0 1 8 156)”
class=”linky11 linky9 linky12”&gt;0&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 40 230)” class=”linky9
linky10”&gt;kW&lt;/text&gt;&lt;/a&gt;</div>
<div class="line">&lt;/svg&gt;</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>La BD :</p>
<a class="reference internal image-reference" href="media/image779.png"><img alt="media/image779.png" src="media/image779.png" style="width: 6.26806in; height: 0.4875in;" /></a>
<p><strong>Explications pour explode(concerne le PHP) :</strong></p>
<p>Data concerne 6 éléments</p>
<a class="reference internal image-reference" href="media/image780.png"><img alt="media/image780.png" src="media/image780.png" style="width: 4.55278in; height: 4.15694in;" /></a>
<div class="line-block">
<div class="line">Pour n’afficher que le 5eme élément on utilise dans une fonction PHP «
explode »</div>
<div class="line">Explode renvoie un tableau de chaînes, chacune étant une sous-chaîne
limitée par un séparateur, ici un point-virgule.</div>
</div>
<a class="reference internal image-reference" href="media/image781.png"><img alt="media/image781.png" src="media/image781.png" style="width: 6.26806in; height: 1.83611in;" /></a>
<p><em>Contrairement à LUA, en PHP les tables commencent à 0 : 4 = table[4 ]=
5eme champ</em></p>
<p><strong>13.7.1 enregistrement dans la BD SQL</strong></p>
<p>Créer la table :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">CREATE TABLE `energie` (</div>
<div class="line">`num` int(4) NOT NULL,</div>
<div class="line">`date` timestamp NOT NULL DEFAULT current_timestamp() ON
UPDATE current_timestamp(), `conso` varchar(10) NOT NULL,</div>
<div class="line">`pmax` varchar(10) NOT NULL</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div>
<div class="line">ALTER TABLE `energie` CHANGE `num` `num` INT(4) NOT NULL
AUTO_INCREMENT, add PRIMARY KEY (<cite>num</cite>);</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>La table possède 2 valeurs aussi le champ « valeur » ne peut être
utilisé , 2 champs distincts sont créés</p>
<p>Dans Domoticz :</p>
<p>Comme pour le capteur de pression, on enregistre, dans une variable une
info pour éviter d’enregistrer un grand nombre de fois la même valeur ;
on se sert du jour (day) et on modifie la fonction write_datas ()
utilisée pour le capteur de pression (fichier avec 2 valeurs au lieu
d’une)</p>
<a class="reference internal image-reference" href="media/image782.png"><img alt="media/image782.png" src="media/image782.png" style="width: 6.26806in; height: 5.06806in;" /></a>
<a class="reference internal image-reference" href="media/image783.png"><img alt="media/image783.png" src="media/image783.png" style="width: 2.48056in; height: 0.95833in;" /></a>
<p>Dans Monitor :</p>
<a class="reference internal image-reference" href="media/image784.png"><img alt="media/image784.png" src="media/image784.png" style="width: 6.26806in; height: 5.58333in;" /></a>
<a class="reference internal image-reference" href="media/image785.png"><img alt="media/image785.png" src="media/image785.png" style="width: 5.10556in; height: 5.96944in;" /></a>
<a class="reference internal image-reference" href="media/image786.png"><img alt="media/image786.png" src="media/image786.png" style="width: 5.52222in; height: 6.47917in;" /></a>
<p>Pour ajouter un historique de la consommation :</p>
<a class="reference internal image-reference" href="media/image787.png"><img alt="media/image787.png" src="media/image787.png" style="width: 6.26806in; height: 1.49861in;" /></a>
<p><strong>14 ADMINISTRATION</strong></p>
<a class="reference internal image-reference" href="media/image788.png"><img alt="media/image788.png" src="media/image788.png" style="width: 6.30139in; height: 6.9875in;" /></a>
<p><strong>14.1- fichiers communs à toutes les pages : css</strong></p>
<a class="reference internal image-reference" href="media/image789.png"><img alt="media/image789.png" src="media/image789.png" style="width: 5.86389in; height: 1.45in;" /></a>
<p><strong>Index_loc.php</strong></p>
<a class="reference internal image-reference" href="media/image790.png"><img alt="media/image790.png" src="media/image790.png" style="width: 6.26806in; height: 1.39167in;" /></a>
<p><strong>header.php</strong></p>
<a class="reference internal image-reference" href="media/image791.png"><img alt="media/image791.png" src="media/image791.png" style="width: 4.35417in; height: 2.29028in;" /></a>
<p>Affichage obligatoire dans le menu</p>
<p><strong>ajax.php :</strong></p>
<a class="reference internal image-reference" href="media/image792.png"><img alt="media/image792.png" src="media/image792.png" style="width: 6.26806in; height: 0.46805in;" /></a>
<p><strong>admin/config.php :</strong></p>
<a class="reference internal image-reference" href="media/image793.png"><img alt="media/image793.png" src="media/image793.png" style="width: 4.67778in; height: 1.39583in;" /></a>
<a class="reference internal image-reference" href="media/image131.png"><img alt="media/image131.png" src="media/image131.png" style="width: 6.26806in; height: 1.12639in;" /></a>
<p><strong>Extrait de la fonction admin de fonctions.php</strong></p>
<a class="reference internal image-reference" href="media/image794.png"><img alt="media/image794.png" src="media/image794.png" style="width: 6.07917in; height: 5.22917in;" /></a>
<p><strong>14.2- admin.php, test_db.php et backup_bd</strong></p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image795.png"><img alt="media/image795.png" src="media/image795.png" style="width: 4.68611in; height: 3.97917in;" /></a>
<a class="reference internal image-reference" href="media/image796.png"><img alt="media/image796.png" src="media/image796.png" style="width: 4.22917in; height: 0.60417in;" /></a>
<a class="reference internal image-reference" href="media/image797.png"><img alt="media/image797.png" src="media/image797.png" style="width: 4.36389in; height: 2.88611in;" /></a>
</div></blockquote>
<p><strong>admin.php</strong></p>
<a class="reference internal image-reference" href="media/image798.png"><img alt="media/image798.png" src="media/image798.png" style="width: 6.30139in; height: 5.11667in;" /></a>
<p><strong>Sauvegardes Domoticz, rappel :</strong></p>
<p>Variables :</p>
<p>Types :</p>
<div class="line-block">
<div class="line">0 = Entier, par exemple -1, 1, 0, 2, 10</div>
<div class="line">1 = Flottant, par exemple -1,1, 1,2, 3,1</div>
<div class="line">2 = chaîne</div>
<div class="line">3 = Date au format JJ / MM / AAAA</div>
<div class="line">4 = Heure au format 24 h HH: MM</div>
</div>
<p><strong>Le fichier info_admin.php</strong></p>
<a class="reference internal image-reference" href="media/image799.png"><img alt="media/image799.png" src="media/image799.png" style="width: 6.30139in; height: 4.57222in;" /></a>
<p><strong>Le fichier test_db.php</strong></p>
<a class="reference internal image-reference" href="media/image800.png"><img alt="media/image800.png" src="media/image800.png" style="width: 6.26806in; height: 2.1125in;" /></a>
<div class="line-block">
<div class="line"><strong>Le fichier backup_db.php</strong></div>
<div class="line">Pour la sauvegarde de la BD :</div>
</div>
<a class="reference internal image-reference" href="media/image801.png"><img alt="media/image801.png" src="media/image801.png" style="width: 6.30139in; height: 6.28472in;" /></a>
<p>Résultat :</p>
<a class="reference internal image-reference" href="media/image802.png"><img alt="media/image802.png" src="media/image802.png" style="width: 4.21944in; height: 3.25in;" /></a>
<p><strong>14.3- le javascript :</strong></p>
<p>Pour la fonction mdp() et le clavier(<em>Minimal Virtual Keypad</em>), voir le
<em>§5.5</em></p>
<a class="reference internal image-reference" href="media/image803.png"><img alt="media/image803.png" src="media/image803.png" style="width: 3.43889in; height: 0.89583in;" /></a>
<a class="reference internal image-reference" href="media/image804.png"><img alt="media/image804.png" src="media/image804.png" style="width: 6.26806in; height: 3.00417in;" /></a>
<p><strong>14.4- fonctions PHP :</strong></p>
<a class="reference internal image-reference" href="media/image805.png"><img alt="media/image805.png" src="media/image805.png" style="width: 6.30139in; height: 2.34167in;" /></a>
<a class="reference internal image-reference" href="media/image806.png"><img alt="media/image806.png" src="media/image806.png" style="width: 6.30139in; height: 7.39444in;" /></a>
<a class="reference internal image-reference" href="media/image807.png"><img alt="media/image807.png" src="media/image807.png" style="width: 6.30139in; height: 6.02778in;" /></a>
<a class="reference internal image-reference" href="media/image808.png"><img alt="media/image808.png" src="media/image808.png" style="width: 6.30139in; height: 0.49583in;" /></a>
<p><strong>Tableau JS :</strong></p>
<p><em>il suffit d’ajouter ces lignes au script node-red pour récupérer l’idx
de Domoticz à partir du nom</em></p>
<a class="reference internal image-reference" href="media/image809.png"><img alt="media/image809.png" src="media/image809.png" style="width: 6.26806in; height: 3.15417in;" /></a>
<p><strong>14.5 - Téléchargement d’un fichier externe dans Domoticz</strong></p>
<div class="line-block">
<div class="line">Pour la mise à jour du fichier avec les variables pour les scripts
Domoticz : plusieurs solutions étaient possibles mais avec
l’installations de modules supplémentaires ainsi que de</div>
<div class="line">scripts (sftp dérivé de ssh étant la plus facile à installer et
utiliser).</div>
</div>
<p>En http, on ne peut seulement télécharger un fichier depuis un site
distant.</p>
<div class="line-block">
<div class="line">La solution retenue :</div>
<div class="line">- Avec l’API de Domoticz il est possible de maj des variables ; à la
lecture puis mise à jour d’un fichier de Domoticz distant, on
enregistre un fichier temporaire et on met à 1 une variable pour
l’exécution d’un script qui va télécharger le fichier modifié ; la
variable est mise à 0 jusqu’à une prochaine modification du fichier.</div>
</div>
<blockquote>
<div><p>Pour la mise à jour de la liste des caméras dont la détection est
activée, c’est le même script qui est utilisé, la variable « upload »
est alors passé à 2</p>
</div></blockquote>
<p>La variable <a class="reference internal" href="media/image810.png"><img alt="image45" src="media/image810.png" style="width: 0.47917in; height: 0.45833in;" /></a></p>
<a class="reference internal image-reference" href="media/image811.png"><img alt="media/image811.png" src="media/image811.png" style="width: 6.26806in; height: 0.72083in;" /></a>
<p>Le script :<a class="reference internal" href="media/image810.png"><img alt="image46" src="media/image810.png" style="width: 0.47917in; height: 0.45833in;" /></a></p>
<a class="reference internal image-reference" href="media/image812.png"><img alt="media/image812.png" src="media/image812.png" style="width: 6.26806in; height: 5.79306in;" /></a>
<p>Les fonctions wajax() et yajax() dans mes_js.js</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">function
w</div>
</div>
</div></blockquote>
<dl>
<dt>ajax(content,rel){alert(content+”</dt><dd><blockquote>
<div><p>“+rel);</p>
</div></blockquote>
<div class="line-block">
<div class="line">$(“btclose”</div>
</div>
</dd>
<dt>).remove();$(“reponse1”).empty();</dt><dd><div class="line-block">
<div class="line">$(“#adm1”).empty();</div>
<div class="line">$.post(‘ajax.php’,
{appp:’adminp’,
variable:rel,</div>
</div>
</dd>
</dl>
<div class="line-block">
<div class="line">command:content}).done(function</div>
</div>
<p>(response){console.log(response);</p>
<blockquote>
<div><p>$(“#reponse1”).html(response);
| });}
| function yajax(id1){
| $(id1).hide();}
| function</p>
<blockquote>
<div><p>remplace(id2,content2){</p>
</div></blockquote>
<div class="line-block">
<div class="line">$(id2).text(content2);</div>
<div class="line">}</div>
</div>
</div></blockquote>
</th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image813.png"><img alt="media/image813.png" src="media/image813.png" style="width: 6.26806in; height: 2.05833in;" /></a>
<p>Le fichier temporaire dans monitor pour Domoticz :</p>
<a class="reference internal image-reference" href="media/image814.png"><img alt="media/image814.png" src="media/image814.png" style="width: 3.32361in; height: 3.35417in;" /></a>
<p><strong>14.6 - Copies d’écran :</strong></p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image815.png"><img alt="media/image815.png" src="media/image815.png" style="width: 3.94861in; height: 5.32361in;" /></a>
<a class="reference internal image-reference" href="media/image816.png"><img alt="media/image816.png" src="media/image816.png" style="width: 3.65694in; height: 3.95833in;" /></a>
<a class="reference internal image-reference" href="media/image817.png"><img alt="media/image817.png" src="media/image817.png" style="width: 3.6875in; height: 5.025in;" /></a>
</div></blockquote>
<p>L’ip de monitor dans ce fichier permet, en cas de changement de l’IP de
ne pas avoir à modifier les scripts. C’est également valable pour tous
les serveurs</p>
<p>Un double de connect.lua est enregistré au format python pour les script
écrit dans ce langage</p>
<a class="reference internal image-reference" href="media/image823.png"><img alt="media/image823.png" src="media/image823.png" style="width: 6.19861in; height: 3.63472in;" /></a>
<p>Ce double peut aussi servir à un autre serveur (un PI par exemple) ce
qui facilite les mises à jour.</p>
<p>Une commande dans administration permet une mise à jour automatique du
RPI</p>
<p>Pour cela le fichier admin/config.php doit posséder l’IP du serveur :</p>
<a class="reference internal image-reference" href="media/image824.png"><img alt="media/image824.png" src="media/image824.png" style="width: 4.89722in; height: 0.95833in;" /></a>
<a class="reference internal image-reference" href="media/image825.png"><img alt="media/image825.png" src="media/image825.png" style="width: 4.44861in; height: 1.11528in;" /></a>
<p>La page admin.php :</p>
<a class="reference internal image-reference" href="media/image826.png"><img alt="media/image826.png" src="media/image826.png" style="width: 6.30139in; height: 0.65in;" /></a>
<p>fonctions.php :</p>
<a class="reference internal image-reference" href="media/image827.png"><img alt="media/image827.png" src="media/image827.png" style="width: 6.30139in; height: 0.59722in;" /></a>
<a class="reference internal image-reference" href="media/image828.png"><img alt="media/image828.png" src="media/image828.png" style="width: 6.30139in; height: 2.56111in;" /></a>
<a class="reference internal image-reference" href="media/image829.png"><img alt="media/image829.png" src="media/image829.png" style="width: 6.30139in; height: 1.95139in;" /></a>
<a class="reference internal image-reference" href="media/image830.png"><img alt="media/image830.png" src="media/image830.png" style="width: 4.19861in; height: 1.625in;" /></a>
<p>Cette commande utilise SSH2 et SCP , voir le <em>§ 14.10</em></p>
<blockquote>
<div><p><strong>:connect.js</strong></p>
<a class="reference internal image-reference" href="media/image831.png"><img alt="media/image831.png" src="media/image831.png" style="width: 2.59444in; height: 2.49722in;" /></a>
</div></blockquote>
<p><strong>14.7 Explications concernant l’importation distantes d’un tableau
LUA</strong></p>
<p>Compléments sur l’affichage ci-dessus : fichier de variables LUA</p>
<p>Concerne :</p>
<blockquote>
<div><ul class="simple">
<li><p>le tableau de variable string_tableau.lua</p></li>
<li><p>la liste des caméras Modect pour l’alarme</p></li>
<li><p>le fichier des Logins/mots de passe</p></li>
</ul>
<p><strong>string_tableau.lua</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image832.png"><img alt="media/image832.png" src="media/image832.png" style="width: 3.89722in; height: 2.77083in;" /></a>
<p>Dans config.php de monitor :</p>
<a class="reference internal image-reference" href="media/image833.png"><img alt="media/image833.png" src="media/image833.png" style="width: 5.53333in; height: 0.85417in;" /></a>
<p>Le fichier temporaire dans monitor, le répertoire « dz » est à créer
avec les autorisations pour écrire</p>
<a class="reference internal image-reference" href="media/image834.png"><img alt="media/image834.png" src="media/image834.png" style="width: 5.29722in; height: 0.54861in;" /></a>
<a class="reference internal image-reference" href="media/image835.png"><img alt="media/image835.png" src="media/image835.png" style="width: 3.37639in; height: 2.91667in;" /></a>
<a class="reference internal image-reference" href="media/image836.png"><img alt="media/image836.png" src="media/image836.png" style="width: 3.59444in; height: 3.19583in;" /></a>
<p>Dans fonctions.php :</p>
<p>function admin($choix,$idrep) :</p>
<a class="reference internal image-reference" href="media/image837.png"><img alt="media/image837.png" src="media/image837.png" style="width: 6.30139in; height: 3.24583in;" /></a>
<a class="reference internal image-reference" href="media/image838.png"><img alt="media/image838.png" src="media/image838.png" style="width: 6.26111in; height: 2.00972in;" /></a>
<p>Maj par dz : on met à 1,2 ou 3 la variable upload et dz se charge
d’importer le fichier</p>
<a class="reference internal image-reference" href="media/image839.png"><img alt="media/image839.png" src="media/image839.png" style="width: 6.30139in; height: 1.30556in;" /></a>
<a class="reference internal image-reference" href="media/image840.png"><img alt="media/image840.png" src="media/image840.png" style="width: 4.86528in; height: 2.6875in;" /></a>
<p>Le script <em>lua utilisé</em> :</p>
<a class="reference internal image-reference" href="media/image841.png"><img alt="media/image841.png" src="media/image841.png" style="width: 5.55278in; height: 0.66667in;" /></a>
<a class="reference internal image-reference" href="media/image842.png"><img alt="media/image842.png" src="media/image842.png" style="width: 6.30139in; height: 5.08194in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">if ((domoticz.variables(‘upload’).changed) and
(domoticz.variables(‘upload’).value ~= “0”)) then</div>
<div class="line">if (domoticz.variables(‘upload’).value == “1”) then</div>
<div class="line">print(“upload string_tableaux”);</div>
<div class="line">command = rep..’upload_fichier.py string_tableaux.lua
‘..ip_mon..’ &gt; ‘..rep_log..’string_tableaux.log 2&gt;&amp;1’</div>
<div class="line">elseif (domoticz.variables(‘upload’).value == “2”) then</div>
<div class="line">print(“upload string_modect”)</div>
<div class="line">command = rep..’upload_fichier.py string_modect.lua ‘..ip_mon..’
&gt; ‘..rep_log..’string_modect.log 2&gt;&amp;1’</div>
<div class="line">elseif (domoticz.variables(‘upload’).value == “3”) then</div>
<div class="line">print(“upload connect”)</div>
<div class="line">command = rep..’upload_fichier.py connect.lua &gt;
‘..rep_log..’connect.log 2&gt;&amp;1’</div>
<div class="line">fich=””</div>
<div class="line">for line in io.lines(
“/opt/domoticz/www/modules_lua/connect.lua” ) do</div>
<div class="line">fich=fich..tostring(line)..”\n”</div>
<div class="line">end</div>
<div class="line">f = io.open(“userdata/scripts/python/connect.py”, “w”)</div>
<div class="line">env=”#!/usr/bin/env python3”</div>
<div class="line">f:write(env..” -<em>- coding: utf-8 -</em>-“..”\n”..fich)</div>
<div class="line">f:close()</div>
<div class="line">end</div>
<div class="line">–print(command);</div>
<div class="line">os.execute(command);print(‘maj effectuée’);</div>
<div class="line">domoticz.variables(‘upload’).set(‘0’)</div>
<div class="line">end</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Le script python : upload_fichier.py</p>
<p>C’est pour la raison ci-dessous que l’adresse ip de monitor se trouve
dans le fichier « connect.lua »</p>
<a class="reference internal image-reference" href="media/image843.png"><img alt="media/image843.png" src="media/image843.png" style="width: 5.83333in; height: 1.58333in;" /></a>
<p>La fonction actuelle :</p>
<a class="reference internal image-reference" href="media/image844.png"><img alt="media/image844.png" src="media/image844.png" style="width: 4.81389in; height: 2.13611in;" /></a>
<p><strong>REMARQUE</strong> : pour que python trouve le fichier connect <strong>et donc la
variable ip_monitor,</strong> il faut ajouter le répertoire vide
<strong>__INIT__.py</strong></p>
<a class="reference internal image-reference" href="media/image845.png"><img alt="media/image845.png" src="media/image845.png" style="width: 5.39722in; height: 0.89583in;" /></a>
<p><strong>string_modect.lua</strong></p>
<a class="reference internal image-reference" href="media/image846.png"><img alt="media/image846.png" src="media/image846.png" style="width: 4.66667in; height: 6.0875in;" /></a>
<div class="line-block">
<div class="line">Pour cette fonction le script LUA est similaire à celui pour les
poubelles, la fosse septique, les anniversaires, …</div>
<div class="line">La variable est mise à 2, voir le script lua :</div>
</div>
<a class="reference internal image-reference" href="media/image847.png"><img alt="media/image847.png" src="media/image847.png" style="width: 4.17778in; height: 2.23889in;" /></a>
<p><strong>admin.php :</strong></p>
<a class="reference internal image-reference" href="media/image848.png"><img alt="media/image848.png" src="media/image848.png" style="width: 6.26806in; height: 1.42222in;" /></a>
<p>Affichage :</p>
<a class="reference internal image-reference" href="media/image849.png"><img alt="media/image849.png" src="media/image849.png" style="width: 3.83333in; height: 5.10833in;" /></a>
<p><strong>fonctions.php</strong></p>
<a class="reference internal image-reference" href="media/image850.png"><img alt="media/image850.png" src="media/image850.png" style="width: 6.26806in; height: 2.675in;" /></a>
<a class="reference internal image-reference" href="media/image851.png"><img alt="media/image851.png" src="media/image851.png" style="width: 6.26806in; height: 2.975in;" /></a>
<p>MODECT Affichage dans admin.php mais aussi dans alarmes.php</p>
<a class="reference internal image-reference" href="media/image852.png"><img alt="media/image852.png" src="media/image852.png" style="width: 5.54306in; height: 3.125in;" /></a>
<a class="reference internal image-reference" href="media/image853.png"><img alt="media/image853.png" src="media/image853.png" style="width: 5.17778in; height: 4.53194in;" /></a>
<p><strong>alarm.php</strong></p>
<a class="reference internal image-reference" href="media/image854.png"><img alt="media/image854.png" src="media/image854.png" style="width: 6.26806in; height: 1.60694in;" /></a>
<p><strong>fonctions.php</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">function sql_app($choix,$table,$valeur,$date,$icone=’’){</div>
<div class="line">// SERVEUR SQL connexion</div>
<div class="line">$conn = new mysqli(SERVEUR,UTILISATEUR,MOTDEPASSE,DBASE);</div>
<div class="line">if ($choix==0) {</div>
<div class="line">$sql=”INSERT INTO “.$table.” (<cite>num</cite>, `date`, `valeur`,
`icone`)</div>
<div class="line">VALUES (NULL, ‘”.$date.”’, ‘”.$valeur.”’, ‘”.$icone.”’);”;</div>
<div class="line">$result = $conn-&gt;query($sql);</div>
<div class="line">;}</div>
<div class="line">if ($choix==1) {</div>
<div class="line">$sql=”SELECT * FROM “.$table.” ORDER BY num DESC LIMIT 24”;</div>
<div class="line">$result = $conn-&gt;query($sql);</div>
<div class="line">$number = $result-&gt;num_rows;</div>
<div class="line">while($row = $result-&gt;fetch_array(MYSQLI_ASSOC)){</div>
<div class="line">echo $row[‘date’].’ ‘.$row[‘valeur’].’ &lt;img
style=”width:30px;vertical-align:middle”
src=”’.$row[‘icone’].’”/&gt;&lt;br&gt;’;</div>
<div class="line">}</div>
<div class="line">}</div>
<div class="line">if ($choix==2 || $choix==3) {// modect pour dz —–
2,”cameras”,”modect”,1,$icone=’’</div>
<div class="line">$sql=”SELECT * FROM `cameras` WHERE `modect` = 1 “;</div>
<div class="line">$result = $conn-&gt;query($sql);$i=0;</div>
<div class="line">$number = $result-&gt;num_rows;if ($number&gt;0) {</div>
<div class="line">$content=”cam_modect = {“;</div>
<div class="line">while($row = $result-&gt;fetch_array(MYSQLI_ASSOC)){</div>
<div class="line">//$content = $cont.$row[‘id_zm’];</div>
<div class="line">if ($choix==2){ $content =
$content.’[‘.$row[“id_zm”].’]=”’.$row[‘url’].’”’;}</div>
<div class="line">if ($choix==3){ $content = $content.$row[“id_zm”];}</div>
<div class="line">$i++;if ($number&gt;$i) {$content=$content.”,”;}</div>
<div class="line">}</div>
<div class="line">$content = $content.”}”;if ($choix==3) token_zm();</div>
<div class="line">}</div>
<div class="line">else echo “pas de cameras modect”;</div>
<div class="line">}</div>
<div class="line">$conn-&gt;close();</div>
</div>
<p>return $content;}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>footer.php</strong></p>
<a class="reference internal image-reference" href="media/image855.png"><img alt="media/image855.png" src="media/image855.png" style="width: 6.26806in; height: 1.64028in;" /></a>
<p><strong>14.8 Explications concernant la mise à jour automatique SQL des
variables et dispositifs</strong></p>
<p>admin.php</p>
<a class="reference internal image-reference" href="media/image856.png"><img alt="media/image856.png" src="media/image856.png" style="width: 6.30139in; height: 0.39583in;" /></a>
<p>footer.php</p>
<a class="reference internal image-reference" href="media/image857.png"><img alt="media/image857.png" src="media/image857.png" style="width: 6.30139in; height: 2.48889in;" /></a>
<p>fonction.php : admin()</p>
<a class="reference internal image-reference" href="media/image858.png"><img alt="media/image858.png" src="media/image858.png" style="width: 6.30139in; height: 4.62361in;" /></a>
<p>Affichage monitor :</p>
<a class="reference internal image-reference" href="media/image859.png"><img alt="media/image859.png" src="media/image859.png" style="width: 4.30278in; height: 5.94861in;" /></a>
<p>footer.php</p>
<a class="reference internal image-reference" href="media/image860.png"><img alt="media/image860.png" src="media/image860.png" style="width: 6.14583in; height: 7.69861in;" /></a>
<a class="reference internal image-reference" href="media/image861.png"><img alt="media/image861.png" src="media/image861.png" style="width: 6.30139in; height: 2.78472in;" /></a>
<p>ajax.php puis fonctions.php : mysql_app()</p>
<a class="reference internal image-reference" href="media/image862.png"><img alt="media/image862.png" src="media/image862.png" style="width: 6.19583in; height: 4.58333in;" /></a>
<p>Monitor :</p>
<a class="reference internal image-reference" href="media/image863.png"><img alt="media/image863.png" src="media/image863.png" style="width: 5.00139in; height: 3.77083in;" /></a>
<p><strong>14.9 Explications concernant l’affichage des infos de la page
admin.php</strong></p>
<a class="reference internal image-reference" href="media/image864.png"><img alt="media/image864.png" src="media/image864.png" style="width: 4.03194in; height: 3.39583in;" /></a>
<p>admin.php</p>
<p>on ajoute pour les lignes concernées :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;a&gt;&lt;img class=”info_admin” src=”images/icon-info.svg”
data-toggle=”modal” data-target=”#info-admin1” rel=6</div>
<div class="line">style=”width:25px;display:inline;”&gt;&lt;/a&gt;&lt;br&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>rel correspond au n° de l’élément dans la table du
fichier:info_admin.php</p>
<a class="reference internal image-reference" href="media/image865.png"><img alt="media/image865.png" src="media/image865.png" style="width: 6.30139in; height: 5.25139in;" /></a>
<p><strong>14.10 Commandes ssh2 PC distant ( ici un RPI ) depuis monitor</strong></p>
<p>SSH, ou Secure Shell, est un protocole utilisé pour se connecter en
toute sécurité à des systèmes distants.</p>
<p>Mon RAID1 étant alimenté en 230 Volts, le PI étant alimenté sur
batterie, lors d’une coupure secteur, lors de la remise sous tension, le
raid1 n’est pas reconnu ; Absent de la maison il faut donc faire un
reboot du PI ou un « mount -a « en bash d’où la commande ci-dessous.</p>
<p>Autre application, mise à jour de la configuration pour l’envoi de
notifications par mails lors d’un changement de mot de passe par
exemple.</p>
<p>Pour cela on utilise le paquet php8.2-ssh2</p>
<p>sudo apt install php8.2-ssh2</p>
<a class="reference internal image-reference" href="media/image866.png"><img alt="media/image866.png" src="media/image866.png" style="width: 6.30139in; height: 0.85833in;" /></a>
<p><strong>14.10.1 reboot PC (ou RPI)</strong></p>
<p>Sur le pi, soit une commande sudo reboot, soit un script qui effectue la
commande ; j’ai choisi cette dernière solution car il suffit de modifier
ce fichier pour faire d’autres commandes.:</p>
<a class="reference internal image-reference" href="media/image867.png"><img alt="media/image867.png" src="media/image867.png" style="width: 2.36528in; height: 0.69861in;" /></a>
<p>La fonction PHP (ssh_scp.php) :</p>
<a class="reference internal image-reference" href="media/image868.png"><img alt="media/image868.png" src="media/image868.png" style="width: 6.30139in; height: 3.99306in;" /></a>
<p>Comme pour toutes les autres commandes « Administration » les scripts JS
et ajax existent déjà, il suffit d’ajouter l’appel de la fonction
ci-dessus dans admin.php :</p>
<a class="reference internal image-reference" href="media/image869.png"><img alt="media/image869.png" src="media/image869.png" style="width: 6.30139in; height: 1.00139in;" /></a>
<p>La fonction PHP admin() appelle la fonction ssh_scp.php</p>
<a class="reference internal image-reference" href="media/image870.png"><img alt="media/image870.png" src="media/image870.png" style="width: 6.30139in; height: 1.73333in;" /></a>
<p><strong>14.10.2 commandes scp pour l’envoi ou la réception de fichiers
distants</strong></p>
<p>SCP veut dire Secure Copy et il est utilisé pour copier en toute
sécurité des fichiers d’un ordinateur local vers des serveurs distants
ou inversement, à l’aide du protocole SSH, SSH2 avec PHP</p>
<p>Comme pour le reboot ci-dessus, le processus est le même mais plusieurs
étapes sont nécessaires :</p>
<blockquote>
<div><div class="line-block">
<div class="line">- télécharger le fichier distant /etc/mcmtprc, par exemple , celui
de la commande affichée dans « Administration »</div>
<div class="line">- le modifier</div>
<div class="line">- le renvoyer au pc distant</div>
</div>
<p>fonctions.php , admin()</p>
<a class="reference internal image-reference" href="media/image871.png"><img alt="media/image871.png" src="media/image871.png" style="width: 5.95694in; height: 2.1875in;" /></a>
<a class="reference internal image-reference" href="media/image872.png"><img alt="media/image872.png" src="media/image872.png" style="width: 6.3in; height: 3.84444in;" /></a>
</div></blockquote>
<p><strong>Exemple de fichier /etc/msmtprc</strong></p>
<a class="reference internal image-reference" href="media/image873.png"><img alt="media/image873.png" src="media/image873.png" style="width: 4.68889in; height: 7.02083in;" /></a>
<p><strong>SSH2 et SCP concerne aussi la commande de maj du fichier python
connect.py si il est utilisé par</strong></p>
<p><strong>plusieurs serveurs.</strong></p>
<p><strong>La commande ci-dessous met à jour connect.py dans Domoticz, Monitor,
et un autre serveur (le PI)</strong></p>
<p><strong>REMARQUE</strong> : pour que python trouve le fichier connect <strong>et donc les
variables,</strong>il faut ajouter</p>
<p>le répertoire vide <strong>__INIT__.py</strong></p>
<a class="reference internal image-reference" href="media/image874.png"><img alt="media/image874.png" src="media/image874.png" style="width: 3.71944in; height: 1.0625in;" /></a>
<p><strong>Ce fichier permet de ne pas avoir à modifier les scripts python lors
d’un changement de serveur</strong></p>
<p><strong>Exemple ( fichier rec_sms_serie.py)</strong></p>
<a class="reference internal image-reference" href="media/image875.png"><img alt="media/image875.png" src="media/image875.png" style="width: 6.00139in; height: 2.48889in;" /></a>
<a class="reference internal image-reference" href="media/image876.png"><img alt="media/image876.png" src="media/image876.png" style="width: 5.59444in; height: 4.84444in;" /></a>
<p>connect.py</p>
<a class="reference internal image-reference" href="media/image877.png"><img alt="media/image877.png" src="media/image877.png" style="width: 4.42778in; height: 1.59444in;" /></a>
<p><strong>15. - EXEMPLES</strong></p>
<div class="line-block">
<div class="line"><strong>15.1- ajout d’un dispositif</strong></div>
<div class="line"><strong>Ajout d’un contact de porte supplémentaire</strong></div>
</div>
<a class="reference internal image-reference" href="media/image878.png"><img alt="media/image878.png" src="media/image878.png" style="width: 3.98055in; height: 1.35417in;" /></a>
<p>Dans Domoticz le dispositif est ajouté au plan :</p>
<a class="reference internal image-reference" href="media/image879.png"><img alt="media/image879.png" src="media/image879.png" style="width: 3.62639in; height: 2.125in;" /></a>
<a class="reference internal image-reference" href="media/image880.png"><img alt="media/image880.png" src="media/image880.png" style="width: 5.50139in; height: 6.16667in;" /></a>
<div class="line-block">
<div class="line"><strong>15.1.1- Modifier l’image :</strong></div>
<div class="line">- On effectue (avec Notepad par exemple) une sauvegarde de l’image :</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image881.png"><img alt="media/image881.png" src="media/image881.png" style="width: 6.26111in; height: 3.74028in;" /></a>
<ul class="simple">
<li><p>Avec Inkscape, ouvrir l’image</p></li>
</ul>
<a class="reference internal image-reference" href="media/image882.png"><img alt="media/image882.png" src="media/image882.png" style="width: 3.70972in; height: 1.61528in;" /></a>
<p>Faire un copier/coller d’un dispositif existant ou importer une icone</p>
<a class="reference internal image-reference" href="media/image883.png"><img alt="media/image883.png" src="media/image883.png" style="width: 3.18889in; height: 1.84306in;" /></a>
</div></blockquote>
<p>Placer l’icône et renseigner l’ID</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image884.png"><img alt="media/image884.png" src="media/image884.png" style="width: 1.40694in; height: 1.67639in;" /></a>
<a class="reference internal image-reference" href="media/image885.png"><img alt="media/image885.png" src="media/image885.png" style="width: 5.23056in; height: 5.75in;" /></a>
<p>Pour la couleur :</p>
<a class="reference internal image-reference" href="media/image886.png"><img alt="media/image886.png" src="media/image886.png" style="width: 5.71944in; height: 4.26111in;" /></a>
<p>Sauvegarder l’image dans le fichier PHP d’origine, en supprimant la
ligne XML</p>
<a class="reference internal image-reference" href="media/image887.png"><img alt="media/image887.png" src="media/image887.png" style="width: 6.26806in; height: 3.85in;" /></a>
<p><strong>15.1.2 Dans la Base de données SQL :</strong></p>
<p>Insérer le dispositif dans la table « dispositifs_dz »</p>
<a class="reference internal image-reference" href="media/image888.png"><img alt="media/image888.png" src="media/image888.png" style="width: 6.26806in; height: 0.60417in;" /></a>
<div class="line-block">
<div class="line"><strong>15.1.3 Dans le fichier PHP de l’image</strong></div>
<div class="line">On ajoute un onclick pour l’affichage des propriétés ; avec
Inkscape, il est possible de l’ajouter lors de la création de
l’image si l’on a déjà choisi l’ID monitor.</div>
</div>
<p>Ce n’est pas important, il faut ouvrir de toute façon cette image
pour ajouter un cercle clignotant pour la gestion de la pile.</p>
<a class="reference internal image-reference" href="media/image889.png"><img alt="media/image889.png" src="media/image889.png" style="width: 4.11528in; height: 1.77083in;" /></a>
<a class="reference internal image-reference" href="media/image890.png"><img alt="media/image890.png" src="media/image890.png" style="width: 3.03056in; height: 3.39583in;" /></a>
<p>On peut vérifier que l’iD pour la couleur est bien présent</p>
</div></blockquote>
<p><strong>15.2- Réinitialisation des dispositifs dans Domoticz</strong></p>
<p><strong>Exemple</strong> : transfert de Domoticz linux vers Domoticz Docker avec
Zwave et Zigbee sous docker également, avec la reconnaissance
automatique MQTT</p>
<a class="reference internal image-reference" href="media/image895.png"><img alt="media/image895.png" src="media/image895.png" style="width: 6.26806in; height: 2.37639in;" /></a>
<p>Dans ce cas tous les dispositifs changent d’idx dans Domoticz, il faut
mettre à jour la table de</p>
<p>la base de données : « dispositifs ».</p>
<p>Pour préparer le travail, faire une copie de la table « dispositifs en
l’exportant</p>
<a class="reference internal image-reference" href="media/image896.png"><img alt="media/image896.png" src="media/image896.png" style="width: 6.08472in; height: 2.05278in;" /></a>
<p>Modifier le fichier exporté :</p>
<a class="reference internal image-reference" href="media/image897.png"><img alt="media/image897.png" src="media/image897.png" style="width: 4.08472in; height: 4.32361in;" /></a>
<p>Importer la nouvelle table</p>
<a class="reference internal image-reference" href="media/image898.png"><img alt="media/image898.png" src="media/image898.png" style="width: 6.26806in; height: 2.54306in;" /></a>
<p>Faire correspondre les nouveaux « idx » de Domoticz avec les « idm « de
monitor.</p>
<p>Dans le fichier de configuration, modifier le nom de la table et la
nouvelle IP de Domoticz :</p>
<a class="reference internal image-reference" href="media/image899.png"><img alt="media/image899.png" src="media/image899.png" style="width: 5.54306in; height: 1.5625in;" /></a>
<a class="reference internal image-reference" href="media/image900.png"><img alt="media/image900.png" src="media/image900.png" style="width: 5.95972in; height: 1.10417in;" /></a>
<p><strong>16. – Ajouter des pages ou des alertes non incluses dans le
programme</strong></p>
<blockquote>
<div><p><strong>16.1 – Ajouter un plan (ex : 1er étage)</strong></p>
<ul class="simple">
<li><p>créer la page avec le plan, voir le <em>§ 2</em></p></li>
<li><p>Ajouter la page à index_loc.php</p></li>
</ul>
<a class="reference internal image-reference" href="media/image901.png"><img alt="media/image901.png" src="media/image901.png" style="width: 5.56389in; height: 1.72917in;" /></a>
<p>Ajouter la page au menu dans header.php :</p>
<a class="reference internal image-reference" href="media/image902.png"><img alt="media/image902.png" src="media/image902.png" style="width: 6.26111in; height: 2.46944in;" /></a>
<p><strong>16.2 – Ajouter une page vierge,</strong> affichage d’un sous domaine
distant <strong>:</strong></p>
<p>Comme précédemment, ajouter la page à index_loc.php et jouter la page
au menu</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;?php</div>
<div class="line">session_start();</div>
<div class="line">$domaine=$_SESSION[“domaine”];</div>
<div class="line">if ($domaine==URLMONITOR) $lien_ID_MENU=NOM SOUS DOMAINE dans
config.php; if ($domaine==IPMONITOR) $lien_ID MENU=NOM IP dans
config.php;;</div>
<div class="line">?&gt;</div>
<div class="line">&lt;!– section TITRE start –&gt;</div>
<div class="line">&lt;!– ================ –&gt;</div>
<div class="line">&lt;div id=”ID du MENU” &gt;</div>
<div class="line">&lt;div class=”container”&gt;</div>
<div class="line">&lt;div class=”col-md-12”&gt;</div>
<div class="line">&lt;h1 id=”about” class=”title”
style=”position:relative;top:-30px;”&gt;TITRE1 : &lt;span
style=”color:blue”&gt;TITRE2&lt;/span&gt;&lt;/h1&gt;</div>
<div class="line">&lt;iframe id=”ID de l’IFRAME” src=”&lt;?php echo $lien_IDMENU;?&gt;”
frameborder=”0” &gt;&lt;/iframe&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
<div class="line">&lt;!– section TITRE fin–&gt;</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>16.3.1 Exemple avec un rappel pour la prise de médicaments sur la page
d’accueil</strong> - Télécharger une icones ou image svg</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image904.png"><img alt="media/image904.png" src="media/image904.png" style="width: 4.33333in; height: 2.75in;" /></a>
<div class="line-block">
<div class="line">- Copies d’écran des pages concernées :</div>
<div class="line"><strong>Dans Domoticz :</strong></div>
<div class="line"><em>Créer la variable</em></div>
</div>
<a class="reference internal image-reference" href="media/image905.png"><img alt="media/image905.png" src="media/image905.png" style="width: 5.99028in; height: 0.69861in;" /></a>
<p><em>Dans le script maj_services :</em></p>
<a class="reference internal image-reference" href="media/image906.png"><img alt="media/image906.png" src="media/image906.png" style="width: 4.70833in; height: 0.74028in;" /></a>
<p><em>Dans le script notifications_variables (pour une alerte sms)</em></p>
<a class="reference internal image-reference" href="media/image907.png"><img alt="media/image907.png" src="media/image907.png" style="width: 5.31389in; height: 1.6875in;" /></a>
<p><strong>Dans la base de données SQL :</strong></p>
<p><em>La table dispositifs et variables</em></p>
<a class="reference internal image-reference" href="media/image908.png"><img alt="media/image908.png" src="media/image908.png" style="width: 5.23056in; height: 2.02083in;" /></a>
<p><em>La table text_image :</em></p>
<a class="reference internal image-reference" href="media/image909.png"><img alt="media/image909.png" src="media/image909.png" style="width: 4.5in; height: 0.50972in;" /></a>
<p><strong>Dans monitor :</strong></p>
<p><em>Accueil.php</em></p>
</div></blockquote>
<p><strong>17. – DIY</strong></p>
<blockquote>
<div><p><strong>17. 1 – Domotiser un SPA (ou une piscine)</strong></p>
</div></blockquote>
<div class="line-block">
<div class="line">Ce paragraphe contient différentes parties qui peuvent être
indépendantes ou liées suivant le choix de chacun :</div>
<div class="line">- La réalisation d’un boitier électronique de mesures de PH, Redox,</div>
<div class="line">Températures, Débit de la filtration, les mesures étant envoyées sur
un serveur MQTT.</div>
</div>
<p>Cette réalisation est décrite sur le <strong>site domo-site.fr</strong></p>
<ul class="simple">
<li><p>Création de capteurs virtuels dans Domoticz qui récupère les valeurs</p></li>
</ul>
<p>envoyées par le serveur MQTT et les envoie vers la base de données de
Monitor ; il envoie également des alertes sur la TV comme pour les
poubelles et la fosse septique.</p>
<ul class="simple">
<li><p>Création d’une page dans Monitor pour afficher les données sur une</p></li>
</ul>
<p>page dédiée, afficher des alertes et commander s’il y a lieu le
chauffage, les pompes ,….</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image914.png"><img alt="media/image914.png" src="media/image914.png" style="width: 3.95417in; height: 3.30139in;" /></a>
<p><strong>17.1.1. – Création de capteurs virtuels dans Domoticz</strong> Pour
mémoire, :</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image915.png"><img alt="media/image915.png" src="media/image915.png" style="width: 5.90278in; height: 3.61667in;" /></a>
<p>C’est Domoticz qui fournit l’IDX, il faut donc modifier cet IDX dans
EasyEsp ; Pour le PH, le redox, le débit, les capteurs sont « Custom.</p>
<a class="reference internal image-reference" href="media/image916.png"><img alt="media/image916.png" src="media/image916.png" style="width: 4.92639in; height: 2.74305in;" /></a>
<p>Dans EasyEsp</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">CREATE TABLE `ph_spa` (</div>
<div class="line">`num` int(5) NOT NULL,</div>
<div class="line">`date` timestamp NOT NULL DEFAULT current_timestamp() ON
UPDATE</div>
<div class="line">current_timestamp(),</div>
<div class="line">`valeur` varchar(5) NOT NULL</div>
<div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div>
<div class="line">ALTER TABLE `debit_spa` CHANGE `num` `num` INT(5) NOT NULL
AUTO_INCREMENT, add PRIMARY KEY (<cite>num</cite>);</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Le paragraphe 6.2 traite de ce sujet (envoie de températures issues de
capteurs réels ou virtuels).</p>
<p>Il suffit donc d’ajouter les données PH, Redox, etc…dans le script
export_sql dans Evènements de Domoticz :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image921.png"><img alt="media/image921.png" src="media/image921.png" style="width: 6.26806in; height: 3.23611in;" /></a>
<p><em>Pour rappel fabric appelle le script python sqlite_mysql.py de
monitor</em> Les valeurs si dessous ne sont pas réelles, la sonde PH
n’est pas branchée.</p>
<a class="reference internal image-reference" href="media/image922.png"><img alt="media/image922.png" src="media/image922.png" style="width: 6.26806in; height: 3.71667in;" /></a>
<div class="line-block">
<div class="line"><strong>17.1.4. – Affichage dans Monitor</strong></div>
<div class="line">Pour que Monitor reçoive les données, il faut enregistrer les
capteurs dans la BD et les ajouter dans un plan dans Domoticz plan,
voir les paragraphes <em>Prérequis</em> et <em>2.3</em> <strong>17.1.4.1 la page
spa.php</strong></div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">&lt;!– section SPA start –&gt;</div>
<div class="line">&lt;!– ================ –&gt;</div>
<div class="line">&lt;div id=”spa” class=”spa”&gt;</div>
<div class="line">&lt;div class=”container”&gt;</div>
<div class="line">&lt;div class=”col-md-12”&gt;&lt;p&gt;</div>
<div class="line">&lt;h1 class=”title_ext text-center”&gt;SPA&lt;span
style=”margin-left:20px;font-size: 20px;”&gt; contrôle
qualité&lt;/span&gt;&lt;/h1&gt;&lt;br&gt;</div>
<div class="line">&lt;/p&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;?php include (“ph-redox_svg.php”);?&gt; &lt;/div&gt;</div>
<div class="line">&lt;/div&gt;</div>
</div>
<p>&lt;/div&gt;</p>
<div class="line-block">
<div class="line">&lt;script&gt;</div>
<div class="line">num_ecran=0;nb_ecran=&lt;?php echo NB_ECRAN_SPA;?&gt;; function
next_ecran(num_ec){</div>
<div class="line">num_actuel=num_ecran;num_ecran=num_ecran+num_ec; if
(num_ecran&gt;=nb_ecran || num_ecran&lt;0) {num_ecran=0;}
div_suiv=”ecran”+num_ecran;div_prec=”ecran”+num_actuel;</div>
</div>
<div class="line-block">
<div class="line">document.getElementById</div>
</div>
</div></blockquote>
<dl>
<dt>(div_prec).style.display=”none”;document.getElementById(div_suiv).sty</dt><dd><blockquote>
<div><blockquote>
<div><p>le.display=”block”;</p>
</div></blockquote>
<div class="line-block">
<div class="line">var ecranspa=&lt;?php echo ‘[“’ . implode(‘”, “’, ECRANSPA) . ‘”]’
?&gt;;</div>
<div class="line">nbec=0;</div>
<div class="line">while (nbec&lt;=nb_ecran-2){//console.log(nbec+” ..
“+ecranspa[nbec]);</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">graph(ecranspa[nbec]+’_spa’,’text_svg’,’<a href="#id13"><span class="problematic" id="id14">graphic_</span></a>’+ecranspa[nbec]);
| nbec++;
| }
| }
| &lt;/script&gt;</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image923.png"><img alt="media/image923.png" src="media/image923.png" style="width: 6.20833in; height: 4.69861in;" /></a>
<p>Explication de cette ligne :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>var ecranspa=&lt;?php echo ‘[“’ . implode(‘”, “’, ECRANSPA) . ‘”]’
?&gt;;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><em>C’est la façon de passer un array PHP à une fonction JavaScript, une
autre façon de faire : var ecranspa = &lt;?php echo ‘[“’ . implode(‘”,
“’, ECRANSPA) . ‘”]’ ?&gt;;</em></p>
<div class="line-block">
<div class="line">La fonction graph de la page graphique est utilisée</div>
<div class="line">Dans config.php : permet d’ajouter facilement une autre page ;</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">&lt;svg version=”1.1” id=”mesures_spa”
xmlns=”<a class="reference external" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>”</div>
<div class="line">xmlns:xlink=”http://www.w3.org/1999/xlink” x=”0px” y=”0px”</div>
<div class="line">viewBox=”0 0 337 252” style=”enable-background:new 0 0 337 252;”
xml:space=”preserve”&gt; &lt;style type=”text/css”&gt;</div>
<div class="line">.spa0{fill:#0000BF;}</div>
<div class="line">.spa1{fill:#00FFFF;}</div>
<div class="line">.spa2{font-family:’ArialMT’;}</div>
<div class="line">.spa3{font-size:12px;}</div>
<div class="line">.spa4{letter-spacing:33;}</div>
<div class="line">.spa5{fill:#FFFF00;stroke:#000000;stroke-miterlimit:10;}</div>
<div class="line">.spa6{fill:#00FF00;}</div>
<div class="line">.spa7{fill:#3FA9F5;}</div>
<div class="line">.spa8{fill:#94FFFD;stroke:#000000;stroke-miterlimit:10;}</div>
<div class="line">.spa9{fill:#FEC9FF;}</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">.spa10{fill:#355CFF;}</div>
<div class="line">.spa11{fill:#FFFFFF;}</div>
<div class="line">.spa12{font-size:9px;}</div>
<div class="line">.spa13{font-size:15px;}</div>
<div class="line">.spa14{fill:#FFFB00;}</div>
</div>
<div class="line-block">
<div class="line">&lt;/style&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;path class=”spa0”
d=”M10,247c-2.8,0-5-2.2-</div>
</div>
</div></blockquote>
<dl>
<dt>5-5V10c0-2.8,2.2-5,5-5h317c2.8,0,5,2.2,5,5v232c0,2.8-2.2,5-5,5H10z”/&gt;</dt><dd><div class="line-block">
<div class="line">&lt;path class=”spa0” d=”M327,10v232H10V10H327</div>
<div class="line">M327,0</div>
</div>
</dd>
<dt>H10C4.5,0,0,4.5,0,10v232c0,5.5,4.5,10,10,10h317c5.5,0,10-4.5,10-10V10</dt><dd><div class="line-block">
<div class="line">C337,4.5,332.5,0,327,0L327,0z”/&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g id=”ecran0”&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;rect x=”43” y=”36.5” class=”spa1” width=”256.7”
height=”145.9”/&gt;</div>
<div class="line">&lt;path d=”M299,37.1V182H43.6V37.1H299
M300.3,36h-258v147h258V36L300.3,36z”/&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 57 63)” class=”spa2
spa3”&gt;PH&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 167 63)” class=”spa2 spa3”&gt;
ORP&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 132.2758 83.6919)” class=”spa2
spa3”&gt;Températures : &lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 83.5654 130.1042)” class=”spa2
spa3 spa4”&gt; &lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 172 104)” class=”spa2 spa3”&gt;
Air&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 63.7774 150.1797)” class=”spa2
spa3”&gt;Débit Filtration :&lt;/text&gt;</div>
<div class="line">&lt;rect x=”80” y=”47” class=”spa5” width=”72.2” height=”21”/&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;rect x=”198.7” y=”47.5” class=”spa6” width=”66.7” height=”20”/&gt;</div>
<div class="line">&lt;path d=”M264.7,48v19h-65.4V48H264.7
M266,47h-68v21h68V47L266,47z”/&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;rect x=”80.8” y=”94” class=”spa7” width=”71” height=”20”/&gt;</div>
<div class="line">&lt;path d=”M151.1,94.5v19H81.3v-19H151.1
M152.3,93.5H80.1v21h72.2L152.3,93.5L152.3,93.5z”/&gt; &lt;/g&gt;</div>
<div class="line">&lt;rect x=”198.2” y=”91.5” class=”spa8” width=”67.8” height=”21”/&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;rect x=”155.6” y=”136.6” class=”spa9” width=”61” height=”20”/&gt;</div>
<div class="line">&lt;path d=”M216.1,137.1v19h-60v-19H216.1
M217.1,136.1h-62v21h62V136.1L217.1,136.1z”/&gt; &lt;/g&gt;</div>
<div class="line">&lt;text id=”acide” transform=”matrix(1 0 0 1 84 62)” class=”spa2
spa13”&gt;ph&lt;/text&gt;</div>
<div class="line">&lt;text id=”redox” transform=”matrix(1 0 0 1 203 62)” class=”spa2
spa13”&gt;orp&lt;/text&gt;</div>
<div class="line">&lt;text id=”temp_eau” transform=”matrix(1 0 0 1 90 107)”
class=”spa2 spa13”&gt;temp1spa&lt;/text&gt;</div>
<div class="line">&lt;text id=”temp_air” transform=”matrix(1 0 0 1 205 107)”
class=”spa2 spa13”&gt;temp2spa&lt;/text&gt;</div>
<div class="line">&lt;text id=”debit” transform=”matrix(1 0 0 1 160 150.1799)”
class=”spa2 spa13”&gt;m3/h&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1.0326 0 0 1 54 107)” class=”spa2
spa3”&gt;Eau &lt;/text&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g id=”ecran1” style=”display:none”&gt;</div>
<div class="line">&lt;rect x=”43” y=”36.5” class=”spa14” width=”256.7”
height=”145.9”/&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;text transform=”matrix(1 0 0 1 70 55)” class=”spa2
spa3”&gt;Dernières Mesures de PH :&lt;/text&gt; &lt;g id=”graphic_ph”
transform=”matrix(1 0 0 1 70 65)” class=”spa2 spa3”&gt;&lt;/g&gt; &lt;/g&gt;</div>
<div class="line">&lt;g id=”ecran2” style=”display:none”&gt;</div>
<div class="line">&lt;rect x=”43” y=”36.5” class=”spa6” width=”256.7”
height=”145.9”/&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;text transform=”matrix(1 0 0 1 70 55)” class=”spa2
spa3”&gt;Dernières Mesures de Redox :&lt;/text&gt; &lt;g id=”graphic_orp”
transform=”matrix(1 0 0 1 70 65)” class=”spa2 spa3”&gt;&lt;/g&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g id=”ecran3” style=”display:none”&gt;</div>
<div class="line">&lt;rect x=”43” y=”36.5” class=”spa9” width=”256.7”
height=”145.9”/&gt;</div>
</div>
<div class="line-block">
<div class="line">&lt;text transform=”matrix(1 0 0 1 70 55)” class=”spa2
spa3”&gt;Dernières Mesures de Débit :&lt;/text&gt; &lt;g id=”graphic_debit”
transform=”matrix(1 0 0 1 70 65)” class=”spa2 spa3”&gt;&lt;/g&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g&gt;</div>
</div>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">&lt;ellipse class=”spa10” cx=”169” cy=”207” rx=”49.5” ry=”23.5”/&gt;</div>
<div class="line">&lt;path
d=”M169,184c13.2,0,25.6,2.5,34.9,6.9C2</div>
</div>
</div></blockquote>
<dl>
<dt>13,195.3,218,201,218,207s-5,11.7-14.1,16.1c-9.3,4.5-21.7,6.9-34.9,6.9</dt><dd><div class="line-block">
<div class="line">s-25.6-2.5-34.9-6.9C125,218.7,120,213,120,207s5-11.7,14.1-</div>
<div class="line">16.1C143.4,186.5,155.8,184,169,184
M169,183c-27.6,0-50,10.7-50,24</div>
<div class="line">s22.4,24,50,24s50-10.7,50-24S196.6,183,169,183L169,183z”/&gt;</div>
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;g id=”<a href="#id15"><span class="problematic" id="id16">ecran_suivant_</span></a>” xlink:href=”#spa” onclick=”next_ecran(1)”
transform=”matrix(0,-</div>
<div class="line">1,1,0,28.57143,680.00001)”&gt;</div>
<div class="line">&lt;path id=”e_suiv”
d=”M493,147.5c0,0.1-19.</div>
</div>
</dd>
<dt>5,39-19.5,39c-0.1-0.1-19.5-39-19.5-39s4.4,1.9,9.8,4.2l9.7,4.2l9.7-4.2</dt><dd><blockquote>
<div><div class="line-block">
<div class="line"><br /></div>
</div>
</div></blockquote>
<dl>
<dt>C488.5,149.3,492.9,147.4,493,147.5C493,147.4,493,147.4,493,147.5z”/&gt;</dt><dd><blockquote>
<div><p>&lt;/g&gt;</p>
</div></blockquote>
<div class="line-block">
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;g&gt;</div>
<div class="line">&lt;g id=”<a href="#id17"><span class="problematic" id="id18">ecran_precedent_</span></a>” xlink:href=”#spa”
onclick=”next_ecran(-1)”
transform=”matrix(0,-1,1,0,28.57143,680.00001)”&gt;</div>
<div class="line">&lt;path id=”e_prec”
d=”M493.4,134.2c0-0.1-19.</div>
</div>
</dd>
</dl>
</dd>
<dt>5-39-19.5-39c-0.1,0.1-19.5,39-19.5,39s4.4-1.9,9.8-4.2l9.7-4.2l9.7,4.2</dt><dd><div class="line-block">
<div class="line">C489,</div>
</div>
</dd>
<dt>132.4,493.4,134.3,493.4,134.2C493.4,134.3,493.4,134.2,493.4,134.2z”/&gt;</dt><dd><blockquote>
<div><p>&lt;/g&gt;</p>
</div></blockquote>
<div class="line-block">
<div class="line">&lt;/g&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 41.4414 27.3308)” class=”spa11
spa2 spa3”&gt;MESURE PH-REDOX-TEMPERATURES-DEBIT&lt;/text&gt;</div>
<div class="line">&lt;text transform=”matrix(1 0 0 1 19.522 221.5869)” class=”spa11
spa2 spa12”&gt;NodeMcu esp8266&lt;/text&gt;</div>
</div>
<p>&lt;/svg&gt;</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image928.png"><img alt="media/image928.png" src="media/image928.png" style="width: 6.26806in; height: 6.31944in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>&lt;g id=”graphic_ph” transform=”matrix(1 0 0 1 70 65)” class=”spa2
spa3”&gt;&lt;/g&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image935.png"><img alt="media/image935.png" src="media/image935.png" style="width: 6.26806in; height: 0.90278in;" /></a>
<p><strong>Les autres fichiers concernés :</strong></p>
<ul class="simple">
<li><p>fonctions.php</p></li>
<li><p>export_tab_sqli.php</p></li>
</ul>
<a class="reference internal image-reference" href="media/image936.png"><img alt="media/image936.png" src="media/image936.png" style="width: 6.26806in; height: 2.70139in;" /></a>
<p>L’écran de mesure est petit , l’affichage est limité à 10 analyses ;
pour un historique</p>
<p>plus long , utiliser page graphique et « infos_bd »</p>
</div></blockquote>
<p>L’image svg n’accepte pas les retours à la ligne &lt;br&gt; , pour chaque
ligne il faut définir</p>
<blockquote>
<div><p>un &lt;text&gt;…&lt;/text&gt; ; le fichier fonctions.php est donc modifié en
conséquence :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>&lt;text transform=”matrix(1 0 0 1 0 ‘.$ccc.’)” class=”spa2
spa3”&gt;’.$xdate[$i].’=’.$yvaleur[$i].’&lt;/text&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image937.png"><img alt="media/image937.png" src="media/image937.png" style="width: 6.26806in; height: 0.88055in;" /></a>
<a class="reference internal image-reference" href="media/image938.png"><img alt="media/image938.png" src="media/image938.png" style="width: 6.26806in; height: 3.77778in;" /></a>
<ul class="simple">
<li><p>Les lignes non indispensables sont supprimées pour $periode= «</p></li>
</ul>
<p>text_svg »</p>
<ul class="simple">
<li><p>Affichage de « connected : echo ‘&lt;text transform=”matrix(1 0 0 1 0</p></li>
</ul>
<p>0)”</p>
</div></blockquote>
<p>class=”spa2 spa3”&gt;Connected&lt;/text&gt;’;}</p>
<blockquote>
<div><p><strong>17.1.4.3 ajout d’un ID dans l’image svg pour 3eme écran</strong></p>
<p>qui affichera les données Redox de la même façon que pour le PH
ci-dessus</p>
<a class="reference internal image-reference" href="media/image939.png"><img alt="media/image939.png" src="media/image939.png" style="width: 6.26806in; height: 0.39167in;" /></a>
<a class="reference internal image-reference" href="media/image940.png"><img alt="media/image940.png" src="media/image940.png" style="width: 4.12083in; height: 3.65972in;" /></a>
<div class="line-block">
<div class="line"><strong>17.1.4.4 ajout d’autres pages</strong></div>
<div class="line">Mesure de la température de l’eau, de l’air, le débit de la
filtration, ….</div>
</div>
<div class="line-block">
<div class="line"><strong>Débit de la filtration :</strong></div>
<div class="line"><em>Impulsion de débit : F(Hz)=(0.20xQ)-3%</em> <em>, Q=L/min F= 0,2 L/mn</em></div>
<div class="line"><em>dans EasyEsp les données envoyées sont :</em></div>
</div>
<a class="reference internal image-reference" href="media/image941.png"><img alt="media/image941.png" src="media/image941.png" style="width: 5.31389in; height: 1.14583in;" /></a>
<p><em>Domoticz reçoit donc :</em></p>
<a class="reference internal image-reference" href="media/image942.png"><img alt="media/image942.png" src="media/image942.png" style="width: 4.25in; height: 0.53055in;" /></a>
<p>Pour envoyer à la BD uniquement le débit :</p>
<a class="reference internal image-reference" href="media/image943.png"><img alt="media/image943.png" src="media/image943.png" style="width: 6.09444in; height: 3.75972in;" /></a>
<a class="reference internal image-reference" href="media/image944.png"><img alt="media/image944.png" src="media/image944.png" style="width: 6.26806in; height: 0.75278in;" /></a>
</div></blockquote>
<p><strong>Dans monitor</strong>,</p>
<ul class="simple">
<li><p>ajout de la page à l’image svg :</p></li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Récupérer l’adresse du pool NTP de votre pays..</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pour cela nous allons nous rendre sur le site</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image950.png"><img alt="media/image950.png" src="media/image950.png" style="width: 5.52222in; height: 1.76111in;" /></a>
<a class="reference internal image-reference" href="media/image951.png"><img alt="media/image951.png" src="media/image951.png" style="width: 6.3in; height: 1.75139in;" /></a>
<p>Extension Pompes perisaltiques pour réguler PH et REDOX : Schéma de
la partie « pompes »:</p>
<a class="reference internal image-reference" href="media/image952.png"><img alt="media/image952.png" src="media/image952.png" style="width: 6.3in; height: 3.96944in;" /></a>
<a class="reference internal image-reference" href="media/image953.png"><img alt="media/image953.png" src="media/image953.png" style="width: 4.17778in; height: 4.29167in;" /></a>
<p>Flasher l’ESP avec ESP easy mega :</p>
<a class="reference internal image-reference" href="media/image954.png"><img alt="media/image954.png" src="media/image954.png" style="width: 6.3in; height: 3.90972in;" /></a>
<a class="reference internal image-reference" href="media/image955.png"><img alt="media/image955.png" src="media/image955.png" style="width: 4.43889in; height: 7.04167in;" /></a>
</div></blockquote>
<p>Sur l’ESP qui assure les mesures , seul le GPIO 13 (D7) peut être
utilisé , d’où l’utilisation d’un 2eme ESP pour commander les 2 pompes
et plus …….</p>
<div class="line-block">
<div class="line">Utilisation du plugin : le contrôleur - ESPEasy P2P Networking</div>
<div class="line">Ce protocole est spécifiquement destiné à être utilisé par les nœuds
ESPeasy pour communiquer les uns avec les autres .</div>
</div>
<div class="line-block">
<div class="line">Activer le contrôleur réseau p2p sur le nœud émetteur ; un contrôleur
MQTT ne peut plus être utilisé sur ce nœud,</div>
<div class="line">Activer le contrôleur réseau p2p sur le nœud de réception, c’est à
partir de ce nœud que les données MQTT pourront être envoyées.</div>
</div>
<div class="line-block">
<div class="line">Concernant cette extension, il faut dupliquer l’envoi vers le serveur
MQTT des données concernées (ESP « mesures » vers l’ESP « pompes »</div>
<div class="line">Exemple :</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image956.png"><img alt="media/image956.png" src="media/image956.png" style="width: 4.84444in; height: 5.72917in;" /></a>
</div></blockquote>
<p><strong>Calibration</strong></p>
<div class="line-block">
<div class="line">Mesure Du PH</div>
<div class="line">Les bibliothèques Phidget peuvent convertir automatiquement la tension
du capteur en pH en sélectionnant le type de capteur approprié.
Consultez l’API Phidget22 pour plus de détails. Pour déterminer le pH
d’une solution, assurez-vous que l’interrupteur DIP de la carte est
retourné du côté du pH. Compte tenu de la tension du capteur, la
formule suivante peut être appliquée :</div>
</div>
<blockquote>
<div><div class="line-block">
<div class="line">pH</div>
<div class="line">=</div>
<div class="line">3.56</div>
<div class="line">×</div>
<div class="line">Tension</div>
<div class="line">−</div>
<div class="line">1.889</div>
</div>
<p>\text{pH} = 3.56 \times \text{Voltage} - 1.889</p>
<p>Cette formule (et la formule Phidget Library Sensor Value) suppose
que la solution est à 25°C. En fonction de la température de la
solution et du niveau de pH réel, la tension de sortie peut changer
considérablement. Pour incorporer la température (en °C) pour plus de
précision, la formule suivante peut être utilisée:</p>
<div class="line-block">
<div class="line">pH = 7</div>
<div class="line">−</div>
<div class="line">2.5</div>
<div class="line">−</div>
<div class="line">Tension</div>
<div class="line">0.257179</div>
<div class="line">+</div>
<div class="line">0.000941468</div>
<div class="line">×</div>
<div class="line">Température</div>
</div>
<p>\text{pH = 7 }- \frac{2.5 - \text{Voltage}}{0.257179 + 0.000941468
\times \text{Temperature}}</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>On plonge la sonde dans 2 solutions étalons.</p>
<p>On obtient une valeur de l’espeasy exprimé en bits.</p>
<div class="line-block">
<div class="line">Et la suite en essayant d’être simple :</div>
<div class="line">Je vérifie le ph de ma solution étalon avec un petit ph de poche
qui me donne un ph de 7. L’espeasy m’affiche une valeur de 822
bits.</div>
</div>
<p>Je vérifie le ph de ma solution étalon avec un petit ph de poche
qui me donne un ph de 4. L’espeasy m’affiche une valeur de
580bits.</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">Calcul:</div>
<div class="line">y=ax+b y =ax a= y/x</div>
<div class="line">soit</div>
<div class="line">y1=4</div>
<div class="line">y2=7</div>
<div class="line">x1=882</div>
<div class="line">x2=580</div>
<div class="line">a=(y2-y1)/(x2-x1)</div>
<div class="line">b=y-ax</div>
<div class="line">soit</div>
<div class="line">a=(7-4)/(882-580)=0,00993377(on arrondi car ca ne rentre pas
dans la formule espeasy)</div>
<div class="line">b=4-0,00993377*580=-1,7615866</div>
<div class="line">Voilà donc la formula que j’intègre dans espeasy pour avoir la
valeur du ph déjà convertie:</div>
<div class="line">%value%*0,00993377-1,7615866</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image957.png"><img alt="media/image957.png" src="media/image957.png" style="width: 5.08889in; height: 4.22361in;" /></a>
<a class="reference internal image-reference" href="media/image958.png"><img alt="media/image958.png" src="media/image958.png" style="width: 4.96944in; height: 1.51111in;" /></a>
</div></blockquote>
<p>Tuto concernant le P2P</p>
<blockquote>
<div><p>Config pour l’ESP qui mesures le PH et le Redox :</p>
<a class="reference internal image-reference" href="media/image959.png"><img alt="media/image959.png" src="media/image959.png" style="width: 4.65972in; height: 2.9375in;" /></a>
<p>Config pour l’ESP qui gère les pompes</p>
<a class="reference internal image-reference" href="media/image960.png"><img alt="media/image960.png" src="media/image960.png" style="width: 5.04167in; height: 1.68056in;" /></a>
<div class="line-block">
<div class="line">Port pour l’ UDP :</div>
<div class="line">Sur les 2ESP,</div>
</div>
<a class="reference internal image-reference" href="media/image961.png"><img alt="media/image961.png" src="media/image961.png" style="width: 4.84444in; height: 4.49028in;" /></a>
<a class="reference internal image-reference" href="media/image962.png"><img alt="media/image962.png" src="media/image962.png" style="width: 4.73056in; height: 1.05278in;" /></a>
</div></blockquote>
<p>L’ ESP « mesures_SPA » est l’esclave, il transmet les données et l’ESP «
Pompes » sera le maître , il reçoit les valeurs de PH et Redox , les
transmet par MQTT à Domoticz et avec ces données gère les pompes.</p>
<p>Dans l’esp « mesures_spa », et aussi dans «l’ESP « pompes » on ajoute un
contrôleur :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image963.png"><img alt="media/image963.png" src="media/image963.png" style="width: 5.44861in; height: 2.41667in;" /></a>
<a class="reference internal image-reference" href="media/image964.png"><img alt="media/image964.png" src="media/image964.png" style="width: 6.3in; height: 2.99583in;" /></a>
<a class="reference internal image-reference" href="media/image965.png"><img alt="media/image965.png" src="media/image965.png" style="width: 6.3in; height: 3.10833in;" /></a>
<p>Dans l’ESP « mesures_spa » une ligne a été ajoutée, cocher la case
concernant P2P</p>
</div></blockquote>
<p>networking et décocher la case concernant MQTT</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image966.png"><img alt="media/image966.png" src="media/image966.png" style="width: 4.71944in; height: 3.78194in;" /></a>
<p>Rebooter les 2 contrôleurs :</p>
<p>Dans « pompes, activer les capteurs Redox, PH, temp</p>
<a class="reference internal image-reference" href="media/image967.png"><img alt="media/image967.png" src="media/image967.png" style="width: 6.33333in; height: 2.32222in;" /></a>
<a class="reference internal image-reference" href="media/image968.png"><img alt="media/image968.png" src="media/image968.png" style="width: 4.45972in; height: 4.82222in;" /></a>
<a class="reference internal image-reference" href="media/image969.png"><img alt="media/image969.png" src="media/image969.png" style="width: 6.3in; height: 2.28472in;" /></a>
<p>Les valeurs PH et Redox sont erronées, les sondes n’étant pas
raccordées</p>
</div></blockquote>
<div class="line-block">
<div class="line">Jusqu’à présent nous ne mesurions que des valeurs, désormais nous
allons gérer le PH, le Redox et la température.</div>
<div class="line">- 1 pompe pour PH+, réglé à 7.1</div>
<div class="line">- 1 pompe pour PH minus à 7.5</div>
</div>
<p>Le pH de l’eau de votre piscine doit se situer aux alentours de 7 pour
être correct. Le taux idéal admis est de 7,4.</p>
<div class="line-block">
<div class="line">- pH trop élevé : acide sulfurique, acide chlorhydrique</div>
<div class="line">1 centilitre d’acide à 20/22°C pour 1m3 fait descendre le pH de 0.3
unités</div>
<div class="line">Débit pompe mini 90ml/mn soit 9cl/60 /s-→ 0.15cl/s -&gt;2s de
fonctionnement= 0.1 de PH , à vérifier</div>
<div class="line">Durée vie tube silicone : 200H</div>
</div>
<div class="line-block">
<div class="line">- pH trop bas : Ajoutez du pH plus, contenant du carbonate et du
bicarbonate de sodium ou de calcium. On le trouve sous forme liquide</div>
<div class="line">- 1 Une pompe pour ORP</div>
</div>
<blockquote>
<div><p>Le 1er relais 5V est raccordé au GPIO 12 (D6)</p>
<a class="reference internal image-reference" href="media/image970.png"><img alt="media/image970.png" src="media/image970.png" style="width: 6.3in; height: 5.74722in;" /></a>
<a class="reference internal image-reference" href="media/image971.png"><img alt="media/image971.png" src="media/image971.png" style="width: 6.3in; height: 1.53611in;" /></a>
<p>Dans Domoticz :</p>
<p><a class="reference internal" href="media/image972.png"><img alt="image47" src="media/image972.png" style="width: 4.11528in; height: 1.47778in;" /></a> idx = 285</p>
<p>Le 2eme relais pour PH moins :</p>
<a class="reference internal image-reference" href="media/image973.png"><img alt="media/image973.png" src="media/image973.png" style="width: 5.35694in; height: 5.25833in;" /></a>
<a class="reference internal image-reference" href="media/image974.png"><img alt="media/image974.png" src="media/image974.png" style="width: 5.82361in; height: 1.58333in;" /></a>
<p>On créer également un switch virtuel dans Domoticz, ; cela permet de
commander la pompe en manuel</p>
<a class="reference internal image-reference" href="media/image975.png"><img alt="media/image975.png" src="media/image975.png" style="width: 4.01111in; height: 1.53055in;" /></a>
<div class="line-block">
<div class="line">Le 3eme relais commande la pompe Redox</div>
<div class="line">Pour régler le redox, on doit stabiliser le pH sur sa valeur idéale
qui doit être comprise entre 7,2 et 7,4. Ensuite il faut régler le
redox sur une valeur optimale entre 650 et 750mV environ. Cette
valeur redox va permettre d’avoir une eau de piscine désinfectée et
désinfectante.</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>Pour augmenter le redox : ajoutez
du chlore dans le bassin</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</td>
<td><p>Pour baisser le redox : Le
potentiel redox et le pH sont
très liés. Augmenter le pH</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>piscine fera diminuer le pouvoir désinfectant du chlore et ainsi
baisser le redox de la piscine…. Une seule pompe pour le chlore
suffit</p>
<a class="reference internal image-reference" href="media/image976.png"><img alt="media/image976.png" src="media/image976.png" style="width: 5.14583in; height: 5.15278in;" /></a>
<a class="reference internal image-reference" href="media/image977.png"><img alt="media/image977.png" src="media/image977.png" style="width: 5.44861in; height: 1.52083in;" /></a>
<p>Dans Domoticz</p>
<a class="reference internal image-reference" href="media/image978.png"><img alt="media/image978.png" src="media/image978.png" style="width: 4.20833in; height: 1.42778in;" /></a>
<p>On active les règles :</p>
<a class="reference internal image-reference" href="media/image979.png"><img alt="media/image979.png" src="media/image979.png" style="width: 4.19861in; height: 2.57361in;" /></a>
<p>La règle :</p>
<div class="line-block">
<div class="line">on System#Boot do</div>
<div class="line">gpio,12,0 // Prevent relay turning on during boot gpio,13,0</div>
<div class="line">endon</div>
</div>
<div class="line-block">
<div class="line">On PH#Valeur Do</div>
<div class="line">If [PH#Valeur] &gt;7.5</div>
<div class="line">GPIO,12,1</div>
<div class="line">Else</div>
<div class="line">gpio,12,0</div>
<div class="line">Endif</div>
<div class="line">If [PH#Valeur] &lt;7.1</div>
<div class="line">GPIO,14,1</div>
<div class="line">Else</div>
<div class="line">gpio,14,0</div>
<div class="line">Endif</div>
<div class="line">Endon</div>
</div>
<div class="line-block">
<div class="line">On ORP#Valeur Do</div>
<div class="line">If [ORP#Valeur] &lt;1</div>
<div class="line">GPIO,13,1</div>
<div class="line">Else</div>
<div class="line">gpio,13,0</div>
<div class="line">Endif</div>
<div class="line">Endon</div>
</div>
<p>Après création ou modification des Règles : REBOOT</p>
<a class="reference internal image-reference" href="media/image980.png"><img alt="media/image980.png" src="media/image980.png" style="width: 4.01944in; height: 3.24028in;" /></a>
<a class="reference internal image-reference" href="media/image981.png"><img alt="media/image981.png" src="media/image981.png" style="width: 6.3in; height: 3.56528in;" /></a>
<div class="line-block">
<div class="line">// ACQUISITION VALEUR pH</div>
<div class="line">SondePH = analogRead(A0); // Enregistre la valeur de l’entrée
analogique A0 dans la variable</div>
</div>
<div class="line-block">
<div class="line">// Calcul moyenne de la variable pH</div>
<div class="line">totalpH = totalpH + SondePH; // Additionne la valeur à chaque cycle
comptpH++; // Compte le nombre de cycles</div>
</div>
<div class="line-block">
<div class="line">if(comptpH == 300){ // Dès que la qté de cycle est atteinte (300
afin de lisser les entrées hors normes)</div>
<div class="line">moyennepH = totalpH / comptpH; // Calcul la moyenne</div>
<div class="line">totalpH = SondePH; // Remet à zéro le compteur</div>
<div class="line">comptpH = 1;</div>
<div class="line">}</div>
</div>
<div class="line-block">
<div class="line">// Conversion pH</div>
<div class="line">// pH = moyennepH / 73.07143; // converti la variable (Gain pour pH
0 à 14) pH = 4 + moyennepH / 169.000; // converti la variable (Gain
pour pH 4 à 10)</div>
</div>
<p>a sonde ORP genere un signal -2V / +2V</p>
<p>L’adaptateur le transforme en 0/5V.</p>
<p>Pour avoir l’ORP il faut :</p>
<p>ORP (V)=(2.5−Voltage)/1.037</p>
<p>Ensuite je fais la convention ORP vers Cl (j’ai une regulation PH
donc toujours à 7.4)</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">#!/usr/bin/env python3.7</div>
<div class="line"># -<em>- coding: utf-8 -</em>-</div>
</div>
<div class="line-block">
<div class="line">import paho.mqtt.client as mqtt</div>
<div class="line">import json</div>
<div class="line">import sys</div>
<div class="line"># Variables et Arguments</div>
<div class="line">topic= str(sys.argv[1])</div>
<div class="line">etat= str(sys.argv[2])</div>
<div class="line">valeur= str(sys.argv[3])</div>
<div class="line">MQTT_HOST = “192.168.1.42”</div>
<div class="line">MQTT_PORT = 1883</div>
<div class="line">MQTT_KEEPALIVE_INTERVAL = 45</div>
<div class="line">MQTT_TOPIC = topic</div>
</div>
<div class="line-block">
<div class="line">MQTT_MSG=json.dumps({etat: valeur});</div>
<div class="line">#</div>
<div class="line">def on_publish(client, userdata, mid):</div>
<div class="line">print (“Message Publié…”)</div>
</div>
<div class="line-block">
<div class="line">def on_connect(client, userdata, flags, rc):</div>
<div class="line">client.subscribe(MQTT_TOPIC)</div>
<div class="line">client.publish(MQTT_TOPIC, MQTT_MSG)</div>
</div>
<div class="line-block">
<div class="line">def on_message(client, userdata, msg):</div>
<div class="line">print(msg.topic)</div>
<div class="line">print(msg.payload)</div>
<div class="line">payload = json.loads(msg.payload) # convertion en json</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">print(payload[‘state_l2’])</div>
<div class="line">client.disconnect()</div>
</div>
<div class="line-block">
<div class="line"># Initialisation MQTT Client</div>
<div class="line">mqttc = mqtt.Client()</div>
</div>
<div class="line-block">
<div class="line"># callback funRction</div>
<div class="line">mqttc.on_publish = on_publish</div>
<div class="line">mqttc.on_connect = on_connect</div>
<div class="line">mqttc.on_message = on_message</div>
</div>
<div class="line-block">
<div class="line"># Connection avec le serveur MQTT</div>
<div class="line">mqttc.connect(MQTT_HOST, MQTT_PORT, MQTT_KEEPALIVE_INTERVAL)</div>
</div>
<div class="line-block">
<div class="line"># Loop forever</div>
<div class="line">mqttc.loop_forever()</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Pour être sûr que le fichier est au bon format (Unix) :</p>
<a class="reference internal image-reference" href="media/image985.png"><img alt="media/image985.png" src="media/image985.png" style="width: 4.79306in; height: 0.41667in;" /></a>
</div></blockquote>
<p><strong>18.3 Liaison série Domoticz-PI</strong></p>
<blockquote>
<div><p><strong>Scripts dans Domoticz</strong></p>
<p>Ils sont exécutés en dehors du conteneur si Domoticz est sous Docker.</p>
<p><strong>ATTENTION</strong> :La passerelle Zigbee 3.0 SonOff utilise le même driver
série CP2102 -</p>
<p>→donc pour /dev/serial/by-id = IDENTIQUE</p>
<a class="reference internal image-reference" href="media/image986.png"><img alt="media/image986.png" src="media/image986.png" style="width: 6.26806in; height: 0.85972in;" /></a>
<p><strong>Script sms_dz.py</strong></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">#!/usr/bin/env python3.9 -<em>- coding: utf-8 -</em>-</div>
<div class="line">import requests , time ,json, os, chardet, shutil</div>
<div class="line">from periphery import Serial</div>
<div class="line">import importlib</div>
<div class="line">import aldz as b</div>
</div>
<div class="line-block">
<div class="line">ser = Serial(“/dev/ttyUSB1”, 115200)</div>
<div class="line">#ser = Serial(“/dev/serial/by-id/usb-</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0”,
115200) def envoi_sms(message):</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">bmessage = message.encode(‘utf-8’)</div>
<div class="line">ser.write(bmessage)</div>
</div>
<div class="line-block">
<div class="line">def com_dz(url):</div>
<div class="line">response = requests.get(url)</div>
<div class="line">if response.status_code == 200:</div>
<div class="line">contenu = response.json()</div>
<div class="line">message = contenu[‘title’]</div>
<div class="line">envoi_sms(message)</div>
<div class="line">else:</div>
<div class="line">print(‘URL absente’)</div>
<div class="line">envoi_sms(‘url_absente’)</div>
<div class="line">def raz_dz():</div>
<div class="line">src=r’/opt/domoticz/config/scripts/python/aldz.bak.py’
des=r’/opt/domoticz/config/scripts/python/aldz.py’
shutil.copy(src, des)</div>
</div>
<div class="line-block">
<div class="line">print(‘start’)</div>
<div class="line">#effacer le tampon série pour supprimer le courrier indésirable
et le bruit ser.flush()</div>
<div class="line">while True:</div>
<div class="line">b = importlib.reload(b)</div>
<div class="line">message=b.x</div>
<div class="line">print(message)</div>
<div class="line">if message != “0” :</div>
<div class="line">envoi_sms(message)</div>
<div class="line">raz_dz()</div>
<div class="line">url = ser.read(128, 0.5).decode(errors=’ignore’)</div>
<div class="line">if url:</div>
<div class="line">print(url)</div>
<div class="line">com_dz(url)</div>
<div class="line">time.sleep(10)</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image987.png"><img alt="media/image987.png" src="media/image987.png" style="width: 6.26806in; height: 5.59167in;" /></a>
<p>Modifier si besoin le numéro de la variable et le port de domoticz</p>
</div></blockquote>
<p>Le démarrage automatique est assuré par systemd , voir domo-site.fr page
70 (liaison</p>
<blockquote>
<div><p>série):</p>
<p>aldz.py</p>
<a class="reference internal image-reference" href="media/image988.png"><img alt="media/image988.png" src="media/image988.png" style="width: 4.87639in; height: 0.89583in;" /></a>
<p>aldz.bak.dz</p>
<a class="reference internal image-reference" href="media/image989.png"><img alt="media/image989.png" src="media/image989.png" style="width: 4.29305in; height: 0.61528in;" /></a>
<p><strong>Scripts PI</strong></p>
<p>rec_sms_serie.py</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"><em>!/usr/bin/env python3.8</em></div>
<div class="line"><em># -</em>- coding: utf-8 -<em>-</em></div>
</div>
<div class="line-block">
<div class="line"><em>import time,serial,requests</em></div>
<div class="line"><em>from periphery import Serial</em></div>
<div class="line"><em>ip_domoticz=”http://192.168.1.76:8086/”</em></div>
<div class="line"><em>se_domoticz=# voir IMPORTANT def convert_to_string(buf):</em></div>
<div class="line"><em>try:</em></div>
<div class="line"><em>tt = buf.decode(‘utf-8’).strip()</em></div>
<div class="line"><em>return tt</em></div>
<div class="line"><em>except UnicodeError:</em></div>
<div class="line"><em>tmp = bytearray(buf)</em></div>
<div class="line"><em>for i in range(len(tmp)):</em></div>
<div class="line"><em>if tmp[i]&gt;127:</em></div>
<div class="line"><em>tmp[i] = ord(‘?’)</em></div>
<div class="line"><em>return bytes(tmp).decode(‘utf-8’).strip()</em></div>
</div>
<div class="line-block">
<div class="line"><em>def not_reception(content):</em></div>
<div class="line"><em>message =
(‘AT+SMSSEND=0670065886,’+content+’\r\n’).encode(‘utf-8’)
phone.write(b’+++’)</em></div>
<div class="line"><em>time.sleep(2)</em></div>
<div class="line"><em>phone.write(b’AT+VER\r\n’)</em></div>
<div class="line"><em>time.sleep(1)</em></div>
<div class="line"><em>phone.write(message)</em></div>
<div class="line"><em>phone.write(b’AT+EXAT’);</em></div>
<div class="line"><em>time.sleep(1);</em></div>
</div>
<div class="line-block">
<div class="line"><em>def ip_serie(ip_se,url):</em></div>
<div class="line"><em>if ip_se == 1:</em></div>
<div class="line"><em>response = requests.get(url)</em></div>
<div class="line"><em>contenu = response.json()</em></div>
<div class="line"><em>if contenu[‘status’]==”OK”:</em></div>
<div class="line"><em>content=contenu[‘title’]</em></div>
<div class="line"><em>else :</em></div>
<div class="line"><em>content=”erreur”</em></div>
<div class="line"><em>#print(content)</em></div>
<div class="line"><em>not_reception(content)</em></div>
<div class="line"><em>elif ip_se == 2:</em></div>
<div class="line"><em>print(“Connexion série”)</em></div>
<div class="line"><em>url=url.encode(‘utf-8’)</em></div>
<div class="line"><em>serie.write(url)</em></div>
<div class="line"><em>time.sleep(1)</em></div>
<div class="line"><em>else:</em></div>
<div class="line"><em>print(“erreur”)</em></div>
<div class="line"><em>not_reception(“mauvais formatage”)</em></div>
<div class="line"><em>phone =
serial.Serial(port=”/dev/ttyAMA1”,baudrate=115200,timeout=2)
serie = Serial(“/dev/ttyAMA2”, 115200)</em></div>
<div class="line"><em>phone.close() #Cloture du port pour le cas ou il serait déjà
ouvert ailleurs phone.open() #Ouverture du port</em></div>
<div class="line"><em>phone.write(b’AT+EXAT’);</em></div>
<div class="line"><em>time.sleep(1);</em></div>
<div class="line"><em>while True:</em></div>
<div class="line"><em>line = phone.readline() # copie d’une ligne entiere jusqu’a \n
dans “line”</em> <em>print(line)</em></div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"><em>buf_dz = serie.read(128, 0.5)</em></div>
<div class="line"><em>#print(buf_dz)</em></div>
<div class="line"><em>id=”none”</em></div>
<div class="line"><em>value=”none”</em></div>
<div class="line"><em>name=”none”</em></div>
<div class="line"><em>if buf_dz:</em></div>
<div class="line"><em>buf_dz = convert_to_string(buf_dz)</em></div>
<div class="line"><em>not_reception(buf_dz)</em></div>
<div class="line"><em>if line:</em></div>
<div class="line"><em>line = convert_to_string(line)</em></div>
<div class="line"><em>#print(line) #pour essai</em></div>
<div class="line"><em>params=line.split(‘#’)</em></div>
<div class="line"><em>if params[0] and (params[0]==’smsip’ or params[0]==’smsse’):</em></div>
<div class="line"><em>if params[0]==”smsip”:</em></div>
<div class="line"><em>domoticz=ip_domoticz</em></div>
<div class="line"><em>ip_se=1</em></div>
<div class="line"><em>if params[0]==”smsse”:</em></div>
<div class="line"><em>domoticz=se_domoticz</em></div>
<div class="line"><em>ip_se=2</em></div>
<div class="line"><em>if params[1]:</em></div>
<div class="line"><em>id = params[1]</em></div>
<div class="line"><em>if params[1]:</em></div>
<div class="line"><em>id = params[1]</em></div>
<div class="line"><em>#print(‘Id:’+id)</em></div>
<div class="line"><em>if params[2]:</em></div>
<div class="line"><em>name = params[2]</em></div>
<div class="line"><em>#print(‘name:’+name)</em></div>
<div class="line"><em>if params[3]:</em></div>
<div class="line"><em>value = params[3]</em></div>
<div class="line"><em>#print(‘valeur:’+value)</em></div>
<div class="line"><em>if (id!=”none” and name!=”none” and value!=”none”):</em></div>
<div class="line"><em>if name == ‘switch’:</em></div>
<div class="line"><em>url = domoticz+’json.htm?type=command&amp;param=switchlight&amp;idx$</em>
<em>else :</em></div>
<div class="line"><em>url = domoticz+’json.htm?type=command&amp;param=updateuservaria$</em>
<em>else :</em></div>
<div class="line"><em>ip_se=””</em></div>
</div>
<p><em>ip_serie(ip_se,url)</em></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image990.png"><img alt="media/image990.png" src="media/image990.png" style="width: 6.26806in; height: 6.21944in;" /></a>
<p>Utiliser localhost et non 127.0.0.1</p>
<p><strong>IMPORTANT</strong></p>
<p>Si ce massage en bash :</p>
<a class="reference internal image-reference" href="media/image991.png"><img alt="media/image991.png" src="media/image991.png" style="width: 6.26806in; height: 1.91806in;" /></a>
<p>Ajouter login et mot de passe :</p>
<a class="reference internal image-reference" href="media/image992.png"><img alt="media/image992.png" src="media/image992.png" style="width: 4.30278in; height: 0.94861in;" /></a>
<a class="reference internal image-reference" href="media/image993.png"><img alt="media/image993.png" src="media/image993.png" style="width: 6.26806in; height: 1.58889in;" /></a>
<p>start_rec_sms.sh</p>
<a class="reference internal image-reference" href="media/image994.png"><img alt="media/image994.png" src="media/image994.png" style="width: 4.27222in; height: 0.66667in;" /></a>
<p>Démarrage auto avec systemd :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">[Unit]</div>
<div class="line">Description=start rec sms pour Domoticz</div>
</div>
<div class="line-block">
<div class="line">[Service]</div>
<div class="line">Type=simple</div>
<div class="line">ExecStart=/home/michel/start_rec_sms.sh Restart=on-failure</div>
<div class="line">RestartSec=10</div>
<div class="line">KillMode=process</div>
</div>
<div class="line-block">
<div class="line">[Install]</div>
<div class="line">WantedBy=multi-user.target</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image995.png"><img alt="media/image995.png" src="media/image995.png" style="width: 6.26806in; height: 2.91111in;" /></a>
<p><strong>18.4 Commandes de l’alarme à partir d’un GSM</strong></p>
<p>Pour faciliter l’activation ou l’arrêt de l’alarme , il est facile
d’ajouter des codes au</p>
<p>script du paragraphe précédent 18.2</p>
<p>Extrait de rec_sms_serie.py installé sur le PI qui assure le
monitoring , les</p>
<p>notifications GSM et les sauvegardes</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">params=line.split(‘#’)</div>
<div class="line">if params[0] and (params[0]==’smsip’ or params[0]==’smsse’ or
params[0]==’Alon’ or params[0]==’Aloff’):</div>
<div class="line">if params[0]==”smsip”:</div>
<div class="line">domoticz=ip_domoticz</div>
<div class="line">ip_se=1</div>
<div class="line">if params[0]==”smsse”:</div>
<div class="line">domoticz=se_domoticz</div>
<div class="line">ip_se=2</div>
<div class="line">if params[0]==”Alon”:</div>
<div class="line">domoticz=ip_domoticz</div>
<div class="line">ip_se=1</div>
<div class="line">params[1]= ‘41’</div>
<div class="line">params[2]=’switch’</div>
<div class="line">params[3]=’On’</div>
<div class="line">if params[0]==”Aloff”:</div>
<div class="line">domoticz=ip_domoticz</div>
<div class="line">ip_se=1</div>
<div class="line">params[1]= ‘41’</div>
<div class="line">params[2]=’switch’</div>
<div class="line">params[3]=’Off’</div>
<div class="line">if params[1]:</div>
<div class="line">id = params[1]</div>
<div class="line">print(‘Id:’+id)</div>
<div class="line">if params[2]:</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">name = params[2]</div>
<div class="line">print(‘name:’+name)</div>
<div class="line">if params[3]:</div>
<div class="line">value = params[3]</div>
<div class="line">print(‘valeur:’+value)</div>
<div class="line">if (id!=”none” and name!=”none” and value!=”none”):</div>
<div class="line">if name == ‘switch’:</div>
<div class="line">url =</div>
<div class="line">domoticz+</div>
</div>
</div></blockquote>
<dl>
<dt>‘json.htm?type=command&amp;param=switchlight&amp;idx=’+id+’&amp;switchcmd=’+value</dt><dd><blockquote>
<div><p>else :</p>
</div></blockquote>
<div class="line-block">
<div class="line">url =</div>
<div class="line">domoticz+</div>
</div>
</dd>
<dt>‘json.htm?type=command&amp;param=updateuservariable&amp;idx=’+id+’&amp;vname=’+na</dt><dd><blockquote>
<div><p>me+’&amp;vtype=2$</p>
</div></blockquote>
<div class="line-block">
<div class="line">else :</div>
<div class="line">ip_se=””</div>
</div>
<p>ip_serie(ip_se,url)</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image996.png"><img alt="media/image996.png" src="media/image996.png" style="width: 6.26806in; height: 4.33055in;" /></a>
<p>Le switch domoticz :</p>
</div></blockquote>
<p><strong>18.6 Complément sur l’utilisation des Mots de Passe cryptés dans
Domoticz</strong> Une des solutions pour crypter et décrypter les mots de passe</p>
<p><em>Codage</em> : <a class="reference external" href="https://www.base64encode.org/">https://www.base64encode.org/</a></p>
<a class="reference internal image-reference" href="media/image1011.png"><img alt="media/image1011.png" src="media/image1011.png" style="width: 6.17778in; height: 6.14583in;" /></a>
<div class="line-block">
<div class="line"><strong>Décodage</strong></div>
<div class="line"><em>Extrait du script maj-services.lua</em></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">–</div>
<div class="line">–[[</div>
<div class="line">– time</div>
<div class="line">name : maj_services.lua</div>
</div>
<div class="line-block">
<div class="line">ce script à pour but de déterminer si nous sommes en semaine
pair ou impair et fonction de cela, le jeudi en fin d’après
midi,</div>
<div class="line">de nous alerter par SMS , par notifiction TV de sortir la
poubelle concernée, de gérer la fosse septique et les
anniversaires.</div>
</div>
<div class="line-block">
<div class="line">– les variables Domoticz A CREER</div>
<div class="line">– variables ‘chaine’: poubelles=”0” , fosse_septique=”0”
,anniversaires ,not_tv_fosse=”0” , not_tv_poubelle=”0”</div>
<div class="line">–
————————</div>
</div>
</div></blockquote>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><div class="line-block">
<div class="line">la 1ere semaine est celle ayant au moins 4 jours sur la nouvelle
année</div>
<div class="line">–]]</div>
<div class="line">– Get day of a week at year beginning</div>
<div class="line">–(tm can be any date and will be forced to 1st of january same
year)</div>
<div class="line">– return 1=mon 7=sun</div>
<div class="line">–</div>
<div class="line">– chargement fichier contenant les variables de configuration</div>
<div class="line">package.path = package.path..”;www/modules_lua/?.lua”</div>
<div class="line">require ‘string_tableaux’</div>
<div class="line">require ‘connect’</div>
<div class="line">local base64 = require’base64’</div>
<div class="line">local user_free = base64.decode(login_free);local passe_free =
base64.decode(pass_free); local sms_free=”curl –insecure
‘<a class="reference external" href="https://smsapi.free">https://smsapi.free</a>-</div>
<div class="line">mobil</div>
</div>
</div></blockquote>
<dl class="simple">
<dt>e.fr/sendmsg?user=”..user_free..”&amp;pass=”..passe_free..”&amp;msg=poubelle’</dt><dd><p>&gt;&gt; /home/michel/OsExecute.log 2&gt;&amp;1”</p>
</dd>
</dl>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="media/image1012.png"><img alt="media/image1012.png" src="media/image1012.png" style="width: 7.20833in; height: 1.46111in;" /></a>
<p>Le fichier connect.lua :</p>
<a class="reference internal image-reference" href="media/image1013.png"><img alt="media/image1013.png" src="media/image1013.png" style="width: 3.45972in; height: 0.69861in;" /></a>
<p>notification_devices : base64 pour login et mot de passe</p>
<a class="reference internal image-reference" href="media/image1014.png"><img alt="media/image1014.png" src="media/image1014.png" style="width: 6.26806in; height: 2.44306in;" /></a>
<p><strong>18.7 pages sans rapport avec la domotique</strong></p>
<blockquote>
<div><p><strong>18.7.1 Les recettes de cuisines sur la tablette domotique</strong></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">mes.css.css</div>
<div class="line">config.php</div>
<div class="line">index_loc.php</div>
<div class="line">header.php</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>et parfois le fichierbib-Slide.js , si l’on doit modifier la largeur
du menu</p>
<a class="reference internal image-reference" href="media/image1016.png"><img alt="media/image1016.png" src="media/image1016.png" style="width: 2.90556in; height: 2.49028in;" /></a>
<p>le fichier recettes.php :</p>
<a class="reference internal image-reference" href="media/image1017.png"><img alt="media/image1017.png" src="media/image1017.png" style="width: 6.3in; height: 2.56944in;" /></a>
<a class="reference internal image-reference" href="media/image1018.png"><img alt="media/image1018.png" src="media/image1018.png" style="width: 6.3in; height: 2.28055in;" /></a>
<p>Dans fonctions.php :</p>
<a class="reference internal image-reference" href="media/image1019.png"><img alt="media/image1019.png" src="media/image1019.png" style="width: 6.3in; height: 6.575in;" /></a>
<p>La page avec 2 recettes :</p>
<a class="reference internal image-reference" href="media/image1020.png"><img alt="media/image1020.png" src="media/image1020.png" style="width: 5.56111in; height: 3.57361in;" /></a>
<p>Exemple de page recette</p>
<a class="reference internal image-reference" href="media/image1021.png"><img alt="media/image1021.png" src="media/image1021.png" style="width: 6.3in; height: 2.01944in;" /></a>
<p><strong>18.8 migration de Domoticz différentes étapes pour ne rien
oublier</strong></p>
<p>Exemple migration vers Docker.</p>
<ul class="simple">
<li><p><strong>Modifier les IP/PORT</strong> de Domoticz, Zwavejs2mqtt,</p></li>
</ul>
<p>Zigbee2mqtt,…dans le fichier de configuration de monitor.</p>
<div class="line-block">
<div class="line">- <strong>Pour les scripts externes non gérés dans le conteneur
Domoticz</strong> ,installer les versions de python, node, … nécessaires,
et les dépendances nécessaires ;par exemple pour la</div>
<div class="line">communication série de Domoticz , l’installation de
python-periphery , le démarrage auto sur systemd ,…. Si l’API de
Domoticz est utilisée dans ces scripts , modifier le Port de
Domoticz</div>
</div>
<p><strong>Pour VOIP asterisk,</strong> modifier ip de domoticz pour la capture
d’image (portier) ; pour appeler json de Domoticz depuis Docker,
autoriser dans les paramètres de Domoticz le réseau 172.*.*.*</p>
<ul class="simple">
<li><p><strong>Pour le monitoring Nagios</strong>, il faut indiquer les IP/PORT qui</p></li>
</ul>
<p>sont modifiés et les noms des VM</p>
<p>Proxmox si Proxmox est utilisé.</p>
<ul class="simple">
<li><p><strong>Si une nouvelle page doit être ajoutée à monitor</strong>, par exemple</p></li>
</ul>
<p>pour Zwave (OZW n’étant plus</p>
<p>maintenu) : créer le sous-domaine pour l’accès distant et le
certificat pour HTTPS</p>
<p>(Letsencrypt-cerbot)</p>
<ul class="simple">
<li><p><strong>Les dispositifs sont souvent difficiles à réveiller</strong>, s’ils sont</p></li>
</ul>
<p>réinstallés, modifier l’ID de</p>
<p>Domoticz dans la base de données de monitor</p>
</div></blockquote>
<p><strong>19. – UPDATE PHP 8.2</strong></p>
<p>Fichiers concernés:</p>
<a class="reference internal image-reference" href="media/image1022.png"><img alt="media/image1022.png" src="media/image1022.png" style="width: 1.92778in; height: 1.96944in;" /></a>
<p>Changement de version jpgraph</p>
<p>Dossier include :</p>
<a class="reference internal image-reference" href="media/image1023.png"><img alt="media/image1023.png" src="media/image1023.png" style="width: 2.27222in; height: 5.02083in;" /></a>
<p>Principale modification : concerne les sessions</p>
<p><strong>20. – Résolution de problèmes</strong></p>
<div class="line-block">
<div class="line"><strong>20.1 concernant les variables :</strong></div>
<div class="line">L’idx ou l’ID indiqué dans MySQL (table dispositifs) ne correspond pas
avec celui de Domoticz HA</div>
</div>
<a class="reference internal image-reference" href="media/image1024.png"><img alt="media/image1024.png" src="media/image1024.png" style="width: 3.71944in; height: 2.57361in;" /></a>
<p>Vérifier avec F12 du navigateur -&gt;réseau le json renvoyé : exist_id doit
être « oui »</p>
<a class="reference internal image-reference" href="media/image1025.png"><img alt="media/image1025.png" src="media/image1025.png" style="width: 3.32361in; height: 1.97917in;" /></a>
<p><strong>21. – Mon installation</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Un conteneur, une VM ou une
partition classique Ensuite
LEMP</div>
<div class="line">En dernier et monitor</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Installation de Proxmox : assurez-vous que la virtualisation UEFI est
activée dans le BIOS</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pour terminer le processus de post-installation de Proxmox VE
7(évite de modifier manuellement les fichiers sources.list d’apt,)
vous pouvez exécuter la commande suivante dans pve Shell.</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>bash -c “$(wget -qLO -</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference external" href="https://github.com/tteck/Proxmox/raw/main/misc/post-pve-install.sh">https://github.com/tteck/Proxmox/raw/main/misc/post-pve-install.sh</a>)”</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>voir sur Github : <a class="reference external" href="https://github.com/StevenSeifried/proxmox-scripts">https://github.com/StevenSeifried/proxmox-scripts</a></p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><blockquote>
<div><p><a href="#id5"><span class="problematic" id="id6">*</span></a><a class="reference external" href="https://github.co">https://github.co</a></p>
</div></blockquote>
<p>m/StevenSeifried/proxmox-scripts*</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image1027.png"><img alt="media/image1027.png" src="media/image1027.png" style="width: 4.42639in; height: 2.52083in;" /></a>
<p><strong>21.1.1 installation de VM ou CT par l’interface graphique : IP
:8006</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image1034.png"><img alt="media/image1034.png" src="media/image1034.png" style="width: 3.19861in; height: 3.59444in;" /></a>
<p>Plex est installé sur un autre mini PC sous Proxmox également, en
conteneur, voir le site domo-site.fr</p>
<div class="line-block">
<div class="line"><strong>21.2 Domoticz</strong></div>
<div class="line">Installation sous Docker :</div>
<div class="line">Installation VM :</div>
</div>
<p>Mes scripts lua :</p>
<a class="reference internal image-reference" href="media/image1035.png"><img alt="media/image1035.png" src="media/image1035.png" style="width: 3.19861in; height: 3.07222in;" /></a>
<p>Mes scripts bash, python et Node js :</p>
<a class="reference internal image-reference" href="media/image1036.png"><img alt="media/image1036.png" src="media/image1036.png" style="width: 4.18889in; height: 3.63611in;" /></a>
<a class="reference internal image-reference" href="media/image1037.png"><img alt="media/image1037.png" src="media/image1037.png" style="width: 4.27222in; height: 3.19722in;" /></a>
<a class="reference internal image-reference" href="media/image1038.png"><img alt="media/image1038.png" src="media/image1038.png" style="width: 4.34444in; height: 1.76111in;" /></a>
<p>Les scripts sont disponibles sur Github :</p>
<blockquote>
<div><div class="line-block">
<div class="line"><strong>21.3 Zwave</strong></div>
<div class="line">Installation de zwave-js-ui ,</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>dans un conteneur LXC :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><blockquote>
<div><p>sous Docker, avec Domoticz :
<a href="#id7"><span class="problematic" id="id8">*</span></a><a class="reference external" href="http://">http://</a></p>
</div></blockquote>
<p>domo-site.fr/accueil/dossiers/86*</p>
</td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Affichage dans monitor :</p>
<a class="reference internal image-reference" href="media/image1039.png"><img alt="media/image1039.png" src="media/image1039.png" style="width: 4.85139in; height: 5.58056in;" /></a>
<p>Configuration de l’hôte virtuel Nginx pour affichage dans monitor :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">sous Docker :</div>
<div class="line">dans un conteneur LXC :</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Affichage dans monitor :</p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image1042.png"><img alt="media/image1042.png" src="media/image1042.png" style="width: 4.93889in; height: 4.97778in;" /></a>
<p>Configuration de l’hôte virtuel Nginx pour affichage dans monitor :</p>
<a class="reference internal image-reference" href="media/image1043.png"><img alt="media/image1043.png" src="media/image1043.png" style="width: 5.36806in; height: 6in;" /></a>
<p>Plus de commentaires dans le paragraphe précédent</p>
<div class="line-block">
<div class="line"><strong>21.5 Asterisk (sip)</strong></div>
<div class="line">Installation dans une VM :</div>
</div>
<p>Il n’est pas utile de créer un hôte virtuel sur Nginx, les
modifications, mises à jour,…peuvent se faire sur Proxmox.</p>
<div class="line-block">
<div class="line"><strong>21.6 MQTT (mosquito)</strong></div>
<div class="line">Installation dans une VM :</div>
</div>
<p>Comme pour Asterisk , il n’est pas utile de créer un hôte virtuel.</p>
<div class="line-block">
<div class="line"><strong>21.7 Zoneminder</strong></div>
<div class="line">Installation dans une VM :</div>
</div>
<blockquote>
<div><p>Ce serveur est nécessaire pour :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">-</div>
<div class="line">-</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">L’affichage du mur de
caméras</div>
<div class="line">La détection (mode modect)
de présence pour l’alarme</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><a class="reference internal image-reference" href="media/image1044.png"><img alt="media/image1044.png" src="media/image1044.png" style="width: 4.84861in; height: 6.13472in;" /></a>
<p>Configuration de l’hôte virtuel Nginx</p>
<a class="reference internal image-reference" href="media/image1045.png"><img alt="media/image1045.png" src="media/image1045.png" style="width: 4.98194in; height: 5.14583in;" /></a>
</div></blockquote>
<div class="line-block">
<div class="line"><strong>21.8 Plex</strong></div>
<div class="line">Installation :</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>dans un conteneur LXC :</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>dans une VM :</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>partage samba pour Plex (conteneur LXC) :</p>
<p>affichage dans un navigateur ou TV <strong>: IP :32400/web</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="media/image1046.png"><img alt="media/image1046.png" src="media/image1046.png" style="width: 6.30139in; height: 4.77917in;" /></a>
<p>Configuration de l’hôte virtuel Nginx pour accès distant</p>
<a class="reference internal image-reference" href="media/image1047.png"><img alt="media/image1047.png" src="media/image1047.png" style="width: 5.21806in; height: 4.62361in;" /></a>
<div class="line-block">
<div class="line"><strong>21.9 Raspberry PI4</strong></div>
<div class="line">Alimenté en 12 Volts , comme le mini PC Proxmox, le PI4 couplé à un
modem GSM assure l’envoi et la réception des sms même en cas de
coupure d’alimentation électrique ENEDIS ; L’alarme ainsi que toute
les commandes Domoticz restent opérationnelles.</div>
</div>
<div class="line-block">
<div class="line">Le serveur Domoticz et ce PI4 sont reliés par une liaison série ; à
partir d’un smartphone l’envoi de sms permet de commander directement
des switches par l’intermédiaire de l’API de Domoticz(</div>
<div class="line">Le système est sauvegardé par le logiciel Raspibackup :</div>
</div>
<blockquote>
<div><a class="reference internal image-reference" href="media/image1048.png"><img alt="media/image1048.png" src="media/image1048.png" style="width: 6.25in; height: 4.01111in;" /></a>
<p>Le PI4 assure aussi :</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>La sauvegarde RAID1, mais
celle-ci n’est pas sauvegardée
et un reboot du PI est</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>nécessaire en cas de coupure de courant ; une fonction existe, pour
cela, dans</p>
<p>monitor…..</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><blockquote>
<div><p>Le monitoring (Nagios) :
<a href="#id9"><span class="problematic" id="id10">*</span></a><a class="reference external" href="http://">http://</a></p>
</div></blockquote>
<p>domo-site.fr/accueil/dossiers/71*</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Conf Nginx :</p>
<a class="reference internal image-reference" href="media/image1049.png"><img alt="media/image1049.png" src="media/image1049.png" style="width: 4.70694in; height: 5.54028in;" /></a>
</div></blockquote>
<p>Installation du système et du raid1 :</p>
<p>Scripts installés en plus de raspibackup et Nagios :</p>
<blockquote>
<div><a class="reference internal image-reference" href="media/image1050.png"><img alt="media/image1050.png" src="media/image1050.png" style="width: 4.11528in; height: 4.07361in;" /></a>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>msmtp , pour envoyer des
emails facilement</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>config :</p>
<a class="reference internal image-reference" href="media/image1051.png"><img alt="media/image1051.png" src="media/image1051.png" style="width: 2.88472in; height: 4.07222in;" /></a>
<p>Affichage dans monitor :</p>
</div></blockquote>
<p><strong>21.9.1.1 cannot-open-access-to-console-the-root-account-is-locked</strong></p>
<p>Si votre Raspberry Pi (RPI) ne démarre pas et affiche “Impossible
d’ouvrir l’accès à la console, le compte root est verrouillé sur l’écran
de démarrage :</p>
<p><strong>Mode d’emploi pour revenir à la situation normale</strong></p>
<p>/etc/fstab à certainement une entrée non prise en charge. C’est ce qui
se passe si un disque USB externe est déconnecté ou remplacé</p>
<p>Pour résoudre ce problème, sortez la carte SD ou la clé USB du PI et
branchez-la sur votre ordinateur. Ignorez les demandes de formatage et
explorer la partition « boot » .</p>
<p>Ouvrir le fichier appelé cmdline.txt dans le Bloc-notes ou Notepad et
ajouter <strong>init=/bin/sh</strong>à la fin de la première ligne .</p>
<a class="reference internal image-reference" href="media/image1053.png"><img alt="media/image1053.png" src="media/image1053.png" style="width: 5.58472in; height: 0.38472in;" /></a>
<p>Enregistrez le fichier et remettez la carte SD ou la clé USB dans le PI
et bootez. Un clavier et un écran sont raccordés au PI ; sur l’écran on
peut alors constater qu’une console en bash est alors disponible pour
effectuer des modification sur le fichier /etc/fstab.</p>
<p>sudo nano /etc/fstab</p>
<a class="reference internal image-reference" href="media/image1057.png"><img alt="media/image1057.png" src="media/image1057.png" style="width: 6.30139in; height: 2.78611in;" /></a>
<a class="reference internal image-reference" href="media/image1058.png"><img alt="media/image1058.png" src="media/image1058.png" style="width: 6.16667in; height: 2.34444in;" /></a>
<a class="reference internal image-reference" href="media/image1059.png"><img alt="media/image1059.png" src="media/image1059.png" style="width: 6.30139in; height: 3.22222in;" /></a>
<a class="reference internal image-reference" href="media/image1060.png"><img alt="media/image1060.png" src="media/image1060.png" style="width: 3.09444in; height: 2.15556in;" /></a>
<a class="reference internal image-reference" href="media/image1061.png"><img alt="media/image1061.png" src="media/image1061.png" style="width: 6.30139in; height: 3.64167in;" /></a>
<a class="reference internal image-reference" href="media/image1062.png"><img alt="media/image1062.png" src="media/image1062.png" style="width: 2.59444in; height: 2.1875in;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><ul class="simple">
<li></li>
</ul>
</th>
<th class="head"><p>Reset à distance du modem GSM
( 1 Bug en 2 ans !!!)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>Simple programme de commande de relais USB LCUS_1</strong></p>
<p>#!/usr/bin/bash</p>
<div class="line-block">
<div class="line">echo “Entrer une commande : ON ou OFF “</div>
<div class="line">read COMMANDE</div>
<div class="line">if [ “$COMMANDE” = “ON” ] ; then cmd=’\xA0\x01\x01\xA2’ fi</div>
<div class="line">if [ “$COMMANDE” = “OFF” ] ; then cmd=’\xA0\x01\x01\xA2’; fi</div>
<div class="line">serdev=”/dev/ttyUSB0”</div>
</div>
<div class="line-block">
<div class="line">echo ‘open door’</div>
<div class="line">/bin/bash -c “echo -n -e ‘$cmd’ &gt; $serdev”</div>
</div>
<p>Retour d’info avec GPIO du RPI</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"># Import des modules</div>
<div class="line">import RPi.GPIO as GPIO</div>
<div class="line">import time</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>import envoi_sms.py</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"># Initialisation de la numerotation et des E/S
GPIO.setmode(GPIO.BCM)</div>
<div class="line"># numerotation de la sérigraphie : (GPIO.BOARD)</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>GPIO.setup(19, GPIO.IN)</p>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"># Si on detecte un appui sur le bouton, on allume la LED # et on
attend que le bouton soit relache</div>
<div class="line">whileTrue:</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><div class="line-block">
<div class="line">state = GPIO.(19)</div>
<div class="line">ifnot state:</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line"># on a appuye sur le bouton connecte sur la broche 19
exec(open(“envoi_sms.py 0Volts”).read())</div>
<div class="line">whilenot state:</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><div class="line-block">
<div class="line">state = GPIO.(19)</div>
<div class="line">time.sleep(0.02) # Pause pour ne pas saturer le processeur</div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">exec(open(“envoi_sms.py 12Volts”).read())</div>
<div class="line">time.sleep(0.02) # Pause pour ne pas saturer le processeur</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">monitor-domotique</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Gravier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>